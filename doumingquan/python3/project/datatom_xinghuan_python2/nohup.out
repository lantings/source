2019-08-19 10:23:09,156 - db - INFO - The database has been successfully connected
2019-08-19 10:23:09,156 - db - INFO - select token from public.token_info
2019-08-19 10:23:09,195 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjY3ODYxODksImlhdCI6MTU2NjE4MTM4OSwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.P28bK8TcmmaTrlLN91MAX4mw5hFI80KZ_rZDoGkLGvgZp3ndgJuGt1J0SqQRj61LBkqRwy71k41Ja4R4M07LlP4Dpm1fjFBxyZdv-3AgHBnrjJsBcJyquVHPKgn6y2tYbF7Ax_5PafLsUCSVPr6rEe4gAp9oIGlBvJnGEW4P528e-cmyUB2V2qaxtBCyRB9A_w9NIxGXZYEwEMMscnuVYxlwlSYcdYydm5eXKQMsEBd3iuZfTl9twhC5ujHUQ5gEeqOc-rwRS90wTR8S-5n1TzKdjWxxyahBaJr3IDNa-Vg53eo4UNF0TqMZkaouzJD_c-Cfc-7ySLSgCreFhq0VR4674nJ0UWKMnok__hR6Y2GBSe6VSA2kULZQt3HTledi54I7hyNFx6hUhRTHHEI89jQdDzAwjDOg6ersQJDDoznntfG5kPLarKcPlwcBmLYgipSEEHdxFsvxOYkEybZ95fdSpPSkJ_sxneYPAlKBInhZiDpi2OIeYjGy4mjNf_MwvkLkiVADOf_ND8d0NgeihCwAaD_Ua6JvWwRbOMpD2l13J-N2TMnAx3FmpHPa9t0Si0f-a9E8YH0c7zp2Vhhb6xoFUCCony5KXgWdd4sKXPM4bk0JfSTXEz1hua-Ag5oaMTJkqV7rZ_i0I3WYJbDkaesHYrVS9Gsq6bcQ27KmXGs' where 1='1'
2019-08-19 10:24:29,910 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.7)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.7')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 52, in post
    ColumnType = res['ColumnType']
KeyError: 'ColumnType'
2019-08-19 10:24:29,932 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.7) 22.65ms
2019-08-19 10:25:20,603 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.7)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.7')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 52, in post
    ColumnType = res['ColumnType']
KeyError: 'ColumnType'
2019-08-19 10:25:20,603 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.7) 0.98ms
2019-08-19 10:38:36,212 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.7)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.7')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 52, in post
    ColumnType = res['ColumnType']
KeyError: 'ColumnType'
2019-08-19 10:38:36,213 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.7) 0.95ms
2019-08-20 14:34:59,965 - db - INFO - The database has been successfully connected
2019-08-20 14:34:59,969 - db - INFO - select token from public.token_info
2019-08-20 14:34:59,999 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjY4ODc2OTksImlhdCI6MTU2NjI4Mjg5OSwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.XcHxl4-78Ii8L4IMP9EIAT9l1aNsLJw63m_ye0EKPXBuNTyV6Y7m73FdsPz1pigg0zYsvJN2Lr7NR34k1tBbEpdHpTglnkehDy2TcaIXUZghh0ty_C8X_FnOoSdE61zUGL8eR81sfu8tulKNjdZtTz61lPO6NydEJfm-mL4JZYo7cbKp_O5D3aWcTeUFdEE0CoorrWma_fYR28DEf05wWdkTks0uvDGTt0pcgzOuAfU3lgSWUHWaF937CSaL_a2Cj6ySErHcCew2u7a2B_txGtH-uY1_u3Psh3pi9VUw0i4ANgg9wGGRXu4CayGnznjE-ifvG9BbOM1INY3MYvMHYZnK6bcdvIlWLERRPZu91vATNIYV1El4EPsqnd2h-_t77FA47mrYr2RIYSSUNlki9WAAtQY_dBNL6Bh2nypJspddxu74aAX4HQTN-0UpakfNuGjDF8KjVADG2VRKyxamiObfJx2_KKEI9nLYODehVFwUFWULyNhjL69MTJu8n-GJ5aayDyYwsF8KieG5S_Ya67lLbljgKH1tOXkKO6qd_gWMK0h3WGG2jgxlsSpcDHlPU6_cLBACS99Hx3Q2ZBrb4rXP29TItxISTL2NlstuKgDQ2WfLogm5OyU1Na-S-Ag8M2m3Ra4Rh6nk8k1CxdpGFs2ZMYh3N7Av0tEIAKOgs-4' where 1='1'
Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjY4ODc2OTksImlhdCI6MTU2NjI4Mjg5OSwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.XcHxl4-78Ii8L4IMP9EIAT9l1aNsLJw63m_ye0EKPXBuNTyV6Y7m73FdsPz1pigg0zYsvJN2Lr7NR34k1tBbEpdHpTglnkehDy2TcaIXUZghh0ty_C8X_FnOoSdE61zUGL8eR81sfu8tulKNjdZtTz61lPO6NydEJfm-mL4JZYo7cbKp_O5D3aWcTeUFdEE0CoorrWma_fYR28DEf05wWdkTks0uvDGTt0pcgzOuAfU3lgSWUHWaF937CSaL_a2Cj6ySErHcCew2u7a2B_txGtH-uY1_u3Psh3pi9VUw0i4ANgg9wGGRXu4CayGnznjE-ifvG9BbOM1INY3MYvMHYZnK6bcdvIlWLERRPZu91vATNIYV1El4EPsqnd2h-_t77FA47mrYr2RIYSSUNlki9WAAtQY_dBNL6Bh2nypJspddxu74aAX4HQTN-0UpakfNuGjDF8KjVADG2VRKyxamiObfJx2_KKEI9nLYODehVFwUFWULyNhjL69MTJu8n-GJ5aayDyYwsF8KieG5S_Ya67lLbljgKH1tOXkKO6qd_gWMK0h3WGG2jgxlsSpcDHlPU6_cLBACS99Hx3Q2ZBrb4rXP29TItxISTL2NlstuKgDQ2WfLogm5OyU1Na-S-Ag8M2m3Ra4Rh6nk8k1CxdpGFs2ZMYh3N7Av0tEIAKOgs-4
Traceback (most recent call last):
  File "api_201907302051.py", line 165, in <module>
    application.listen(12306)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2042, in listen
    server.listen(port, address)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/tcpserver.py", line 143, in listen
    sockets = bind_sockets(port, address=address)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/netutil.py", line 168, in bind_sockets
    sock.bind(sockaddr)
  File "/usr/local/python2.7/lib/python2.7/socket.py", line 228, in meth
    return getattr(self._sock,name)(*args)
socket.error: [Errno 98] Address already in use
2019-08-20 14:35:00,037 - db - INFO - The database has been closed
2019-08-20 14:41:00,635 - db - INFO - The database has been successfully connected
2019-08-20 14:41:00,635 - db - INFO - select token from public.token_info
2019-08-20 14:41:00,667 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjY4ODgwNjAsImlhdCI6MTU2NjI4MzI2MCwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.vkCPxnwY9wZ8aurBVaa7IAlsEhro0L_XaAX8UOYncuM62TPh9D3duhYzYxbgO5FXtF5l8RK-rWgrhuylCDKCtthSYxRaC88_XRrAL3_95VnLqvXqqtQJSRmrkwg-U5Xav6mapUtXq1ekX4YY_K9g1upWlflEOOBHsSftsJq-KHjLDgb1rFZXxVjfjdl_SUgyz4DbunVE3qpEbZl4JJV9n-PWOdupiRh1obXOlHDKEKuFh4Bg7myvUZDoIJtuL5A8ajuB1uxTIxLb4TuUqhf5QLBNlolH3W0cf7lVT-2MJmEhkG--_AqlmpY4Yjc6TypMYWom3bC7zHY_dnTQ3U4PNFIvw_SjHDYxpVgkX0Pkb6HklzjdKJ0cxqu5zbrjrML56hGV2H5LeQjSqpEWS577q7vqQgxsKhqZUAX24wlFKvjI5w5-EnlJ16lv_TmO_QWb99bpMFgdm-lq8_I0EVrBRVg-izsjQZqJemU6bLVW5PGcm1o0kM18FvFrNeCjEKocRYX_VvN-i0SnqP0Dk7SHx0RujNSkh8UveTRB5ZjPdDaod_AehKtAxriV0tz7dz-t6V4cDoX2VflpbsVfXsGGSTKIUW1o868SSpHe9sQQFF8qVOswdavq2kvGJRrj1sZdmK_aUoBKQwRPsFqIPdEuDxxw2j4ntOhkB10Wp7Y97TM' where 1='1'
2019-08-20 14:41:10,449 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.93)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.93')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 27, in post
    res = json.loads(res)
  File "/usr/local/python2.7/lib/python2.7/json/__init__.py", line 339, in loads
    return _default_decoder.decode(s)
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 364, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 380, in raw_decode
    obj, end = self.scan_once(s, idx)
ValueError: Expecting ',' delimiter: line 1 column 495 (char 494)
2019-08-20 14:41:10,450 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.93) 2.16ms
2019-08-20 14:42:13,918 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.92)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.92')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 27, in post
    res = json.loads(res)
  File "/usr/local/python2.7/lib/python2.7/json/__init__.py", line 339, in loads
    return _default_decoder.decode(s)
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 364, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 380, in raw_decode
    obj, end = self.scan_once(s, idx)
ValueError: Expecting ',' delimiter: line 1 column 494 (char 493)
2019-08-20 14:42:13,918 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.92) 1.01ms
2019-08-20 14:46:12,590 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_check_action'
2019-08-20 14:46:12,692 - dodox_01907302051 - INFO - Successful folder creation
2019-08-20 14:46:12,748 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_check_action.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_jgxw_check_action.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_check_action.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_check_action.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_check_action.log', 'gonganju_txt_ods.jg_jgxw_check_action', 'dsjzx.jg_jgxw_check_action','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_check_action数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_jgxw_check_action\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_jgxw_check_action_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_jgxw_check_action_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_jgxw_check_action_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_jgxw_check_action_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_check_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_check_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_check_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt' into table gonganju_txt_ods.jg_jgxw_check_action\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_check_action select * from gonganju_txt_ods.jg_jgxw_check_action\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_jgxw_check_action\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_check_action抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_jgxw_check_action.py"}}

2019-08-20 14:46:12,749 - dodox_01907302051 - INFO - Upload Success
2019-08-20 14:46:12,897 - dodox_01907302051 - INFO - AWytxqYXBZ1xJXgBM2sr
2019-08-20 14:46:13,992 - dodox_01907302051 - INFO - b55b0a7d835112ecc56a305a4245aade
2019-08-20 14:46:13,993 - dodox_01907302051 - INFO - workflow success
2019-08-20 14:46:15,156 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-20 14:46:15,157 - dodox_01907302051 - INFO - workflowid:b55b0a7d835112ecc56a305a4245aade
2019-08-20 14:46:16,275 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_check_action'
2019-08-20 14:46:16,275 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('b55b0a7d835112ecc56a305a4245aade','up','AWytxqYXBZ1xJXgBM2sr','gonganju_8_103_dsjzx_jg_jgxw_check_action')
2019-08-20 14:46:16,278 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3744.39ms
2019-08-20 15:10:18,654 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_force_action'
2019-08-20 15:10:18,766 - dodox_01907302051 - INFO - Successful folder creation
2019-08-20 15:10:18,804 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_force_action.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_jgxw_force_action.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_force_action.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_force_action.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_force_action.log', 'gonganju_txt_ods.jg_jgxw_force_action', 'dsjzx.jg_jgxw_force_action','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_force_action数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_jgxw_force_action\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_jgxw_force_action_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_jgxw_force_action_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_jgxw_force_action_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_jgxw_force_action_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_force_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_force_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_force_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt' into table gonganju_txt_ods.jg_jgxw_force_action\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_force_action select * from gonganju_txt_ods.jg_jgxw_force_action\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_jgxw_force_action\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_force_action抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_jgxw_force_action.py"}}

2019-08-20 15:10:18,804 - dodox_01907302051 - INFO - Upload Success
2019-08-20 15:10:18,977 - dodox_01907302051 - INFO - AWyt3La-BZ1xJXgBM2s6
2019-08-20 15:10:20,047 - dodox_01907302051 - INFO - 08cf809792e84b3a38b4e9fbe1b823d5
2019-08-20 15:10:20,047 - dodox_01907302051 - INFO - workflow success
2019-08-20 15:10:21,169 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-20 15:10:21,169 - dodox_01907302051 - INFO - workflowid:08cf809792e84b3a38b4e9fbe1b823d5
2019-08-20 15:10:22,282 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_force_action'
2019-08-20 15:10:22,282 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('08cf809792e84b3a38b4e9fbe1b823d5','up','AWyt3La-BZ1xJXgBM2s6','gonganju_8_103_dsjzx_jg_jgxw_force_action')
2019-08-20 15:10:22,284 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3685.53ms
2019-08-20 16:23:38,428 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-20 16:23:38,503 - dodox_01907302051 - INFO - Successful folder creation
2019-08-20 16:23:38,536 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_other_action.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_jgxw_other_action.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_other_action.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_other_action.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_other_action.log', 'gonganju_txt_ods.jg_jgxw_other_action', 'dsjzx.jg_jgxw_other_action','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_other_action数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_jgxw_other_action\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_jgxw_other_action_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_jgxw_other_action_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_jgxw_other_action_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_jgxw_other_action_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_other_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_other_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_other_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt' into table gonganju_txt_ods.jg_jgxw_other_action\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_other_action select * from gonganju_txt_ods.jg_jgxw_other_action\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_jgxw_other_action\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_other_action抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_jgxw_other_action.py"}}

2019-08-20 16:23:38,536 - dodox_01907302051 - INFO - Upload Success
2019-08-20 16:23:38,692 - dodox_01907302051 - INFO - AWyuH9k3BZ1xJXgBM2to
2019-08-20 16:23:39,766 - dodox_01907302051 - INFO - a21782959db705aa3f494111b344a776
2019-08-20 16:23:39,766 - dodox_01907302051 - INFO - workflow success
2019-08-20 16:23:40,883 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-20 16:23:40,883 - dodox_01907302051 - INFO - workflowid:a21782959db705aa3f494111b344a776
2019-08-20 16:23:42,036 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-20 16:23:42,036 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('a21782959db705aa3f494111b344a776','up','AWyuH9k3BZ1xJXgBM2to','gonganju_8_103_dsjzx_jg_jgxw_other_action')
2019-08-20 16:23:42,038 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3665.97ms
2019-08-20 16:25:55,808 - db - INFO - The database has been successfully connected
2019-08-20 16:25:55,808 - db - INFO - select token from public.token_info
2019-08-20 16:25:55,838 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjY4OTQzNTUsImlhdCI6MTU2NjI4OTU1NSwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.y-7DZ2FaYW6SHunNGZQkC7olwds0RRFeppKiKr7PfTBJuPdU601SNiy9JqSO9Qfxwlu00Im58QdoWCifKR_iOF9kfHyS-FdKOZnBvhsGSGB6Vt5buOHniiyVad17oHC0GMJ-wQw5_XRa0wEoBoB0SBvUVjxl2Dy8lGASUip-IdB5IaiFch3CmeW2271X09Is0Daflhm5yYsCSWOQKmnrpo2_DBkSHQ__Ms-dRcbANLgrFqUh-7IrJIV6KrsKQbSTkVoniLYIQfxirkr7_BBMGtrfUAFFV3gl8DZ_8P_6wAqgXZFKbGMhlTI7k73NpovAen7p4iuWrfvE0i3yMDBcqJuxECUQWm4p_BunfOL1eUhrAymf4UdKYhQNyh8Xg1m8xWl9jCPMgRdixRH30MmUeO_nvX2Soe0eWbAw3ZKLgeJjLgoINWDXMZvrwCvqn-GeYNy_dLz8vXUJu53-bzRS0BvuZ00r_pXgnmPSA7O0nOfifqagawRNAbEmfWBQ9xnlJ67K1iOcbnmganG09N-IpOFLUsztx3dAYCiO5goah9G1_S454D7yqOCjTe_Md8YLmmWPAhUHc4nkz64nxaWpUBwOhDd0vCgrv-nwoBGpMYVEKDnt3ulPBoIKcNAcHGE6q-fFhY14wiESiaw2EHenhPfZxQSojLpGYixLiNFGJPE' where 1='1'
2019-08-20 16:26:13,272 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-20 16:26:13,274 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.21ms
2019-08-20 16:26:34,731 - db - INFO - select * from public.task_info where wfid = 'a21782959db705aa3f494111b344a776'
2019-08-20 16:26:34,732 - db - INFO - update  public.task_info set status='down' where wfid='a21782959db705aa3f494111b344a776'
2019-08-20 16:26:35,892 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1160.87ms
2019-08-20 16:26:40,663 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-20 16:26:40,748 - dodox_01907302051 - INFO - Successful folder creation
2019-08-20 16:26:40,785 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_other_action.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_jgxw_other_action.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_other_action.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_other_action.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_other_action.log', 'gonganju_txt_ods.jg_jgxw_other_action', 'dsjzx.jg_jgxw_other_action','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_other_action数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_jgxw_other_action\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_jgxw_other_action_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_jgxw_other_action_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_jgxw_other_action_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_jgxw_other_action_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_other_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_other_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_other_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt' into table gonganju_txt_ods.jg_jgxw_other_action\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_other_action select * from gonganju_txt_ods.jg_jgxw_other_action\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_jgxw_other_action\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_other_action抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_jgxw_other_action.py"}}

2019-08-20 16:26:40,785 - dodox_01907302051 - INFO - Upload Success
2019-08-20 16:26:40,924 - dodox_01907302051 - INFO - AWyuIqEjBZ1xJXgBM2tx
2019-08-20 16:26:42,000 - dodox_01907302051 - INFO - aac302f5407272e507a974af70307c85
2019-08-20 16:26:42,000 - dodox_01907302051 - INFO - workflow success
2019-08-20 16:26:43,113 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-20 16:26:43,113 - dodox_01907302051 - INFO - workflowid:aac302f5407272e507a974af70307c85
2019-08-20 16:26:44,225 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-20 16:26:44,226 - db - INFO - update  public.task_info set wfid='aac302f5407272e507a974af70307c85',status='up',scriptid='AWyuIqEjBZ1xJXgBM2tx' where workflowname='gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-20 16:26:44,228 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3617.45ms
2019-08-20 17:52:37,818 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_punish_action'
2019-08-20 17:52:37,928 - dodox_01907302051 - INFO - Successful folder creation
2019-08-20 17:52:38,000 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_punish_action.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_jgxw_punish_action.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_punish_action.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_punish_action.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_punish_action.log', 'gonganju_txt_ods.jg_jgxw_punish_action', 'dsjzx.jg_jgxw_punish_action','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_punish_action数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_jgxw_punish_action\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_jgxw_punish_action_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_jgxw_punish_action_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_jgxw_punish_action_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_jgxw_punish_action_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_punish_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_punish_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_punish_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt' into table gonganju_txt_ods.jg_jgxw_punish_action\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_punish_action select * from gonganju_txt_ods.jg_jgxw_punish_action\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_jgxw_punish_action\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_punish_action抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_jgxw_punish_action.py"}}

2019-08-20 17:52:38,000 - dodox_01907302051 - INFO - Upload Success
2019-08-20 17:52:38,191 - dodox_01907302051 - INFO - AWyucVJ6BZ1xJXgBM2uO
2019-08-20 17:52:39,293 - dodox_01907302051 - INFO - 133811a8c86980b35097c20e65341c5a
2019-08-20 17:52:39,293 - dodox_01907302051 - INFO - workflow success
2019-08-20 17:52:40,422 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-20 17:52:40,422 - dodox_01907302051 - INFO - workflowid:133811a8c86980b35097c20e65341c5a
2019-08-20 17:52:41,564 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_punish_action'
2019-08-20 17:52:41,565 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('133811a8c86980b35097c20e65341c5a','up','AWyucVJ6BZ1xJXgBM2uO','gonganju_8_103_dsjzx_jg_jgxw_punish_action')
2019-08-20 17:52:41,567 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3814.79ms
2019-08-20 18:29:56,011 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_zfk_user_info'
2019-08-20 18:29:56,108 - dodox_01907302051 - INFO - Successful folder creation
2019-08-20 18:29:56,146 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_zfk_user_info.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_zfk_user_info.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_zfk_user_info.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_zfk_user_info.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_zfk_user_info.log', 'gonganju_txt_ods.jg_zfk_user_info', 'dsjzx.jg_zfk_user_info','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_zfk_user_info数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_zfk_user_info\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_zfk_user_info_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_zfk_user_info_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_zfk_user_info_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_zfk_user_info_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_zfk_user_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_zfk_user_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_zfk_user_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt' into table gonganju_txt_ods.jg_zfk_user_info\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_zfk_user_info select * from gonganju_txt_ods.jg_zfk_user_info\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_zfk_user_info\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_zfk_user_info抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_zfk_user_info.py"}}

2019-08-20 18:29:56,146 - dodox_01907302051 - INFO - Upload Success
2019-08-20 18:29:56,315 - dodox_01907302051 - INFO - AWyuk3k8BZ1xJXgBM2ud
2019-08-20 18:29:57,392 - dodox_01907302051 - INFO - 3b9b52fdd38aca451fb0d1509077abb1
2019-08-20 18:29:57,392 - dodox_01907302051 - INFO - workflow success
2019-08-20 18:29:58,521 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-20 18:29:58,521 - dodox_01907302051 - INFO - workflowid:3b9b52fdd38aca451fb0d1509077abb1
2019-08-20 18:29:59,666 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_zfk_user_info'
2019-08-20 18:29:59,667 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('3b9b52fdd38aca451fb0d1509077abb1','up','AWyuk3k8BZ1xJXgBM2ud','gonganju_8_103_dsjzx_jg_zfk_user_info')
2019-08-20 18:29:59,669 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3712.71ms
2019-08-21 10:29:39,005 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 274, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-21 10:32:22,091 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 274, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-21 10:33:05,361 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_dsjzx_tb_chx_hlnr'
2019-08-21 10:33:05,502 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 10:33:05,535 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_dsjzx_tb_chx_hlnr.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_dsjzx_tb_chx_hlnr.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_dsjzx_tb_chx_hlnr.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_dsjzx_tb_chx_hlnr.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_dsjzx_tb_chx_hlnr.log', 'yibaoju_txt.TB_CHX_HLNR', 'dsjzx.TB_CHX_HLNR','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.TB_CHX_HLNR数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/dsjzx_TB_CHX_HLNR\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_TB_CHX_HLNR_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_TB_CHX_HLNR_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_TB_CHX_HLNR_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_TB_CHX_HLNR_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_CHX_HLNR.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_dsjzx_TB_CHX_HLNR.txt' into table yibaoju_txt.TB_CHX_HLNR\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_CHX_HLNR select * from yibaoju_txt.TB_CHX_HLNR\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_CHX_HLNR\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.TB_CHX_HLNR抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_dsjzx_tb_chx_hlnr.py"}}

2019-08-21 10:33:05,535 - dodox_01907302051 - INFO - Upload Success
2019-08-21 10:33:05,669 - dodox_01907302051 - INFO - AWyyBUUIBZ1xJXgBM2yS
2019-08-21 10:33:06,735 - dodox_01907302051 - INFO - e5248cce1c2e391483d46e9827704935
2019-08-21 10:33:06,736 - dodox_01907302051 - INFO - workflow success
2019-08-21 10:33:07,847 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 10:33:07,847 - dodox_01907302051 - INFO - workflowid:e5248cce1c2e391483d46e9827704935
2019-08-21 10:33:08,967 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_dsjzx_tb_chx_hlnr'
2019-08-21 10:33:08,968 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('e5248cce1c2e391483d46e9827704935','up','AWyyBUUIBZ1xJXgBM2yS','yibaoju_68_15_dsjzx_tb_chx_hlnr')
2019-08-21 10:33:08,970 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3666.23ms
2019-08-21 10:43:02,345 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_dsjzx_tb_chx_js'
2019-08-21 10:43:02,412 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 10:43:02,456 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_dsjzx_tb_chx_js.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_dsjzx_tb_chx_js.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_dsjzx_tb_chx_js.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_dsjzx_tb_chx_js.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_dsjzx_tb_chx_js.log', 'yibaoju_txt.TB_CHX_JS', 'dsjzx.TB_CHX_JS','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.TB_CHX_JS数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/dsjzx_TB_CHX_JS\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_TB_CHX_JS_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_TB_CHX_JS_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_TB_CHX_JS_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_TB_CHX_JS_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_CHX_JS.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_TB_CHX_JS_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_TB_CHX_JS_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_TB_CHX_JS_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_dsjzx_TB_CHX_JS.txt' into table yibaoju_txt.TB_CHX_JS\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_CHX_JS select * from yibaoju_txt.TB_CHX_JS\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_CHX_JS\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.TB_CHX_JS抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_dsjzx_tb_chx_js.py"}}

2019-08-21 10:43:02,456 - dodox_01907302051 - INFO - Upload Success
2019-08-21 10:43:02,590 - dodox_01907302051 - INFO - AWyyDmDDBZ1xJXgBM2yg
2019-08-21 10:43:03,655 - dodox_01907302051 - INFO - 63ef91c67fc2a00545eaae91865c1b37
2019-08-21 10:43:03,656 - dodox_01907302051 - INFO - workflow success
2019-08-21 10:43:04,770 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 10:43:04,770 - dodox_01907302051 - INFO - workflowid:63ef91c67fc2a00545eaae91865c1b37
2019-08-21 10:43:05,889 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_dsjzx_tb_chx_js'
2019-08-21 10:43:05,890 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('63ef91c67fc2a00545eaae91865c1b37','up','AWyyDmDDBZ1xJXgBM2yg','yibaoju_68_15_dsjzx_tb_chx_js')
2019-08-21 10:43:05,892 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3602.39ms
2019-08-21 10:48:56,213 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_dsjzx_tb_dic_yd'
2019-08-21 10:48:56,278 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 10:48:56,306 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_dsjzx_tb_dic_yd.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_dsjzx_tb_dic_yd.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_dsjzx_tb_dic_yd.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_dsjzx_tb_dic_yd.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_dsjzx_tb_dic_yd.log', 'yibaoju_txt.TB_DIC_YD', 'dsjzx.TB_DIC_YD','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.TB_DIC_YD数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/dsjzx_TB_DIC_YD\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_TB_DIC_YD_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_TB_DIC_YD_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_TB_DIC_YD_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_TB_DIC_YD_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_DIC_YD.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_TB_DIC_YD_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_TB_DIC_YD_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_TB_DIC_YD_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_dsjzx_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_dsjzx_TB_DIC_YD.txt' into table yibaoju_txt.TB_DIC_YD\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_DIC_YD select * from yibaoju_txt.TB_DIC_YD\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_DIC_YD\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.TB_DIC_YD抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_dsjzx_tb_dic_yd.py"}}

2019-08-21 10:48:56,307 - dodox_01907302051 - INFO - Upload Success
2019-08-21 10:48:56,436 - dodox_01907302051 - INFO - AWyyE8b8BZ1xJXgBM2y4
2019-08-21 10:48:57,503 - dodox_01907302051 - INFO - e80c026e537d7f3921ae996c6c7505ea
2019-08-21 10:48:57,503 - dodox_01907302051 - INFO - workflow success
2019-08-21 10:48:58,606 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 10:48:58,606 - dodox_01907302051 - INFO - workflowid:e80c026e537d7f3921ae996c6c7505ea
2019-08-21 10:48:59,715 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_dsjzx_tb_dic_yd'
2019-08-21 10:48:59,716 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('e80c026e537d7f3921ae996c6c7505ea','up','AWyyE8b8BZ1xJXgBM2y4','yibaoju_68_15_dsjzx_tb_dic_yd')
2019-08-21 10:48:59,718 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3559.10ms
2019-08-21 14:17:07,162 - db - INFO - select * from public.task_info where wfid = 'e80c026e537d7f3921ae996c6c7505ea'
2019-08-21 14:17:07,163 - db - INFO - update  public.task_info set status='down' where wfid='e80c026e537d7f3921ae996c6c7505ea'
2019-08-21 14:17:08,336 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1174.38ms
2019-08-21 14:17:29,902 - db - INFO - select * from public.task_info where wfid = '63ef91c67fc2a00545eaae91865c1b37'
2019-08-21 14:17:29,903 - db - INFO - update  public.task_info set status='down' where wfid='63ef91c67fc2a00545eaae91865c1b37'
2019-08-21 14:17:31,075 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1173.55ms
2019-08-21 14:18:50,696 - db - INFO - select * from public.task_info where wfid = 'e5248cce1c2e391483d46e9827704935'
2019-08-21 14:18:50,696 - db - INFO - update  public.task_info set status='down' where wfid='e5248cce1c2e391483d46e9827704935'
2019-08-21 14:18:51,846 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1151.16ms
2019-08-21 14:33:03,576 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 14:33:03,665 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 14:33:03,696 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_dic_yd.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_dic_yd.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_dic_yd.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_dic_yd.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_dic_yd.log', 'yibaoju_txt.TB_DIC_YD', 'sysdba.TB_DIC_YD','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_DIC_YD数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_DIC_YD\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_DIC_YD_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_DIC_YD_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_DIC_YD_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_DIC_YD_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_DIC_YD_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_DIC_YD_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_DIC_YD_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt' into table yibaoju_txt.TB_DIC_YD\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_DIC_YD select * from yibaoju_txt.TB_DIC_YD\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_DIC_YD\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_DIC_YD抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_dic_yd.py"}}

2019-08-21 14:33:03,697 - dodox_01907302051 - INFO - Upload Success
2019-08-21 14:33:03,820 - dodox_01907302051 - INFO - AWyy4PfcBZ1xJXgBM20E
2019-08-21 14:33:04,884 - dodox_01907302051 - INFO - 58cb4efebae1a3ccdaf06bfa97853eb0
2019-08-21 14:33:04,884 - dodox_01907302051 - INFO - workflow success
2019-08-21 14:33:05,995 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 14:33:05,995 - dodox_01907302051 - INFO - workflowid:58cb4efebae1a3ccdaf06bfa97853eb0
2019-08-21 14:33:07,107 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 14:33:07,108 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('58cb4efebae1a3ccdaf06bfa97853eb0','up','AWyy4PfcBZ1xJXgBM20E','yibaoju_68_15_sysdba_tb_dic_yd')
2019-08-21 14:33:07,110 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3604.20ms
2019-08-21 14:47:00,678 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_js'
2019-08-21 14:47:00,743 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 14:47:00,773 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_js.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_chx_js.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_js.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_js.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_js.log', 'yibaoju_txt.TB_CHX_JS', 'sysdba.TB_CHX_JS','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_CHX_JS数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_CHX_JS\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_CHX_JS_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_CHX_JS_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_CHX_JS_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_CHX_JS_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_JS_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_JS_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_JS_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt' into table yibaoju_txt.TB_CHX_JS\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_CHX_JS select * from yibaoju_txt.TB_CHX_JS\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_CHX_JS\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_CHX_JS抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_chx_js.py"}}

2019-08-21 14:47:00,773 - dodox_01907302051 - INFO - Upload Success
2019-08-21 14:47:00,916 - dodox_01907302051 - INFO - AWyy7b2uBZ1xJXgBM20P
2019-08-21 14:47:01,996 - dodox_01907302051 - INFO - 910dd080abdad849b642768ed5882f1f
2019-08-21 14:47:01,997 - dodox_01907302051 - INFO - workflow success
2019-08-21 14:47:03,119 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 14:47:03,119 - dodox_01907302051 - INFO - workflowid:910dd080abdad849b642768ed5882f1f
2019-08-21 14:47:04,249 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_js'
2019-08-21 14:47:04,250 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('910dd080abdad849b642768ed5882f1f','up','AWyy7b2uBZ1xJXgBM20P','yibaoju_68_15_sysdba_tb_chx_js')
2019-08-21 14:47:04,252 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3626.74ms
2019-08-21 14:55:51,280 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_yd_jy'
2019-08-21 14:55:51,344 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 14:55:51,374 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_yd_jy.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_yd_jy.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_yd_jy.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_yd_jy.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_yd_jy.log', 'yibaoju_txt.TB_YD_JY', 'sysdba.TB_YD_JY','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_YD_JY数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_YD_JY\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_YD_JY_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_YD_JY_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_YD_JY_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_YD_JY_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_YD_JY_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_YD_JY_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_YD_JY_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt' into table yibaoju_txt.TB_YD_JY\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_YD_JY select * from yibaoju_txt.TB_YD_JY\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_YD_JY\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_YD_JY抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_yd_jy.py"}}

2019-08-21 14:55:51,374 - dodox_01907302051 - INFO - Upload Success
2019-08-21 14:55:51,500 - dodox_01907302051 - INFO - AWyy9dZYBZ1xJXgBM20Z
2019-08-21 14:55:52,587 - dodox_01907302051 - INFO - 20b01914a36f94768fd26563e80d0360
2019-08-21 14:55:52,588 - dodox_01907302051 - INFO - workflow success
2019-08-21 14:55:53,698 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 14:55:53,698 - dodox_01907302051 - INFO - workflowid:20b01914a36f94768fd26563e80d0360
2019-08-21 14:55:54,817 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_yd_jy'
2019-08-21 14:55:54,818 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('20b01914a36f94768fd26563e80d0360','up','AWyy9dZYBZ1xJXgBM20Z','yibaoju_68_15_sysdba_tb_yd_jy')
2019-08-21 14:55:54,819 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3594.37ms
2019-08-21 14:59:14,655 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_hlnr'
2019-08-21 14:59:14,721 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 14:59:14,751 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_hlnr.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_chx_hlnr.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_hlnr.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_hlnr.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_hlnr.log', 'yibaoju_txt.TB_CHX_HLNR', 'sysdba.TB_CHX_HLNR','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_CHX_HLNR数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_CHX_HLNR\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_CHX_HLNR_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_CHX_HLNR_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_CHX_HLNR_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_CHX_HLNR_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt' into table yibaoju_txt.TB_CHX_HLNR\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_CHX_HLNR select * from yibaoju_txt.TB_CHX_HLNR\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_CHX_HLNR\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_CHX_HLNR抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_chx_hlnr.py"}}

2019-08-21 14:59:14,751 - dodox_01907302051 - INFO - Upload Success
2019-08-21 14:59:14,879 - dodox_01907302051 - INFO - AWyy-PDIBZ1xJXgBM20i
2019-08-21 14:59:15,946 - dodox_01907302051 - INFO - 7ab6b2489f9a05cfcb9178d5730936e0
2019-08-21 14:59:15,946 - dodox_01907302051 - INFO - workflow success
2019-08-21 14:59:17,083 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 14:59:17,083 - dodox_01907302051 - INFO - workflowid:7ab6b2489f9a05cfcb9178d5730936e0
2019-08-21 14:59:18,196 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_hlnr'
2019-08-21 14:59:18,197 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('7ab6b2489f9a05cfcb9178d5730936e0','up','AWyy-PDIBZ1xJXgBM20i','yibaoju_68_15_sysdba_tb_chx_hlnr')
2019-08-21 14:59:18,198 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3600.01ms
2019-08-21 15:07:18,595 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 15:07:18,662 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 15:07:18,698 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_mxxx.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_mxxx.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_mxxx.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_mxxx.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_mxxx.log', 'yibaoju_txt.TB_MXXX', 'sysdba.TB_MXXX','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_MXXX数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_MXXX\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_MXXX_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_MXXX_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_MXXX_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_MXXX_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt' into table yibaoju_txt.TB_MXXX\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_MXXX select * from yibaoju_txt.TB_MXXX\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_MXXX\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_MXXX抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_mxxx.py"}}

2019-08-21 15:07:18,698 - dodox_01907302051 - INFO - Upload Success
2019-08-21 15:07:18,822 - dodox_01907302051 - INFO - AWyzAFM0BZ1xJXgBM20w
2019-08-21 15:07:19,883 - dodox_01907302051 - INFO - 1b2c54947e5d3b1ec426046cc7c73453
2019-08-21 15:07:19,884 - dodox_01907302051 - INFO - workflow success
2019-08-21 15:07:20,988 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 15:07:20,989 - dodox_01907302051 - INFO - workflowid:1b2c54947e5d3b1ec426046cc7c73453
2019-08-21 15:07:22,099 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 15:07:22,100 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('1b2c54947e5d3b1ec426046cc7c73453','up','AWyzAFM0BZ1xJXgBM20w','yibaoju_68_15_sysdba_tb_mxxx')
2019-08-21 15:07:22,102 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3562.88ms
2019-08-21 17:07:57,743 - db - INFO - select * from public.task_info where wfid = '58cb4efebae1a3ccdaf06bfa97853eb0'
2019-08-21 17:07:57,744 - db - INFO - update  public.task_info set status='down' where wfid='58cb4efebae1a3ccdaf06bfa97853eb0'
2019-08-21 17:07:58,903 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1160.55ms
2019-08-21 17:08:10,574 - db - INFO - select * from public.task_info where wfid = '910dd080abdad849b642768ed5882f1f'
2019-08-21 17:08:10,574 - db - INFO - update  public.task_info set status='down' where wfid='910dd080abdad849b642768ed5882f1f'
2019-08-21 17:08:11,743 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1169.78ms
2019-08-21 17:08:20,916 - db - INFO - select * from public.task_info where wfid = '20b01914a36f94768fd26563e80d0360'
2019-08-21 17:08:20,917 - db - INFO - update  public.task_info set status='down' where wfid='20b01914a36f94768fd26563e80d0360'
2019-08-21 17:08:22,086 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1170.29ms
2019-08-21 17:08:30,904 - db - INFO - select * from public.task_info where wfid = '7ab6b2489f9a05cfcb9178d5730936e0'
2019-08-21 17:08:30,905 - db - INFO - update  public.task_info set status='down' where wfid='7ab6b2489f9a05cfcb9178d5730936e0'
2019-08-21 17:08:32,064 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1160.26ms
2019-08-21 17:08:41,021 - db - INFO - select * from public.task_info where wfid = '1b2c54947e5d3b1ec426046cc7c73453'
2019-08-21 17:08:41,022 - db - INFO - update  public.task_info set status='down' where wfid='1b2c54947e5d3b1ec426046cc7c73453'
2019-08-21 17:08:42,173 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1152.73ms
2019-08-21 17:31:11,067 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 17:31:11,131 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 17:31:11,161 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_mxxx.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_mxxx.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_mxxx.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_mxxx.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_mxxx.log', 'yibaoju_txt.TB_MXXX', 'sysdba.TB_MXXX','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_MXXX数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_MXXX\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_MXXX_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_MXXX_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_MXXX_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_MXXX_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt' into table yibaoju_txt.TB_MXXX\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_MXXX_ods select * from yibaoju_txt.TB_MXXX\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_MXXX\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_MXXX抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_mxxx.py"}}

2019-08-21 17:31:11,162 - dodox_01907302051 - INFO - Upload Success
2019-08-21 17:31:11,288 - dodox_01907302051 - INFO - AWyzhAvMBZ1xJXgBM22W
2019-08-21 17:31:12,350 - dodox_01907302051 - INFO - 5e6f9eb3ef9432b1d7c68bf3a99bbb0c
2019-08-21 17:31:12,350 - dodox_01907302051 - INFO - workflow success
2019-08-21 17:31:13,453 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 17:31:13,453 - dodox_01907302051 - INFO - workflowid:5e6f9eb3ef9432b1d7c68bf3a99bbb0c
2019-08-21 17:31:14,560 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 17:31:14,560 - db - INFO - update  public.task_info set wfid='5e6f9eb3ef9432b1d7c68bf3a99bbb0c',status='up',scriptid='AWyzhAvMBZ1xJXgBM22W' where workflowname='yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 17:31:14,562 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3548.16ms
2019-08-21 17:39:23,376 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 17:39:23,378 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 53.82ms
2019-08-21 17:39:34,281 - db - INFO - select * from public.task_info where wfid = '5e6f9eb3ef9432b1d7c68bf3a99bbb0c'
2019-08-21 17:39:34,281 - db - INFO - update  public.task_info set status='down' where wfid='5e6f9eb3ef9432b1d7c68bf3a99bbb0c'
2019-08-21 17:39:35,445 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1164.84ms
2019-08-21 17:39:38,562 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 17:39:38,625 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 17:39:38,653 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_mxxx.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_mxxx.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_mxxx.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_mxxx.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_mxxx.log', 'yibaoju_txt.TB_MXXX', 'sysdba.TB_MXXX','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_MXXX数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_MXXX\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_MXXX_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_MXXX_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_MXXX_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_MXXX_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt' into table yibaoju_txt.TB_MXXX\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_MXXX_ods select * from yibaoju_txt.TB_MXXX\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_MXXX\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_MXXX抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_mxxx.py"}}

2019-08-21 17:39:38,653 - dodox_01907302051 - INFO - Upload Success
2019-08-21 17:39:38,796 - dodox_01907302051 - INFO - AWyzi8ouBZ1xJXgBM22u
2019-08-21 17:39:39,862 - dodox_01907302051 - INFO - bb94d6d77b5b879abe7cf3737a3460da
2019-08-21 17:39:39,862 - dodox_01907302051 - INFO - workflow success
2019-08-21 17:39:40,975 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 17:39:40,976 - dodox_01907302051 - INFO - workflowid:bb94d6d77b5b879abe7cf3737a3460da
2019-08-21 17:39:42,084 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 17:39:42,084 - db - INFO - update  public.task_info set wfid='bb94d6d77b5b879abe7cf3737a3460da',status='up',scriptid='AWyzi8ouBZ1xJXgBM22u' where workflowname='yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 17:39:42,086 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3576.99ms
2019-08-21 17:40:53,241 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_yd_jy'
2019-08-21 17:40:53,308 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 17:40:53,337 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_yd_jy.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_yd_jy.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_yd_jy.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_yd_jy.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_yd_jy.log', 'yibaoju_txt.TB_YD_JY', 'sysdba.TB_YD_JY','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_YD_JY数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_YD_JY\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_YD_JY_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_YD_JY_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_YD_JY_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_YD_JY_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_YD_JY_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_YD_JY_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_YD_JY_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt' into table yibaoju_txt.TB_YD_JY\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_YD_JY_ods select * from yibaoju_txt.TB_YD_JY\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_YD_JY\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_YD_JY抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_yd_jy.py"}}

2019-08-21 17:40:53,337 - dodox_01907302051 - INFO - Upload Success
2019-08-21 17:40:53,470 - dodox_01907302051 - INFO - AWyzjO3sBZ1xJXgBM229
2019-08-21 17:40:54,530 - dodox_01907302051 - INFO - 483ece4a30cdaa9f3ae79c9df4bb7ff2
2019-08-21 17:40:54,530 - dodox_01907302051 - INFO - workflow success
2019-08-21 17:40:55,637 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 17:40:55,638 - dodox_01907302051 - INFO - workflowid:483ece4a30cdaa9f3ae79c9df4bb7ff2
2019-08-21 17:40:56,760 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_yd_jy'
2019-08-21 17:40:56,760 - db - INFO - update  public.task_info set wfid='483ece4a30cdaa9f3ae79c9df4bb7ff2',status='up',scriptid='AWyzjO3sBZ1xJXgBM229' where workflowname='yibaoju_68_15_sysdba_tb_yd_jy'
2019-08-21 17:40:56,762 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3576.04ms
2019-08-21 17:42:31,710 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_hlnr'
2019-08-21 17:42:31,782 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 17:42:31,812 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_hlnr.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_chx_hlnr.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_hlnr.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_hlnr.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_hlnr.log', 'yibaoju_txt.TB_CHX_HLNR', 'sysdba.TB_CHX_HLNR','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_CHX_HLNR数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_CHX_HLNR\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_CHX_HLNR_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_CHX_HLNR_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_CHX_HLNR_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_CHX_HLNR_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt' into table yibaoju_txt.TB_CHX_HLNR\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_CHX_HLNR_ods select * from yibaoju_txt.TB_CHX_HLNR\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_CHX_HLNR\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_CHX_HLNR抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_chx_hlnr.py"}}

2019-08-21 17:42:31,812 - dodox_01907302051 - INFO - Upload Success
2019-08-21 17:42:31,954 - dodox_01907302051 - INFO - AWyzjm6XBZ1xJXgBM23F
2019-08-21 17:42:33,016 - dodox_01907302051 - INFO - 2d762fc3d5fff46f1e39e8d711626cf4
2019-08-21 17:42:33,016 - dodox_01907302051 - INFO - workflow success
2019-08-21 17:42:34,128 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 17:42:34,128 - dodox_01907302051 - INFO - workflowid:2d762fc3d5fff46f1e39e8d711626cf4
2019-08-21 17:42:35,243 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_hlnr'
2019-08-21 17:42:35,244 - db - INFO - update  public.task_info set wfid='2d762fc3d5fff46f1e39e8d711626cf4',status='up',scriptid='AWyzjm6XBZ1xJXgBM23F' where workflowname='yibaoju_68_15_sysdba_tb_chx_hlnr'
2019-08-21 17:42:35,246 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3592.43ms
2019-08-21 19:09:43,440 - db - INFO - select * from public.task_info where wfid = '58cb4efebae1a3ccdaf06bfa97853eb0'
2019-08-21 19:09:43,443 - db - INFO - update  public.task_info set status='down' where wfid='58cb4efebae1a3ccdaf06bfa97853eb0'
2019-08-21 19:09:44,738 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1299.01ms
2019-08-21 19:10:09,259 - db - INFO - select * from public.task_info where wfid = '910dd080abdad849b642768ed5882f1f'
2019-08-21 19:10:09,260 - db - INFO - update  public.task_info set status='down' where wfid='910dd080abdad849b642768ed5882f1f'
2019-08-21 19:10:10,323 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1064.44ms
2019-08-21 19:11:06,882 - db - INFO - select * from public.task_info where wfid = '7ab6b2489f9a05cfcb9178d5730936e0'
2019-08-21 19:11:07,957 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1075.40ms
2019-08-21 19:11:31,878 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:11:31,960 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 19:11:31,996 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_dic_yd.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_dic_yd.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_dic_yd.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_dic_yd.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_dic_yd.log', 'yibaoju_txt.TB_DIC_YD', 'sysdba.TB_DIC_YD','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_DIC_YD数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_DIC_YD\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_DIC_YD_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_DIC_YD_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_DIC_YD_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_DIC_YD_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_DIC_YD_split/%s \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_DIC_YD_split/%s \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_DIC_YD_split/%s \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt' into table yibaoju_txt.TB_DIC_YD\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_DIC_YD_ods select * from yibaoju_txt.TB_DIC_YD\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_DIC_YD\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_DIC_YD抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_dic_yd.py"}}

2019-08-21 19:11:31,997 - dodox_01907302051 - INFO - Upload Success
2019-08-21 19:11:32,156 - dodox_01907302051 - INFO - AWyz3-qwBZ1xJXgBM24C
2019-08-21 19:11:33,229 - dodox_01907302051 - INFO - 72223cea9eb3d57b03c6906398124c81
2019-08-21 19:11:33,229 - dodox_01907302051 - INFO - workflow success
2019-08-21 19:11:34,357 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 19:11:34,357 - dodox_01907302051 - INFO - workflowid:72223cea9eb3d57b03c6906398124c81
2019-08-21 19:11:35,481 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:11:35,482 - db - INFO - update  public.task_info set wfid='72223cea9eb3d57b03c6906398124c81',status='up',scriptid='AWyz3-qwBZ1xJXgBM24C' where workflowname='yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:11:35,484 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3669.78ms
2019-08-21 19:13:57,262 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:13:57,263 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.65ms
2019-08-21 19:14:27,328 - db - INFO - select * from public.task_info where wfid = '910dd080abdad849b642768ed5882f1f'
2019-08-21 19:14:27,329 - db - INFO - update  public.task_info set status='down' where wfid='910dd080abdad849b642768ed5882f1f'
2019-08-21 19:14:28,378 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1049.88ms
2019-08-21 19:14:34,743 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:14:34,745 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.61ms
2019-08-21 19:16:29,038 - db - INFO - select * from public.task_info where wfid = '910dd080abdad849b642768ed5882f1f'
2019-08-21 19:16:29,039 - db - INFO - update  public.task_info set status='down' where wfid='910dd080abdad849b642768ed5882f1f'
2019-08-21 19:16:30,119 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1081.14ms
2019-08-21 19:16:34,023 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:16:34,024 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 57.81ms
2019-08-21 19:19:03,012 - db - INFO - select * from public.task_info where wfid = '910dd080abdad849b642768ed5882f1f'
2019-08-21 19:19:03,012 - db - INFO - update  public.task_info set status='down' where wfid='910dd080abdad849b642768ed5882f1f'
2019-08-21 19:19:04,068 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1057.05ms
2019-08-21 19:19:27,180 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:19:27,181 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 65.28ms
2019-08-21 19:23:04,826 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_js'
2019-08-21 19:23:05,035 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 19:23:05,070 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_js.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_chx_js.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_js.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_js.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_js.log', 'yibaoju_txt.TB_CHX_JS', 'sysdba.TB_CHX_JS','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_CHX_JS数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_CHX_JS\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_CHX_JS_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_CHX_JS_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_CHX_JS_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_CHX_JS_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_JS_split/%s \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_JS_split/%s \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_JS_split/%s \\\"http://72.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt' into table yibaoju_txt.TB_CHX_JS\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_CHX_JS_ods select * from yibaoju_txt.TB_CHX_JS\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_CHX_JS\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_CHX_JS抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_chx_js.py"}}

2019-08-21 19:23:05,070 - dodox_01907302051 - INFO - Upload Success
2019-08-21 19:23:05,209 - dodox_01907302051 - INFO - AWyz6n4BBZ1xJXgBM24q
2019-08-21 19:23:06,298 - dodox_01907302051 - INFO - 0885ae2deaeca1c2224611a0e7e402c7
2019-08-21 19:23:06,299 - dodox_01907302051 - INFO - workflow success
2019-08-21 19:23:07,399 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 19:23:07,399 - dodox_01907302051 - INFO - workflowid:0885ae2deaeca1c2224611a0e7e402c7
2019-08-21 19:23:08,510 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_js'
2019-08-21 19:23:08,511 - db - INFO - update  public.task_info set wfid='0885ae2deaeca1c2224611a0e7e402c7',status='up',scriptid='AWyz6n4BBZ1xJXgBM24q' where workflowname='yibaoju_68_15_sysdba_tb_chx_js'
2019-08-21 19:23:08,512 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3740.45ms
2019-08-21 19:23:47,835 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:23:47,836 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.67ms
2019-08-21 19:27:12,182 - db - INFO - select * from public.task_info where wfid = '0885ae2deaeca1c2224611a0e7e402c7'
2019-08-21 19:27:12,182 - db - INFO - update  public.task_info set status='down' where wfid='0885ae2deaeca1c2224611a0e7e402c7'
2019-08-21 19:27:13,368 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1186.75ms
2019-08-21 19:27:28,205 - db - INFO - select * from public.task_info where wfid = '72223cea9eb3d57b03c6906398124c81'
2019-08-21 19:27:28,206 - db - INFO - update  public.task_info set status='down' where wfid='72223cea9eb3d57b03c6906398124c81'
2019-08-21 19:27:29,365 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1161.03ms
2019-08-21 19:27:44,314 - db - INFO - select * from public.task_info where wfid = '2d762fc3d5fff46f1e39e8d711626cf4'
2019-08-21 19:27:44,315 - db - INFO - update  public.task_info set status='down' where wfid='2d762fc3d5fff46f1e39e8d711626cf4'
2019-08-21 19:27:45,496 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1182.78ms
2019-08-21 19:27:58,263 - db - INFO - select * from public.task_info where wfid = '483ece4a30cdaa9f3ae79c9df4bb7ff2'
2019-08-21 19:27:58,264 - db - INFO - update  public.task_info set status='down' where wfid='483ece4a30cdaa9f3ae79c9df4bb7ff2'
2019-08-21 19:27:59,429 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1166.06ms
2019-08-21 19:28:09,342 - db - INFO - select * from public.task_info where wfid = 'bb94d6d77b5b879abe7cf3737a3460da'
2019-08-21 19:28:09,342 - db - INFO - update  public.task_info set status='down' where wfid='bb94d6d77b5b879abe7cf3737a3460da'
2019-08-21 19:28:10,518 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1176.71ms
2019-08-21 19:29:20,281 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:29:20,364 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 19:29:20,408 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_dic_yd.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_dic_yd.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_dic_yd.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_dic_yd.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_dic_yd.log', 'yibaoju_txt.TB_DIC_YD', 'sysdba.TB_DIC_YD','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_DIC_YD数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_DIC_YD\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_DIC_YD_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_DIC_YD_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_DIC_YD_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_DIC_YD_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_DIC_YD_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_DIC_YD_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_DIC_YD_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_DIC_YD.txt' into table yibaoju_txt.TB_DIC_YD\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_DIC_YD_ods select * from yibaoju_txt.TB_DIC_YD\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_DIC_YD\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_DIC_YD抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_dic_yd.py"}}

2019-08-21 19:29:20,408 - dodox_01907302051 - INFO - Upload Success
2019-08-21 19:29:20,571 - dodox_01907302051 - INFO - AWyz8DgsBZ1xJXgBM25A
2019-08-21 19:29:21,638 - dodox_01907302051 - INFO - 2c247501b4b271a44d17e1245b678de9
2019-08-21 19:29:21,638 - dodox_01907302051 - INFO - workflow success
2019-08-21 19:29:22,750 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 19:29:22,750 - dodox_01907302051 - INFO - workflowid:2c247501b4b271a44d17e1245b678de9
2019-08-21 19:29:23,869 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:29:23,869 - db - INFO - update  public.task_info set wfid='2c247501b4b271a44d17e1245b678de9',status='up',scriptid='AWyz8DgsBZ1xJXgBM25A' where workflowname='yibaoju_68_15_sysdba_tb_dic_yd'
2019-08-21 19:29:23,871 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3642.51ms
2019-08-21 19:29:36,003 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_js'
2019-08-21 19:29:36,072 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 19:29:36,102 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_js.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_chx_js.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_js.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_js.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_js.log', 'yibaoju_txt.TB_CHX_JS', 'sysdba.TB_CHX_JS','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_CHX_JS数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_CHX_JS\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_CHX_JS_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_CHX_JS_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_CHX_JS_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_CHX_JS_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_JS_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_JS_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_JS_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_CHX_JS.txt' into table yibaoju_txt.TB_CHX_JS\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_CHX_JS_ods select * from yibaoju_txt.TB_CHX_JS\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_CHX_JS\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_CHX_JS抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_chx_js.py"}}

2019-08-21 19:29:36,103 - dodox_01907302051 - INFO - Upload Success
2019-08-21 19:29:36,249 - dodox_01907302051 - INFO - AWyz8HV7BZ1xJXgBM25J
2019-08-21 19:29:37,323 - dodox_01907302051 - INFO - 020282c31c0a08bb84e859148c1daff7
2019-08-21 19:29:37,323 - dodox_01907302051 - INFO - workflow success
2019-08-21 19:29:38,432 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 19:29:38,432 - dodox_01907302051 - INFO - workflowid:020282c31c0a08bb84e859148c1daff7
2019-08-21 19:29:39,537 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_js'
2019-08-21 19:29:39,538 - db - INFO - update  public.task_info set wfid='020282c31c0a08bb84e859148c1daff7',status='up',scriptid='AWyz8HV7BZ1xJXgBM25J' where workflowname='yibaoju_68_15_sysdba_tb_chx_js'
2019-08-21 19:29:39,540 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3591.89ms
2019-08-21 19:29:51,735 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_hlnr'
2019-08-21 19:29:51,812 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 19:29:51,850 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_hlnr.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_chx_hlnr.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_chx_hlnr.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_hlnr.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_chx_hlnr.log', 'yibaoju_txt.TB_CHX_HLNR', 'sysdba.TB_CHX_HLNR','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_CHX_HLNR数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_CHX_HLNR\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_CHX_HLNR_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_CHX_HLNR_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_CHX_HLNR_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_CHX_HLNR_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_CHX_HLNR_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_CHX_HLNR.txt' into table yibaoju_txt.TB_CHX_HLNR\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_CHX_HLNR_ods select * from yibaoju_txt.TB_CHX_HLNR\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_CHX_HLNR\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_CHX_HLNR抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_chx_hlnr.py"}}

2019-08-21 19:29:51,850 - dodox_01907302051 - INFO - Upload Success
2019-08-21 19:29:52,011 - dodox_01907302051 - INFO - AWyz8LL-BZ1xJXgBM25R
2019-08-21 19:29:53,073 - dodox_01907302051 - INFO - 23f8ffd940c58ca5649f0ee3a4a5e9cb
2019-08-21 19:29:53,073 - dodox_01907302051 - INFO - workflow success
2019-08-21 19:29:54,199 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 19:29:54,199 - dodox_01907302051 - INFO - workflowid:23f8ffd940c58ca5649f0ee3a4a5e9cb
2019-08-21 19:29:55,304 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_chx_hlnr'
2019-08-21 19:29:55,305 - db - INFO - update  public.task_info set wfid='23f8ffd940c58ca5649f0ee3a4a5e9cb',status='up',scriptid='AWyz8LL-BZ1xJXgBM25R' where workflowname='yibaoju_68_15_sysdba_tb_chx_hlnr'
2019-08-21 19:29:55,307 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3627.30ms
2019-08-21 19:30:10,129 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 19:30:10,193 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 19:30:10,226 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_mxxx.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_mxxx.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_mxxx.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_mxxx.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_mxxx.log', 'yibaoju_txt.TB_MXXX', 'sysdba.TB_MXXX','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_MXXX数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_MXXX\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_MXXX_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_MXXX_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_MXXX_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_MXXX_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_MXXX_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_MXXX.txt' into table yibaoju_txt.TB_MXXX\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_MXXX_ods select * from yibaoju_txt.TB_MXXX\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_MXXX\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_MXXX抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_mxxx.py"}}

2019-08-21 19:30:10,226 - dodox_01907302051 - INFO - Upload Success
2019-08-21 19:30:10,392 - dodox_01907302051 - INFO - AWyz8PrOBZ1xJXgBM25Y
2019-08-21 19:30:11,463 - dodox_01907302051 - INFO - d0357c42cce9de32b8089eccc9ef0004
2019-08-21 19:30:11,463 - dodox_01907302051 - INFO - workflow success
2019-08-21 19:30:12,565 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 19:30:12,565 - dodox_01907302051 - INFO - workflowid:d0357c42cce9de32b8089eccc9ef0004
2019-08-21 19:30:13,683 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 19:30:13,683 - db - INFO - update  public.task_info set wfid='d0357c42cce9de32b8089eccc9ef0004',status='up',scriptid='AWyz8PrOBZ1xJXgBM25Y' where workflowname='yibaoju_68_15_sysdba_tb_mxxx'
2019-08-21 19:30:13,685 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3610.77ms
2019-08-21 19:30:54,381 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_yd_jy'
2019-08-21 19:30:54,444 - dodox_01907302051 - INFO - Successful folder creation
2019-08-21 19:30:54,481 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_yd_jy.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_tb_yd_jy.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_tb_yd_jy.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_yd_jy.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_tb_yd_jy.log', 'yibaoju_txt.TB_YD_JY', 'sysdba.TB_YD_JY','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.TB_YD_JY数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_TB_YD_JY\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_TB_YD_JY_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_TB_YD_JY_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_TB_YD_JY_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_TB_YD_JY_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_TB_YD_JY_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_YD_JY_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_TB_YD_JY_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_TB_YD_JY.txt' into table yibaoju_txt.TB_YD_JY\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.TB_YD_JY_ods select * from yibaoju_txt.TB_YD_JY\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.TB_YD_JY\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.TB_YD_JY抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_tb_yd_jy.py"}}

2019-08-21 19:30:54,482 - dodox_01907302051 - INFO - Upload Success
2019-08-21 19:30:54,627 - dodox_01907302051 - INFO - AWyz8aelBZ1xJXgBM25g
2019-08-21 19:30:55,712 - dodox_01907302051 - INFO - c342bfc8014959920dd18e4ae7b3c963
2019-08-21 19:30:55,713 - dodox_01907302051 - INFO - workflow success
2019-08-21 19:30:56,818 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-21 19:30:56,819 - dodox_01907302051 - INFO - workflowid:c342bfc8014959920dd18e4ae7b3c963
2019-08-21 19:30:57,925 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_tb_yd_jy'
2019-08-21 19:30:57,925 - db - INFO - update  public.task_info set wfid='c342bfc8014959920dd18e4ae7b3c963',status='up',scriptid='AWyz8aelBZ1xJXgBM25g' where workflowname='yibaoju_68_15_sysdba_tb_yd_jy'
2019-08-21 19:30:57,927 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3599.91ms
2019-08-22 16:29:59,203 - tornado.access - WARNING - 405 GET /dana/workflow/delete (172.26.16.93) 0.58ms
2019-08-22 20:38:46,493 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:38:46,525 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:38:46,554 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:38:46,582 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:40:46,863 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:40:46,971 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 20:40:47,030 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log', 'shenjiju_txt.packet_in_exchange1', 'testone.packet_in_exchange3','public.job_run_info')\r\n\t\tpri.ok(\"表testone.packet_in_exchange3数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/shenjiju_orc;guardianToken=8OaTwGAflRSKjKEex8gw-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/testone_packet_in_exchange3\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/testone_packet_in_exchange3_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/testone_packet_in_exchange3_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_testone_packet_in_exchange3.txt' into table shenjiju_txt.packet_in_exchange1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into shenjiju_orc.packet_in_exchange1 select * from shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表testone.packet_in_exchange3抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_testone_packet_in_exchange3.py"}}

2019-08-22 20:40:47,031 - dodox_01907302051 - INFO - Upload Success
2019-08-22 20:40:47,202 - dodox_01907302051 - INFO - AWy5V_zUBZ1xJXgBM294
2019-08-22 20:40:48,294 - dodox_01907302051 - INFO - 64525db15767edf5d1cf79d49e93f030
2019-08-22 20:40:48,295 - dodox_01907302051 - INFO - workflow success
2019-08-22 20:40:49,429 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 20:40:49,430 - dodox_01907302051 - INFO - workflowid:64525db15767edf5d1cf79d49e93f030
2019-08-22 20:40:50,566 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:40:50,567 - db - INFO - update  public.task_info set wfid='64525db15767edf5d1cf79d49e93f030',status='up',scriptid='AWy5V_zUBZ1xJXgBM294' where workflowname='gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:40:50,569 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3761.21ms
2019-08-22 20:41:20,142 - db - INFO - select * from public.task_info where wfid = '64525db15767edf5d1cf79d49e93f030'
2019-08-22 20:41:20,142 - db - INFO - update  public.task_info set status='down' where wfid='64525db15767edf5d1cf79d49e93f030'
2019-08-22 20:41:21,330 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1189.37ms
2019-08-22 20:49:59,115 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:49:59,145 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:49:59,173 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:49:59,203 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:54:31,793 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:54:31,882 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 20:54:31,929 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log', 'shenjiju_txt.packet_in_exchange1', 'testone.packet_in_exchange3','public.job_run_info')\r\n\t\tpri.ok(\"表testone.packet_in_exchange3数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/testone_packet_in_exchange3\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/testone_packet_in_exchange3_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/testone_packet_in_exchange3_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_testone_packet_in_exchange3.txt' into table shenjiju_txt.packet_in_exchange1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into shenjiju_orc.packet_in_exchange1 select * from shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表testone.packet_in_exchange3抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_testone_packet_in_exchange3.py"}}

2019-08-22 20:54:31,929 - dodox_01907302051 - INFO - Upload Success
2019-08-22 20:54:32,120 - dodox_01907302051 - INFO - AWy5ZJMTBZ1xJXgBM2-I
2019-08-22 20:54:33,205 - dodox_01907302051 - INFO - af5a19ffb484bbc3f219bba50df20006
2019-08-22 20:54:33,205 - dodox_01907302051 - INFO - workflow success
2019-08-22 20:54:34,330 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 20:54:34,330 - dodox_01907302051 - INFO - workflowid:af5a19ffb484bbc3f219bba50df20006
2019-08-22 20:54:35,484 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:54:35,484 - db - INFO - update  public.task_info set wfid='af5a19ffb484bbc3f219bba50df20006',status='up',scriptid='AWy5ZJMTBZ1xJXgBM2-I' where workflowname='gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:54:35,486 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3750.19ms
2019-08-22 20:54:52,715 - db - INFO - select * from public.task_info where wfid = 'af5a19ffb484bbc3f219bba50df20006'
2019-08-22 20:54:52,716 - db - INFO - update  public.task_info set status='down' where wfid='af5a19ffb484bbc3f219bba50df20006'
2019-08-22 20:54:53,880 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1165.03ms
2019-08-22 20:55:57,134 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:55:57,196 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 20:55:57,241 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log', 'shenjiju_txt.packet_in_exchange1', 'testone.packet_in_exchange3','public.job_run_info')\r\n\t\tpri.ok(\"表testone.packet_in_exchange3数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/testone_packet_in_exchange3\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/testone_packet_in_exchange3_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/testone_packet_in_exchange3_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_testone_packet_in_exchange3.txt' into table shenjiju_txt.packet_in_exchange1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc.VOM_CORP_INFO select * from shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表testone.packet_in_exchange3抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_testone_packet_in_exchange3.py"}}

2019-08-22 20:55:57,241 - dodox_01907302051 - INFO - Upload Success
2019-08-22 20:55:57,403 - dodox_01907302051 - INFO - AWy5ZeBSBZ1xJXgBM2-R
2019-08-22 20:55:58,479 - dodox_01907302051 - INFO - cbb562538d65c4475ab00847df70f7ae
2019-08-22 20:55:58,479 - dodox_01907302051 - INFO - workflow success
2019-08-22 20:55:59,583 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 20:55:59,583 - dodox_01907302051 - INFO - workflowid:cbb562538d65c4475ab00847df70f7ae
2019-08-22 20:56:00,699 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:56:00,700 - db - INFO - update  public.task_info set wfid='cbb562538d65c4475ab00847df70f7ae',status='up',scriptid='AWy5ZeBSBZ1xJXgBM2-R' where workflowname='gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:56:00,701 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3620.44ms
2019-08-22 20:56:31,234 - db - INFO - select * from public.task_info where wfid = 'cbb562538d65c4475ab00847df70f7ae'
2019-08-22 20:56:31,235 - db - INFO - update  public.task_info set status='down' where wfid='cbb562538d65c4475ab00847df70f7ae'
2019-08-22 20:56:32,389 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1156.09ms
2019-08-22 20:57:38,479 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:57:38,548 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 20:57:38,578 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log', 'shenjiju_txt.packet_in_exchange1', 'testone.packet_in_exchange3','public.job_run_info')\r\n\t\tpri.ok(\"表testone.packet_in_exchange3数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/testone_packet_in_exchange3\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/testone_packet_in_exchange3_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/testone_packet_in_exchange3_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_testone_packet_in_exchange3.txt' into table shenjiju_txt.packet_in_exchange1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc.VOM_CORP_INFO select * from shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表testone.packet_in_exchange3抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_testone_packet_in_exchange3.py"}}

2019-08-22 20:57:38,579 - dodox_01907302051 - INFO - Upload Success
2019-08-22 20:57:38,717 - dodox_01907302051 - INFO - AWy5Z2wnBZ1xJXgBM2-a
2019-08-22 20:57:39,795 - dodox_01907302051 - INFO - 57981461a5970a6655ed155e3040bdd0
2019-08-22 20:57:39,795 - dodox_01907302051 - INFO - workflow success
2019-08-22 20:57:40,920 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 20:57:40,921 - dodox_01907302051 - INFO - workflowid:57981461a5970a6655ed155e3040bdd0
2019-08-22 20:57:42,088 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:57:42,089 - db - INFO - update  public.task_info set wfid='57981461a5970a6655ed155e3040bdd0',status='up',scriptid='AWy5Z2wnBZ1xJXgBM2-a' where workflowname='gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:57:42,090 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3664.60ms
2019-08-22 20:57:49,517 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-22 20:57:49,519 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 55.53ms
2019-08-22 20:57:59,158 - db - INFO - select * from public.task_info where wfid = '57981461a5970a6655ed155e3040bdd0'
2019-08-22 20:57:59,158 - db - INFO - update  public.task_info set status='down' where wfid='57981461a5970a6655ed155e3040bdd0'
2019-08-22 20:58:00,333 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1176.23ms
2019-08-22 20:58:46,194 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 20:58:46,276 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 20:58:46,303 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log', 'gonganju_txt.VOM_CORP_INFO', 'dsjzx.vom_corp_info','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_vom_corp_info\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_vom_corp_info_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_vom_corp_info_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt' into table gonganju_txt.VOM_CORP_INFO\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc.VOM_CORP_INFO select * from gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_vom_corp_info.py"}}

2019-08-22 20:58:46,304 - dodox_01907302051 - INFO - Upload Success
2019-08-22 20:58:46,443 - dodox_01907302051 - INFO - AWy5aHSqBZ1xJXgBM2-j
2019-08-22 20:58:47,540 - dodox_01907302051 - INFO - 14cfe3d40000e9c99dfb59a9f3fab1ef
2019-08-22 20:58:47,540 - dodox_01907302051 - INFO - workflow success
2019-08-22 20:58:48,665 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 20:58:48,665 - dodox_01907302051 - INFO - workflowid:14cfe3d40000e9c99dfb59a9f3fab1ef
2019-08-22 20:58:49,785 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 20:58:49,785 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('14cfe3d40000e9c99dfb59a9f3fab1ef','up','AWy5aHSqBZ1xJXgBM2-j','gonganju_8_103_dsjzx_vom_corp_info')
2019-08-22 20:58:49,787 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3645.93ms
2019-08-22 20:59:00,455 - db - INFO - select * from public.task_info where wfid = '14cfe3d40000e9c99dfb59a9f3fab1ef'
2019-08-22 20:59:00,456 - db - INFO - update  public.task_info set status='down' where wfid='14cfe3d40000e9c99dfb59a9f3fab1ef'
2019-08-22 20:59:01,633 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1178.02ms
2019-08-22 20:59:24,874 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:59:24,903 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:59:24,931 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 20:59:24,961 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 93, in post
    datax_all_file(UnitId,WorkflowName)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 244, in datax_all_file
    pri.error("the parameter ColumnType is not exists or type error!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 44, in error
    sys.exit(2)
SystemExit: 2
2019-08-22 21:02:19,099 - db - INFO - select * from public.task_info where wfid = '14cfe3d40000e9c99dfb59a9f3fab1ef'
2019-08-22 21:02:19,100 - db - INFO - update  public.task_info set status='down' where wfid='14cfe3d40000e9c99dfb59a9f3fab1ef'
2019-08-22 21:02:20,152 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1053.49ms
2019-08-22 21:02:20,265 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:02:20,333 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 21:02:20,363 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log', 'gonganju_txt.VOM_CORP_INFO', 'dsjzx.vom_corp_info','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_vom_corp_info\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_vom_corp_info_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_vom_corp_info_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt' into table gonganju_txt.VOM_CORP_INFO\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc.VOM_CORP_INFO select * from gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_vom_corp_info.py"}}

2019-08-22 21:02:20,364 - dodox_01907302051 - INFO - Upload Success
2019-08-22 21:02:20,515 - dodox_01907302051 - INFO - AWy5a7jkBZ1xJXgBM2-1
2019-08-22 21:02:21,592 - dodox_01907302051 - INFO - 9f655e28fb18629bc15ed6ab62e6c3e2
2019-08-22 21:02:21,592 - dodox_01907302051 - INFO - workflow success
2019-08-22 21:02:22,696 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 21:02:22,696 - dodox_01907302051 - INFO - workflowid:9f655e28fb18629bc15ed6ab62e6c3e2
2019-08-22 21:02:23,822 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:02:23,823 - db - INFO - update  public.task_info set wfid='9f655e28fb18629bc15ed6ab62e6c3e2',status='up',scriptid='AWy5a7jkBZ1xJXgBM2-1' where workflowname='gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:02:23,824 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3615.71ms
2019-08-22 21:02:41,224 - db - INFO - select * from public.task_info where wfid = '9f655e28fb18629bc15ed6ab62e6c3e2'
2019-08-22 21:02:41,225 - db - INFO - update  public.task_info set status='down' where wfid='9f655e28fb18629bc15ed6ab62e6c3e2'
2019-08-22 21:02:42,400 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1176.81ms
2019-08-22 21:04:32,969 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:04:33,036 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 21:04:33,068 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log', 'gonganju_txt.VOM_CORP_INFO', 'dsjzx.vom_corp_info','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_vom_corp_info\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_vom_corp_info_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_vom_corp_info_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt' into table gonganju_txt.VOM_CORP_INFO\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc.VOM_CORP_INFO select * from gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_vom_corp_info.py"}}

2019-08-22 21:04:33,068 - dodox_01907302051 - INFO - Upload Success
2019-08-22 21:04:33,223 - dodox_01907302051 - INFO - AWy5bb8-BZ1xJXgBM2_G
2019-08-22 21:04:34,307 - dodox_01907302051 - INFO - eb7ec046fcc6fff3de82bf4e377b9928
2019-08-22 21:04:34,307 - dodox_01907302051 - INFO - workflow success
2019-08-22 21:04:35,419 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 21:04:35,419 - dodox_01907302051 - INFO - workflowid:eb7ec046fcc6fff3de82bf4e377b9928
2019-08-22 21:04:36,528 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:04:36,528 - db - INFO - update  public.task_info set wfid='eb7ec046fcc6fff3de82bf4e377b9928',status='up',scriptid='AWy5bb8-BZ1xJXgBM2_G' where workflowname='gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:04:36,530 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3614.08ms
2019-08-22 21:05:06,489 - db - INFO - select * from public.task_info where wfid = 'eb7ec046fcc6fff3de82bf4e377b9928'
2019-08-22 21:05:06,490 - db - INFO - update  public.task_info set status='down' where wfid='eb7ec046fcc6fff3de82bf4e377b9928'
2019-08-22 21:05:07,656 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1167.63ms
2019-08-22 21:07:32,136 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:07:32,223 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 21:07:32,256 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log', 'gonganju_txt.VOM_CORP_INFO', 'dsjzx.vom_corp_info','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_vom_corp_info\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_vom_corp_info_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_vom_corp_info_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt' into table gonganju_txt.VOM_CORP_INFO\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc.VOM_CORP_INFO select * from gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_vom_corp_info.py"}}

2019-08-22 21:07:32,256 - dodox_01907302051 - INFO - Upload Success
2019-08-22 21:07:32,412 - dodox_01907302051 - INFO - AWy5cHs1BZ1xJXgBM2_T
2019-08-22 21:07:33,472 - dodox_01907302051 - INFO - 74990d65e4afb6a6a8d86b6dae870a51
2019-08-22 21:07:33,472 - dodox_01907302051 - INFO - workflow success
2019-08-22 21:07:34,592 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 21:07:34,592 - dodox_01907302051 - INFO - workflowid:74990d65e4afb6a6a8d86b6dae870a51
2019-08-22 21:07:35,716 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:07:35,717 - db - INFO - update  public.task_info set wfid='74990d65e4afb6a6a8d86b6dae870a51',status='up',scriptid='AWy5cHs1BZ1xJXgBM2_T' where workflowname='gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:07:35,719 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3634.97ms
2019-08-22 21:08:19,046 - db - INFO - select * from public.task_info where wfid = '74990d65e4afb6a6a8d86b6dae870a51'
2019-08-22 21:08:19,047 - db - INFO - update  public.task_info set status='down' where wfid='74990d65e4afb6a6a8d86b6dae870a51'
2019-08-22 21:08:20,200 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1153.77ms
2019-08-22 21:09:04,013 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:09:04,079 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 21:09:04,109 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log', 'gonganju_txt.VOM_CORP_INFO', 'dsjzx.vom_corp_info','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_vom_corp_info\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_vom_corp_info_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_vom_corp_info_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt' into table gonganju_txt.VOM_CORP_INFO\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc.VOM_CORP_INFO select * from gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_vom_corp_info.py"}}

2019-08-22 21:09:04,109 - dodox_01907302051 - INFO - Upload Success
2019-08-22 21:09:04,296 - dodox_01907302051 - INFO - AWy5ceH-BZ1xJXgBM2_c
2019-08-22 21:09:05,364 - dodox_01907302051 - INFO - 1fff58303a923f2b8ed4035e371f1bd7
2019-08-22 21:09:05,364 - dodox_01907302051 - INFO - workflow success
2019-08-22 21:09:06,473 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 21:09:06,474 - dodox_01907302051 - INFO - workflowid:1fff58303a923f2b8ed4035e371f1bd7
2019-08-22 21:09:07,605 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:09:07,605 - db - INFO - update  public.task_info set wfid='1fff58303a923f2b8ed4035e371f1bd7',status='up',scriptid='AWy5ceH-BZ1xJXgBM2_c' where workflowname='gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:09:07,607 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3647.84ms
2019-08-22 21:09:54,566 - db - INFO - select * from public.task_info where wfid = '1fff58303a923f2b8ed4035e371f1bd7'
2019-08-22 21:09:54,567 - db - INFO - update  public.task_info set status='down' where wfid='1fff58303a923f2b8ed4035e371f1bd7'
2019-08-22 21:09:55,760 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1194.47ms
2019-08-22 21:09:59,763 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:09:59,831 - dodox_01907302051 - INFO - Successful folder creation
2019-08-22 21:09:59,862 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_vom_corp_info.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_vom_corp_info.log', 'gonganju_txt.VOM_CORP_INFO', 'dsjzx.vom_corp_info','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_vom_corp_info\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_vom_corp_info_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_vom_corp_info_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_vom_corp_info_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_vom_corp_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_vom_corp_info.txt' into table gonganju_txt.VOM_CORP_INFO\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc.VOM_CORP_INFO select * from gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt.VOM_CORP_INFO\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.vom_corp_info抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_vom_corp_info.py"}}

2019-08-22 21:09:59,862 - dodox_01907302051 - INFO - Upload Success
2019-08-22 21:10:00,011 - dodox_01907302051 - INFO - AWy5crvPBZ1xJXgBM2_o
2019-08-22 21:10:01,095 - dodox_01907302051 - INFO - 42ebc1e2f278c1a55193f903b1d7ba20
2019-08-22 21:10:01,095 - dodox_01907302051 - INFO - workflow success
2019-08-22 21:10:02,237 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-22 21:10:02,238 - dodox_01907302051 - INFO - workflowid:42ebc1e2f278c1a55193f903b1d7ba20
2019-08-22 21:10:03,344 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:10:03,344 - db - INFO - update  public.task_info set wfid='42ebc1e2f278c1a55193f903b1d7ba20',status='up',scriptid='AWy5crvPBZ1xJXgBM2_o' where workflowname='gonganju_8_103_dsjzx_vom_corp_info'
2019-08-22 21:10:03,346 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3639.84ms
2019-08-22 21:10:37,983 - __main__ - INFO - {"code":200,"result":{"recordid":"160b864f47c4bc29300dd8b11b7cc3d0"}}

2019-08-22 21:10:37,983 - tornado.access - INFO - 200 POST /dana/workflow/start (172.26.16.7) 100.23ms
2019-08-23 15:42:45,339 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_linshi_zqx_0819'
2019-08-23 15:42:45,453 - dodox_01907302051 - INFO - Successful folder creation
2019-08-23 15:42:45,545 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_linshi_zqx_0819.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_linshi_zqx_0819.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_linshi_zqx_0819.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_linshi_zqx_0819.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_linshi_zqx_0819.log', 'gonganjuorc_txt.LINSHI_ZQX_0819', 'dsjzx.linshi_zqx_0819','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.linshi_zqx_0819数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_orc_ods;guardianToken=qb9MhtQSEBsIiASwlHEw-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://72.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_linshi_zqx_0819\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_linshi_zqx_0819_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_linshi_zqx_0819_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_linshi_zqx_0819_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_linshi_zqx_0819_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://72.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_linshi_zqx_0819.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_linshi_zqx_0819_split/%s \\\"http://72.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_linshi_zqx_0819.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_linshi_zqx_0819_split/%s \\\"http://72.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_linshi_zqx_0819.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_linshi_zqx_0819_split/%s \\\"http://72.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_linshi_zqx_0819.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_linshi_zqx_0819.txt' into table gonganjuorc_txt.LINSHI_ZQX_0819\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.LINSHI_ZQX_0819 select * from gonganjuorc_txt.LINSHI_ZQX_0819\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganjuorc_txt.LINSHI_ZQX_0819\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.linshi_zqx_0819抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_linshi_zqx_0819.py"}}

2019-08-23 15:42:45,545 - dodox_01907302051 - INFO - Upload Success
2019-08-23 15:42:45,772 - dodox_01907302051 - INFO - AWy9bX8yBZ1xJXgBM3C9
2019-08-23 15:42:46,891 - dodox_01907302051 - INFO - eda12b16168fd99a4f5562b5b1f01f09
2019-08-23 15:42:46,891 - dodox_01907302051 - INFO - workflow success
2019-08-23 15:42:48,063 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-23 15:42:48,063 - dodox_01907302051 - INFO - workflowid:eda12b16168fd99a4f5562b5b1f01f09
2019-08-23 15:42:49,241 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_linshi_zqx_0819'
2019-08-23 15:42:49,241 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('eda12b16168fd99a4f5562b5b1f01f09','up','AWy9bX8yBZ1xJXgBM3C9','gonganju_8_103_dsjzx_linshi_zqx_0819')
2019-08-23 15:42:49,243 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3971.24ms
2019-08-23 15:43:30,368 - __main__ - INFO - {"code":200,"result":{"recordid":"ebaf01285d5047a8a5cf53158f71cb84"}}

2019-08-23 15:43:30,369 - tornado.access - INFO - 200 POST /dana/workflow/start (172.26.16.7) 78.40ms
2019-08-27 09:44:37,629 - db - INFO - The database has been successfully connected
2019-08-27 09:44:37,635 - db - INFO - select token from public.token_info
2019-08-27 09:44:37,673 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1Njc0NzUwNzcsImlhdCI6MTU2Njg3MDI3NywiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.arjmsY-9I97qm8P3qV-f1r74XG__B2oWOXFcA9c-x1z4N5LU1zDXNlAe05gYV9OyTIPyBrxV-iu-Pxasw6xudfqqRi4o5aKrYVpyV-Axt7BEK7Pt6ZR0rsQm5Z4xsG0Zb0egEyxDVlS9-V0vFJbO2SxEJUQU_ZYFemb-Pmiz-Um3yqD5rXw0A5ieaLkEWcEwQ5Co97Mz37mW6LPSANVGskGm7A5_HxSeLi7jEfqst2ZkiyCD7MyF_95n0Sx25hvPY7aIRN1sG3ukN_gthY3qEEaQNUTf-_UqlLmT2hAof_kY5clPvfnZPR-TvP9hSSfaFYEO3dTCp9UuCK30H1cA_lABUY8NOmLN2g-ds8pkzyrNlRVDm839-0HuKhFfKebBfA767Dknmab9tnGw7XqpZdJmyT6ZSZUjC5YD7HTLpKHkntKqxFjXFiRZQ09uNWt6bIB56wkctN5fsZpzSDcQswBo7h1CPLT_ea50MxNJ-RWlIxihXZbebxXbX0Hdu36xTfb8xi3VLdXpDMBHj0MnnglmbGSBqcfd7a82xeeGZyiGchvvA12dUHx_r1u1FmiQt-sqOM-GfN4k_jo4bjT6egDH3ZVPl4ow1S5r7UDC8yEo6MkNEn9gTzo_Qk7xvziX6QTIGtGLW88E109pWnhjf1cUcHCFwmXb8azDkVw6drc' where 1='1'
2019-08-27 18:02:13,003 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 18:02:13,018 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 104.08ms
2019-08-27 18:02:34,891 - db - INFO - select * from public.task_info where wfid = 'c55d4f1174a4c906d7b3e65b1181614f'
2019-08-27 18:02:34,892 - db - INFO - update  public.task_info set status='down' where wfid='c55d4f1174a4c906d7b3e65b1181614f'
2019-08-27 18:02:36,148 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1257.42ms
2019-08-27 18:02:42,670 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 18:02:42,737 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 18:02:42,834 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log', 'gonganju_txt_ods.base_jjlhy_drivinglicense_df', 'dsjzx.base_jjlhy_drivinglicense_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drivinglicense_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_drivinglicense_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt' into table gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_check_action (dabh,sfzmhm,zjcx,yzjcx,qfrq,qfrq_dt,syrq,syrq_dt,cclzrq,cclzrq_dt,ccfzjg,jzqx,yxqs,yxqz,ljjf,cfrq,cfrq_dt,xxtzrq,xxtzrq_dt,bzcs,zt,ly,jxmc,jly,xzqh,xzqj,fzrq,jbr,glbm,fzjg,gxsj,gxsj_dt,lsh,xgzl,bz,jyw,ydabh,sqdm,zxbh,xh,sfzmmc,hmcd,xm,xb,csrq,csrq_dt,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,zzfzrq_dt,sfbd,dwbh,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,xzqhmc,xbmc,dt,jhpt_update_time,jhpt_delete) select dabh,sfzmhm,zjcx,yzjcx,qfrq,qfrq_dt,syrq,syrq_dt,cclzrq,cclzrq_dt,ccfzjg,jzqx,yxqs,yxqz,ljjf,cfrq,cfrq_dt,xxtzrq,xxtzrq_dt,bzcs,zt,ly,jxmc,jly,xzqh,xzqj,fzrq,jbr,glbm,fzjg,gxsj,gxsj_dt,lsh,xgzl,bz,jyw,ydabh,sqdm,zxbh,xh,sfzmmc,hmcd,xm,xb,csrq,csrq_dt,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,zzfzrq_dt,sfbd,dwbh,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,xzqhmc,xbmc,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drivinglicense_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.py"}}

2019-08-27 18:02:42,835 - dodox_01907302051 - INFO - Upload Success
2019-08-27 18:02:43,045 - dodox_01907302051 - INFO - AWzShxEnBZ1xJXgBM3Xp
2019-08-27 18:02:44,133 - dodox_01907302051 - INFO - 13ec2f681b9355724d39869935c166c0
2019-08-27 18:02:44,133 - dodox_01907302051 - INFO - workflow success
2019-08-27 18:02:45,313 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 18:02:45,313 - dodox_01907302051 - INFO - workflowid:13ec2f681b9355724d39869935c166c0
2019-08-27 18:02:46,505 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 18:02:46,506 - db - INFO - update  public.task_info set wfid='13ec2f681b9355724d39869935c166c0',status='up',scriptid='AWzShxEnBZ1xJXgBM3Xp' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 18:02:46,507 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3893.57ms
2019-08-27 19:35:04,572 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_check_action'
2019-08-27 19:35:04,573 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.15ms
2019-08-27 19:35:39,469 - db - INFO - select * from public.task_info where wfid = 'e24700b59d7d630bc15cd4a3c3d51b52'
2019-08-27 19:35:39,470 - db - INFO - update  public.task_info set status='down' where wfid='e24700b59d7d630bc15cd4a3c3d51b52'
2019-08-27 19:35:40,603 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1134.44ms
2019-08-27 19:35:44,597 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_check_action'
2019-08-27 19:35:44,702 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 19:35:44,765 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_check_action.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_jgxw_check_action.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_check_action.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_check_action.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_check_action.log', 'gonganju_txt_ods.jg_jgxw_check_action', 'dsjzx.jg_jgxw_check_action','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_check_action数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_jgxw_check_action\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_jgxw_check_action_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_jgxw_check_action_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_jgxw_check_action_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_jgxw_check_action_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_check_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_check_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_check_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_jgxw_check_action.txt' into table gonganju_txt_ods.jg_jgxw_check_action\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_check_action (cd_id,Record_Unique_Identity,Supervise_Item_Implement_Code,Supervise_Item_Check_ICode,Check_Action_Name,Check_Action_Code,Implement_Institution,Implement_Institution_Code,Entrust_Dept,Entrust_Dept_Code,Supervise_Object,Administrative_Cp,Administrative_Cp_Na,Administrative_Cp_Ce_Type,Administrative_Cp_UI_Code,Address_Registered,Address_Operating,Area_Number,Check_Form,Check_Type,Check_Mode,Check_Result,Check_Date,Check_Personnel,Check_Personnel_Code,Submitted_Date,Submitted_Personnel,cd_time,cd_source,cd_batch,cd_operation) select cd_id,Record_Unique_Identity,Supervise_Item_Implement_Code,Supervise_Item_Check_ICode,Check_Action_Name,Check_Action_Code,Implement_Institution,Implement_Institution_Code,Entrust_Dept,Entrust_Dept_Code,Supervise_Object,Administrative_Cp,Administrative_Cp_Na,Administrative_Cp_Ce_Type,Administrative_Cp_UI_Code,Address_Registered,Address_Operating,Area_Number,Check_Form,Check_Type,Check_Mode,Check_Result,Check_Date,Check_Personnel,Check_Personnel_Code,Submitted_Date,Submitted_Personnel,cd_time,cd_source,cd_batch,cd_operation  from gonganju_txt_ods.jg_jgxw_check_action\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_jgxw_check_action\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_check_action抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_jgxw_check_action.py"}}

2019-08-27 19:35:44,765 - dodox_01907302051 - INFO - Upload Success
2019-08-27 19:35:44,949 - dodox_01907302051 - INFO - AWzS3D2SBZ1xJXgBM3YA
2019-08-27 19:35:46,057 - dodox_01907302051 - INFO - cf10e4bd453502c5216d16d6f1a57d79
2019-08-27 19:35:46,058 - dodox_01907302051 - INFO - workflow success
2019-08-27 19:35:47,215 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 19:35:47,215 - dodox_01907302051 - INFO - workflowid:cf10e4bd453502c5216d16d6f1a57d79
2019-08-27 19:35:48,389 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_check_action'
2019-08-27 19:35:48,389 - db - INFO - update  public.task_info set wfid='cf10e4bd453502c5216d16d6f1a57d79',status='up',scriptid='AWzS3D2SBZ1xJXgBM3YA' where workflowname='gonganju_8_103_dsjzx_jg_jgxw_check_action'
2019-08-27 19:35:48,391 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3848.08ms
2019-08-27 19:49:38,909 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_force_action'
2019-08-27 19:49:38,911 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 57.00ms
2019-08-27 19:49:53,449 - db - INFO - select * from public.task_info where wfid = '08cf809792e84b3a38b4e9fbe1b823d5'
2019-08-27 19:49:53,450 - db - INFO - update  public.task_info set status='down' where wfid='08cf809792e84b3a38b4e9fbe1b823d5'
2019-08-27 19:49:54,631 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1183.01ms
2019-08-27 19:49:59,462 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_force_action'
2019-08-27 19:49:59,527 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 19:49:59,582 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_force_action.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_jgxw_force_action.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_force_action.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_force_action.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_force_action.log', 'gonganju_txt_ods.jg_jgxw_force_action', 'dsjzx.jg_jgxw_force_action','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_force_action数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_jgxw_force_action\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_jgxw_force_action_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_jgxw_force_action_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_jgxw_force_action_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_jgxw_force_action_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_force_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_force_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_force_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_jgxw_force_action.txt' into table gonganju_txt_ods.jg_jgxw_force_action\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_force_action (cd_id,Record_Unique_Identity,Supervise_Item_Code,Force_Action_Name,Force_Action_Code,Implement_Institution,Implement_Institution_Code,Supervise_Object,Check_Action_Code,Administrative_Cp,Administrative_Cp_Na,Administrative_Cp_Ce_Type,Administrative_Cp_UI_Code,Address_Registered,Address_Operating,Area_Number,Illegal_Fact,Mandatory_Basis,Mandatory_Decision_Number,Force_Type,Coercive_Measure_Type,Force_Execution_Type,Mandatory_Decision_Patify,Mandatory_Decision_Sev_Date,Force_Extend_Date,End_Date,Submitted_Date,Submitted_Personnel,cd_time,cd_source,cd_batch,cd_operation) select cd_id,Record_Unique_Identity,Supervise_Item_Code,Force_Action_Name,Force_Action_Code,Implement_Institution,Implement_Institution_Code,Supervise_Object,Check_Action_Code,Administrative_Cp,Administrative_Cp_Na,Administrative_Cp_Ce_Type,Administrative_Cp_UI_Code,Address_Registered,Address_Operating,Area_Number,Illegal_Fact,Mandatory_Basis,Mandatory_Decision_Number,Force_Type,Coercive_Measure_Type,Force_Execution_Type,Mandatory_Decision_Patify,Mandatory_Decision_Sev_Date,Force_Extend_Date,End_Date,Submitted_Date,Submitted_Personnel,cd_time,cd_source,cd_batch,cd_operation  from gonganju_txt_ods.jg_jgxw_force_action\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_jgxw_force_action\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_force_action抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_jgxw_force_action.py"}}

2019-08-27 19:49:59,582 - dodox_01907302051 - INFO - Upload Success
2019-08-27 19:49:59,765 - dodox_01907302051 - INFO - AWzS6UizBZ1xJXgBM3YR
2019-08-27 19:50:00,859 - dodox_01907302051 - INFO - 86bf3b71a77afa53ab8451ee6ffbc99a
2019-08-27 19:50:00,859 - dodox_01907302051 - INFO - workflow success
2019-08-27 19:50:01,987 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 19:50:01,987 - dodox_01907302051 - INFO - workflowid:86bf3b71a77afa53ab8451ee6ffbc99a
2019-08-27 19:50:03,164 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_force_action'
2019-08-27 19:50:03,164 - db - INFO - update  public.task_info set wfid='86bf3b71a77afa53ab8451ee6ffbc99a',status='up',scriptid='AWzS6UizBZ1xJXgBM3YR' where workflowname='gonganju_8_103_dsjzx_jg_jgxw_force_action'
2019-08-27 19:50:03,166 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3757.71ms
2019-08-27 19:53:39,862 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-27 19:53:39,864 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.55ms
2019-08-27 19:53:55,477 - db - INFO - select * from public.task_info where wfid = 'aac302f5407272e507a974af70307c85'
2019-08-27 19:53:55,478 - db - INFO - update  public.task_info set status='down' where wfid='aac302f5407272e507a974af70307c85'
2019-08-27 19:53:56,623 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1146.49ms
2019-08-27 19:54:01,602 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-27 19:54:01,666 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 19:54:01,728 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_other_action.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_jgxw_other_action.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_other_action.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_other_action.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_other_action.log', 'gonganju_txt_ods.jg_jgxw_other_action', 'dsjzx.jg_jgxw_other_action','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_other_action数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_jgxw_other_action\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_jgxw_other_action_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_jgxw_other_action_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_jgxw_other_action_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_jgxw_other_action_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_other_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_other_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_other_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_jgxw_other_action.txt' into table gonganju_txt_ods.jg_jgxw_other_action\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_other_action (cd_id,Record_Unique_Identity,Supervise_Item_Code,Action_Name,Action_Code,Check_Behavior_Number,Supervise_Object,Item_Source,Implement_Institution,Implement_Institution_Code,Entrust_Dept,Entrust_Dept_Code,Administrative_Cp,Administrative_Cp_Na,Administrative_Cp_Ce_Type,Administrative_Cp_UI_Code,Address_Registered,Address_Operating,Area_Number,Supervise_Measure,Closing_Case,Start_Date,End_Date,Submitted_Date,Submitted_Personnel,cd_time,cd_source,cd_batch,cd_operation) select cd_id,Record_Unique_Identity,Supervise_Item_Code,Action_Name,Action_Code,Check_Behavior_Number,Supervise_Object,Item_Source,Implement_Institution,Implement_Institution_Code,Entrust_Dept,Entrust_Dept_Code,Administrative_Cp,Administrative_Cp_Na,Administrative_Cp_Ce_Type,Administrative_Cp_UI_Code,Address_Registered,Address_Operating,Area_Number,Supervise_Measure,Closing_Case,Start_Date,End_Date,Submitted_Date,Submitted_Personnel,cd_time,cd_source,cd_batch,cd_operation  from gonganju_txt_ods.jg_jgxw_other_action\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_jgxw_other_action\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_other_action抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_jgxw_other_action.py"}}

2019-08-27 19:54:01,728 - dodox_01907302051 - INFO - Upload Success
2019-08-27 19:54:01,904 - dodox_01907302051 - INFO - AWzS7PqVBZ1xJXgBM3Ya
2019-08-27 19:54:03,195 - dodox_01907302051 - INFO - 30b6902e6be1c6d8ad609944fadf1102
2019-08-27 19:54:03,196 - dodox_01907302051 - INFO - workflow success
2019-08-27 19:54:04,312 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 19:54:04,312 - dodox_01907302051 - INFO - workflowid:30b6902e6be1c6d8ad609944fadf1102
2019-08-27 19:54:05,436 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-27 19:54:05,437 - db - INFO - update  public.task_info set wfid='30b6902e6be1c6d8ad609944fadf1102',status='up',scriptid='AWzS7PqVBZ1xJXgBM3Ya' where workflowname='gonganju_8_103_dsjzx_jg_jgxw_other_action'
2019-08-27 19:54:05,439 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3889.59ms
2019-08-27 19:54:05,496 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 19:54:05,497 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 57.24ms
2019-08-27 19:54:19,802 - db - INFO - select * from public.task_info where wfid = '13ec2f681b9355724d39869935c166c0'
2019-08-27 19:54:19,803 - db - INFO - update  public.task_info set status='down' where wfid='13ec2f681b9355724d39869935c166c0'
2019-08-27 19:54:20,954 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1152.18ms
2019-08-27 19:54:23,756 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 19:54:23,858 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 19:54:23,885 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log', 'gonganju_txt_ods.base_jjlhy_drivinglicense_df', 'dsjzx.base_jjlhy_drivinglicense_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drivinglicense_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_drivinglicense_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt' into table gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_drivinglicense_df (dabh,bdrq,sfzmhm,bdzjcx,bdyy,zjbj,yzjcx,jxmc,jly,lsh,jbr,fzjg,jyw,xh,sxzjcx,sxyxqs,sxyxqz,sxqljjf1,sxqljjf2,sxbj,jfjzrq,sfzxyw,zxzk,zyjy,jyw2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select dabh,bdrq,sfzmhm,bdzjcx,bdyy,zjbj,yzjcx,jxmc,jly,lsh,jbr,fzjg,jyw,xh,sxzjcx,sxyxqs,sxyxqz,sxqljjf1,sxqljjf2,sxbj,jfjzrq,sfzxyw,zxzk,zyjy,jyw2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drivinglicense_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.py"}}

2019-08-27 19:54:23,886 - dodox_01907302051 - INFO - Upload Success
2019-08-27 19:54:24,075 - dodox_01907302051 - INFO - AWzS7VEkBZ1xJXgBM3Yj
2019-08-27 19:54:25,172 - dodox_01907302051 - INFO - 7d865b56baf7a42ef7c779eb97364860
2019-08-27 19:54:25,172 - dodox_01907302051 - INFO - workflow success
2019-08-27 19:54:26,283 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 19:54:26,284 - dodox_01907302051 - INFO - workflowid:7d865b56baf7a42ef7c779eb97364860
2019-08-27 19:54:27,427 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 19:54:27,427 - db - INFO - update  public.task_info set wfid='7d865b56baf7a42ef7c779eb97364860',status='up',scriptid='AWzS7VEkBZ1xJXgBM3Yj' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 19:54:27,429 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3726.85ms
2019-08-27 19:57:00,006 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_punish_action'
2019-08-27 19:57:00,007 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.67ms
2019-08-27 19:57:18,025 - db - INFO - select * from public.task_info where wfid = '133811a8c86980b35097c20e65341c5a'
2019-08-27 19:57:18,026 - db - INFO - update  public.task_info set status='down' where wfid='133811a8c86980b35097c20e65341c5a'
2019-08-27 19:57:19,136 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1111.08ms
2019-08-27 19:57:24,069 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_punish_action'
2019-08-27 19:57:24,135 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 19:57:24,212 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_punish_action.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_jgxw_punish_action.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_jgxw_punish_action.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_punish_action.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_jgxw_punish_action.log', 'gonganju_txt_ods.jg_jgxw_punish_action', 'dsjzx.jg_jgxw_punish_action','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_punish_action数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_jgxw_punish_action\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_jgxw_punish_action_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_jgxw_punish_action_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_jgxw_punish_action_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_jgxw_punish_action_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_punish_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_punish_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_jgxw_punish_action_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_jgxw_punish_action.txt' into table gonganju_txt_ods.jg_jgxw_punish_action\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_jgxw_punish_action (cd_id,Record_Unique_Identity,Supervise_Item_Code,Punish_Action_Name,Punish_Action_Code,Implement_Institution,Implement_Institution_Code,Entrust_Dept,Entrust_Dept_Code,Supervise_Object,Case_Source,Check_Action_Code,Administrative_Cp,Administrative_Cp_Na,Administrative_Cp_Ce_Type,Administrative_Cp_UI_Code,Address_Registered,Address_Operating,Area_Number,Illegal_Fact,Punish_Accord,Punish_Procedure,If_Hearing_Witnesses,Filing_Date,Case_Involving_Punishment,Major_Case,Legal_Review,Legal_Review_Date,Legal_Review_Opinions,Discuss_Collectively,Group_Discussion_Date,Group_Discussion_Conclusion,Punish_Document_Code,Set_Date,Fine,Punish_Type,Penalty_Result,Administrative_Reconsider,Administrative_Action,Cases_Closed_Execution_Way,Cases_Closed_Execution_Result,Cases_Closed_Fine,Cases_Closed_Execution,Administrative_Penalties,Other_Disposals,Deportation_Date,Submitted_Date,Submitted_Personnel,cd_time,cd_source,cd_batch,cd_operation) select cd_id,Record_Unique_Identity,Supervise_Item_Code,Punish_Action_Name,Punish_Action_Code,Implement_Institution,Implement_Institution_Code,Entrust_Dept,Entrust_Dept_Code,Supervise_Object,Case_Source,Check_Action_Code,Administrative_Cp,Administrative_Cp_Na,Administrative_Cp_Ce_Type,Administrative_Cp_UI_Code,Address_Registered,Address_Operating,Area_Number,Illegal_Fact,Punish_Accord,Punish_Procedure,If_Hearing_Witnesses,Filing_Date,Case_Involving_Punishment,Major_Case,Legal_Review,Legal_Review_Date,Legal_Review_Opinions,Discuss_Collectively,Group_Discussion_Date,Group_Discussion_Conclusion,Punish_Document_Code,Set_Date,Fine,Punish_Type,Penalty_Result,Administrative_Reconsider,Administrative_Action,Cases_Closed_Execution_Way,Cases_Closed_Execution_Result,Cases_Closed_Fine,Cases_Closed_Execution,Administrative_Penalties,Other_Disposals,Deportation_Date,Submitted_Date,Submitted_Personnel,cd_time,cd_source,cd_batch,cd_operation  from gonganju_txt_ods.jg_jgxw_punish_action\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_jgxw_punish_action\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_jgxw_punish_action抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_jgxw_punish_action.py"}}

2019-08-27 19:57:24,212 - dodox_01907302051 - INFO - Upload Success
2019-08-27 19:57:24,390 - dodox_01907302051 - INFO - AWzS8BGHBZ1xJXgBM3Yw
2019-08-27 19:57:25,449 - dodox_01907302051 - INFO - e2eedd5a7875a4006901d84977281dd2
2019-08-27 19:57:25,450 - dodox_01907302051 - INFO - workflow success
2019-08-27 19:57:26,579 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 19:57:26,580 - dodox_01907302051 - INFO - workflowid:e2eedd5a7875a4006901d84977281dd2
2019-08-27 19:57:27,733 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_jgxw_punish_action'
2019-08-27 19:57:27,733 - db - INFO - update  public.task_info set wfid='e2eedd5a7875a4006901d84977281dd2',status='up',scriptid='AWzS8BGHBZ1xJXgBM3Yw' where workflowname='gonganju_8_103_dsjzx_jg_jgxw_punish_action'
2019-08-27 19:57:27,735 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3720.99ms
2019-08-27 20:02:56,622 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_zfk_user_info'
2019-08-27 20:02:56,630 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 73.17ms
2019-08-27 20:03:10,256 - db - INFO - select * from public.task_info where wfid = '3b9b52fdd38aca451fb0d1509077abb1'
2019-08-27 20:03:10,257 - db - INFO - update  public.task_info set status='down' where wfid='3b9b52fdd38aca451fb0d1509077abb1'
2019-08-27 20:03:11,410 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1153.91ms
2019-08-27 20:03:17,487 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_zfk_user_info'
2019-08-27 20:03:17,591 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:03:17,680 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_zfk_user_info.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_jg_zfk_user_info.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_jg_zfk_user_info.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_zfk_user_info.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_jg_zfk_user_info.log', 'gonganju_txt_ods.jg_zfk_user_info', 'dsjzx.jg_zfk_user_info','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.jg_zfk_user_info数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_jg_zfk_user_info\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_jg_zfk_user_info_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_jg_zfk_user_info_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_jg_zfk_user_info_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_jg_zfk_user_info_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_jg_zfk_user_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_zfk_user_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_jg_zfk_user_info_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_jg_zfk_user_info.txt' into table gonganju_txt_ods.jg_zfk_user_info\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.jg_zfk_user_info (cd_id,Record_Unique_Identity,Name,Full_name_of_the_subject,ID_Number,Sex,Birth_Date,Political_Status,Rank,Nation,Highest_Education,Law_Staff_Type,Supervision_Staff,Qualification_Legal_Pro,Contact_Tel,Code,Academic_Qualifications,Licence_Issuing_Authority,Enforcement_Area,Enforcement_Type,Validity_Documents,cd_time,cd_source,cd_batch,cd_operation) select cd_id,Record_Unique_Identity,Name,Full_name_of_the_subject,ID_Number,Sex,Birth_Date,Political_Status,Rank,Nation,Highest_Education,Law_Staff_Type,Supervision_Staff,Qualification_Legal_Pro,Contact_Tel,Code,Academic_Qualifications,Licence_Issuing_Authority,Enforcement_Area,Enforcement_Type,Validity_Documents,cd_time,cd_source,cd_batch,cd_operation  from gonganju_txt_ods.jg_zfk_user_info\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.jg_zfk_user_info\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.jg_zfk_user_info抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_jg_zfk_user_info.py"}}

2019-08-27 20:03:17,681 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:03:17,865 - dodox_01907302051 - INFO - AWzS9XZEBZ1xJXgBM3ZJ
2019-08-27 20:03:18,960 - dodox_01907302051 - INFO - d44eac74a42a923c6f585eb10b7a2de2
2019-08-27 20:03:18,960 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:03:20,095 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:03:20,095 - dodox_01907302051 - INFO - workflowid:d44eac74a42a923c6f585eb10b7a2de2
2019-08-27 20:03:21,222 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_jg_zfk_user_info'
2019-08-27 20:03:21,222 - db - INFO - update  public.task_info set wfid='d44eac74a42a923c6f585eb10b7a2de2',status='up',scriptid='AWzS9XZEBZ1xJXgBM3ZJ' where workflowname='gonganju_8_103_dsjzx_jg_zfk_user_info'
2019-08-27 20:03:21,224 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3792.10ms
2019-08-27 20:08:35,452 - db - INFO - select * from public.task_info where wfid = '7d865b56baf7a42ef7c779eb97364860'
2019-08-27 20:08:35,453 - db - INFO - update  public.task_info set status='down' where wfid='7d865b56baf7a42ef7c779eb97364860'
2019-08-27 20:08:36,669 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1217.72ms
2019-08-27 20:12:35,213 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 20:12:35,308 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:12:35,363 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log', 'gonganju_txt_ods.base_jjlhy_drivinglicense_df', 'dsjzx.base_jjlhy_drivinglicense_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drivinglicense_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_drivinglicense_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt' into table gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_drivinglicense_df (dabh,sfzmhm,zjcx,yzjcx,qfrq,qfrq_dt,syrq,syrq_dt,cclzrq,cclzrq_dt,ccfzjg,jzqx,yxqs,yxqz,ljjf,cfrq,cfrq_dt,xxtzrq,xxtzrq_dt,bzcs,zt,ly,jxmc,jly,xzqh,xzqj,fzrq,jbr,glbm,fzjg,gxsj,gxsj_dt,lsh,xgzl,bz,jyw,ydabh,sqdm,zxbh,xh,sfzmmc,hmcd,xm,xb,csrq,csrq_dt,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,zzfzrq_dt,sfbd,dwbh,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,xzqhmc,xbmc,dt,jhpt_update_time,jhpt_delete) select dabh,sfzmhm,zjcx,yzjcx,qfrq,qfrq_dt,syrq,syrq_dt,cclzrq,cclzrq_dt,ccfzjg,jzqx,yxqs,yxqz,ljjf,cfrq,cfrq_dt,xxtzrq,xxtzrq_dt,bzcs,zt,ly,jxmc,jly,xzqh,xzqj,fzrq,jbr,glbm,fzjg,gxsj,gxsj_dt,lsh,xgzl,bz,jyw,ydabh,sqdm,zxbh,xh,sfzmmc,hmcd,xm,xb,csrq,csrq_dt,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,zzfzrq_dt,sfbd,dwbh,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,xzqhmc,xbmc,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drivinglicense_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.py"}}

2019-08-27 20:12:35,363 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:12:35,540 - dodox_01907302051 - INFO - AWzS_fi3BZ1xJXgBM3Za
2019-08-27 20:12:36,619 - dodox_01907302051 - INFO - b359efdeb1059ea5218aee9256b18e69
2019-08-27 20:12:36,619 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:12:37,729 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:12:37,729 - dodox_01907302051 - INFO - workflowid:b359efdeb1059ea5218aee9256b18e69
2019-08-27 20:12:38,849 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 20:12:38,850 - db - INFO - update  public.task_info set wfid='b359efdeb1059ea5218aee9256b18e69',status='up',scriptid='AWzS_fi3BZ1xJXgBM3Za' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-08-27 20:12:38,852 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3694.18ms
2019-08-27 20:17:34,484 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df'
2019-08-27 20:17:34,486 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 62.09ms
2019-08-27 20:17:46,933 - db - INFO - select * from public.task_info where wfid = 'f488251aba49d489d31799c082847109'
2019-08-27 20:17:46,934 - db - INFO - update  public.task_info set status='down' where wfid='f488251aba49d489d31799c082847109'
2019-08-27 20:17:48,106 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1173.73ms
2019-08-27 20:18:03,222 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df'
2019-08-27 20:18:03,289 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:18:03,345 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.log', 'gonganju_txt_ods.base_crjdata_ry_czjwryjbxx_df', 'dsjzx.base_crjdata_ry_czjwryjbxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_ry_czjwryjbxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_ry_czjwryjbxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt' into table gonganju_txt_ods.base_crjdata_ry_czjwryjbxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_ry_czjwryjbxx_df (yw_id,czjwrylb,ry_id,rybh,xp_id,pcsyw_id,sf,qfrq,zjyxqz,zjnrs,qzzl,jlsy,qzhm,qzqfrq,qzyxqz,qfjg,lxdh,bz,ryzl,jddwlb,jddw,zdrwbs,hczt,sfyx,lrsj,lrr,zhxgr,tbdwbh,ssbz,jsbz,scbz,lcztbz,czbz,ydbz,zjzl,zjhm,gjdq,xb,csrq,rydylb,ywx,ywm,ywxm,zwxm,crjxxhcbz,rjsy,rjrq,sfzh,pcsmc,jzdhsbz,gzdhsbz,pcsbh,zxsj,jzzt,zxr,zxyy,old_ywid,jwjzd,qzyxcs,rjka,yjjlbz,ssgabbh,zhxgsj,jh_xzqh,sjxzqh,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select yw_id,czjwrylb,ry_id,rybh,xp_id,pcsyw_id,sf,qfrq,zjyxqz,zjnrs,qzzl,jlsy,qzhm,qzqfrq,qzyxqz,qfjg,lxdh,bz,ryzl,jddwlb,jddw,zdrwbs,hczt,sfyx,lrsj,lrr,zhxgr,tbdwbh,ssbz,jsbz,scbz,lcztbz,czbz,ydbz,zjzl,zjhm,gjdq,xb,csrq,rydylb,ywx,ywm,ywxm,zwxm,crjxxhcbz,rjsy,rjrq,sfzh,pcsmc,jzdhsbz,gzdhsbz,pcsbh,zxsj,jzzt,zxr,zxyy,old_ywid,jwjzd,qzyxcs,rjka,yjjlbz,ssgabbh,zhxgsj,jh_xzqh,sjxzqh,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_ry_czjwryjbxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_ry_czjwryjbxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_ry_czjwryjbxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.py"}}

2019-08-27 20:18:03,345 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:18:03,516 - dodox_01907302051 - INFO - AWzTAvnmBZ1xJXgBM3Zp
2019-08-27 20:18:04,619 - dodox_01907302051 - INFO - a43b74cff909655108a07a846d9c8228
2019-08-27 20:18:04,619 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:18:05,747 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:18:05,748 - dodox_01907302051 - INFO - workflowid:a43b74cff909655108a07a846d9c8228
2019-08-27 20:18:06,918 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df'
2019-08-27 20:18:06,919 - db - INFO - update  public.task_info set wfid='a43b74cff909655108a07a846d9c8228',status='up',scriptid='AWzTAvnmBZ1xJXgBM3Zp' where workflowname='gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df'
2019-08-27 20:18:06,921 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3755.43ms
2019-08-27 20:20:54,641 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-08-27 20:20:54,645 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 73.63ms
2019-08-27 20:21:04,214 - db - INFO - select * from public.task_info where wfid = 'b99857a5dc5e7c41f76207cf74a2fb3f'
2019-08-27 20:21:04,215 - db - INFO - update  public.task_info set status='down' where wfid='b99857a5dc5e7c41f76207cf74a2fb3f'
2019-08-27 20:21:05,400 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1186.28ms
2019-08-27 20:21:09,395 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-08-27 20:21:09,491 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:21:09,595 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.log', 'gonganju_txt_ods.base_crjdata_ryxx_df', 'dsjzx.base_crjdata_ryxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_ryxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_ryxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_ryxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_ryxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_ryxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_ryxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ryxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ryxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ryxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt' into table gonganju_txt_ods.base_crjdata_ryxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_ryxx_df (ry_id,rybh,ryxh,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,yym,xb,csrq,csd,sfzh,gjdq,zjzl,zjhm,jmzjhm,zjhmc,zjhmd,rydylb,jdywlx,jdywbh,jdsj,ywglsfyx,ywglbs,xxrbs,czrybh,cdh,bz,yxbz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,old_sqid,old_ryid,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select ry_id,rybh,ryxh,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,yym,xb,csrq,csd,sfzh,gjdq,zjzl,zjhm,jmzjhm,zjhmc,zjhmd,rydylb,jdywlx,jdywbh,jdsj,ywglsfyx,ywglbs,xxrbs,czrybh,cdh,bz,yxbz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,old_sqid,old_ryid,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_ryxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_ryxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_ryxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.py"}}

2019-08-27 20:21:09,595 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:21:09,779 - dodox_01907302051 - INFO - AWzTBdFwBZ1xJXgBM3Zy
2019-08-27 20:21:10,871 - dodox_01907302051 - INFO - 13e01b720018a1c997cbabee5baf57f8
2019-08-27 20:21:10,871 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:21:11,990 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:21:11,991 - dodox_01907302051 - INFO - workflowid:13e01b720018a1c997cbabee5baf57f8
2019-08-27 20:21:13,124 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-08-27 20:21:13,125 - db - INFO - update  public.task_info set wfid='13e01b720018a1c997cbabee5baf57f8',status='up',scriptid='AWzTBdFwBZ1xJXgBM3Zy' where workflowname='gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-08-27 20:21:13,127 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3788.13ms
2019-08-27 20:23:14,005 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-08-27 20:23:14,006 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 68.37ms
2019-08-27 20:23:28,316 - db - INFO - select * from public.task_info where wfid = '258772502ac82f624733ba8cfa017a8d'
2019-08-27 20:23:28,317 - db - INFO - update  public.task_info set status='down' where wfid='258772502ac82f624733ba8cfa017a8d'
2019-08-27 20:23:29,579 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1263.60ms
2019-08-27 20:23:34,023 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-08-27 20:23:34,111 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:23:34,176 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.log', 'gonganju_txt_ods.base_jjlhy_drv_logout_di', 'dsjzx.base_jjlhy_drv_logout_di','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drv_logout_di数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_drv_logout_di\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_drv_logout_di_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_drv_logout_di_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_drv_logout_di_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_drv_logout_di_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_logout_di_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_logout_di_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_logout_di_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt' into table gonganju_txt_ods.base_jjlhy_drv_logout_di\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_drv_logout_di (dabh,zxrq,zxyy,ggrq,ggbz,sfzmhm,zjcx,yzjcx,qfrq,syrq,cclzrq,ccfzjg,jzqx,yxqs,yxqz,ljjf,cfrq,bzcs,zt,ly,jxmc,jly,xzqh,xzqj,fzrq,jbr,glbm,fzjg,zxjbr,lsh,xgzl,zrd,ydabh,jyw,bz,bh,csbj,xh,sfzmmc,hmcd,xm,xb,csrq,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,sfbd,dlr,dlrxm,dwd_loadtime,dwd_updatetime,dwd_yxbz,zxyymc,zjcxmc,yzjcxmc,ccfzjgmc,ztmc,lymc,xzqhmc,glbmmc,fzjgmc,xgzlmc,sfzmmcmc,xbmc,gjmc,djzsxzqhmc,lxzsxzqhmc,dt,jhpt_update_time,jhpt_delete) select dabh,zxrq,zxyy,ggrq,ggbz,sfzmhm,zjcx,yzjcx,qfrq,syrq,cclzrq,ccfzjg,jzqx,yxqs,yxqz,ljjf,cfrq,bzcs,zt,ly,jxmc,jly,xzqh,xzqj,fzrq,jbr,glbm,fzjg,zxjbr,lsh,xgzl,zrd,ydabh,jyw,bz,bh,csbj,xh,sfzmmc,hmcd,xm,xb,csrq,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,sfbd,dlr,dlrxm,dwd_loadtime,dwd_updatetime,dwd_yxbz,zxyymc,zjcxmc,yzjcxmc,ccfzjgmc,ztmc,lymc,xzqhmc,glbmmc,fzjgmc,xgzlmc,sfzmmcmc,xbmc,gjmc,djzsxzqhmc,lxzsxzqhmc,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_drv_logout_di\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_drv_logout_di\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drv_logout_di抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.py"}}

2019-08-27 20:23:34,176 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:23:34,357 - dodox_01907302051 - INFO - AWzTCAY1BZ1xJXgBM3Z_
2019-08-27 20:23:35,433 - dodox_01907302051 - INFO - 07d561c440c56cecb87c3452a36c815e
2019-08-27 20:23:35,433 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:23:36,545 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:23:36,546 - dodox_01907302051 - INFO - workflowid:07d561c440c56cecb87c3452a36c815e
2019-08-27 20:23:37,685 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-08-27 20:23:37,685 - db - INFO - update  public.task_info set wfid='07d561c440c56cecb87c3452a36c815e',status='up',scriptid='AWzTCAY1BZ1xJXgBM3Z_' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-08-27 20:23:37,687 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3750.17ms
2019-08-27 20:24:43,310 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-08-27 20:24:43,312 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 61.83ms
2019-08-27 20:24:57,419 - db - INFO - select * from public.task_info where wfid = 'a7afc9abdb1e43188ffe9851d2b22580'
2019-08-27 20:24:57,420 - db - INFO - update  public.task_info set status='down' where wfid='a7afc9abdb1e43188ffe9851d2b22580'
2019-08-27 20:24:58,589 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1169.87ms
2019-08-27 20:25:04,166 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-08-27 20:25:04,254 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:25:04,318 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.log', 'gonganju_txt_ods.base_syrk_t_zp_edz_df', 'dsjzx.base_syrk_t_zp_edz_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_syrk_t_zp_edz_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_syrk_t_zp_edz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_syrk_t_zp_edz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_syrk_t_zp_edz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_syrk_t_zp_edz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_syrk_t_zp_edz_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_zp_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_zp_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_zp_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt' into table gonganju_txt_ods.base_syrk_t_zp_edz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_syrk_t_zp_edz_df (id,zjhm,zp,zprq,sjgxsj,photo_no,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select id,zjhm,zp,zprq,sjgxsj,photo_no,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_syrk_t_zp_edz_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_syrk_t_zp_edz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_syrk_t_zp_edz_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.py"}}

2019-08-27 20:25:04,318 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:25:04,485 - dodox_01907302051 - INFO - AWzTCWZUBZ1xJXgBM3aI
2019-08-27 20:25:05,579 - dodox_01907302051 - INFO - 3fea68f77d863275279ff5aff44031fb
2019-08-27 20:25:05,579 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:25:06,730 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:25:06,730 - dodox_01907302051 - INFO - workflowid:3fea68f77d863275279ff5aff44031fb
2019-08-27 20:25:07,849 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-08-27 20:25:07,849 - db - INFO - update  public.task_info set wfid='3fea68f77d863275279ff5aff44031fb',status='up',scriptid='AWzTCWZUBZ1xJXgBM3aI' where workflowname='gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-08-27 20:25:07,851 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3750.65ms
2019-08-27 20:28:47,775 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df'
2019-08-27 20:28:47,777 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 62.63ms
2019-08-27 20:28:56,078 - db - INFO - select * from public.task_info where wfid = '5d97aa6eb5048640d6a779b28f18d5d6'
2019-08-27 20:28:56,079 - db - INFO - update  public.task_info set status='down' where wfid='5d97aa6eb5048640d6a779b28f18d5d6'
2019-08-27 20:28:57,268 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1190.48ms
2019-08-27 20:29:01,031 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df'
2019-08-27 20:29:01,101 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:29:01,164 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.log', 'gonganju_txt_ods.base_crjdata_twtbsqxx_df', 'dsjzx.base_crjdata_twtbsqxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_twtbsqxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_twtbsqxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_twtbsqxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_twtbsqxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_twtbsqxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_twtbsqxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_twtbsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_twtbsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_twtbsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt' into table gonganju_txt_ods.base_crjdata_twtbsqxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_twtbsqxx_df (sq_id,ry_id,rybh,ywbh,sqlb,bzlb,sqsy,djsy,mz,jwrylb,ldlsf,jwzy,jnlxdh,twhzhm,twsfzh,ldlsy,rjka,rjrq,qwd,twjzd,twxxzz,ndjzdpcs,ndjzdxxdz,ndjzdxzqh,dwbh,dwmc,dwszdpcs,dwszdxxdz,dwszdxzqh,dbdw,dbr,dbrlxdh,tqywbh,xczjzl,xczjhm,xczjbbh,xczjqfjg,xczjqfrq,xczjyxqz,xcqzzl,xcqzrjcs,xcqzhm,xcqzqfrq,xcqzyxqz,xcqzqfjg,sbzjhm,sbqzhm,sldw,slrq,slr,spdw,sprq,spr,spjg,bpzyy,zzrq,fzrq,gdrq,sfqrbz,sflb,sfje,sfbz,syhbs,sfsyhsj,sfyhfksj,tfsyhsj,tfyhfksj,qrsfsj,qrsfr,qrtfsj,qrtfr,jjbs,tbbs,dah,xxjb,yyqzrq,sfxxz,sfxqz,sfxjz,sfcjzp,bz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,xxly,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,xb,csrq,sfzh,gjdq,rydylb,csd,slrqchar,sprqchar,zzzrqchar,zqzrqchar,zzrqchar,fzrqchar,sfxtkzd,sjr,yzbm,emsdz,zjclhm,jffs,yddrxbdbz,ydyrxbdbz,xm_gbk,ftxm_gbk,wwbm,twzyrwbz,sjrdh,jjqk_lxr,jjqk_lxrdh,old_sqid,sfdzzj,sjxfbz,hyzk,jg,ndjlb,whcd,yhjszd,szqm,dah2,djpzdh,tbyj,qzdw,qzdz,yyqzrq_char,emsdh,tdxzqh,sfmclbh,qzfsdd,jjzl,jjyy,cym,ycxzjhm,ndjd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select sq_id,ry_id,rybh,ywbh,sqlb,bzlb,sqsy,djsy,mz,jwrylb,ldlsf,jwzy,jnlxdh,twhzhm,twsfzh,ldlsy,rjka,rjrq,qwd,twjzd,twxxzz,ndjzdpcs,ndjzdxxdz,ndjzdxzqh,dwbh,dwmc,dwszdpcs,dwszdxxdz,dwszdxzqh,dbdw,dbr,dbrlxdh,tqywbh,xczjzl,xczjhm,xczjbbh,xczjqfjg,xczjqfrq,xczjyxqz,xcqzzl,xcqzrjcs,xcqzhm,xcqzqfrq,xcqzyxqz,xcqzqfjg,sbzjhm,sbqzhm,sldw,slrq,slr,spdw,sprq,spr,spjg,bpzyy,zzrq,fzrq,gdrq,sfqrbz,sflb,sfje,sfbz,syhbs,sfsyhsj,sfyhfksj,tfsyhsj,tfyhfksj,qrsfsj,qrsfr,qrtfsj,qrtfr,jjbs,tbbs,dah,xxjb,yyqzrq,sfxxz,sfxqz,sfxjz,sfcjzp,bz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,xxly,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,xb,csrq,sfzh,gjdq,rydylb,csd,slrqchar,sprqchar,zzzrqchar,zqzrqchar,zzrqchar,fzrqchar,sfxtkzd,sjr,yzbm,emsdz,zjclhm,jffs,yddrxbdbz,ydyrxbdbz,xm_gbk,ftxm_gbk,wwbm,twzyrwbz,sjrdh,jjqk_lxr,jjqk_lxrdh,old_sqid,sfdzzj,sjxfbz,hyzk,jg,ndjlb,whcd,yhjszd,szqm,dah2,djpzdh,tbyj,qzdw,qzdz,yyqzrq_char,emsdh,tdxzqh,sfmclbh,qzfsdd,jjzl,jjyy,cym,ycxzjhm,ndjd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_twtbsqxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_twtbsqxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_twtbsqxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.py"}}

2019-08-27 20:29:01,164 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:29:01,328 - dodox_01907302051 - INFO - AWzTDQOFBZ1xJXgBM3aa
2019-08-27 20:29:02,409 - dodox_01907302051 - INFO - d669272eb39cd2722c6c7dfdac89b46f
2019-08-27 20:29:02,409 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:29:03,536 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:29:03,536 - dodox_01907302051 - INFO - workflowid:d669272eb39cd2722c6c7dfdac89b46f
2019-08-27 20:29:04,672 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df'
2019-08-27 20:29:04,672 - db - INFO - update  public.task_info set wfid='d669272eb39cd2722c6c7dfdac89b46f',status='up',scriptid='AWzTDQOFBZ1xJXgBM3aa' where workflowname='gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df'
2019-08-27 20:29:04,675 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3704.08ms
2019-08-27 20:30:12,710 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df'
2019-08-27 20:30:12,713 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 83.94ms
2019-08-27 20:30:24,731 - db - INFO - select * from public.task_info where wfid = 'd37d33382b6c5876f6e4d50151ad0b03'
2019-08-27 20:30:24,731 - db - INFO - update  public.task_info set status='down' where wfid='d37d33382b6c5876f6e4d50151ad0b03'
2019-08-27 20:30:25,888 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1157.74ms
2019-08-27 20:30:31,122 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df'
2019-08-27 20:30:31,205 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:30:31,264 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.log', 'gonganju_txt_ods.base_syrk_t_rjbxx_xjcj_df', 'dsjzx.base_syrk_t_rjbxx_xjcj_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_syrk_t_rjbxx_xjcj_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_syrk_t_rjbxx_xjcj_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt' into table gonganju_txt_ods.base_syrk_t_rjbxx_xjcj_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_syrk_t_rjbxx_xjcj_df (rid,xm,xbdm,mzdm,sg,csrq,gmsfhm,czhkszd_xzqhdm,czhkszd_dzmc,cjrxm,cjrzjhm,cjrlxfs,cjrdwdm,cjsj,zzmmdm,whcddm,dhmddm,lhfsdm,sjlybz,babz,gxr,gxsj,zt,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,xm,xbdm,mzdm,sg,csrq,gmsfhm,czhkszd_xzqhdm,czhkszd_dzmc,cjrxm,cjrzjhm,cjrlxfs,cjrdwdm,cjsj,zzmmdm,whcddm,dhmddm,lhfsdm,sjlybz,babz,gxr,gxsj,zt,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_syrk_t_rjbxx_xjcj_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_syrk_t_rjbxx_xjcj_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_syrk_t_rjbxx_xjcj_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.py"}}

2019-08-27 20:30:31,265 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:30:31,435 - dodox_01907302051 - INFO - AWzTDmN8BZ1xJXgBM3ar
2019-08-27 20:30:32,541 - dodox_01907302051 - INFO - 6043b8ed4a0704205a248601bb835f49
2019-08-27 20:30:32,542 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:30:33,664 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:30:33,664 - dodox_01907302051 - INFO - workflowid:6043b8ed4a0704205a248601bb835f49
2019-08-27 20:30:34,801 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df'
2019-08-27 20:30:34,801 - db - INFO - update  public.task_info set wfid='6043b8ed4a0704205a248601bb835f49',status='up',scriptid='AWzTDmN8BZ1xJXgBM3ar' where workflowname='gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df'
2019-08-27 20:30:34,803 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3746.54ms
2019-08-27 20:33:33,616 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df'
2019-08-27 20:33:33,618 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 79.66ms
2019-08-27 20:33:47,168 - db - INFO - select * from public.task_info where wfid = '220876ded1cb845951f24245d47e8045'
2019-08-27 20:33:47,169 - db - INFO - update  public.task_info set status='down' where wfid='220876ded1cb845951f24245d47e8045'
2019-08-27 20:33:48,351 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1183.52ms
2019-08-27 20:33:53,215 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df'
2019-08-27 20:33:53,300 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:33:53,363 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.log', 'gonganju_txt_ods.base_syrk_t_rjbxx_df', 'dsjzx.base_syrk_t_rjbxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_syrk_t_rjbxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_syrk_t_rjbxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_syrk_t_rjbxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_syrk_t_rjbxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_syrk_t_rjbxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_syrk_t_rjbxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt' into table gonganju_txt_ods.base_syrk_t_rjbxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_syrk_t_rjbxx_df (rid,syrklbdm,syrklbhz,zjzldm,zjzlhz,zjhm,xm,xmqp,xmsp,cym,xbdm,xbhz,mzdm,mzhz,csrq,csrq_dt,csdxzqhdm,csdxzqhhz,csdxz,jgdm,jghz,hh,fhlsh,hlsh,hjdxzqhdm,hjdxzqhhz,hjdlmdm,hjdlmhz,hjdxz,hjdz,hjdyjmp,hjdyjmpdsh,hjdejmp,hjdejmpdsh,jzdxzqhdm,jzdxzqhhz,jzdlmdm,jzdlmhz,jzdxz,jzdz,jzdyjmp,jzdyjmpdsh,jzdejmp,jzdejmpdsh,whcddm,whcdhz,hyzkdm,hyzkhz,poxm,pozjhm,zy,zylbdm,zylbhz,fwcs,zjxydm,zjxyhz,byzkdm,byzkhz,sg,xxdm,xxhz,zzsydm,zzsyhz,gjdm,gjhz,ywx,ywm,jwrysfdm,jwrysfhz,tlsydm,tlsyhz,rjsj,rjsj_dt,xxjb,zzjgdm,zzjghz,zwbh,dnabh,zxgxsj,zxgxsj_dt,wzjzd,wzjz,sjlydm,sjlyhz,bz,mapid,did,hjdid,del_flag,is_jsbr,is_zzrs,is_xdry,is_szry,jzzh,mapidd,yhzgxdm,yhzgxhz,yzjzrgxdm,yzjzrgxhz,tzbj,hjfwid,jzfwid,syrkzlbdm,syrkzlbhz,ywbh,is_kgh,qzdqrq,qzdqrq_dt,jzdzzjgdm,jzdzzjghz,sckrksj,sckrksj_dt,sckgxsj,sckgxsj_dt,jzdjzwdm,jzdjzwmc,hjdjzwdm,hjdjzwmc,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,dt,jhpt_update_time,jhpt_delete) select rid,syrklbdm,syrklbhz,zjzldm,zjzlhz,zjhm,xm,xmqp,xmsp,cym,xbdm,xbhz,mzdm,mzhz,csrq,csrq_dt,csdxzqhdm,csdxzqhhz,csdxz,jgdm,jghz,hh,fhlsh,hlsh,hjdxzqhdm,hjdxzqhhz,hjdlmdm,hjdlmhz,hjdxz,hjdz,hjdyjmp,hjdyjmpdsh,hjdejmp,hjdejmpdsh,jzdxzqhdm,jzdxzqhhz,jzdlmdm,jzdlmhz,jzdxz,jzdz,jzdyjmp,jzdyjmpdsh,jzdejmp,jzdejmpdsh,whcddm,whcdhz,hyzkdm,hyzkhz,poxm,pozjhm,zy,zylbdm,zylbhz,fwcs,zjxydm,zjxyhz,byzkdm,byzkhz,sg,xxdm,xxhz,zzsydm,zzsyhz,gjdm,gjhz,ywx,ywm,jwrysfdm,jwrysfhz,tlsydm,tlsyhz,rjsj,rjsj_dt,xxjb,zzjgdm,zzjghz,zwbh,dnabh,zxgxsj,zxgxsj_dt,wzjzd,wzjz,sjlydm,sjlyhz,bz,mapid,did,hjdid,del_flag,is_jsbr,is_zzrs,is_xdry,is_szry,jzzh,mapidd,yhzgxdm,yhzgxhz,yzjzrgxdm,yzjzrgxhz,tzbj,hjfwid,jzfwid,syrkzlbdm,syrkzlbhz,ywbh,is_kgh,qzdqrq,qzdqrq_dt,jzdzzjgdm,jzdzzjghz,sckrksj,sckrksj_dt,sckgxsj,sckgxsj_dt,jzdjzwdm,jzdjzwmc,hjdjzwdm,hjdjzwmc,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_syrk_t_rjbxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_syrk_t_rjbxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_syrk_t_rjbxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.py"}}

2019-08-27 20:33:53,363 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:33:53,532 - dodox_01907302051 - INFO - AWzTEXjpBZ1xJXgBM3a1
2019-08-27 20:33:54,612 - dodox_01907302051 - INFO - 2f537872ecf9ff0b193b25bd2b2837cc
2019-08-27 20:33:54,612 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:33:55,737 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:33:55,737 - dodox_01907302051 - INFO - workflowid:2f537872ecf9ff0b193b25bd2b2837cc
2019-08-27 20:33:56,894 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df'
2019-08-27 20:33:56,894 - db - INFO - update  public.task_info set wfid='2f537872ecf9ff0b193b25bd2b2837cc',status='up',scriptid='AWzTEXjpBZ1xJXgBM3a1' where workflowname='gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df'
2019-08-27 20:33:56,896 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3738.89ms
2019-08-27 20:36:33,614 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_zjblxx_df'
2019-08-27 20:36:33,616 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 72.56ms
2019-08-27 20:36:53,904 - db - INFO - select * from public.task_info where wfid = 'a2651b30367b7a4c22ac84c136dfd368'
2019-08-27 20:36:53,904 - db - INFO - update  public.task_info set status='down' where wfid='a2651b30367b7a4c22ac84c136dfd368'
2019-08-27 20:36:55,093 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1190.18ms
2019-08-27 20:37:05,918 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_zjblxx_df'
2019-08-27 20:37:06,008 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:37:06,072 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.log', 'gonganju_txt_ods.base_crjdata_zjblxx_df', 'dsjzx.base_crjdata_zjblxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_zjblxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_zjblxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_zjblxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_zjblxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_zjblxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_zjblxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_zjblxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_zjblxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_zjblxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt' into table gonganju_txt_ods.base_crjdata_zjblxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_zjblxx_df (zjbl_id,sq_id,ywbh,sqlb,spdw,sprq,spjg,bpzyy,zjzl,zjhm,zjyxcs,zjbbh,zjqfrq,zjqfdw,zjyxq,zjyxqdw,zjyxqz,sfmclbh,bz,scbz,ssbz,jsbz,wfcs,cjka,dbdw,dbr,dbrlxdh,yqdwbh,yqdwmc,slrq,tbdwbh,zhxgr,zhxgsj,tbzzjhm,old_sqid,dah,zjyxqjdw,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select zjbl_id,sq_id,ywbh,sqlb,spdw,sprq,spjg,bpzyy,zjzl,zjhm,zjyxcs,zjbbh,zjqfrq,zjqfdw,zjyxq,zjyxqdw,zjyxqz,sfmclbh,bz,scbz,ssbz,jsbz,wfcs,cjka,dbdw,dbr,dbrlxdh,yqdwbh,yqdwmc,slrq,tbdwbh,zhxgr,zhxgsj,tbzzjhm,old_sqid,dah,zjyxqjdw,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_zjblxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_zjblxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_zjblxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.py"}}

2019-08-27 20:37:06,073 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:37:06,247 - dodox_01907302051 - INFO - AWzTFGmxBZ1xJXgBM3bG
2019-08-27 20:37:07,322 - dodox_01907302051 - INFO - c8571804746085f6fa2494dd715eec02
2019-08-27 20:37:07,322 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:37:08,459 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:37:08,459 - dodox_01907302051 - INFO - workflowid:c8571804746085f6fa2494dd715eec02
2019-08-27 20:37:09,616 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_zjblxx_df'
2019-08-27 20:37:09,616 - db - INFO - update  public.task_info set wfid='c8571804746085f6fa2494dd715eec02',status='up',scriptid='AWzTFGmxBZ1xJXgBM3bG' where workflowname='gonganju_8_103_dsjzx_base_crjdata_zjblxx_df'
2019-08-27 20:37:09,618 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3767.16ms
2019-08-27 20:37:14,169 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df'
2019-08-27 20:37:14,171 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 64.93ms
2019-08-27 20:37:14,499 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df'
2019-08-27 20:37:14,501 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 60.43ms
2019-08-27 20:37:23,020 - db - INFO - select * from public.task_info where wfid = '588046e2536a4e017b8fa53472c22b98'
2019-08-27 20:37:23,021 - db - INFO - update  public.task_info set status='down' where wfid='588046e2536a4e017b8fa53472c22b98'
2019-08-27 20:37:24,191 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1172.36ms
2019-08-27 20:37:27,299 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df'
2019-08-27 20:37:27,374 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:37:27,424 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.log', 'gonganju_txt_ods.base_jjlhy_drv_vehicletype_df', 'dsjzx.base_jjlhy_drv_vehicletype_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drv_vehicletype_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_drv_vehicletype_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_drv_vehicletype_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_drv_vehicletype_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_drv_vehicletype_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_drv_vehicletype_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_vehicletype_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_vehicletype_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_vehicletype_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt' into table gonganju_txt_ods.base_jjlhy_drv_vehicletype_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_drv_vehicletype_df (dabh,bdrq,sfzmhm,bdzjcx,bdyy,zjbj,yzjcx,jxmc,jly,lsh,jbr,fzjg,jyw,xh,sxzjcx,sxyxqs,sxyxqz,sxqljjf1,sxqljjf2,sxbj,jfjzrq,sfzxyw,zxzk,zyjy,jyw2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select dabh,bdrq,sfzmhm,bdzjcx,bdyy,zjbj,yzjcx,jxmc,jly,lsh,jbr,fzjg,jyw,xh,sxzjcx,sxyxqs,sxyxqz,sxqljjf1,sxqljjf2,sxbj,jfjzrq,sfzxyw,zxzk,zyjy,jyw2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_drv_vehicletype_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_drv_vehicletype_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_drv_vehicletype_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.py"}}

2019-08-27 20:37:27,424 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:37:27,587 - dodox_01907302051 - INFO - AWzTFL0TBZ1xJXgBM3bP
2019-08-27 20:37:28,672 - dodox_01907302051 - INFO - 86b1ff893c16e67d27fdfa4e78c123b0
2019-08-27 20:37:28,672 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:37:29,804 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:37:29,804 - dodox_01907302051 - INFO - workflowid:86b1ff893c16e67d27fdfa4e78c123b0
2019-08-27 20:37:30,938 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df'
2019-08-27 20:37:30,939 - db - INFO - update  public.task_info set wfid='86b1ff893c16e67d27fdfa4e78c123b0',status='up',scriptid='AWzTFL0TBZ1xJXgBM3bP' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df'
2019-08-27 20:37:30,941 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3700.44ms
2019-08-27 20:37:58,386 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df'
2019-08-27 20:37:58,387 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 60.69ms
2019-08-27 20:38:10,403 - db - INFO - select * from public.task_info where wfid = '20054569792e18aeb2c979fa7af2e58a'
2019-08-27 20:38:10,404 - db - INFO - update  public.task_info set status='down' where wfid='20054569792e18aeb2c979fa7af2e58a'
2019-08-27 20:38:11,562 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1158.74ms
2019-08-27 20:38:18,398 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df'
2019-08-27 20:38:18,468 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:38:18,528 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.log', 'gonganju_txt_ods.base_syrk_t_gl_jzdz_df', 'dsjzx.base_syrk_t_gl_jzdz_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_syrk_t_gl_jzdz_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_syrk_t_gl_jzdz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_syrk_t_gl_jzdz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_syrk_t_gl_jzdz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_syrk_t_gl_jzdz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_syrk_t_gl_jzdz_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_gl_jzdz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_gl_jzdz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_gl_jzdz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt' into table gonganju_txt_ods.base_syrk_t_gl_jzdz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_syrk_t_gl_jzdz_df (gmsfhm,jzdz_xzqhdm,jzdz_lmdm,jzdz_mlph,jzdz_dzmc,zsqkdm,cjrxm,cjrzjhm,cjrlxfs,cjrdwdm,cjsj,rid,id,sjlybz,babz,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select gmsfhm,jzdz_xzqhdm,jzdz_lmdm,jzdz_mlph,jzdz_dzmc,zsqkdm,cjrxm,cjrzjhm,cjrlxfs,cjrdwdm,cjsj,rid,id,sjlybz,babz,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_syrk_t_gl_jzdz_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_syrk_t_gl_jzdz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_syrk_t_gl_jzdz_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.py"}}

2019-08-27 20:38:18,528 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:38:18,688 - dodox_01907302051 - INFO - AWzTFYS1BZ1xJXgBM3bY
2019-08-27 20:38:19,795 - dodox_01907302051 - INFO - bb734dd6cb6568fc1ac04751fb51ab01
2019-08-27 20:38:19,795 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:38:21,000 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:38:21,000 - dodox_01907302051 - INFO - workflowid:bb734dd6cb6568fc1ac04751fb51ab01
2019-08-27 20:38:22,158 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df'
2019-08-27 20:38:22,158 - db - INFO - update  public.task_info set wfid='bb734dd6cb6568fc1ac04751fb51ab01',status='up',scriptid='AWzTFYS1BZ1xJXgBM3bY' where workflowname='gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df'
2019-08-27 20:38:22,160 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3824.28ms
2019-08-27 20:40:57,874 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shlg_t_hotel_df'
2019-08-27 20:40:57,876 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 72.99ms
2019-08-27 20:41:09,514 - db - INFO - select * from public.task_info where wfid = '09f9ca5f94a519ef26f0f5c7586982ed'
2019-08-27 20:41:09,515 - db - INFO - update  public.task_info set status='down' where wfid='09f9ca5f94a519ef26f0f5c7586982ed'
2019-08-27 20:41:10,706 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1192.73ms
2019-08-27 20:41:16,663 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shlg_t_hotel_df'
2019-08-27 20:41:16,758 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:41:16,819 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.log', 'gonganju_txt_ods.base_shlg_t_hotel_df', 'dsjzx.base_shlg_t_hotel_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_shlg_t_hotel_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_shlg_t_hotel_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_shlg_t_hotel_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_shlg_t_hotel_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_shlg_t_hotel_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_shlg_t_hotel_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_shlg_t_hotel_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shlg_t_hotel_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shlg_t_hotel_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt' into table gonganju_txt_ods.base_shlg_t_hotel_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_shlg_t_hotel_df (h_lvguandaima,h_lvguanmingcheng,h_farenmingcheng,h_lvguanzongjingli,h_lvguanzhianzerenren,h_xiangzhi,h_lvguanlianxidianhua,h_baoanbudianhua,h_zhuangtai,h_zhuangtaigaibianriqi,h_zhuangtaigaibianriqi_dt,h_fangjianshu,h_chuangweishu,h_lvguanxingji,h_lvguandengji,h_sno,stationid,recordsno,h_paichusuodm,h_paichusuo,h_mnemonic,h_zhycscsj,deip_time,deip_update_time,h_dianzhao,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select h_lvguandaima,h_lvguanmingcheng,h_farenmingcheng,h_lvguanzongjingli,h_lvguanzhianzerenren,h_xiangzhi,h_lvguanlianxidianhua,h_baoanbudianhua,h_zhuangtai,h_zhuangtaigaibianriqi,h_zhuangtaigaibianriqi_dt,h_fangjianshu,h_chuangweishu,h_lvguanxingji,h_lvguandengji,h_sno,stationid,recordsno,h_paichusuodm,h_paichusuo,h_mnemonic,h_zhycscsj,deip_time,deip_update_time,h_dianzhao,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_shlg_t_hotel_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_shlg_t_hotel_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_shlg_t_hotel_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.py"}}

2019-08-27 20:41:16,820 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:41:17,024 - dodox_01907302051 - INFO - AWzTGD0zBZ1xJXgBM3bj
2019-08-27 20:41:18,112 - dodox_01907302051 - INFO - 6caab38e499416c673fef6b1a8a583dc
2019-08-27 20:41:18,112 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:41:19,302 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:41:19,303 - dodox_01907302051 - INFO - workflowid:6caab38e499416c673fef6b1a8a583dc
2019-08-27 20:41:20,446 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shlg_t_hotel_df'
2019-08-27 20:41:20,447 - db - INFO - update  public.task_info set wfid='6caab38e499416c673fef6b1a8a583dc',status='up',scriptid='AWzTGD0zBZ1xJXgBM3bj' where workflowname='gonganju_8_103_dsjzx_base_shlg_t_hotel_df'
2019-08-27 20:41:20,449 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3855.60ms
2019-08-27 20:43:35,529 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df'
2019-08-27 20:43:35,531 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 1877.08ms
2019-08-27 20:43:36,292 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df'
2019-08-27 20:43:36,293 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 66.12ms
2019-08-27 20:43:44,040 - db - INFO - select * from public.task_info where wfid = '816a257a72e3ae17a2ed967f3bf37869'
2019-08-27 20:43:44,041 - db - INFO - update  public.task_info set status='down' where wfid='816a257a72e3ae17a2ed967f3bf37869'
2019-08-27 20:43:45,215 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1175.44ms
2019-08-27 20:43:48,037 - db - INFO - select * from public.task_info where wfid = '297fcf31f9a2059f17fb36831117d0b3'
2019-08-27 20:43:48,038 - db - INFO - update  public.task_info set status='down' where wfid='297fcf31f9a2059f17fb36831117d0b3'
2019-08-27 20:43:49,258 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1221.45ms
2019-08-27 20:43:54,493 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df'
2019-08-27 20:43:54,584 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:43:54,627 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.log', 'gonganju_txt_ods.base_shjz_t_wxwp_jdzgz_df', 'dsjzx.base_shjz_t_wxwp_jdzgz_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_shjz_t_wxwp_jdzgz_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_shjz_t_wxwp_jdzgz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt' into table gonganju_txt_ods.base_shjz_t_wxwp_jdzgz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_shjz_t_wxwp_jdzgz_df (dwmc,xsdw,pzbh,gmjbrxm,jbrgmsfhm1,xsjbrxm,jbrgmsfhm2,xsfzrxm,yxrq,bz,tbr,tbrq,pcsbm,rksj,cjrjh,cjrxm,cjsj,zxrq,zxyy,zxcjsj,zxcjrxm,zxcjrjh,id,zxflag,hid,fzjg,zghxpmc,isdr,zxlx,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select dwmc,xsdw,pzbh,gmjbrxm,jbrgmsfhm1,xsjbrxm,jbrgmsfhm2,xsfzrxm,yxrq,bz,tbr,tbrq,pcsbm,rksj,cjrjh,cjrxm,cjsj,zxrq,zxyy,zxcjsj,zxcjrxm,zxcjrjh,id,zxflag,hid,fzjg,zghxpmc,isdr,zxlx,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_shjz_t_wxwp_jdzgz_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_shjz_t_wxwp_jdzgz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_shjz_t_wxwp_jdzgz_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.py"}}

2019-08-27 20:43:54,628 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:43:54,792 - dodox_01907302051 - INFO - AWzTGqWZBZ1xJXgBM3b6
2019-08-27 20:43:55,887 - dodox_01907302051 - INFO - 8cf741919d99e14df1dd7c2532ffb2b9
2019-08-27 20:43:55,887 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:43:57,036 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:43:57,036 - dodox_01907302051 - INFO - workflowid:8cf741919d99e14df1dd7c2532ffb2b9
2019-08-27 20:43:58,177 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df'
2019-08-27 20:43:58,178 - db - INFO - update  public.task_info set wfid='8cf741919d99e14df1dd7c2532ffb2b9',status='up',scriptid='AWzTGqWZBZ1xJXgBM3b6' where workflowname='gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df'
2019-08-27 20:43:58,180 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3745.38ms
2019-08-27 20:46:35,000 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df'
2019-08-27 20:46:35,004 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 102.22ms
2019-08-27 20:46:44,714 - db - INFO - select * from public.task_info where wfid = '38873ff55f25b67c0049a511196f82a5'
2019-08-27 20:46:44,714 - db - INFO - update  public.task_info set status='down' where wfid='38873ff55f25b67c0049a511196f82a5'
2019-08-27 20:46:45,990 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1276.73ms
Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1Njc0NzUwNzcsImlhdCI6MTU2Njg3MDI3NywiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.arjmsY-9I97qm8P3qV-f1r74XG__B2oWOXFcA9c-x1z4N5LU1zDXNlAe05gYV9OyTIPyBrxV-iu-Pxasw6xudfqqRi4o5aKrYVpyV-Axt7BEK7Pt6ZR0rsQm5Z4xsG0Zb0egEyxDVlS9-V0vFJbO2SxEJUQU_ZYFemb-Pmiz-Um3yqD5rXw0A5ieaLkEWcEwQ5Co97Mz37mW6LPSANVGskGm7A5_HxSeLi7jEfqst2ZkiyCD7MyF_95n0Sx25hvPY7aIRN1sG3ukN_gthY3qEEaQNUTf-_UqlLmT2hAof_kY5clPvfnZPR-TvP9hSSfaFYEO3dTCp9UuCK30H1cA_lABUY8NOmLN2g-ds8pkzyrNlRVDm839-0HuKhFfKebBfA767Dknmab9tnGw7XqpZdJmyT6ZSZUjC5YD7HTLpKHkntKqxFjXFiRZQ09uNWt6bIB56wkctN5fsZpzSDcQswBo7h1CPLT_ea50MxNJ-RWlIxihXZbebxXbX0Hdu36xTfb8xi3VLdXpDMBHj0MnnglmbGSBqcfd7a82xeeGZyiGchvvA12dUHx_r1u1FmiQt-sqOM-GfN4k_jo4bjT6egDH3ZVPl4ow1S5r7UDC8yEo6MkNEn9gTzo_Qk7xvziX6QTIGtGLW88E109pWnhjf1cUcHCFwmXb8azDkVw6drc
('1111111111', u'dsjzx.base_jjlhy_drivinglicense_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_jjlhy_drivinglicense_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_jgxw_check_action')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_jgxw_check_action')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_jgxw_force_action')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_jgxw_force_action')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_jgxw_other_action')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_jgxw_other_action')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_jjlhy_drivinglicense_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_jjlhy_drivinglicense_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_jgxw_punish_action')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_jgxw_punish_action')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_zfk_user_info')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.jg_zfk_user_info')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_jjlhy_drivinglicense_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_crjdata_ry_czjwryjbxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_crjdata_ry_czjwryjbxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_crjdata_ryxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_crjdata_ryxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_jjlhy_drv_logout_di')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_jjlhy_drv_logout_di')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_syrk_t_zp_edz_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_syrk_t_zp_edz_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_crjdata_twtbsqxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_crjdata_twtbsqxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_syrk_t_rjbxx_xjcj_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_syrk_t_rjbxx_xjcj_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_syrk_t_rjbxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_syrk_t_rjbxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_crjdata_zjblxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_crjdata_zjblxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_jjlhy_drv_vehicletype_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_jjlhy_drv_vehicletype_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_jjlhy_drv_vehicletype_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_syrk_t_gl_jzdz_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_syrk_t_gl_jzdz_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_shlg_t_hotel_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_shlg_t_hotel_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_shjz_t_wxwp_jdzgz_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_czrk_t3_rk_hjbxx_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_shjz_t_wxwp_jdzgz_df')
('222222222', 'dsjzx')
('1111111111', u'dsjzx.base_shjz_t_wxwp_jdgmpz_df')
('222222222', 'dsjzx')
('1111111111', u2019-08-27 20:46:51,421 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df'
2019-08-27 20:46:51,519 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:46:51,581 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.log', 'gonganju_txt_ods.base_shjz_t_wxwp_jdgmpz_df', 'dsjzx.base_shjz_t_wxwp_jdgmpz_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_shjz_t_wxwp_jdgmpz_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_shjz_t_wxwp_jdgmpz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt' into table gonganju_txt_ods.base_shjz_t_wxwp_jdgmpz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_shjz_t_wxwp_jdgmpz_df (gmpzbh,zghxpmc,dwmc,dwszdlm,dwszdxz,dwdh,frdb,fzjg,fzrq,gmjbrxm,jbrgmsfhm,bz,tbr,tbrq,pcsbm,rksj,cjrjh,cjrxm,cjsj,zxrq,zxyy,zxcjsj,zxcjrxm,zxcjrjh,id,zxflag,hid,isdr,zxlx,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select gmpzbh,zghxpmc,dwmc,dwszdlm,dwszdxz,dwdh,frdb,fzjg,fzrq,gmjbrxm,jbrgmsfhm,bz,tbr,tbrq,pcsbm,rksj,cjrjh,cjrxm,cjsj,zxrq,zxyy,zxcjsj,zxcjrxm,zxcjrjh,id,zxflag,hid,isdr,zxlx,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_shjz_t_wxwp_jdgmpz_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_shjz_t_wxwp_jdgmpz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_shjz_t_wxwp_jdgmpz_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.py"}}

2019-08-27 20:46:51,581 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:46:51,779 - dodox_01907302051 - INFO - AWzTHVjZBZ1xJXgBM3cI
2019-08-27 20:46:52,873 - dodox_01907302051 - INFO - 4c551093458c0c79e5a7d015465ebfa7
2019-08-27 20:46:52,873 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:46:54,017 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:46:54,018 - dodox_01907302051 - INFO - workflowid:4c551093458c0c79e5a7d015465ebfa7
2019-08-27 20:46:55,149 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df'
2019-08-27 20:46:55,150 - db - INFO - update  public.task_info set wfid='4c551093458c0c79e5a7d015465ebfa7',status='up',scriptid='AWzTHVjZBZ1xJXgBM3cI' where workflowname='gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df'
2019-08-27 20:46:55,152 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3793.31ms
2019-08-27 20:49:17,693 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df'
2019-08-27 20:49:17,696 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 184.41ms
2019-08-27 20:49:24,542 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_sb_a_kxx_df'
2019-08-27 20:49:24,543 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 620.68ms
2019-08-27 20:49:37,402 - db - INFO - select * from public.task_info where wfid = 'c42e17e9d8c858209757191006789021'
2019-08-27 20:49:37,402 - db - INFO - update  public.task_info set status='down' where wfid='c42e17e9d8c858209757191006789021'
2019-08-27 20:49:38,610 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1208.33ms
2019-08-27 20:49:44,160 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_sb_a_kxx_df'
2019-08-27 20:49:44,337 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:49:44,416 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_sb_a_kxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_sb_a_kxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_sb_a_kxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_sb_a_kxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_sb_a_kxx_df.log', 'gonganju_txt_ods.base_sb_a_kxx_df', 'dsjzx.base_sb_a_kxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_sb_a_kxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_sb_a_kxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_sb_a_kxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_sb_a_kxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_sb_a_kxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_sb_a_kxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_sb_a_kxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_sb_a_kxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_sb_a_kxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt' into table gonganju_txt_ods.base_sb_a_kxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_sb_a_kxx_df (klsh,zkrwh,zkzyh,nbgrwym,zjlx,zjhm,shbzhm,xm,xb,mz,csrq,gj,sjhm,lxdh,xzqh,tcq,dwbm,dwmc,yztdhm,zlwd,zdtddzyb,zdtddz,zksqwd2,slwdmc,dqkfbh,sbkh,ksbm,sbxpwlkh,fkrq,kyxq,zklx,klb,xh,hh,jzlb,gfbb,scbz,yhbm,yhkh,yhhm,khhhh,khhmc,yhjmctxx,khdcsjlsh,yhkzt,khsbyy,zkksrq,zkwcrq,kpzxyy,kplzzt,klx,slsj,lsgssj,zdjgsj,bz,sjlsh,bjryid,tdzt,tdzt_gxsj,zlwd_jssj,wdfksj,bhkbj,zdtddz_yznm,zlwd_yznm,txdz,txdz_yb,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select klsh,zkrwh,zkzyh,nbgrwym,zjlx,zjhm,shbzhm,xm,xb,mz,csrq,gj,sjhm,lxdh,xzqh,tcq,dwbm,dwmc,yztdhm,zlwd,zdtddzyb,zdtddz,zksqwd2,slwdmc,dqkfbh,sbkh,ksbm,sbxpwlkh,fkrq,kyxq,zklx,klb,xh,hh,jzlb,gfbb,scbz,yhbm,yhkh,yhhm,khhhh,khhmc,yhjmctxx,khdcsjlsh,yhkzt,khsbyy,zkksrq,zkwcrq,kpzxyy,kplzzt,klx,slsj,lsgssj,zdjgsj,bz,sjlsh,bjryid,tdzt,tdzt_gxsj,zlwd_jssj,wdfksj,bhkbj,zdtddz_yznm,zlwd_yznm,txdz,txdz_yb,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_sb_a_kxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_sb_a_kxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_sb_a_kxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_sb_a_kxx_df.py"}}

2019-08-27 20:49:44,417 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:49:44,670 - dodox_01907302051 - INFO - AWzTH_wBBZ1xJXgBM3cW
2019-08-27 20:49:45,814 - dodox_01907302051 - INFO - b9d1d7da60e7f9f73f53b2487449c333
2019-08-27 20:49:45,814 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:49:46,997 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:49:46,997 - dodox_01907302051 - INFO - workflowid:b9d1d7da60e7f9f73f53b2487449c333
2019-08-27 20:49:48,275 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_sb_a_kxx_df'
2019-08-27 20:49:48,275 - db - INFO - update  public.task_info set wfid='b9d1d7da60e7f9f73f53b2487449c333',status='up',scriptid='AWzTH_wBBZ1xJXgBM3cW' where workflowname='gonganju_8_103_dsjzx_base_sb_a_kxx_df'
2019-08-27 20:49:48,278 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 4306.77ms
2019-08-27 20:49:48,279 - db - INFO - select * from public.task_info where wfid = '17133d856316c5689bc52fef28ad0fc4'
2019-08-27 20:49:48,280 - db - INFO - update  public.task_info set status='down' where wfid='17133d856316c5689bc52fef28ad0fc4'
2019-08-27 20:49:49,504 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1225.62ms
2019-08-27 20:49:52,772 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df'
2019-08-27 20:49:52,852 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:49:52,908 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.log', 'gonganju_txt_ods.base_jjlhy_t_acd_dutysimple_df', 'dsjzx.base_jjlhy_t_acd_dutysimple_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_t_acd_dutysimple_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_t_acd_dutysimple_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt' into table gonganju_txt_ods.base_jjlhy_t_acd_dutysimple_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_t_acd_dutysimple_df (djbh,sgbh,xzqh,xq,xqmc,sgfssj,lh,lm,gls,ms,jdwz,sgdd,ssrs,zjccss,lwsglx,rdyyfl,rdyyflmc,sgrdyy,sgrdyymc,tq,tqmc,xc,swsg,sgxt,sgxtmc,cljsg,dcsg,pzfs,lbqk,tjr1,cclrsj,jllx,scsjd,sszd,sszdmc,dah,sb,tjsgbh,glbm,dzzb,badw,wsbh,sgss,zrtjjg,jar1,jar2,jbr,gxsj,jyw,jafs,dllx,dllxmc,glxzdj,tjfs,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select djbh,sgbh,xzqh,xq,xqmc,sgfssj,lh,lm,gls,ms,jdwz,sgdd,ssrs,zjccss,lwsglx,rdyyfl,rdyyflmc,sgrdyy,sgrdyymc,tq,tqmc,xc,swsg,sgxt,sgxtmc,cljsg,dcsg,pzfs,lbqk,tjr1,cclrsj,jllx,scsjd,sszd,sszdmc,dah,sb,tjsgbh,glbm,dzzb,badw,wsbh,sgss,zrtjjg,jar1,jar2,jbr,gxsj,jyw,jafs,dllx,dllxmc,glxzdj,tjfs,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_t_acd_dutysimple_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_t_acd_dutysimple_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_t_acd_dutysimple_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.py"}}

2019-08-27 20:49:52,908 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:49:53,097 - dodox_01907302051 - INFO - AWzTIB0pBZ1xJXgBM3cg
2019-08-27 20:49:54,205 - dodox_01907302051 - INFO - cf43bc8a69a8962a25ba98619f6931fc
2019-08-27 20:49:54,205 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:49:55,319 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:49:55,320 - dodox_01907302051 - INFO - workflowid:cf43bc8a69a8962a25ba98619f6931fc
2019-08-27 20:49:56,475 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df'
2019-08-27 20:49:56,476 - db - INFO - update  public.task_info set wfid='cf43bc8a69a8962a25ba98619f6931fc',status='up',scriptid='AWzTIB0pBZ1xJXgBM3cg' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df'
2019-08-27 20:49:56,478 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3767.61ms
2019-08-27 20:51:51,560 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df'
2019-08-27 20:51:51,668 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:51:51,728 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.log', 'gonganju_txt_ods.base_czrk_t3_rk_hjbxx_df', 'dsjzx.base_czrk_t3_rk_hjbxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_czrk_t3_rk_hjbxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_czrk_t3_rk_hjbxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_czrk_t3_rk_hjbxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_czrk_t3_rk_hjbxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt' into table gonganju_txt_ods.base_czrk_t3_rk_hjbxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_czrk_t3_rk_hjbxx_df (hid,mnpid,pcsbm,hh,hb,hbhz,jlh,zzlmhz,zzxz,mlph,mlph2,jlsj,jlsj_dt,zxsj,zxsj_dt,ch,xhhkbbh,hsxkzw,jwh,hzid,hzsfzhm,hzxm,hzxb,xxztbz,sjsbxxtqbs,sjsbxxtq,sjhzbs,sjhzsj,slywbm,hzcsrq,hzcsrq_dt,hjywlx,zxbdyy,zxbdyyhz,qybs,ph,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,pcsmc,jlhmc,hzxbmc,hjywlxmc,zxbdyymc,dt,jhpt_update_time,jhpt_delete) select hid,mnpid,pcsbm,hh,hb,hbhz,jlh,zzlmhz,zzxz,mlph,mlph2,jlsj,jlsj_dt,zxsj,zxsj_dt,ch,xhhkbbh,hsxkzw,jwh,hzid,hzsfzhm,hzxm,hzxb,xxztbz,sjsbxxtqbs,sjsbxxtq,sjhzbs,sjhzsj,slywbm,hzcsrq,hzcsrq_dt,hjywlx,zxbdyy,zxbdyyhz,qybs,ph,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,pcsmc,jlhmc,hzxbmc,hjywlxmc,zxbdyymc,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_czrk_t3_rk_hjbxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_czrk_t3_rk_hjbxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_czrk_t3_rk_hjbxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.py"}}

2019-08-27 20:51:51,728 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:51:51,953 - dodox_01907302051 - INFO - AWzTIe1YBZ1xJXgBM3co
2019-08-27 20:51:53,057 - dodox_01907302051 - INFO - 5b674acd8c09783f2766fb2a862bc385
2019-08-27 20:51:53,057 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:51:54,197 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:51:54,197 - dodox_01907302051 - INFO - workflowid:5b674acd8c09783f2766fb2a862bc385
2019-08-27 20:51:55,333 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df'
2019-08-27 20:51:55,334 - db - INFO - update  public.task_info set wfid='5b674acd8c09783f2766fb2a862bc385',status='up',scriptid='AWzTIe1YBZ1xJXgBM3co' where workflowname='gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df'
2019-08-27 20:51:55,335 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3844.68ms
2019-08-27 20:51:55,402 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df'
2019-08-27 20:51:55,404 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 67.38ms
2019-08-27 20:52:06,871 - db - INFO - select * from public.task_info where wfid = 'e9f5900005399448e74c79eacdefd17c'
2019-08-27 20:52:06,872 - db - INFO - update  public.task_info set status='down' where wfid='e9f5900005399448e74c79eacdefd17c'
2019-08-27 20:52:08,044 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1173.44ms
2019-08-27 20:52:12,501 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df'
2019-08-27 20:52:12,590 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:52:12,661 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.log', 'gonganju_txt_ods.base_rkb_czrk_t_t3_rk_xmbgb_df', 'dsjzx.base_rkb_czrk_t_t3_rk_xmbgb_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_rkb_czrk_t_t3_rk_xmbgb_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt' into table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_xmbgb_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_rkb_czrk_t_t3_rk_xmbgb_df (id,bgrh,hid,sfzhm,xm,hkszdhh,hkszdxzqh,hkszdpcs,hkszdjwh,bgxm,bgqnr,bghnr,bgrq,sjsbxxtqbs,sjsbxxtq,sjhzbs,sjhzsj,slywbm,ph,slrxm,bgyy,xbdm,xb,mzdm,mz,csrq,rkxxbggzlbdm,zaglxxlbdm,xxlbmc,bggzsjxbsf,bggzsjxmc,sbr_gmsfhm,sbr_xm,sbr_ycsrgx_jtgxdm,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select id,bgrh,hid,sfzhm,xm,hkszdhh,hkszdxzqh,hkszdpcs,hkszdjwh,bgxm,bgqnr,bghnr,bgrq,sjsbxxtqbs,sjsbxxtq,sjhzbs,sjhzsj,slywbm,ph,slrxm,bgyy,xbdm,xb,mzdm,mz,csrq,rkxxbggzlbdm,zaglxxlbdm,xxlbmc,bggzsjxbsf,bggzsjxmc,sbr_gmsfhm,sbr_xm,sbr_ycsrgx_jtgxdm,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_rkb_czrk_t_t3_rk_xmbgb_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_xmbgb_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_rkb_czrk_t_t3_rk_xmbgb_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.py"}}

2019-08-27 20:52:12,661 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:52:12,861 - dodox_01907302051 - INFO - AWzTIj8TBZ1xJXgBM3c1
2019-08-27 20:52:13,975 - dodox_01907302051 - INFO - e02462062efd4925acedd3e24e2932d8
2019-08-27 20:52:13,976 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:52:15,122 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:52:15,122 - dodox_01907302051 - INFO - workflowid:e02462062efd4925acedd3e24e2932d8
2019-08-27 20:52:16,266 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df'
2019-08-27 20:52:16,267 - db - INFO - update  public.task_info set wfid='e02462062efd4925acedd3e24e2932d8',status='up',scriptid='AWzTIj8TBZ1xJXgBM3c1' where workflowname='gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df'
2019-08-27 20:52:16,269 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3833.32ms
2019-08-27 20:56:52,440 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df'
2019-08-27 20:56:52,442 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 88.57ms
2019-08-27 20:57:02,740 - db - INFO - select * from public.task_info where wfid = 'fdac0ededa501731d716d006dd6f5a61'
2019-08-27 20:57:02,740 - db - INFO - update  public.task_info set status='down' where wfid='fdac0ededa501731d716d006dd6f5a61'
2019-08-27 20:57:03,937 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1198.17ms
2019-08-27 20:57:07,276 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df'
2019-08-27 20:57:07,358 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:57:07,427 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.log', 'gonganju_txt_ods.base_jjlhy_veh_ownermodify_df', 'dsjzx.base_jjlhy_veh_ownermodify_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_veh_ownermodify_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_veh_ownermodify_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_veh_ownermodify_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_veh_ownermodify_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_veh_ownermodify_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_veh_ownermodify_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_veh_ownermodify_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_veh_ownermodify_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_veh_ownermodify_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt' into table gonganju_txt_ods.base_jjlhy_veh_ownermodify_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_veh_ownermodify_df (xh,hpzldm,hpzl,hphm,ysyr,sfzmmc,sfzmhm,yxzqhdm,yxzqh,yxxdz,yyzbm,ylxdh,yhdfs,ysyxz,yxsdw,yxsjg,yhpzldm,yhpzl,yhphm,yglxq,jcjgzms,xgzl,bgrq,jbr,fzjg,lsh,yllpz1,ypzbh1,yllpz2,ypzbh2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,hpzldm,hpzl,hphm,ysyr,sfzmmc,sfzmhm,yxzqhdm,yxzqh,yxxdz,yyzbm,ylxdh,yhdfs,ysyxz,yxsdw,yxsjg,yhpzldm,yhpzl,yhphm,yglxq,jcjgzms,xgzl,bgrq,jbr,fzjg,lsh,yllpz1,ypzbh1,yllpz2,ypzbh2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_veh_ownermodify_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_veh_ownermodify_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_veh_ownermodify_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.py"}}

2019-08-27 20:57:07,427 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:57:07,609 - dodox_01907302051 - INFO - AWzTJr6DBZ1xJXgBM3dP
2019-08-27 20:57:08,718 - dodox_01907302051 - INFO - be153c18ead4a5d652480549ce350bbd
2019-08-27 20:57:08,718 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:57:09,854 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:57:09,854 - dodox_01907302051 - INFO - workflowid:be153c18ead4a5d652480549ce350bbd
2019-08-27 20:57:11,012 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df'
2019-08-27 20:57:11,012 - db - INFO - update  public.task_info set wfid='be153c18ead4a5d652480549ce350bbd',status='up',scriptid='AWzTJr6DBZ1xJXgBM3dP' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df'
2019-08-27 20:57:11,014 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3810.34ms
2019-08-27 20:58:03,007 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df'
2019-08-27 20:58:03,009 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 1021.62ms
2019-08-27 20:58:10,751 - db - INFO - select * from public.task_info where wfid = '5b3e17e10413cedc324d2b68e57cabfe'
2019-08-27 20:58:10,751 - db - INFO - update  public.task_info set status='down' where wfid='5b3e17e10413cedc324d2b68e57cabfe'
2019-08-27 20:58:11,883 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1133.12ms
2019-08-27 20:58:17,791 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df'
2019-08-27 20:58:17,907 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 20:58:17,990 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.log', 'gonganju_txt_ods.base_czrk_t3_rk_jmswbzz_df', 'dsjzx.base_czrk_t3_rk_jmswbzz_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_czrk_t3_rk_jmswbzz_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_czrk_t3_rk_jmswbzz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt' into table gonganju_txt_ods.base_czrk_t3_rk_jmswbzz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_czrk_t3_rk_jmswbzz_df (pcsbh,szxm,sfzbh,swyxzmsbh,swyydm,swyyhz,swrq,jsxm,jsdz,yxqc,yxqz,qfr,qfrq,qyph,rid,ytclddmc,ytcldd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select pcsbh,szxm,sfzbh,swyxzmsbh,swyydm,swyyhz,swrq,jsxm,jsdz,yxqc,yxqz,qfr,qfrq,qyph,rid,ytclddmc,ytcldd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_czrk_t3_rk_jmswbzz_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_czrk_t3_rk_jmswbzz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_czrk_t3_rk_jmswbzz_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.py"}}

2019-08-27 20:58:17,990 - dodox_01907302051 - INFO - Upload Success
2019-08-27 20:58:18,228 - dodox_01907302051 - INFO - AWzTJ9IwBZ1xJXgBM3db
2019-08-27 20:58:19,378 - dodox_01907302051 - INFO - ca49bd6d7d67bc6781b397cc14257ae7
2019-08-27 20:58:19,378 - dodox_01907302051 - INFO - workflow success
2019-08-27 20:58:20,564 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 20:58:20,565 - dodox_01907302051 - INFO - workflowid:ca49bd6d7d67bc6781b397cc14257ae7
2019-08-27 20:58:21,798 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df'
2019-08-27 20:58:21,798 - db - INFO - update  public.task_info set wfid='ca49bd6d7d67bc6781b397cc14257ae7',status='up',scriptid='AWzTJ9IwBZ1xJXgBM3db' where workflowname='gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df'
2019-08-27 20:58:21,801 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 4337.29ms
2019-08-27 21:03:06,812 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df'
2019-08-27 21:03:06,818 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 103.40ms
2019-08-27 21:03:14,009 - db - INFO - select * from public.task_info where wfid = 'a0ed45f711ab81de87831dcb86791049'
2019-08-27 21:03:14,010 - db - INFO - update  public.task_info set status='down' where wfid='a0ed45f711ab81de87831dcb86791049'
2019-08-27 21:03:15,190 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1181.51ms
2019-08-27 21:03:18,746 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df'
2019-08-27 21:03:18,846 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:03:18,905 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.log', 'gonganju_txt_ods.base_czrk_t3_rk_swzxxx_df', 'dsjzx.base_czrk_t3_rk_swzxxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_czrk_t3_rk_swzxxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_czrk_t3_rk_swzxxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_czrk_t3_rk_swzxxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_czrk_t3_rk_swzxxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt' into table gonganju_txt_ods.base_czrk_t3_rk_swzxxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_czrk_t3_rk_swzxxx_df (rid,hid,mnpid,hkszdpcs,pcsmc,sfzhm,xm,hkszdhh,hbdm,hbdmmc,yhb,yhzgx,yhzgxmc,xbdm,xb,csrq,whcddm,whcdmc,pzdw,pzdwmc,bdfx,bdfxmc,swzxlb,swzxlbmc,bdrq,bdsqbh,bdpcsbhdm,bdpcsbh,sfhbd,sfhbdmc,slrxm,slywbm,ph,bz,gmsfzsjyy,gmsfzsjyymc,hkszddz,hkszdmlph,hkszdmlph2,hkszdxzqhdm,hkszdxzqhdmmc,hkszdxzqh,jsdz,jsxm,mz,swdd,swrq,swzmbh,ytcldd,yxrqc,yxrqz,zzxz,ytclddmc,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,hid,mnpid,hkszdpcs,pcsmc,sfzhm,xm,hkszdhh,hbdm,hbdmmc,yhb,yhzgx,yhzgxmc,xbdm,xb,csrq,whcddm,whcdmc,pzdw,pzdwmc,bdfx,bdfxmc,swzxlb,swzxlbmc,bdrq,bdsqbh,bdpcsbhdm,bdpcsbh,sfhbd,sfhbdmc,slrxm,slywbm,ph,bz,gmsfzsjyy,gmsfzsjyymc,hkszddz,hkszdmlph,hkszdmlph2,hkszdxzqhdm,hkszdxzqhdmmc,hkszdxzqh,jsdz,jsxm,mz,swdd,swrq,swzmbh,ytcldd,yxrqc,yxrqz,zzxz,ytclddmc,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_czrk_t3_rk_swzxxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_czrk_t3_rk_swzxxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_czrk_t3_rk_swzxxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.py"}}

2019-08-27 21:03:18,905 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:03:19,078 - dodox_01907302051 - INFO - AWzTLGmPBZ1xJXgBM3dr
2019-08-27 21:03:20,168 - dodox_01907302051 - INFO - 3ef4f221e120b522adc15e8f158b4d8c
2019-08-27 21:03:20,168 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:03:21,290 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:03:21,291 - dodox_01907302051 - INFO - workflowid:3ef4f221e120b522adc15e8f158b4d8c
2019-08-27 21:03:22,431 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df'
2019-08-27 21:03:22,432 - db - INFO - update  public.task_info set wfid='3ef4f221e120b522adc15e8f158b4d8c',status='up',scriptid='AWzTLGmPBZ1xJXgBM3dr' where workflowname='gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df'
2019-08-27 21:03:22,434 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3744.78ms
2019-08-27 21:08:16,756 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_vehicle_df'
2019-08-27 21:08:16,760 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 77.73ms
2019-08-27 21:08:27,542 - db - INFO - select * from public.task_info where wfid = '7ea5d9da58d301e64d46607105b7af98'
2019-08-27 21:08:27,543 - db - INFO - update  public.task_info set status='down' where wfid='7ea5d9da58d301e64d46607105b7af98'
2019-08-27 21:08:28,690 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1148.41ms
2019-08-27 21:08:32,941 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_vehicle_df'
2019-08-27 21:08:33,023 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:08:33,088 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.log', 'gonganju_txt_ods.base_jjlhy_vehicle_df', 'dsjzx.base_jjlhy_vehicle_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_vehicle_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_vehicle_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_vehicle_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_vehicle_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_vehicle_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_vehicle_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_vehicle_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_vehicle_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_vehicle_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt' into table gonganju_txt_ods.base_jjlhy_vehicle_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_vehicle_df (hpzl,hphm,clpp1,clxh,clpp2,gcjk,zzg,zzcmc,clsbdh,fdjh,cllx,csys,syxz,sfzmhm,sfzmmc,syr,syq,ccdjrq,ccdjrq_dt,djrq,djrq_dt,yxqz,yxqz_dt,qzbfqz,qzbfqz_dt,fzjg,glbm,fprq,fprq_dt,fzrq,fzrq_dt,fdjrq,fdjrq_dt,fhgzrq,fhgzrq_dt,bxzzrq,bxzzrq_dt,bpcs,bzcs,bdjcs,djzsbh,zdjzshs,dabh,xzqh,zt,dybj,jbr,clly,lsh,fdjxh,rlzl,pl,gl,zxxs,cwkc,cwkk,cwkg,hxnbcd,hxnbkd,hxnbgd,gbthps,zs,zj,qlj,hlj,ltgg,lts,zzl,zbzl,hdzzl,hdzk,zqyzl,qpzk,hpzk,hbdbqk,ccrq,ccrq_dt,hdfs,llpz1,pzbh1,llpz2,pzbh2,xsdw,xsjg,xsrq,xsrq_dt,jkpz,jkpzhm,hgzbh,nszm,nszmbh,gxrq,gxrq_dt,xgzl,qmbh,hmbh,bz,jyw,zsxzqh,zsxxdz,yzbm1,lxdh,zzz,zzxzqh,zzxxdz,yzbm2,zdyzt,yxh,cyry,dphgzbh,sqdm,clyt,ytsx,dzyx,xszbh,sjhm,jyhgbzbh,dwbh,syqsrq,syqsrq_dt,yqjyqzbfqz,yqjyqz2,fdjgs,sfyzhgn,zzjglx,wxmbc,ncdqsy,hpqysj,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dzbsxlh,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select hpzl,hphm,clpp1,clxh,clpp2,gcjk,zzg,zzcmc,clsbdh,fdjh,cllx,csys,syxz,sfzmhm,sfzmmc,syr,syq,ccdjrq,ccdjrq_dt,djrq,djrq_dt,yxqz,yxqz_dt,qzbfqz,qzbfqz_dt,fzjg,glbm,fprq,fprq_dt,fzrq,fzrq_dt,fdjrq,fdjrq_dt,fhgzrq,fhgzrq_dt,bxzzrq,bxzzrq_dt,bpcs,bzcs,bdjcs,djzsbh,zdjzshs,dabh,xzqh,zt,dybj,jbr,clly,lsh,fdjxh,rlzl,pl,gl,zxxs,cwkc,cwkk,cwkg,hxnbcd,hxnbkd,hxnbgd,gbthps,zs,zj,qlj,hlj,ltgg,lts,zzl,zbzl,hdzzl,hdzk,zqyzl,qpzk,hpzk,hbdbqk,ccrq,ccrq_dt,hdfs,llpz1,pzbh1,llpz2,pzbh2,xsdw,xsjg,xsrq,xsrq_dt,jkpz,jkpzhm,hgzbh,nszm,nszmbh,gxrq,gxrq_dt,xgzl,qmbh,hmbh,bz,jyw,zsxzqh,zsxxdz,yzbm1,lxdh,zzz,zzxzqh,zzxxdz,yzbm2,zdyzt,yxh,cyry,dphgzbh,sqdm,clyt,ytsx,dzyx,xszbh,sjhm,jyhgbzbh,dwbh,syqsrq,syqsrq_dt,yqjyqzbfqz,yqjyqz2,fdjgs,sfyzhgn,zzjglx,wxmbc,ncdqsy,hpqysj,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dzbsxlh,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_vehicle_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_vehicle_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_vehicle_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.py"}}

2019-08-27 21:08:33,088 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:08:33,252 - dodox_01907302051 - INFO - AWzTMTTUBZ1xJXgBM3eA
2019-08-27 21:08:34,334 - dodox_01907302051 - INFO - 3aac27be7a3c7d138823e4965c051002
2019-08-27 21:08:34,334 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:08:35,466 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:08:35,466 - dodox_01907302051 - INFO - workflowid:3aac27be7a3c7d138823e4965c051002
2019-08-27 21:08:36,601 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_vehicle_df'
2019-08-27 21:08:36,602 - db - INFO - update  public.task_info set wfid='3aac27be7a3c7d138823e4965c051002',status='up',scriptid='AWzTMTTUBZ1xJXgBM3eA' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_vehicle_df'
2019-08-27 21:08:36,604 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3719.04ms
2019-08-27 21:08:44,061 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df'
2019-08-27 21:08:44,062 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 56.99ms
2019-08-27 21:08:51,155 - db - INFO - select * from public.task_info where wfid = '5a6c75dbbe632b5d6731b48495a14522'
2019-08-27 21:08:51,156 - db - INFO - update  public.task_info set status='down' where wfid='5a6c75dbbe632b5d6731b48495a14522'
2019-08-27 21:08:52,296 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1142.08ms
2019-08-27 21:09:02,981 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df'
2019-08-27 21:09:03,064 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:09:03,114 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.log', 'gonganju_txt_ods.base_czrk_t_t3_rk_edz_df', 'dsjzx.base_czrk_t_t3_rk_edz_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_czrk_t_t3_rk_edz_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_czrk_t_t3_rk_edz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_czrk_t_t3_rk_edz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_czrk_t_t3_rk_edz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_czrk_t_t3_rk_edz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_czrk_t_t3_rk_edz_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t_t3_rk_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t_t3_rk_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t_t3_rk_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt' into table gonganju_txt_ods.base_czrk_t_t3_rk_edz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_czrk_t_t3_rk_edz_df (rid,zjsfzhm,zjxm,zjxb,xbhz,zjmz,mzhz,zjcsrq,zjcsrq_dt,zjqfjg,zjyxqxqsrq,zjyxqxqsrq_dt,zjyxqxjzrq,zjyxqxjzrq_dt,zjaddr,zjktglh,zjaddr1,zjaddr2,zjaddr3,zjaddr4,czjq1,czktglh1,czrq1,czjq2,czktglh2,czrq2,czjq3,czktglh3,czrq3,czjq4,czktglh4,czrq4,zxsj,zxsj_dt,zxr,zxrjh,zxyy,zxpcsbh,ph,keyid,xxgxsj,xxgxsj_dt,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,zjsfzhm,zjxm,zjxb,xbhz,zjmz,mzhz,zjcsrq,zjcsrq_dt,zjqfjg,zjyxqxqsrq,zjyxqxqsrq_dt,zjyxqxjzrq,zjyxqxjzrq_dt,zjaddr,zjktglh,zjaddr1,zjaddr2,zjaddr3,zjaddr4,czjq1,czktglh1,czrq1,czjq2,czktglh2,czrq2,czjq3,czktglh3,czrq3,czjq4,czktglh4,czrq4,zxsj,zxsj_dt,zxr,zxrjh,zxyy,zxpcsbh,ph,keyid,xxgxsj,xxgxsj_dt,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_czrk_t_t3_rk_edz_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_czrk_t_t3_rk_edz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_czrk_t_t3_rk_edz_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.py"}}

2019-08-27 21:09:03,114 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:09:03,266 - dodox_01907302051 - INFO - AWzTMaofBZ1xJXgBM3eJ
2019-08-27 21:09:04,337 - dodox_01907302051 - INFO - 923dddba0e34e2e69da46df26ace8d27
2019-08-27 21:09:04,338 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:09:05,464 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:09:05,464 - dodox_01907302051 - INFO - workflowid:923dddba0e34e2e69da46df26ace8d27
2019-08-27 21:09:06,580 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df'
2019-08-27 21:09:06,581 - db - INFO - update  public.task_info set wfid='923dddba0e34e2e69da46df26ace8d27',status='up',scriptid='AWzTMaofBZ1xJXgBM3eJ' where workflowname='gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df'
2019-08-27 21:09:06,583 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3656.06ms
2019-08-27 21:16:37,376 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df'
2019-08-27 21:16:37,388 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 828.23ms
2019-08-27 21:16:43,916 - db - INFO - select * from public.task_info where wfid = '60b81399cec252906fbc15f78fa05446'
2019-08-27 21:16:43,920 - db - INFO - update  public.task_info set status='down' where wfid='60b81399cec252906fbc15f78fa05446'
2019-08-27 21:16:45,192 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1277.01ms
2019-08-27 21:16:49,941 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df'
2019-08-27 21:16:50,091 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:16:50,190 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.log', 'gonganju_txt_ods.base_fwdj_t_rhfl_bdb_df', 'dsjzx.base_fwdj_t_rhfl_bdb_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_fwdj_t_rhfl_bdb_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_fwdj_t_rhfl_bdb_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_fwdj_t_rhfl_bdb_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_fwdj_t_rhfl_bdb_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt' into table gonganju_txt_ods.base_fwdj_t_rhfl_bdb_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_fwdj_t_rhfl_bdb_df (hjdxzqhdm,hjdxzqhhz,hjdlmdm,hjdlmhz,hjdxz,jzdxzqhdm,jzdxzqhhz,jzdlmdm,jzdlmhz,jzdxz,hh,mlphxx,sh,zzjgdm,zzjghz,djrxm,djrq,djjgdm,djjgmc,djsj,bdrxm,bdrq,bdsj,bdjgdm,bdjgmc,fwbm,id,jzdpcsdm,jzdpcshz,xm,xbdm,xbhz,mzdm,mzhz,csrq,jgdm,jghz,zjhm,qdm,qmc,jddm,jdmc,jcwdm,jcwmc,jlxdm,jlxmc,mlph,xjgajgdm,xjgajgmc,pcsdm,pcsmc,yfzgxdm,yfzgxhz,flyydm,flyyhz,flsj,flag,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select hjdxzqhdm,hjdxzqhhz,hjdlmdm,hjdlmhz,hjdxz,jzdxzqhdm,jzdxzqhhz,jzdlmdm,jzdlmhz,jzdxz,hh,mlphxx,sh,zzjgdm,zzjghz,djrxm,djrq,djjgdm,djjgmc,djsj,bdrxm,bdrq,bdsj,bdjgdm,bdjgmc,fwbm,id,jzdpcsdm,jzdpcshz,xm,xbdm,xbhz,mzdm,mzhz,csrq,jgdm,jghz,zjhm,qdm,qmc,jddm,jdmc,jcwdm,jcwmc,jlxdm,jlxmc,mlph,xjgajgdm,xjgajgmc,pcsdm,pcsmc,yfzgxdm,yfzgxhz,flyydm,flyyhz,flsj,flag,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_fwdj_t_rhfl_bdb_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_fwdj_t_rhfl_bdb_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_fwdj_t_rhfl_bdb_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.py"}}

2019-08-27 21:16:50,190 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:16:50,432 - dodox_01907302051 - INFO - AWzTOMquBZ1xJXgBM3ek
2019-08-27 21:16:51,575 - dodox_01907302051 - INFO - 9d2d333cca6b9f8714f11a33bec6cf11
2019-08-27 21:16:51,575 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:16:52,706 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:16:52,706 - dodox_01907302051 - INFO - workflowid:9d2d333cca6b9f8714f11a33bec6cf11
2019-08-27 21:16:53,849 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df'
2019-08-27 21:16:53,850 - db - INFO - update  public.task_info set wfid='9d2d333cca6b9f8714f11a33bec6cf11',status='up',scriptid='AWzTOMquBZ1xJXgBM3ek' where workflowname='gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df'
2019-08-27 21:16:53,852 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 4083.45ms
2019-08-27 21:19:51,649 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df'
2019-08-27 21:19:51,651 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 85.50ms
2019-08-27 21:20:00,850 - db - INFO - select * from public.task_info where wfid = '8f1d055cc26bb9febf66a128b1decfe9'
2019-08-27 21:20:00,851 - db - INFO - update  public.task_info set status='down' where wfid='8f1d055cc26bb9febf66a128b1decfe9'
2019-08-27 21:20:02,020 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1170.51ms
2019-08-27 21:20:04,322 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df'
2019-08-27 21:20:04,406 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:20:04,462 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.log', 'gonganju_txt_ods.base_jzz_jzz_cardinfo_df', 'dsjzx.base_jzz_jzz_cardinfo_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jzz_jzz_cardinfo_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jzz_jzz_cardinfo_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jzz_jzz_cardinfo_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jzz_jzz_cardinfo_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jzz_jzz_cardinfo_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jzz_jzz_cardinfo_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_cardinfo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_cardinfo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_cardinfo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt' into table gonganju_txt_ods.base_jzz_jzz_cardinfo_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jzz_jzz_cardinfo_df (apptype,apptype_hz,regcode,chidcard,chname,sortcode,certinum,enrolid,cardid,atr,version,facedate,facedate_dt,validdate,validdate_dt,recokdate,reusenum,cardstatus,cardstatus_hz,cardstadate,statusunitcode,statusunitcode_hz,oprlattice,oprlattice_hz,confirmstatus,confirmdate,confirmdate_dt,latgetcard,latgetcard_hz,latgetdate,pergetdate,errorreason,timestamp,createtime,createtime_dt,reserved,updtuser,updttime,updttime_dt,policeid,policeid_hz,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select apptype,apptype_hz,regcode,chidcard,chname,sortcode,certinum,enrolid,cardid,atr,version,facedate,facedate_dt,validdate,validdate_dt,recokdate,reusenum,cardstatus,cardstatus_hz,cardstadate,statusunitcode,statusunitcode_hz,oprlattice,oprlattice_hz,confirmstatus,confirmdate,confirmdate_dt,latgetcard,latgetcard_hz,latgetdate,pergetdate,errorreason,timestamp,createtime,createtime_dt,reserved,updtuser,updttime,updttime_dt,policeid,policeid_hz,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jzz_jzz_cardinfo_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jzz_jzz_cardinfo_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jzz_jzz_cardinfo_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.py"}}

2019-08-27 21:20:04,462 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:20:04,627 - dodox_01907302051 - INFO - AWzTO8GHBZ1xJXgBM3et
2019-08-27 21:20:05,730 - dodox_01907302051 - INFO - 81e217a169d7aff7cb97f2bcb8ac3ba8
2019-08-27 21:20:05,730 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:20:06,877 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:20:06,877 - dodox_01907302051 - INFO - workflowid:81e217a169d7aff7cb97f2bcb8ac3ba8
2019-08-27 21:20:08,032 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df'
2019-08-27 21:20:08,033 - db - INFO - update  public.task_info set wfid='81e217a169d7aff7cb97f2bcb8ac3ba8',status='up',scriptid='AWzTO8GHBZ1xJXgBM3et' where workflowname='gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df'
2019-08-27 21:20:08,035 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3776.73ms
2019-08-27 21:28:54,454 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_person_df'
2019-08-27 21:28:54,462 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 284.90ms
2019-08-27 21:29:01,593 - db - INFO - select * from public.task_info where wfid = '0e0de9f23e7624e1abd95acef1faed4c'
2019-08-27 21:29:01,595 - db - INFO - update  public.task_info set status='down' where wfid='0e0de9f23e7624e1abd95acef1faed4c'
2019-08-27 21:29:02,825 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1232.72ms
2019-08-27 21:29:06,586 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_person_df'
2019-08-27 21:29:06,800 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:29:06,883 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.log', 'gonganju_txt_ods.base_jzz_jzz_person_df', 'dsjzx.base_jzz_jzz_person_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jzz_jzz_person_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jzz_jzz_person_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jzz_jzz_person_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jzz_jzz_person_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jzz_jzz_person_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jzz_jzz_person_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_person_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_person_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_person_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt' into table gonganju_txt_ods.base_jzz_jzz_person_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jzz_jzz_person_df (apptype,regcode,regcertcode,chidcard,chname,choldname,chsex,xbhz,mzdm,mzdmhz,dtbirthday,dtbirthday_dt,jgcode,height,xxdm,xxhz,chpolity,whcd,whcdhz,oprtype,hjcode,hjaddr,hjtype,birthplace,chreason,dtcome,dtcome_dt,chshlivearea,chshlivestreet,chshliveroad,chshliveaddr,chshhandphone,mobile,chlivetype,houseusage,chlivekind,chliveno,dtendday,chhouseorgname,chhouseownername,rentrooms,houseownertel,chhouseownerid,chrelation,tenantname,tenantrel,isemployee,orgname,orgroad,orgaddr,orgtel,jobtype,orgindustry,isinsurance,hyzk,hyzkhz,chponame,chpoidcard,mcertiflag,chhealth,chvaccinate,minorkeeper,minorkeeperrel,iskeeperlocal,keeperpid,vehicletype,vehicleno,memo,houseid,policeid,applattice,fillernmae,dtfilldate,dtfilldate_dt,dtsavedate,dtsavedate_dt,choperator,chinputor,chphotoname,chchecker,reserved1,reserved2,createtime,createtime_dt,reserved,updtuser,updttime,updttime_dt,personchgseq,houseseq,housechgseq,subhouseseq,subhousechgseq,personstatus,validdate,validdate_dt,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,edunow,email,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjhm,bzyfzgxdm,bzyfzgxhz,dt,jhpt_update_time,jhpt_delete) select apptype,regcode,regcertcode,chidcard,chname,choldname,chsex,xbhz,mzdm,mzdmhz,dtbirthday,dtbirthday_dt,jgcode,height,xxdm,xxhz,chpolity,whcd,whcdhz,oprtype,hjcode,hjaddr,hjtype,birthplace,chreason,dtcome,dtcome_dt,chshlivearea,chshlivestreet,chshliveroad,chshliveaddr,chshhandphone,mobile,chlivetype,houseusage,chlivekind,chliveno,dtendday,chhouseorgname,chhouseownername,rentrooms,houseownertel,chhouseownerid,chrelation,tenantname,tenantrel,isemployee,orgname,orgroad,orgaddr,orgtel,jobtype,orgindustry,isinsurance,hyzk,hyzkhz,chponame,chpoidcard,mcertiflag,chhealth,chvaccinate,minorkeeper,minorkeeperrel,iskeeperlocal,keeperpid,vehicletype,vehicleno,memo,houseid,policeid,applattice,fillernmae,dtfilldate,dtfilldate_dt,dtsavedate,dtsavedate_dt,choperator,chinputor,chphotoname,chchecker,reserved1,reserved2,createtime,createtime_dt,reserved,updtuser,updttime,updttime_dt,personchgseq,houseseq,housechgseq,subhouseseq,subhousechgseq,personstatus,validdate,validdate_dt,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,edunow,email,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjhm,bzyfzgxdm,bzyfzgxhz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jzz_jzz_person_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jzz_jzz_person_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jzz_jzz_person_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.py"}}

2019-08-27 21:29:06,883 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:29:07,201 - dodox_01907302051 - INFO - AWzTRAh8BZ1xJXgBM3fE
2019-08-27 21:29:08,392 - dodox_01907302051 - INFO - 3d48374c91d1d3159085cc12fbeabd1b
2019-08-27 21:29:08,393 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:29:09,562 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:29:09,562 - dodox_01907302051 - INFO - workflowid:3d48374c91d1d3159085cc12fbeabd1b
2019-08-27 21:29:10,746 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_person_df'
2019-08-27 21:29:10,747 - db - INFO - update  public.task_info set wfid='3d48374c91d1d3159085cc12fbeabd1b',status='up',scriptid='AWzTRAh8BZ1xJXgBM3fE' where workflowname='gonganju_8_103_dsjzx_base_jzz_jzz_person_df'
2019-08-27 21:29:10,749 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 4315.00ms
2019-08-27 21:31:09,681 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df'
2019-08-27 21:31:09,686 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 104.99ms
2019-08-27 21:31:16,683 - db - INFO - select * from public.task_info where wfid = 'c010bd5f9ee5da3512866b6366272d80'
2019-08-27 21:31:16,684 - db - INFO - update  public.task_info set status='down' where wfid='c010bd5f9ee5da3512866b6366272d80'
2019-08-27 21:31:17,845 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1162.80ms
2019-08-27 21:31:23,204 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df'
2019-08-27 21:31:23,307 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:31:23,399 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.log', 'gonganju_txt_ods.base_jjlhy_acd_duty_df', 'dsjzx.base_jjlhy_acd_duty_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_acd_duty_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_acd_duty_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_acd_duty_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_acd_duty_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_acd_duty_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_acd_duty_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_duty_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_duty_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_duty_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt' into table gonganju_txt_ods.base_jjlhy_acd_duty_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_acd_duty_df (sgbh,wsbh,jbss,dsfqk,rdnr,baryj,zjyj,cbr1,cbr2,xbrq,tqsprq,sprq,spr,jbr,wszt,jyw,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select sgbh,wsbh,jbss,dsfqk,rdnr,baryj,zjyj,cbr1,cbr2,xbrq,tqsprq,sprq,spr,jbr,wszt,jyw,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_acd_duty_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_acd_duty_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_acd_duty_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.py"}}

2019-08-27 21:31:23,399 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:31:23,726 - dodox_01907302051 - INFO - AWzTRh2xBZ1xJXgBM3fQ
2019-08-27 21:31:24,903 - dodox_01907302051 - INFO - 95f8c97c2f09018886eeb76e8d7ab9fc
2019-08-27 21:31:24,903 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:31:26,073 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:31:26,074 - dodox_01907302051 - INFO - workflowid:95f8c97c2f09018886eeb76e8d7ab9fc
2019-08-27 21:31:27,295 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df'
2019-08-27 21:31:27,295 - db - INFO - update  public.task_info set wfid='95f8c97c2f09018886eeb76e8d7ab9fc',status='up',scriptid='AWzTRh2xBZ1xJXgBM3fQ' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df'
2019-08-27 21:31:27,297 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 4395.48ms
2019-08-27 21:36:03,074 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df'
2019-08-27 21:36:03,083 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 547.16ms
2019-08-27 21:36:10,004 - db - INFO - select * from public.task_info where wfid = '0805a0e60feb56618e6b55389e6a6d6d'
2019-08-27 21:36:10,004 - db - INFO - update  public.task_info set status='down' where wfid='0805a0e60feb56618e6b55389e6a6d6d'
2019-08-27 21:36:11,183 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1180.24ms
2019-08-27 21:36:13,566 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df'
2019-08-27 21:36:13,667 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:36:13,751 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.log', 'gonganju_txt_ods.base_jjlhy_acd_filehuman_df', 'dsjzx.base_jjlhy_acd_filehuman_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_acd_filehuman_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_acd_filehuman_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_acd_filehuman_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_acd_filehuman_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_acd_filehuman_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_acd_filehuman_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_filehuman_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_filehuman_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_filehuman_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt' into table gonganju_txt_ods.base_jjlhy_acd_filehuman_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_acd_filehuman_df (sgbh,xzqh,rybh,sfdsr,dwgr,xm,xb,sfzmhm,nl,csny,mz,gj,whcd,jg,hjz,zz,dh,rylx,wgrlx,dw,sfty,swsj,shcd,shcd24,shcd3,shcd7,shcd30,ssbw,zsyy,hkxz,wfxw1,wfxw2,wfxw3,zyysdw,yzbm,jtfs,glxzqh,dabh,jl,jszzl,jsrlx,zjcx,cclzrq,fzjg,jxmc,sgzr,bx,bxgs,bxpzh,xyjjhl,xszt,aqdtkqk,xrzt,xrsd,pzjs,clbsqdw,clzxdzt,clzmdzt,claqqnzt,hphm,hpzl,clfzjg,clpp,clxh,syq,jdcsyr,clsyxz,clsbdh,fdjh,jdcxh,csys,sfcz,hzl,szl,cllx,jdczt,hpzl1,hphm1,cllx1,clpp1,clxh1,hzl1,szl1,clhfzt,claqzk,glkylc,glkyjyfs,yzwxp,wxpzl,ysxk,wxpcyzg,yzwxphg,czclbh,ylzd1,ylzd2,ylzd3,ylzd4,ylzd5,tdyl1,tdyl2,tdyl3,tdyl4,tdyl5,tdyl6,tdyl7,tdyl8,tdyl9,tdyl10,cjcxbj,jyw,fsjg,ffjg,clsyxzy,ytsx,sfxcfw,xcjszg,xdzt,dwd_loadtime,dwd_updatetime,dwd_yxbz,xzqhmc,xbmc,mzmc,gjmc,whcdmc,jgmc,shcdmc,ssbwmc,zsyymc,wfxw1mc,wfxw2mc,wfxw3mc,jtfsmc,jszzlmc,jsrlxmc,zjcxmc,fzjgmc,sgzrmc,bxgsmc,xsztmc,hpzlmc,clsyxzmc,csysmc,cllxmc,clhfztmc,csny_dt,csny_int,swsj_dt,swsj_int,cclzrq_dt,cclzrq_int,dt,jhpt_update_time,jhpt_delete) select sgbh,xzqh,rybh,sfdsr,dwgr,xm,xb,sfzmhm,nl,csny,mz,gj,whcd,jg,hjz,zz,dh,rylx,wgrlx,dw,sfty,swsj,shcd,shcd24,shcd3,shcd7,shcd30,ssbw,zsyy,hkxz,wfxw1,wfxw2,wfxw3,zyysdw,yzbm,jtfs,glxzqh,dabh,jl,jszzl,jsrlx,zjcx,cclzrq,fzjg,jxmc,sgzr,bx,bxgs,bxpzh,xyjjhl,xszt,aqdtkqk,xrzt,xrsd,pzjs,clbsqdw,clzxdzt,clzmdzt,claqqnzt,hphm,hpzl,clfzjg,clpp,clxh,syq,jdcsyr,clsyxz,clsbdh,fdjh,jdcxh,csys,sfcz,hzl,szl,cllx,jdczt,hpzl1,hphm1,cllx1,clpp1,clxh1,hzl1,szl1,clhfzt,claqzk,glkylc,glkyjyfs,yzwxp,wxpzl,ysxk,wxpcyzg,yzwxphg,czclbh,ylzd1,ylzd2,ylzd3,ylzd4,ylzd5,tdyl1,tdyl2,tdyl3,tdyl4,tdyl5,tdyl6,tdyl7,tdyl8,tdyl9,tdyl10,cjcxbj,jyw,fsjg,ffjg,clsyxzy,ytsx,sfxcfw,xcjszg,xdzt,dwd_loadtime,dwd_updatetime,dwd_yxbz,xzqhmc,xbmc,mzmc,gjmc,whcdmc,jgmc,shcdmc,ssbwmc,zsyymc,wfxw1mc,wfxw2mc,wfxw3mc,jtfsmc,jszzlmc,jsrlxmc,zjcxmc,fzjgmc,sgzrmc,bxgsmc,xsztmc,hpzlmc,clsyxzmc,csysmc,cllxmc,clhfztmc,csny_dt,csny_int,swsj_dt,swsj_int,cclzrq_dt,cclzrq_int,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_acd_filehuman_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_acd_filehuman_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jjlhy_acd_filehuman_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.py"}}

2019-08-27 21:36:13,752 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:36:13,945 - dodox_01907302051 - INFO - AWzTSovVBZ1xJXgBM3fa
2019-08-27 21:36:15,019 - dodox_01907302051 - INFO - 15531f3446b132efa0340f7eae49e715
2019-08-27 21:36:15,019 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:36:16,161 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:36:16,161 - dodox_01907302051 - INFO - workflowid:15531f3446b132efa0340f7eae49e715
2019-08-27 21:36:17,321 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df'
2019-08-27 21:36:17,321 - db - INFO - update  public.task_info set wfid='15531f3446b132efa0340f7eae49e715',status='up',scriptid='AWzTSovVBZ1xJXgBM3fa' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df'
2019-08-27 21:36:17,323 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3825.32ms
2019-08-27 21:37:29,106 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df'
2019-08-27 21:37:29,108 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 93.59ms
2019-08-27 21:37:37,489 - db - INFO - select * from public.task_info where wfid = '14763470cbe70c77bfd4231ab4e4e799'
2019-08-27 21:37:37,490 - db - INFO - update  public.task_info set status='down' where wfid='14763470cbe70c77bfd4231ab4e4e799'
2019-08-27 21:37:38,666 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1177.72ms
2019-08-27 21:37:41,806 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df'
2019-08-27 21:37:41,939 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:37:41,995 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.log', 'gonganju_txt_ods.base_jzz_zp_jzz_photo_df', 'dsjzx.base_jzz_zp_jzz_photo_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_jzz_zp_jzz_photo_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jzz_zp_jzz_photo_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jzz_zp_jzz_photo_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jzz_zp_jzz_photo_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jzz_zp_jzz_photo_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jzz_zp_jzz_photo_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_zp_jzz_photo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_zp_jzz_photo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_zp_jzz_photo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt' into table gonganju_txt_ods.base_jzz_zp_jzz_photo_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jzz_zp_jzz_photo_df (regcertcode,regcode,imagephoto,timestamp,createtime,reserved,updtuser,updttime,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,imagephoto_oss,dt,jhpt_update_time,jhpt_delete) select regcertcode,regcode,imagephoto,timestamp,createtime,reserved,updtuser,updttime,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,imagephoto_oss,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jzz_zp_jzz_photo_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jzz_zp_jzz_photo_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_jzz_zp_jzz_photo_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.py"}}

2019-08-27 21:37:41,995 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:37:42,180 - dodox_01907302051 - INFO - AWzTS-SCBZ1xJXgBM3fp
2019-08-27 21:37:43,281 - dodox_01907302051 - INFO - 0c0235e03b10f046bd73f7a582940b30
2019-08-27 21:37:43,282 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:37:44,428 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:37:44,429 - dodox_01907302051 - INFO - workflowid:0c0235e03b10f046bd73f7a582940b30
2019-08-27 21:37:45,571 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df'
2019-08-27 21:37:45,573 - db - INFO - update  public.task_info set wfid='0c0235e03b10f046bd73f7a582940b30',status='up',scriptid='AWzTS-SCBZ1xJXgBM3fp' where workflowname='gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df'
2019-08-27 21:37:45,576 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3835.35ms
2019-08-27 21:45:11,604 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx'
2019-08-27 21:45:11,611 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 495.20ms
2019-08-27 21:45:20,152 - db - INFO - select * from public.task_info where wfid = 'dab2994879768dc3d3e2dee3df1df550'
2019-08-27 21:45:20,153 - db - INFO - update  public.task_info set status='down' where wfid='dab2994879768dc3d3e2dee3df1df550'
2019-08-27 21:45:21,309 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1157.24ms
2019-08-27 21:45:26,352 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx'
2019-08-27 21:45:26,460 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:45:26,518 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.log', 'gonganju_txt_ods.base_kksj_sjkk_sbxx', 'dsjzx.base_kksj_sjkk_sbxx','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_kksj_sjkk_sbxx数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_kksj_sjkk_sbxx\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_kksj_sjkk_sbxx_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_kksj_sjkk_sbxx_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_kksj_sjkk_sbxx_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_kksj_sjkk_sbxx_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_kksj_sjkk_sbxx_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_kksj_sjkk_sbxx_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_kksj_sjkk_sbxx_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt' into table gonganju_txt_ods.base_kksj_sjkk_sbxx\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_kksj_sjkk_sbxx (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_kksj_sjkk_sbxx\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_kksj_sjkk_sbxx\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_kksj_sjkk_sbxx抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.py"}}

2019-08-27 21:45:26,518 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:45:26,699 - dodox_01907302051 - INFO - AWzTUvsQBZ1xJXgBM3gB
2019-08-27 21:45:27,791 - dodox_01907302051 - INFO - d7b397db021dd697e9832eacf150be4c
2019-08-27 21:45:27,791 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:45:28,913 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:45:28,913 - dodox_01907302051 - INFO - workflowid:d7b397db021dd697e9832eacf150be4c
2019-08-27 21:45:30,041 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx'
2019-08-27 21:45:30,042 - db - INFO - update  public.task_info set wfid='d7b397db021dd697e9832eacf150be4c',status='up',scriptid='AWzTUvsQBZ1xJXgBM3gB' where workflowname='gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx'
2019-08-27 21:45:30,044 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3827.62ms
2019-08-27 21:48:00,640 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df'
2019-08-27 21:48:00,645 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 83.61ms
2019-08-27 21:48:09,242 - db - INFO - select * from public.task_info where wfid = '92b7d76f2a0c487654acbdae27b92255'
2019-08-27 21:48:09,243 - db - INFO - update  public.task_info set status='down' where wfid='92b7d76f2a0c487654acbdae27b92255'
2019-08-27 21:48:10,501 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1260.21ms
2019-08-27 21:48:14,660 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df'
2019-08-27 21:48:14,830 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:48:14,897 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.log', 'gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df', 'dsjzx.base_rkb_czrk_t_t3_rk_qrdjxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_rkb_czrk_t_t3_rk_qrdjxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt' into table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df (rid,hid,mnpid,qrpcsbm,pcsmc,sfzhm,xm,hkszdhh,hbdm,hbdmmc,yhbdm,yhbdmmc,yhzgj,yhzgjmc,xb,xbmc,csrq,whcd,whcdmc,pzdw,pzdwmc,qrfx,qrfxmc,qrlb,qrlbmc,qrrq,bdsqbh,bdsqbhmc,qcdpcsbh,sfhbd,sfhbdmc,slrxm,slywbm,hjywlx,hjywlxmc,ph,jg,jgmc,jggj,gjmc,jgxz,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,hid,mnpid,qrpcsbm,pcsmc,sfzhm,xm,hkszdhh,hbdm,hbdmmc,yhbdm,yhbdmmc,yhzgj,yhzgjmc,xb,xbmc,csrq,whcd,whcdmc,pzdw,pzdwmc,qrfx,qrfxmc,qrlb,qrlbmc,qrrq,bdsqbh,bdsqbhmc,qcdpcsbh,sfhbd,sfhbdmc,slrxm,slywbm,hjywlx,hjywlxmc,ph,jg,jgmc,jggj,gjmc,jgxz,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_rkb_czrk_t_t3_rk_qrdjxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.py"}}

2019-08-27 21:48:14,897 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:48:15,126 - dodox_01907302051 - INFO - AWzTVYzaBZ1xJXgBM3gK
2019-08-27 21:48:16,241 - dodox_01907302051 - INFO - 6dc8703ce72db52afa60a2203bd288ce
2019-08-27 21:48:16,241 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:48:17,458 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:48:17,459 - dodox_01907302051 - INFO - workflowid:6dc8703ce72db52afa60a2203bd288ce
2019-08-27 21:48:18,691 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df'
2019-08-27 21:48:18,691 - db - INFO - update  public.task_info set wfid='6dc8703ce72db52afa60a2203bd288ce',status='up',scriptid='AWzTVYzaBZ1xJXgBM3gK' where workflowname='gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df'
2019-08-27 21:48:18,694 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 4110.79ms
2019-08-27 21:50:46,453 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-08-27 21:50:46,458 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 92.72ms
2019-08-27 21:50:55,973 - db - INFO - select * from public.task_info where wfid = '56103221fab6f8eadd04249cf860bbb1'
2019-08-27 21:50:55,974 - db - INFO - update  public.task_info set status='down' where wfid='56103221fab6f8eadd04249cf860bbb1'
2019-08-27 21:50:57,187 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1215.06ms
2019-08-27 21:51:00,287 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-08-27 21:51:00,389 - dodox_01907302051 - INFO - Successful folder creation
2019-08-27 21:51:00,447 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.log', 'gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df', 'dsjzx.base_rkb_czrk_t_t3_rk_qczxxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_rkb_czrk_t_t3_rk_qczxxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt' into table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_rkb_czrk_t_t3_rk_qczxxx_df (rid,hid,mnpid,qcpcsbm,pcsmc,sfzhm,xm,hh,hbdm,hbdmmc,yhb,yhbdmmc,yhzgj,yhzgjmc,xbdm,xbmc,csrq,whcddm,whcdmc,pzdw,pzdwmc,qcfx,qcfxmc,qclb,qclbmc,qcrq,bdsqbh,bdsqbhmc,qwdpcs,sfhbd,sfhbdmc,slrxm,slywbm,hjywlx,hjywlxmc,ph,bz,cbsxz,cbsxzqhdm,gmsfzsjyy,gmsfzsjyymc,mzdm,mz,mzmc,qcdxz,qcdz,qcxz,qcxzqh,qwdgjdq,qwdgjdqmc,qwdjlh,qwdjlhmc,qwdxz,qwdxzqh,qyzbh,zqzbh,zzzk,zzzkmc,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,hid,mnpid,qcpcsbm,pcsmc,sfzhm,xm,hh,hbdm,hbdmmc,yhb,yhbdmmc,yhzgj,yhzgjmc,xbdm,xbmc,csrq,whcddm,whcdmc,pzdw,pzdwmc,qcfx,qcfxmc,qclb,qclbmc,qcrq,bdsqbh,bdsqbhmc,qwdpcs,sfhbd,sfhbdmc,slrxm,slywbm,hjywlx,hjywlxmc,ph,bz,cbsxz,cbsxzqhdm,gmsfzsjyy,gmsfzsjyymc,mzdm,mz,mzmc,qcdxz,qcdz,qcxz,qcxzqh,qwdgjdq,qwdgjdqmc,qwdjlh,qwdjlhmc,qwdxz,qwdxzqh,qyzbh,zqzbh,zzzk,zzzkmc,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_rkb_czrk_t_t3_rk_qczxxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.py"}}

2019-08-27 21:51:00,448 - dodox_01907302051 - INFO - Upload Success
2019-08-27 21:51:00,662 - dodox_01907302051 - INFO - AWzTWBN4BZ1xJXgBM3gY
2019-08-27 21:51:01,769 - dodox_01907302051 - INFO - 43037b0941bf390da55141c5407ab91b
2019-08-27 21:51:01,769 - dodox_01907302051 - INFO - workflow success
2019-08-27 21:51:02,939 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-27 21:51:02,939 - dodox_01907302051 - INFO - workflowid:43037b0941bf390da55141c5407ab91b
2019-08-27 21:51:04,073 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-08-27 21:51:04,074 - db - INFO - update  public.task_info set wfid='43037b0941bf390da55141c5407ab91b',status='up',scriptid='AWzTWBN4BZ1xJXgBM3gY' where workflowname='gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-08-27 21:51:04,076 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3849.20ms
2019-08-28 17:31:31,324 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df'
2019-08-28 17:31:31,331 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 75.86ms
2019-08-28 17:31:40,601 - db - INFO - select * from public.task_info where wfid = 'f13a17bcd0d2f6adc5f56e85347dd68c'
2019-08-28 17:31:40,601 - db - INFO - update  public.task_info set status='down' where wfid='f13a17bcd0d2f6adc5f56e85347dd68c'
2019-08-28 17:31:41,740 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1140.32ms
2019-08-28 17:31:48,929 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df'
2019-08-28 17:31:49,003 - dodox_01907302051 - INFO - Successful folder creation
2019-08-28 17:31:49,072 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df.log', 'gonganju_txt_ods.base_sjkk_gcjl_ecjgh_df', 'dsjzx.base_sjkk_gcjl_ecjgh_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_sjkk_gcjl_ecjgh_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_sjkk_gcjl_ecjgh_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_sjkk_gcjl_ecjgh_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_sjkk_gcjl_ecjgh_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_sjkk_gcjl_ecjgh_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_sjkk_gcjl_ecjgh_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sjkk_gcjl_ecjgh_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_sjkk_gcjl_ecjgh_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sjkk_gcjl_ecjgh_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_sjkk_gcjl_ecjgh_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sjkk_gcjl_ecjgh_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_sjkk_gcjl_ecjgh_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sjkk_gcjl_ecjgh_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_sjkk_gcjl_ecjgh_df.txt' into table gonganju_txt_ods.base_sjkk_gcjl_ecjgh_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_sjkk_gcjl_ecjgh_df (jlbh,xzqh,kkbh,cdbh,hphm,hpzl,jgsj,sbbh,cdfx,xszt,tplx,tztp,qjtp,rksj,yzsj,sjcz,sjly,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select jlbh,xzqh,kkbh,cdbh,hphm,hpzl,jgsj,sbbh,cdfx,xszt,tplx,tztp,qjtp,rksj,yzsj,sjcz,sjly,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_sjkk_gcjl_ecjgh_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_sjkk_gcjl_ecjgh_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_sjkk_gcjl_ecjgh_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df.py"}}

2019-08-28 17:31:49,073 - dodox_01907302051 - INFO - Upload Success
2019-08-28 17:31:49,248 - dodox_01907302051 - INFO - AWzXkSPjBZ1xJXgBM3jj
2019-08-28 17:31:50,316 - dodox_01907302051 - INFO - 66a496e4b87266ce69351870c7564189
2019-08-28 17:31:50,316 - dodox_01907302051 - INFO - workflow success
2019-08-28 17:31:51,435 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-28 17:31:51,435 - dodox_01907302051 - INFO - workflowid:66a496e4b87266ce69351870c7564189
2019-08-28 17:31:52,556 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df'
2019-08-28 17:31:52,556 - db - INFO - update  public.task_info set wfid='66a496e4b87266ce69351870c7564189',status='up',scriptid='AWzXkSPjBZ1xJXgBM3jj' where workflowname='gonganju_8_103_dsjzx_base_sjkk_gcjl_ecjgh_df'
2019-08-28 17:31:52,558 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3684.56ms
2019-08-28 17:43:18,099 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df'
2019-08-28 17:43:18,106 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 80.03ms
2019-08-28 17:43:29,847 - db - INFO - select * from public.task_info where wfid = '83566c146747a130383d3c9dfc811955'
2019-08-28 17:43:29,848 - db - INFO - update  public.task_info set status='down' where wfid='83566c146747a130383d3c9dfc811955'
2019-08-28 17:43:31,034 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1187.34ms
2019-08-28 17:43:33,895 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df'
2019-08-28 17:43:33,995 - dodox_01907302051 - INFO - Successful folder creation
2019-08-28 17:43:34,046 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.log', 'gonganju_txt_ods.base_crjdata_cjsqxx_df', 'dsjzx.base_crjdata_cjsqxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_cjsqxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_cjsqxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_cjsqxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_cjsqxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_cjsqxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_cjsqxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_cjsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_cjsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_cjsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt' into table gonganju_txt_ods.base_crjdata_cjsqxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_cjsqxx_df (sq_id,ry_id,rybh,ywbh,sqlb,bzlb,bm,mz,hyzk,zzmm,whcd,gzdw,zy,zwzc,lxdh,hkszd,sspcs,jtzz,sfxtkzd,sjr,yzbm,emsdz,sfxsjfsspzk,sjhm,swbadwbh,swbadwmc,dbdw,brjl,qwd,cjsy,djsy,xczjzl,xczjhm,xczjqfrq,xczjyxqz,sbzjhm,sbqzhm,sldw,slrq,slr,spdw,sprq,spr,spjg,bpzyy,zzrq,fzrq,gdrq,jjbs,tbbs,hdbh,sfqrbz,sflb,sfje,sfbz,syhbs,sfsyhsj,sfyhfksj,tfsyhsj,tfyhfksj,qrsfsj,qrsfr,qrtfsj,qrtfr,xxrs,xxid,dah,xxly,xxjb,glywbh,yyqzrq,sfxxz,sfxqz,sfxjz,sfcjzp,sfyjrga,jrgarq,lpzx,lpzm,bz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,xb,csrq,sfzh,gjdq,rydylb,csd,slrqchar,sprqchar,zzzrqchar,zqzrqchar,zzrqchar,fzrqchar,zwtxcjjg,zwmbcjjg,zzznm1,zzznm2,stglxx,stbzxx,sjbh,zwbh,rwbh,sfdzzj,zwmbxrgaq,sqh,tjbh,lxth,sflyhz,yyslsj,lyfph,qzzl,jzzl,qzhm,jffs,qrbz,hkqrqk,yddrxbdbz,ydyrxbdbz,ydbzrylb,jjqk_lxr,jjqk_lxrdh,emsdh,jjzl,jjyy,old_sqid,dah2,zdspbz,zzslbz,zzslszbz,zzslszdw,zzslszrq,szqm,xptm,ydlb,qzdw,qzdz,yyqzrq_char,tdxzqh,sfmclbh,lxtxxb_id,bjczjmbz,yjjzd,qzfsdd,cjka,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select sq_id,ry_id,rybh,ywbh,sqlb,bzlb,bm,mz,hyzk,zzmm,whcd,gzdw,zy,zwzc,lxdh,hkszd,sspcs,jtzz,sfxtkzd,sjr,yzbm,emsdz,sfxsjfsspzk,sjhm,swbadwbh,swbadwmc,dbdw,brjl,qwd,cjsy,djsy,xczjzl,xczjhm,xczjqfrq,xczjyxqz,sbzjhm,sbqzhm,sldw,slrq,slr,spdw,sprq,spr,spjg,bpzyy,zzrq,fzrq,gdrq,jjbs,tbbs,hdbh,sfqrbz,sflb,sfje,sfbz,syhbs,sfsyhsj,sfyhfksj,tfsyhsj,tfyhfksj,qrsfsj,qrsfr,qrtfsj,qrtfr,xxrs,xxid,dah,xxly,xxjb,glywbh,yyqzrq,sfxxz,sfxqz,sfxjz,sfcjzp,sfyjrga,jrgarq,lpzx,lpzm,bz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,xb,csrq,sfzh,gjdq,rydylb,csd,slrqchar,sprqchar,zzzrqchar,zqzrqchar,zzrqchar,fzrqchar,zwtxcjjg,zwmbcjjg,zzznm1,zzznm2,stglxx,stbzxx,sjbh,zwbh,rwbh,sfdzzj,zwmbxrgaq,sqh,tjbh,lxth,sflyhz,yyslsj,lyfph,qzzl,jzzl,qzhm,jffs,qrbz,hkqrqk,yddrxbdbz,ydyrxbdbz,ydbzrylb,jjqk_lxr,jjqk_lxrdh,emsdh,jjzl,jjyy,old_sqid,dah2,zdspbz,zzslbz,zzslszbz,zzslszdw,zzslszrq,szqm,xptm,ydlb,qzdw,qzdz,yyqzrq_char,tdxzqh,sfmclbh,lxtxxb_id,bjczjmbz,yjjzd,qzfsdd,cjka,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_cjsqxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_cjsqxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_cjsqxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.py"}}

2019-08-28 17:43:34,046 - dodox_01907302051 - INFO - Upload Success
2019-08-28 17:43:34,252 - dodox_01907302051 - INFO - AWzXm-W3BZ1xJXgBM3jv
2019-08-28 17:43:35,354 - dodox_01907302051 - INFO - 9d135238dfcc8eb9a8526216f7e8f37a
2019-08-28 17:43:35,354 - dodox_01907302051 - INFO - workflow success
2019-08-28 17:43:36,502 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-28 17:43:36,503 - dodox_01907302051 - INFO - workflowid:9d135238dfcc8eb9a8526216f7e8f37a
2019-08-28 17:43:37,636 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df'
2019-08-28 17:43:37,637 - db - INFO - update  public.task_info set wfid='9d135238dfcc8eb9a8526216f7e8f37a',status='up',scriptid='AWzXm-W3BZ1xJXgBM3jv' where workflowname='gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df'
2019-08-28 17:43:37,639 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3801.85ms
2019-08-28 19:32:41,759 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb'
2019-08-28 19:32:41,997 - dodox_01907302051 - INFO - Successful folder creation
2019-08-28 19:32:42,070 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.json \u003e /opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.log', 'gonganju_txt_ods.ZWY_GRZPBTSQ_XXB', 'dsjzx.ZWY_GRZPBTSQ_XXB','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.ZWY_GRZPBTSQ_XXB数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31327/;guardianToken=GRtS9d0VzDWz4krYZ7ak-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/rensheju/dsjzx_ZWY_GRZPBTSQ_XXB\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_ZWY_GRZPBTSQ_XXB_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_ZWY_GRZPBTSQ_XXB_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_ZWY_GRZPBTSQ_XXB_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_ZWY_GRZPBTSQ_XXB_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_GRZPBTSQ_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_GRZPBTSQ_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_GRZPBTSQ_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt' into table gonganju_txt_ods.ZWY_GRZPBTSQ_XXB\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.ZWY_GRZPBTSQ_XXB (xm,zjhm,hjlb_name,xmmc,zydj_id,rylb,whcd_id,pid,bh_id,tjbh,jhpt_update_time,jhpt_update_flag,jhpt_delete,yw_update_time) select xm,zjhm,hjlb_name,xmmc,zydj_id,rylb,whcd_id,pid,bh_id,tjbh,jhpt_update_time,jhpt_update_flag,jhpt_delete,yw_update_time  from gonganju_txt_ods.ZWY_GRZPBTSQ_XXB\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.ZWY_GRZPBTSQ_XXB\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.ZWY_GRZPBTSQ_XXB抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/rensheju/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.py"}}

2019-08-28 19:32:42,071 - dodox_01907302051 - INFO - Upload Success
2019-08-28 19:32:42,218 - dodox_01907302051 - INFO - AWzX_8_hBZ1xJXgBM3kG
2019-08-28 19:32:43,323 - dodox_01907302051 - INFO - 64e555a651444c1a9565592b9cd085fd
2019-08-28 19:32:43,324 - dodox_01907302051 - INFO - workflow success
2019-08-28 19:32:44,487 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-28 19:32:44,487 - dodox_01907302051 - INFO - workflowid:64e555a651444c1a9565592b9cd085fd
2019-08-28 19:32:45,627 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb'
2019-08-28 19:32:45,627 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('64e555a651444c1a9565592b9cd085fd','up','AWzX_8_hBZ1xJXgBM3kG','rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb')
2019-08-28 19:32:45,629 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3937.46ms
2019-08-28 19:53:38,581 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb'
2019-08-28 19:53:38,582 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.84ms
2019-08-28 19:53:49,107 - db - INFO - select * from public.task_info where wfid = '64e555a651444c1a9565592b9cd085fd'
2019-08-28 19:53:49,108 - db - INFO - update  public.task_info set status='down' where wfid='64e555a651444c1a9565592b9cd085fd'
2019-08-28 19:53:50,325 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1217.72ms
2019-08-28 19:53:53,911 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb'
2019-08-28 19:53:54,007 - dodox_01907302051 - INFO - Successful folder creation
2019-08-28 19:53:54,050 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.json \u003e /opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.log', 'rensheju_txt.ZWY_GRZPBTSQ_XXB', 'dsjzx.ZWY_GRZPBTSQ_XXB','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.ZWY_GRZPBTSQ_XXB数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31327/;guardianToken=GRtS9d0VzDWz4krYZ7ak-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/rensheju/dsjzx_ZWY_GRZPBTSQ_XXB\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_ZWY_GRZPBTSQ_XXB_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_ZWY_GRZPBTSQ_XXB_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_ZWY_GRZPBTSQ_XXB_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_ZWY_GRZPBTSQ_XXB_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_GRZPBTSQ_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_GRZPBTSQ_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_GRZPBTSQ_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/rensheju_dsjzx_ZWY_GRZPBTSQ_XXB.txt' into table rensheju_txt.ZWY_GRZPBTSQ_XXB\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into rensheju_orc.ZWY_GRZPBTSQ_XXB (xm,zjhm,hjlb_name,xmmc,zydj_id,rylb,whcd_id,pid,bh_id,tjbh,jhpt_update_time,jhpt_update_flag,jhpt_delete,yw_update_time) select xm,zjhm,hjlb_name,xmmc,zydj_id,rylb,whcd_id,pid,bh_id,tjbh,jhpt_update_time,jhpt_update_flag,jhpt_delete,yw_update_time  from rensheju_txt.ZWY_GRZPBTSQ_XXB\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table rensheju_txt.ZWY_GRZPBTSQ_XXB\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.ZWY_GRZPBTSQ_XXB抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/rensheju/rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb.py"}}

2019-08-28 19:53:54,051 - dodox_01907302051 - INFO - Upload Success
2019-08-28 19:53:54,200 - dodox_01907302051 - INFO - AWzYEziYBZ1xJXgBM3kT
2019-08-28 19:53:55,280 - dodox_01907302051 - INFO - 216a14a89fd93e3a2a3fea0c8667215b
2019-08-28 19:53:55,280 - dodox_01907302051 - INFO - workflow success
2019-08-28 19:53:56,423 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-28 19:53:56,423 - dodox_01907302051 - INFO - workflowid:216a14a89fd93e3a2a3fea0c8667215b
2019-08-28 19:53:57,539 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb'
2019-08-28 19:53:57,539 - db - INFO - update  public.task_info set wfid='216a14a89fd93e3a2a3fea0c8667215b',status='up',scriptid='AWzYEziYBZ1xJXgBM3kT' where workflowname='rensheju_68_20_dsjzx_zwy_grzpbtsq_xxb'
2019-08-28 19:53:57,541 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3684.39ms
2019-08-28 20:15:26,061 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_pxjgpx_xxb'
2019-08-28 20:15:26,147 - dodox_01907302051 - INFO - Successful folder creation
2019-08-28 20:15:26,178 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.json \u003e /opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.log', 'rensheju_txt.ZWY_PXJGPX_XXB', 'dsjzx.ZWY_PXJGPX_XXB','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.ZWY_PXJGPX_XXB数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31327/;guardianToken=GRtS9d0VzDWz4krYZ7ak-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/rensheju/dsjzx_ZWY_PXJGPX_XXB\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_ZWY_PXJGPX_XXB_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_ZWY_PXJGPX_XXB_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_ZWY_PXJGPX_XXB_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_ZWY_PXJGPX_XXB_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_PXJGPX_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_PXJGPX_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_PXJGPX_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt' into table rensheju_txt.ZWY_PXJGPX_XXB\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into rensheju_orc.ZWY_PXJGPX_XXB (xm,zjhm,dwqc,ksrq,sjjsrq,jhpt_update_time,jhpt_update_flag,jhpt_delete) select xm,zjhm,dwqc,ksrq,sjjsrq,jhpt_update_time,jhpt_update_flag,jhpt_delete  from rensheju_txt.ZWY_PXJGPX_XXB\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table rensheju_txt.ZWY_PXJGPX_XXB\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.ZWY_PXJGPX_XXB抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/rensheju/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.py"}}

2019-08-28 20:15:26,178 - dodox_01907302051 - INFO - Upload Success
2019-08-28 20:15:26,331 - dodox_01907302051 - INFO - AWzYJu_sBZ1xJXgBM3kk
2019-08-28 20:15:27,425 - dodox_01907302051 - INFO - f88496b169d50cbc824745c300876114
2019-08-28 20:15:27,425 - dodox_01907302051 - INFO - workflow success
2019-08-28 20:15:28,528 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-28 20:15:28,529 - dodox_01907302051 - INFO - workflowid:f88496b169d50cbc824745c300876114
2019-08-28 20:15:29,640 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_pxjgpx_xxb'
2019-08-28 20:15:29,640 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('f88496b169d50cbc824745c300876114','up','AWzYJu_sBZ1xJXgBM3kk','rensheju_68_20_dsjzx_zwy_pxjgpx_xxb')
2019-08-28 20:15:29,642 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3634.84ms
2019-08-28 20:23:14,556 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_pxjgpx_xxb'
2019-08-28 20:23:14,557 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 54.55ms
2019-08-28 20:23:23,882 - db - INFO - select * from public.task_info where wfid = 'f88496b169d50cbc824745c300876114'
2019-08-28 20:23:23,883 - db - INFO - update  public.task_info set status='down' where wfid='f88496b169d50cbc824745c300876114'
2019-08-28 20:23:25,078 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1196.55ms
2019-08-28 20:23:29,470 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_pxjgpx_xxb'
2019-08-28 20:23:29,542 - dodox_01907302051 - INFO - Successful folder creation
2019-08-28 20:23:29,588 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.json \u003e /opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.log', 'rensheju_txt.ZWY_PXJGPX_XXB', 'dsjzx.ZWY_PXJGPX_XXB','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.ZWY_PXJGPX_XXB数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31327/;guardianToken=GRtS9d0VzDWz4krYZ7ak-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/rensheju/dsjzx_ZWY_PXJGPX_XXB\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_ZWY_PXJGPX_XXB_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_ZWY_PXJGPX_XXB_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_ZWY_PXJGPX_XXB_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_ZWY_PXJGPX_XXB_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_PXJGPX_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_PXJGPX_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_PXJGPX_XXB_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/rensheju_dsjzx_ZWY_PXJGPX_XXB.txt' into table rensheju_txt.ZWY_PXJGPX_XXB\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into rensheju_orc.ZWY_PXJGPX_XXB (pxdwmc,kbrq,jyrq,xm,zjhm,hjlb_name,whcd_id,pxrylb_id,btbl,btje,khjg_id,xmmc,zydj_id,pid,bh_id,tjbh,jhpt_update_time,jhpt_update_flag,jhpt_delete,yw_update_time) select pxdwmc,kbrq,jyrq,xm,zjhm,hjlb_name,whcd_id,pxrylb_id,btbl,btje,khjg_id,xmmc,zydj_id,pid,bh_id,tjbh,jhpt_update_time,jhpt_update_flag,jhpt_delete,yw_update_time  from rensheju_txt.ZWY_PXJGPX_XXB\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table rensheju_txt.ZWY_PXJGPX_XXB\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.ZWY_PXJGPX_XXB抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/rensheju/rensheju_68_20_dsjzx_zwy_pxjgpx_xxb.py"}}

2019-08-28 20:23:29,588 - dodox_01907302051 - INFO - Upload Success
2019-08-28 20:23:29,759 - dodox_01907302051 - INFO - AWzYLlBMBZ1xJXgBM3kx
2019-08-28 20:23:30,839 - dodox_01907302051 - INFO - 5ae8c2e7f2bd62bc91e72032eeef8268
2019-08-28 20:23:30,839 - dodox_01907302051 - INFO - workflow success
2019-08-28 20:23:31,945 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-28 20:23:31,945 - dodox_01907302051 - INFO - workflowid:5ae8c2e7f2bd62bc91e72032eeef8268
2019-08-28 20:23:33,057 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_pxjgpx_xxb'
2019-08-28 20:23:33,057 - db - INFO - update  public.task_info set wfid='5ae8c2e7f2bd62bc91e72032eeef8268',status='up',scriptid='AWzYLlBMBZ1xJXgBM3kx' where workflowname='rensheju_68_20_dsjzx_zwy_pxjgpx_xxb'
2019-08-28 20:23:33,060 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3648.59ms
2019-08-28 20:46:20,074 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_ldht_lh'
2019-08-28 20:46:20,075 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.86ms
2019-08-28 20:46:59,656 - db - INFO - select * from public.task_info where wfid = '47e77eb84b0f7538a69627015b1a7905'
2019-08-28 20:46:59,657 - db - INFO - update  public.task_info set status='down' where wfid='47e77eb84b0f7538a69627015b1a7905'
2019-08-28 20:47:00,856 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1201.01ms
2019-08-28 20:47:04,494 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_ldht_lh'
2019-08-28 20:47:04,565 - dodox_01907302051 - INFO - Successful folder creation
2019-08-28 20:47:04,598 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_ldht_lh.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/rensheju_68_20_dsjzx_zwy_ldht_lh.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_ldht_lh.json \u003e /opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_ldht_lh.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_ldht_lh.log', 'rensheju_txt.ZWY_LDHT_LH', 'dsjzx.ZWY_LDHT_LH','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.ZWY_LDHT_LH数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31327/;guardianToken=GRtS9d0VzDWz4krYZ7ak-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/rensheju/dsjzx_ZWY_LDHT_LH\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_ZWY_LDHT_LH_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_ZWY_LDHT_LH_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_ZWY_LDHT_LH_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_ZWY_LDHT_LH_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_LDHT_LH.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_LDHT_LH_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_LDHT_LH.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_LDHT_LH_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_LDHT_LH.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_LDHT_LH_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_LDHT_LH.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/rensheju_dsjzx_ZWY_LDHT_LH.txt' into table rensheju_txt.ZWY_LDHT_LH\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into rensheju_orc.ZWY_LDHT_LH (sfzh,dwmc,htqsrq,xm,htqdfs,htzzrq,jhpt_update_time,jhpt_update_flag,jhpt_delete) select sfzh,dwmc,htqsrq,xm,htqdfs,htzzrq,jhpt_update_time,jhpt_update_flag,jhpt_delete  from rensheju_txt.ZWY_LDHT_LH\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table rensheju_txt.ZWY_LDHT_LH\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.ZWY_LDHT_LH抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/rensheju/rensheju_68_20_dsjzx_zwy_ldht_lh.py"}}

2019-08-28 20:47:04,599 - dodox_01907302051 - INFO - Upload Success
2019-08-28 20:47:04,744 - dodox_01907302051 - INFO - AWzYQ-erBZ1xJXgBM3lC
2019-08-28 20:47:05,854 - dodox_01907302051 - INFO - 79b5d239222e3aad2fdb67afe5db5c76
2019-08-28 20:47:05,854 - dodox_01907302051 - INFO - workflow success
2019-08-28 20:47:06,988 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-28 20:47:06,988 - dodox_01907302051 - INFO - workflowid:79b5d239222e3aad2fdb67afe5db5c76
2019-08-28 20:47:08,111 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_ldht_lh'
2019-08-28 20:47:08,112 - db - INFO - update  public.task_info set wfid='79b5d239222e3aad2fdb67afe5db5c76',status='up',scriptid='AWzYQ-erBZ1xJXgBM3lC' where workflowname='rensheju_68_20_dsjzx_zwy_ldht_lh'
2019-08-28 20:47:08,114 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3672.20ms
2019-08-29 10:56:00,467 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_ldht_lh'
2019-08-29 10:56:00,469 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.75ms
2019-08-29 11:02:18,438 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_jysydjz_sh'
2019-08-29 11:02:18,526 - dodox_01907302051 - INFO - Successful folder creation
2019-08-29 11:02:18,565 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_jysydjz_sh.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/rensheju_68_20_dsjzx_zwy_jysydjz_sh.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/rensheju_68_20_dsjzx_zwy_jysydjz_sh.json \u003e /opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_jysydjz_sh.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/rensheju_68_20_dsjzx_zwy_jysydjz_sh.log', 'rensheju_txt.ZWY_JYSYDJZ_SH', 'dsjzx.ZWY_JYSYDJZ_SH','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.ZWY_JYSYDJZ_SH数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31327/;guardianToken=GRtS9d0VzDWz4krYZ7ak-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/rensheju/dsjzx_ZWY_JYSYDJZ_SH\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_ZWY_JYSYDJZ_SH_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_ZWY_JYSYDJZ_SH_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_ZWY_JYSYDJZ_SH_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_ZWY_JYSYDJZ_SH_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_JYSYDJZ_SH.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_JYSYDJZ_SH_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_JYSYDJZ_SH.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_JYSYDJZ_SH_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_JYSYDJZ_SH.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_ZWY_JYSYDJZ_SH_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/rensheju_dsjzx_ZWY_JYSYDJZ_SH.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/rensheju_dsjzx_ZWY_JYSYDJZ_SH.txt' into table rensheju_txt.ZWY_JYSYDJZ_SH\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into rensheju_orc.ZWY_JYSYDJZ_SH (xm,zjhm,pid,jysydjzbh,hkszdz,lxfs,jhpt_update_time,jhpt_update_flag,jhpt_delete,yw_update_time) select xm,zjhm,pid,jysydjzbh,hkszdz,lxfs,jhpt_update_time,jhpt_update_flag,jhpt_delete,yw_update_time  from rensheju_txt.ZWY_JYSYDJZ_SH\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table rensheju_txt.ZWY_JYSYDJZ_SH\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.ZWY_JYSYDJZ_SH抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/rensheju/rensheju_68_20_dsjzx_zwy_jysydjz_sh.py"}}

2019-08-29 11:02:18,566 - dodox_01907302051 - INFO - Upload Success
2019-08-29 11:02:18,697 - dodox_01907302051 - INFO - AWzbUuTSBZ1xJXgBM3mU
2019-08-29 11:02:19,788 - dodox_01907302051 - INFO - e78bfcbda816dbb24e0257545fbfce07
2019-08-29 11:02:19,788 - dodox_01907302051 - INFO - workflow success
2019-08-29 11:02:20,921 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-29 11:02:20,921 - dodox_01907302051 - INFO - workflowid:e78bfcbda816dbb24e0257545fbfce07
2019-08-29 11:02:22,032 - db - INFO - select * from public.task_info where workflowname = 'rensheju_68_20_dsjzx_zwy_jysydjz_sh'
2019-08-29 11:02:22,033 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('e78bfcbda816dbb24e0257545fbfce07','up','AWzbUuTSBZ1xJXgBM3mU','rensheju_68_20_dsjzx_zwy_jysydjz_sh')
2019-08-29 11:02:22,035 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3657.40ms
2019-08-29 17:22:55,921 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_druginfo2'
2019-08-29 17:22:56,022 - dodox_01907302051 - INFO - Successful folder creation
2019-08-29 17:22:56,066 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_druginfo2.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_druginfo2.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_druginfo2.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_druginfo2.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_druginfo2.log', 'yibaoju_txt.DRUGINFO2', 'sysdba.DRUGINFO2','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.DRUGINFO2数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_DRUGINFO2\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_DRUGINFO2_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_DRUGINFO2_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_DRUGINFO2_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_DRUGINFO2_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_DRUGINFO2.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_DRUGINFO2_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_DRUGINFO2.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_DRUGINFO2_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_DRUGINFO2.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_DRUGINFO2_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_DRUGINFO2.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_DRUGINFO2.txt' into table yibaoju_txt.DRUGINFO2\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.DRUGINFO2 (id,batchid,drugid,drugname,approvalnum,druggroup,projid,projname,drugstatus,addtime,projtype,biddate,execdate,projmemo,ypid,pricebid,bidtype,pepricebid,drugform,drugspec,drugfactor,drugunit,drugmaterial,factoryid,factoryname,batchinfo_id,jhpt_update_time,jhpt_deleted) select id,batchid,drugid,drugname,approvalnum,druggroup,projid,projname,drugstatus,addtime,projtype,biddate,execdate,projmemo,ypid,pricebid,bidtype,pepricebid,drugform,drugspec,drugfactor,drugunit,drugmaterial,factoryid,factoryname,batchinfo_id,jhpt_update_time,jhpt_deleted  from yibaoju_txt.DRUGINFO2\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.DRUGINFO2\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.DRUGINFO2抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_druginfo2.py"}}

2019-08-29 17:22:56,066 - dodox_01907302051 - INFO - Upload Success
2019-08-29 17:22:56,246 - dodox_01907302051 - INFO - AWzcr13WBZ1xJXgBM3o7
2019-08-29 17:22:57,358 - dodox_01907302051 - INFO - 8c22af5c64d25101fe660eef237f4631
2019-08-29 17:22:57,358 - dodox_01907302051 - INFO - workflow success
2019-08-29 17:22:58,512 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-29 17:22:58,512 - dodox_01907302051 - INFO - workflowid:8c22af5c64d25101fe660eef237f4631
2019-08-29 17:22:59,637 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_druginfo2'
2019-08-29 17:22:59,638 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('8c22af5c64d25101fe660eef237f4631','up','AWzcr13WBZ1xJXgBM3o7','yibaoju_68_15_sysdba_druginfo2')
2019-08-29 17:22:59,640 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3782.71ms
2019-08-29 17:37:17,502 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_purchaseinfo2'
2019-08-29 17:37:17,596 - dodox_01907302051 - INFO - Successful folder creation
2019-08-29 17:37:17,649 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_purchaseinfo2.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/yibaoju_68_15_sysdba_purchaseinfo2.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/yibaoju_68_15_sysdba_purchaseinfo2.json \u003e /opt/datatom/dana_api/log/yibaoju_68_15_sysdba_purchaseinfo2.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/yibaoju_68_15_sysdba_purchaseinfo2.log', 'yibaoju_txt.PURCHASEINFO2', 'sysdba.PURCHASEINFO2','public.job_run_info')\r\n\t\tpri.ok(\"表sysdba.PURCHASEINFO2数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/yibaoju_txt;guardianToken=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/yibaoju/sysdba_PURCHASEINFO2\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/sysdba_PURCHASEINFO2_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/sysdba_PURCHASEINFO2_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/sysdba_PURCHASEINFO2_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/sysdba_PURCHASEINFO2_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_PURCHASEINFO2.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/sysdba_PURCHASEINFO2_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_PURCHASEINFO2.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_PURCHASEINFO2_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_PURCHASEINFO2.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/sysdba_PURCHASEINFO2_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/yibaoju_sysdba_PURCHASEINFO2.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/yibaoju_sysdba_PURCHASEINFO2.txt' into table yibaoju_txt.PURCHASEINFO2\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into yibaoju_orc.PURCHASEINFO2 (ID,BATCHID,ORDERDETAILID,HOSPID,HOSPNAME,DRUGID,DRUGNAME,APPROVALNUM,VENDORID,VENDORNAME,PURCOUNT,PURPRICE,ORDTIME,PURSTATUS,ADDTIME,BATCHINFO_ID,ORGCODE,YPID,PURPEPRICE,PURAMOUNT,JHPT_UPDATE_TIME,JHPT_DELETED) select ID,BATCHID,ORDERDETAILID,HOSPID,HOSPNAME,DRUGID,DRUGNAME,APPROVALNUM,VENDORID,VENDORNAME,PURCOUNT,PURPRICE,ORDTIME,PURSTATUS,ADDTIME,BATCHINFO_ID,ORGCODE,YPID,PURPEPRICE,PURAMOUNT,JHPT_UPDATE_TIME,JHPT_DELETED  from yibaoju_txt.PURCHASEINFO2\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table yibaoju_txt.PURCHASEINFO2\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表sysdba.PURCHASEINFO2抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/yibaoju/yibaoju_68_15_sysdba_purchaseinfo2.py"}}

2019-08-29 17:37:17,650 - dodox_01907302051 - INFO - Upload Success
2019-08-29 17:37:17,799 - dodox_01907302051 - INFO - AWzcvINcBZ1xJXgBM3pM
2019-08-29 17:37:18,917 - dodox_01907302051 - INFO - 537c32a6c1fd96e647aa7241c91c3541
2019-08-29 17:37:18,917 - dodox_01907302051 - INFO - workflow success
2019-08-29 17:37:20,043 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-29 17:37:20,043 - dodox_01907302051 - INFO - workflowid:537c32a6c1fd96e647aa7241c91c3541
2019-08-29 17:37:21,193 - db - INFO - select * from public.task_info where workflowname = 'yibaoju_68_15_sysdba_purchaseinfo2'
2019-08-29 17:37:21,194 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('537c32a6c1fd96e647aa7241c91c3541','up','AWzcvINcBZ1xJXgBM3pM','yibaoju_68_15_sysdba_purchaseinfo2')
2019-08-29 17:37:21,196 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3758.60ms
2019-09-02 11:52:36,049 - db - INFO - select * from public.task_info where wfid = 'cdfa85e4d67a1b2712795c877f482a76'
2019-09-02 11:52:36,051 - db - INFO - update  public.task_info set status='down' where wfid='cdfa85e4d67a1b2712795c877f482a76'
2019-09-02 11:52:37,326 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1277.16ms
2019-09-02 11:52:44,044 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 11:52:44,125 - dodox_01907302051 - INFO - Successful folder creation
2019-09-02 11:52:44,176 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'tdt.xh_ga1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '${Execrate}'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga2\"\r\n\t\t\tcurs4.execute()\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga2 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表test.xh_gaextracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-02 11:52:44,176 - dodox_01907302051 - INFO - Upload Success
2019-09-02 11:52:44,349 - dodox_01907302051 - INFO - AWzwGn-nBZ1xJXgBM36D
2019-09-02 11:52:45,446 - dodox_01907302051 - INFO - bf7260909f40b0879797d7306df2bf05
2019-09-02 11:52:45,446 - dodox_01907302051 - INFO - workflow success
2019-09-02 11:52:46,632 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-02 11:52:46,632 - dodox_01907302051 - INFO - workflowid:bf7260909f40b0879797d7306df2bf05
2019-09-02 11:52:47,759 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 11:52:47,760 - db - INFO - update  public.task_info set wfid='bf7260909f40b0879797d7306df2bf05',status='up',scriptid='AWzwGn-nBZ1xJXgBM36D' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-02 11:52:47,762 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3787.08ms
2019-09-02 11:55:45,233 - db - INFO - The database has been successfully connected
2019-09-02 11:55:45,238 - db - INFO - select token from public.token_info
2019-09-02 11:55:45,274 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjgwMDEzNDUsImlhdCI6MTU2NzM5NjU0NSwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.jgzp3Lm-j3vNTYjjrC_g84mGgJ65xn4QvCi_0k5PyDUuko3eK_PRhYGmHyi0UU0NIvyNcQk_F-DTRN_OzKJNf5iWSZbboBwEE8KV8YL7kiJ3KMCKUgpzZfRLNWhIw_d25DQPR03zKnmT1SSni8WlAgCfjnr2BRBZZ2tMhLgMu_KAjksm-J2uuAlsXLhN9vbwxifY6OF1g-gAPhfvOdhgTLsc4ydJbslM1Ij8sxkxyvOoOndbz54gVCr3aUboKISheGUbi_NTykIr_1hgH99l1jHUravary_ggczKMlOQ6giQ98pi5p1Q9S6N0gqrbkOJGBErur9aLHB8uBANmROx21eTbX1VD_wt5gp5499FYKZJy6nGJNff0NVdOe1Ies2M58kuUI3Hn8osZisYQ7_T_fqFLWIuvpfAhk8iXLa5rCvIVGRF_jhhhQDhTumhdcQBE93_qpFvQzcZ0mOgb7BblSVzroxB5pRo60wBPsywlwcDd9O7_9KtSSLD1BWBJ2gK-QW2pej4h02ZeT7LFAB463UdY0Q0Ly8JHuW8tpMK9FJNiXUzEdoO0-_d3PrEUC7PLE9RZ116NGndOQGvUjgQ3FLDersH2POFnAPWzLEbkdRTA1gr7SOAlEHHMSqZ7XaWNEx98ToXrDOXc3VXIRjmAViuMd9FEctoAxK7R1o08uc' where 1='1'
2019-09-02 12:48:29,970 - db - INFO - select * from public.task_info where wfid = 'bf7260909f40b0879797d7306df2bf05'
2019-09-02 12:48:29,990 - db - INFO - update  public.task_info set status='down' where wfid='bf7260909f40b0879797d7306df2bf05'
2019-09-02 12:48:31,258 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1288.87ms
2019-09-02 12:48:36,927 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 12:48:37,039 - dodox_01907302051 - INFO - Successful folder creation
2019-09-02 12:48:37,139 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'tdt.xh_ga1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga2\"\r\n\t\t\tcurs4.execute()\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga2 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表test.xh_gaextracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-02 12:48:37,139 - dodox_01907302051 - INFO - Upload Success
2019-09-02 12:48:37,318 - dodox_01907302051 - INFO - AWzwTakqBZ1xJXgBM36a
2019-09-02 12:48:38,425 - dodox_01907302051 - INFO - a8ee7a4c9e5c015fb1cc2dd6c32fe86f
2019-09-02 12:48:38,425 - dodox_01907302051 - INFO - workflow success
2019-09-02 12:48:39,573 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-02 12:48:39,573 - dodox_01907302051 - INFO - workflowid:a8ee7a4c9e5c015fb1cc2dd6c32fe86f
2019-09-02 12:48:40,824 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 12:48:40,825 - db - INFO - update  public.task_info set wfid='a8ee7a4c9e5c015fb1cc2dd6c32fe86f',status='up',scriptid='AWzwTakqBZ1xJXgBM36a' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-02 12:48:40,827 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 4363.67ms
2019-09-02 13:58:25,651 - db - INFO - select * from public.task_info where wfid = 'a8ee7a4c9e5c015fb1cc2dd6c32fe86f'
2019-09-02 13:58:25,663 - db - INFO - update  public.task_info set status='down' where wfid='a8ee7a4c9e5c015fb1cc2dd6c32fe86f'
2019-09-02 13:58:26,896 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1245.30ms
2019-09-02 13:58:37,204 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 13:58:37,308 - dodox_01907302051 - INFO - Successful folder creation
2019-09-02 13:58:37,376 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'tdt.xh_ga1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga2\"\r\n\t\t\tcurs4.execute()\r\n\t\t\tpri.info(\"full data extraction exec successed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga2 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表test.xh_gaextracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-02 13:58:37,376 - dodox_01907302051 - INFO - Upload Success
2019-09-02 13:58:37,582 - dodox_01907302051 - INFO - AWzwjcBUBZ1xJXgBM365
2019-09-02 13:58:38,696 - dodox_01907302051 - INFO - 71e710ebafa995d3fb4e559346f4d507
2019-09-02 13:58:38,696 - dodox_01907302051 - INFO - workflow success
2019-09-02 13:58:39,823 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-02 13:58:39,823 - dodox_01907302051 - INFO - workflowid:71e710ebafa995d3fb4e559346f4d507
2019-09-02 13:58:40,974 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 13:58:40,975 - db - INFO - update  public.task_info set wfid='71e710ebafa995d3fb4e559346f4d507',status='up',scriptid='AWzwjcBUBZ1xJXgBM365' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-02 13:58:40,976 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3832.46ms
2019-09-02 14:05:00,263 - db - INFO - select * from public.task_info where wfid = '71e710ebafa995d3fb4e559346f4d507'
2019-09-02 14:05:00,270 - db - INFO - update  public.task_info set status='down' where wfid='71e710ebafa995d3fb4e559346f4d507'
2019-09-02 14:05:01,475 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1212.21ms
2019-09-02 14:10:27,389 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 14:10:27,485 - dodox_01907302051 - INFO - Successful folder creation
2019-09-02 14:10:27,533 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'tdt.xh_ga1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga2\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table tdt.xh_ga2 succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga2 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table tdt.xh_ga1 succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table test.xh_ga extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-02 14:10:27,533 - dodox_01907302051 - INFO - Upload Success
2019-09-02 14:10:27,706 - dodox_01907302051 - INFO - AWzwmJZgBZ1xJXgBM37P
2019-09-02 14:10:28,819 - dodox_01907302051 - INFO - 883994a17867626113660c5dca5a194b
2019-09-02 14:10:28,819 - dodox_01907302051 - INFO - workflow success
2019-09-02 14:10:29,954 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-02 14:10:29,954 - dodox_01907302051 - INFO - workflowid:883994a17867626113660c5dca5a194b
2019-09-02 14:10:31,089 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 14:10:31,089 - db - INFO - update  public.task_info set wfid='883994a17867626113660c5dca5a194b',status='up',scriptid='AWzwmJZgBZ1xJXgBM37P' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-02 14:10:31,091 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3779.21ms
2019-09-02 14:12:19,412 - db - INFO - select * from public.task_info where wfid = '883994a17867626113660c5dca5a194b'
2019-09-02 14:12:19,413 - db - INFO - update  public.task_info set status='down' where wfid='883994a17867626113660c5dca5a194b'
2019-09-02 14:12:20,618 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1206.34ms
2019-09-02 14:12:37,370 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 14:12:37,472 - dodox_01907302051 - INFO - Successful folder creation
2019-09-02 14:12:37,508 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'tdt.xh_ga1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga2\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table tdt.xh_ga2 succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga2 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table tdt.xh_ga1 succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table test.xh_ga extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-02 14:12:37,508 - dodox_01907302051 - INFO - Upload Success
2019-09-02 14:12:37,670 - dodox_01907302051 - INFO - AWzwmpIbBZ1xJXgBM37Z
2019-09-02 14:12:38,756 - dodox_01907302051 - INFO - 5b5384d341a8fbaba8744683b230c380
2019-09-02 14:12:38,756 - dodox_01907302051 - INFO - workflow success
2019-09-02 14:12:39,935 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-02 14:12:39,935 - dodox_01907302051 - INFO - workflowid:5b5384d341a8fbaba8744683b230c380
2019-09-02 14:12:41,100 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 14:12:41,101 - db - INFO - update  public.task_info set wfid='5b5384d341a8fbaba8744683b230c380',status='up',scriptid='AWzwmpIbBZ1xJXgBM37Z' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-02 14:12:41,103 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3795.93ms
2019-09-02 14:35:29,052 - db - INFO - select * from public.task_info where wfid = '5b5384d341a8fbaba8744683b230c380'
2019-09-02 14:35:29,059 - db - INFO - update  public.task_info set status='down' where wfid='5b5384d341a8fbaba8744683b230c380'
2019-09-02 14:35:30,287 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1235.17ms
2019-09-02 14:35:33,024 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 14:35:33,123 - dodox_01907302051 - INFO - Successful folder creation
2019-09-02 14:35:33,176 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'tdt.xh_ga1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga2\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table tdt.xh_ga2 succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga2 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table tdt.xh_ga1 succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table test.xh_ga extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-02 14:35:33,176 - dodox_01907302051 - INFO - Upload Success
2019-09-02 14:35:33,375 - dodox_01907302051 - INFO - AWzwr4_SBZ1xJXgBM37z
2019-09-02 14:35:34,460 - dodox_01907302051 - INFO - 0f4bc9dcfedf41fe24de72f800f37083
2019-09-02 14:35:34,460 - dodox_01907302051 - INFO - workflow success
2019-09-02 14:35:35,621 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-02 14:35:35,621 - dodox_01907302051 - INFO - workflowid:0f4bc9dcfedf41fe24de72f800f37083
2019-09-02 14:35:36,768 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-02 14:35:36,768 - db - INFO - update  public.task_info set wfid='0f4bc9dcfedf41fe24de72f800f37083',status='up',scriptid='AWzwr4_SBZ1xJXgBM37z' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-02 14:35:36,770 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3808.09ms
2019-09-04 17:53:20,058 - db - INFO - The database has been successfully connected
2019-09-04 17:53:20,068 - db - INFO - select token from public.token_info
2019-09-04 17:53:20,100 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjgxOTU2MDAsImlhdCI6MTU2NzU5MDgwMCwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.JnFCCs0izeECQVBV9ljMTRzQiVNfPvxbiXFGkQYBd0wxBLwzUjOKqXU2Q6p1aVsucQG06ZiQmUtntVLqVIpuGxd4t7BGaRaHKL8N9uoiCHCt2XwX0oxBiTfWJ6uvhSbBSyrvtqBBB63kTpCv0TcGe-iCO4p1TwZH1TLU8PIhGdOpfjwSFGLY39JFR990LeBp98JDtWAqZ-F1Yl_F_BQOLtYXNjBM-2k_Qs5mAzBvHGLhLwPnb1XBdyaolwu-oLGFpc1e_p1sx3-Barqa7sttBGsm64aZcQTOwGeD6gmQ-aJ3DNnzO3ndy1sYyAeJDMuGX32fq7IvhuAU16v2TV6WqrNsqLxxiRM4ryWwmW-mgtxR9x-sX1IEcFBWVdJ6iYgUFUVO8_BEuBLyFWbTLUZpIr-WH-2lkC1NIumC8P5jH3nwDQw9a9UktjCe6PmVw_zV4XEVLOaHRGowh-xjCH5fxrrOvfWqizYYZf0lOc2RsD9Rqxy8KIm6XMY-SMT8UtaIjXA3EOh6jYjcyoL_rtyNR0WKBjtg7xj6SCB55NDBAK7kpP4BizQeqRCqrQDFkSUl1AtcoReXwsnAiQTdRKYy-iN7dhjHceSHlV1GBFcHI2wcb1ha7eJDNt3VbNauo70v8E9PKJ9TG5jWAN5rRMUoNXknNxxo0cNi2CHMhsjvWPk' where 1='1'
2019-09-04 17:54:02,725 - db - INFO - select * from public.task_info where wfid = '0f4bc9dcfedf41fe24de72f800f37083'
2019-09-04 17:54:02,727 - db - INFO - update  public.task_info set status='down' where wfid='0f4bc9dcfedf41fe24de72f800f37083'
2019-09-04 17:54:03,982 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1257.04ms
2019-09-04 17:54:10,825 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-04 17:54:10,921 - dodox_01907302051 - INFO - Successful folder creation
2019-09-04 17:54:10,978 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'tdt.xh_ga1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga2\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table tdt.xh_ga2 succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga2 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table tdt.xh_ga1 succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table test.xh_ga extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-04 17:54:10,978 - dodox_01907302051 - INFO - Upload Success
2019-09-04 17:54:11,165 - dodox_01907302051 - INFO - AWz7siG3BZ1xJXgBM4BY
2019-09-04 17:54:12,261 - dodox_01907302051 - INFO - 1a11985f72f6b02054e743470026f609
2019-09-04 17:54:12,261 - dodox_01907302051 - INFO - workflow success
2019-09-04 17:54:13,402 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-04 17:54:13,402 - dodox_01907302051 - INFO - workflowid:1a11985f72f6b02054e743470026f609
2019-09-04 17:54:14,564 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-04 17:54:14,564 - db - INFO - update  public.task_info set wfid='1a11985f72f6b02054e743470026f609',status='up',scriptid='AWz7siG3BZ1xJXgBM4BY' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-04 17:54:14,566 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3803.23ms
2019-09-04 18:31:51,055 - db - INFO - select * from public.task_info where wfid = '1fff58303a923f2b8ed4035e371f1bd7'
2019-09-04 18:31:52,141 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1085.99ms
2019-09-04 18:31:52,253 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-04 18:31:52,254 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 57.33ms
2019-09-04 18:33:05,872 - db - INFO - select * from public.task_info where wfid = '1fff58303a923f2b8ed4035e371f1bd7'
2019-09-04 18:33:06,922 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1051.16ms
2019-09-04 18:33:07,030 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga1'
2019-09-04 18:33:07,105 - dodox_01907302051 - INFO - Successful folder creation
2019-09-04 18:33:07,147 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga1.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga1.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga1.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga1.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga1.log', 'tdt.xh_ga1', 'test.xh_ga1','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga1 data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga1\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga1_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga1_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga1_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga1_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga1.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga1_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga1.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga1_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga1.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga1_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga1.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga1.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga21\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table tdt.xh_ga21 succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga21 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table tdt.xh_ga1 succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table test.xh_ga1 extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga1.py"}}

2019-09-04 18:33:07,147 - dodox_01907302051 - INFO - Upload Success
2019-09-04 18:33:07,334 - dodox_01907302051 - INFO - AWz71cdVBZ1xJXgBM4Bv
2019-09-04 18:33:08,404 - dodox_01907302051 - INFO - 54afcd8cdc47e5c8b8e42a8a29ed25a3
2019-09-04 18:33:08,405 - dodox_01907302051 - INFO - workflow success
2019-09-04 18:33:09,562 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-04 18:33:09,562 - dodox_01907302051 - INFO - workflowid:54afcd8cdc47e5c8b8e42a8a29ed25a3
2019-09-04 18:33:10,691 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga1'
2019-09-04 18:33:10,691 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('54afcd8cdc47e5c8b8e42a8a29ed25a3','up','AWz71cdVBZ1xJXgBM4Bv','huanbaoju_16_87_test_xh_ga1')
2019-09-04 18:33:10,693 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3716.42ms
2019-09-04 18:33:39,261 - db - INFO - select * from public.task_info where wfid = '54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 18:33:39,262 - db - INFO - update  public.task_info set status='down' where wfid='54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 18:33:40,482 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1221.12ms
2019-09-04 19:11:21,063 - db - INFO - select * from public.task_info where wfid = '54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:11:21,064 - db - INFO - update  public.task_info set status='down' where wfid='54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:11:22,115 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1052.30ms
2019-09-04 19:11:45,646 - db - INFO - select * from public.task_info where wfid = '54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:11:45,647 - db - INFO - update  public.task_info set status='down' where wfid='54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:11:46,699 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1053.01ms
2019-09-04 19:11:46,764 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:11:46,806 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:11:46,814 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:11:46,821 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:16:39,520 - db - INFO - select * from public.task_info where wfid = '54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:16:39,521 - db - INFO - update  public.task_info set status='down' where wfid='54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:16:40,585 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1065.35ms
2019-09-04 19:16:40,654 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:16:40,663 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:16:40,670 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:16:40,676 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:21:05,637 - db - INFO - select * from public.task_info where wfid = '54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:21:05,638 - db - INFO - update  public.task_info set status='down' where wfid='54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:21:06,689 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1051.89ms
2019-09-04 19:21:06,751 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:21:06,759 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:21:06,767 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:21:06,775 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:21:43,241 - db - INFO - select * from public.task_info where wfid = '54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:21:43,242 - db - INFO - update  public.task_info set status='down' where wfid='54afcd8cdc47e5c8b8e42a8a29ed25a3'
2019-09-04 19:21:44,293 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1052.57ms
2019-09-04 19:21:44,420 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-04 19:21:44,421 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 57.92ms
2019-09-04 19:22:08,230 - db - INFO - select * from public.task_info where wfid = '1a11985f72f6b02054e743470026f609'
2019-09-04 19:22:08,230 - db - INFO - update  public.task_info set status='down' where wfid='1a11985f72f6b02054e743470026f609'
2019-09-04 19:22:09,448 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1218.98ms
2019-09-04 19:22:09,559 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-04 19:22:09,631 - dodox_01907302051 - INFO - Successful folder creation
2019-09-04 19:22:09,660 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'tdt.xh_ga1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga2\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table tdt.xh_ga2 succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga2 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table tdt.xh_ga1 succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table test.xh_ga extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-04 19:22:09,660 - dodox_01907302051 - INFO - Upload Success
2019-09-04 19:22:09,828 - dodox_01907302051 - INFO - AWz8Aq2UBZ1xJXgBM4CF
2019-09-04 19:22:10,889 - dodox_01907302051 - INFO - 4a008fb00f9b397c1cddc2bd2c5dfbe7
2019-09-04 19:22:10,889 - dodox_01907302051 - INFO - workflow success
2019-09-04 19:22:12,010 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-04 19:22:12,010 - dodox_01907302051 - INFO - workflowid:4a008fb00f9b397c1cddc2bd2c5dfbe7
2019-09-04 19:22:13,134 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-04 19:22:13,134 - db - INFO - update  public.task_info set wfid='4a008fb00f9b397c1cddc2bd2c5dfbe7',status='up',scriptid='AWz8Aq2UBZ1xJXgBM4CF' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-04 19:22:13,136 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3631.02ms
2019-09-04 19:28:12,302 - db - INFO - select * from public.task_info where wfid = '4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:28:12,303 - db - INFO - update  public.task_info set status='down' where wfid='4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:28:13,475 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1172.78ms
2019-09-04 19:28:13,542 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:28:13,551 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:28:13,558 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:28:13,565 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:19,723 - db - INFO - select * from public.task_info where wfid = '4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:29:19,724 - db - INFO - update  public.task_info set status='down' where wfid='4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:29:20,773 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1049.78ms
2019-09-04 19:29:20,831 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:20,839 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:20,845 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:20,852 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:34,518 - db - INFO - select * from public.task_info where wfid = '4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:29:34,519 - db - INFO - update  public.task_info set status='down' where wfid='4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:29:35,567 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1049.17ms
2019-09-04 19:29:35,628 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:35,635 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:35,642 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:35,649 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:54,172 - db - INFO - select * from public.task_info where wfid = '4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:29:54,172 - db - INFO - update  public.task_info set status='down' where wfid='4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:29:55,226 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1055.06ms
2019-09-04 19:29:55,287 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:55,296 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:55,303 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:29:55,310 - tornado.application - ERROR - Uncaught exception
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/http1connection.py", line 238, in _read_message
    delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/routing.py", line 256, in finish
    self.delegate.finish()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2195, in finish
    self.execute()
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2228, in execute
    **self.path_kwargs)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/gen.py", line 326, in wrapper
    yielded = next(result)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "api_201907302051.py", line 54, in post
    unitname,databasetype,sourceip,sourceport,sourcedbname,sourceaddress,sourceusername,sourcepassword = source_params(UnitId, Dbname)
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 75, in source_params
    pri.error("source database connect failed,please check stork status!")
  File "/opt/dodox_api/GenerateWorkflowScript.py", line 42, in error
    sys.exit(2)
SystemExit: 2
2019-09-04 19:30:27,756 - db - INFO - select * from public.task_info where wfid = '4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:30:27,757 - db - INFO - update  public.task_info set status='down' where wfid='4a008fb00f9b397c1cddc2bd2c5dfbe7'
2019-09-04 19:30:28,820 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1064.23ms
2019-09-04 19:30:28,942 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-04 19:30:29,032 - dodox_01907302051 - INFO - Successful folder creation
2019-09-04 19:30:29,078 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'shenjiju_txt.packet_in_exchange1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table shenjiju_txt.packet_in_exchange1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table shenjiju_orc.packet_in_exchange1\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table shenjiju_orc.packet_in_exchange1 succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into shenjiju_orc.packet_in_exchange1 (BATH,CREATETIME,PROVINCE_CODE,PARAM1,PARAM2,PARAM3,PARAM4,PARAM5,RECOURD_NUM,TABLE_NAME,ID,MX) select BATH,CREATETIME,PROVINCE_CODE,PARAM1,PARAM2,PARAM3,PARAM4,PARAM5,RECOURD_NUM,TABLE_NAME,ID,MX  from shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table shenjiju_txt.packet_in_exchange1 succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table test.xh_ga extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-04 19:30:29,078 - dodox_01907302051 - INFO - Upload Success
2019-09-04 19:30:29,247 - dodox_01907302051 - INFO - AWz8CkxuBZ1xJXgBM4CV
2019-09-04 19:30:30,337 - dodox_01907302051 - INFO - d376a316acc560150323b066afa84f1a
2019-09-04 19:30:30,337 - dodox_01907302051 - INFO - workflow success
2019-09-04 19:30:31,443 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-04 19:30:31,444 - dodox_01907302051 - INFO - workflowid:d376a316acc560150323b066afa84f1a
2019-09-04 19:30:32,573 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-04 19:30:32,574 - db - INFO - update  public.task_info set wfid='d376a316acc560150323b066afa84f1a',status='up',scriptid='AWz8CkxuBZ1xJXgBM4CV' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-04 19:30:32,576 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3695.03ms
2019-09-04 19:31:22,689 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-04 19:31:22,690 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 56.45ms
2019-09-04 19:35:10,586 - db - INFO - select * from public.task_info where wfid = 'd376a316acc560150323b066afa84f1a'
2019-09-04 19:35:10,587 - db - INFO - update  public.task_info set status='down' where wfid='d376a316acc560150323b066afa84f1a'
2019-09-04 19:35:11,741 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1155.67ms
2019-09-05 14:14:43,366 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df'
2019-09-05 14:14:43,379 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 104.98ms
2019-09-05 14:15:02,435 - db - INFO - select * from public.task_info where wfid = '6043b8ed4a0704205a248601bb835f49'
2019-09-05 14:15:02,436 - db - INFO - update  public.task_info set status='down' where wfid='6043b8ed4a0704205a248601bb835f49'
2019-09-05 14:15:03,818 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1383.25ms
2019-09-05 14:15:10,326 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df'
2019-09-05 14:15:10,472 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:15:10,531 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.log', 'gonganju_txt_ods.base_syrk_t_rjbxx_xjcj_df', 'dsjzx.base_syrk_t_rjbxx_xjcj_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_syrk_t_rjbxx_xjcj_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_syrk_t_rjbxx_xjcj_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_xjcj_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_xjcj_df.txt' into table gonganju_txt_ods.base_syrk_t_rjbxx_xjcj_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_syrk_t_rjbxx_xjcj_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_syrk_t_rjbxx_xjcj_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_syrk_t_rjbxx_xjcj_df (rid,xm,xbdm,mzdm,sg,csrq,gmsfhm,czhkszd_xzqhdm,czhkszd_dzmc,cjrxm,cjrzjhm,cjrlxfs,cjrdwdm,cjsj,zzmmdm,whcddm,dhmddm,lhfsdm,sjlybz,babz,gxr,gxsj,zt,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,xm,xbdm,mzdm,sg,csrq,gmsfhm,czhkszd_xzqhdm,czhkszd_dzmc,cjrxm,cjrzjhm,cjrlxfs,cjrdwdm,cjsj,zzmmdm,whcddm,dhmddm,lhfsdm,sjlybz,babz,gxr,gxsj,zt,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_syrk_t_rjbxx_xjcj_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_syrk_t_rjbxx_xjcj_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_syrk_t_rjbxx_xjcj_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_syrk_t_rjbxx_xjcj_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df.py"}}

2019-09-05 14:15:10,532 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:15:10,719 - dodox_01907302051 - INFO - AW0AD_veBZ1xJXgBM4FD
2019-09-05 14:15:11,866 - dodox_01907302051 - INFO - b9ef2b335aaf58ec9a6df4f6c45c8cab
2019-09-05 14:15:11,866 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:15:13,016 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:15:13,016 - dodox_01907302051 - INFO - workflowid:b9ef2b335aaf58ec9a6df4f6c45c8cab
2019-09-05 14:15:14,195 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df'
2019-09-05 14:15:14,196 - db - INFO - update  public.task_info set wfid='b9ef2b335aaf58ec9a6df4f6c45c8cab',status='up',scriptid='AW0AD_veBZ1xJXgBM4FD' where workflowname='gonganju_8_103_dsjzx_base_syrk_t_rjbxx_xjcj_df'
2019-09-05 14:15:14,197 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3926.78ms
2019-09-05 14:22:34,016 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df'
2019-09-05 14:22:34,017 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.04ms
2019-09-05 14:22:41,290 - db - INFO - select * from public.task_info where wfid = 'bb734dd6cb6568fc1ac04751fb51ab01'
2019-09-05 14:22:41,291 - db - INFO - update  public.task_info set status='down' where wfid='bb734dd6cb6568fc1ac04751fb51ab01'
2019-09-05 14:22:42,488 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1198.25ms
2019-09-05 14:22:46,869 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df'
2019-09-05 14:22:46,940 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:22:46,981 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.log', 'gonganju_txt_ods.base_syrk_t_gl_jzdz_df', 'dsjzx.base_syrk_t_gl_jzdz_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_syrk_t_gl_jzdz_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_syrk_t_gl_jzdz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_syrk_t_gl_jzdz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_syrk_t_gl_jzdz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_syrk_t_gl_jzdz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_syrk_t_gl_jzdz_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_gl_jzdz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_gl_jzdz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_gl_jzdz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_syrk_t_gl_jzdz_df.txt' into table gonganju_txt_ods.base_syrk_t_gl_jzdz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_syrk_t_gl_jzdz_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_syrk_t_gl_jzdz_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_syrk_t_gl_jzdz_df (gmsfhm,jzdz_xzqhdm,jzdz_lmdm,jzdz_mlph,jzdz_dzmc,zsqkdm,cjrxm,cjrzjhm,cjrlxfs,cjrdwdm,cjsj,rid,id,sjlybz,babz,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select gmsfhm,jzdz_xzqhdm,jzdz_lmdm,jzdz_mlph,jzdz_dzmc,zsqkdm,cjrxm,cjrzjhm,cjrlxfs,cjrdwdm,cjsj,rid,id,sjlybz,babz,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_syrk_t_gl_jzdz_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_syrk_t_gl_jzdz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_syrk_t_gl_jzdz_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_syrk_t_gl_jzdz_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df.py"}}

2019-09-05 14:22:46,981 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:22:47,148 - dodox_01907302051 - INFO - AW0AFvLYBZ1xJXgBM4FR
2019-09-05 14:22:48,246 - dodox_01907302051 - INFO - 47fbe0a271e33254e6528a85eafe5a12
2019-09-05 14:22:48,246 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:22:49,363 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:22:49,363 - dodox_01907302051 - INFO - workflowid:47fbe0a271e33254e6528a85eafe5a12
2019-09-05 14:22:50,486 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df'
2019-09-05 14:22:50,486 - db - INFO - update  public.task_info set wfid='47fbe0a271e33254e6528a85eafe5a12',status='up',scriptid='AW0AFvLYBZ1xJXgBM4FR' where workflowname='gonganju_8_103_dsjzx_base_syrk_t_gl_jzdz_df'
2019-09-05 14:22:50,488 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3676.67ms
2019-09-05 14:23:33,619 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shlg_t_hotel_df'
2019-09-05 14:23:33,621 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 59.07ms
2019-09-05 14:23:41,621 - db - INFO - select * from public.task_info where wfid = '6caab38e499416c673fef6b1a8a583dc'
2019-09-05 14:23:41,621 - db - INFO - update  public.task_info set status='down' where wfid='6caab38e499416c673fef6b1a8a583dc'
2019-09-05 14:23:42,812 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1191.54ms
2019-09-05 14:23:47,094 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shlg_t_hotel_df'
2019-09-05 14:23:47,169 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:23:47,204 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.log', 'gonganju_txt_ods.base_shlg_t_hotel_df', 'dsjzx.base_shlg_t_hotel_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_shlg_t_hotel_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_shlg_t_hotel_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_shlg_t_hotel_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_shlg_t_hotel_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_shlg_t_hotel_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_shlg_t_hotel_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_shlg_t_hotel_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shlg_t_hotel_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shlg_t_hotel_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_shlg_t_hotel_df.txt' into table gonganju_txt_ods.base_shlg_t_hotel_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_shlg_t_hotel_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_shlg_t_hotel_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_shlg_t_hotel_df (h_lvguandaima,h_lvguanmingcheng,h_farenmingcheng,h_lvguanzongjingli,h_lvguanzhianzerenren,h_xiangzhi,h_lvguanlianxidianhua,h_baoanbudianhua,h_zhuangtai,h_zhuangtaigaibianriqi,h_zhuangtaigaibianriqi_dt,h_fangjianshu,h_chuangweishu,h_lvguanxingji,h_lvguandengji,h_sno,stationid,recordsno,h_paichusuodm,h_paichusuo,h_mnemonic,h_zhycscsj,deip_time,deip_update_time,h_dianzhao,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select h_lvguandaima,h_lvguanmingcheng,h_farenmingcheng,h_lvguanzongjingli,h_lvguanzhianzerenren,h_xiangzhi,h_lvguanlianxidianhua,h_baoanbudianhua,h_zhuangtai,h_zhuangtaigaibianriqi,h_zhuangtaigaibianriqi_dt,h_fangjianshu,h_chuangweishu,h_lvguanxingji,h_lvguandengji,h_sno,stationid,recordsno,h_paichusuodm,h_paichusuo,h_mnemonic,h_zhycscsj,deip_time,deip_update_time,h_dianzhao,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_shlg_t_hotel_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_shlg_t_hotel_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_shlg_t_hotel_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_shlg_t_hotel_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_shlg_t_hotel_df.py"}}

2019-09-05 14:23:47,205 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:23:47,390 - dodox_01907302051 - INFO - AW0AF94cBZ1xJXgBM4Fc
2019-09-05 14:23:48,495 - dodox_01907302051 - INFO - c8d7f4bb68f6847ccc5b05e2d566b7f9
2019-09-05 14:23:48,495 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:23:49,619 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:23:49,619 - dodox_01907302051 - INFO - workflowid:c8d7f4bb68f6847ccc5b05e2d566b7f9
2019-09-05 14:23:50,745 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shlg_t_hotel_df'
2019-09-05 14:23:50,746 - db - INFO - update  public.task_info set wfid='c8d7f4bb68f6847ccc5b05e2d566b7f9',status='up',scriptid='AW0AF94cBZ1xJXgBM4Fc' where workflowname='gonganju_8_103_dsjzx_base_shlg_t_hotel_df'
2019-09-05 14:23:50,748 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3709.14ms
2019-09-05 14:24:32,460 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df'
2019-09-05 14:24:32,462 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.34ms
2019-09-05 14:24:43,037 - db - INFO - select * from public.task_info where wfid = '4c551093458c0c79e5a7d015465ebfa7'
2019-09-05 14:24:43,038 - db - INFO - update  public.task_info set status='down' where wfid='4c551093458c0c79e5a7d015465ebfa7'
2019-09-05 14:24:44,220 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1183.36ms
2019-09-05 14:24:48,709 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df'
2019-09-05 14:24:48,774 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:24:48,810 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.log', 'gonganju_txt_ods.base_shjz_t_wxwp_jdgmpz_df', 'dsjzx.base_shjz_t_wxwp_jdgmpz_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_shjz_t_wxwp_jdgmpz_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_shjz_t_wxwp_jdgmpz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdgmpz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdgmpz_df.txt' into table gonganju_txt_ods.base_shjz_t_wxwp_jdgmpz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_shjz_t_wxwp_jdgmpz_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_shjz_t_wxwp_jdgmpz_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_shjz_t_wxwp_jdgmpz_df (gmpzbh,zghxpmc,dwmc,dwszdlm,dwszdxz,dwdh,frdb,fzjg,fzrq,gmjbrxm,jbrgmsfhm,bz,tbr,tbrq,pcsbm,rksj,cjrjh,cjrxm,cjsj,zxrq,zxyy,zxcjsj,zxcjrxm,zxcjrjh,id,zxflag,hid,isdr,zxlx,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select gmpzbh,zghxpmc,dwmc,dwszdlm,dwszdxz,dwdh,frdb,fzjg,fzrq,gmjbrxm,jbrgmsfhm,bz,tbr,tbrq,pcsbm,rksj,cjrjh,cjrxm,cjsj,zxrq,zxyy,zxcjsj,zxcjrxm,zxcjrjh,id,zxflag,hid,isdr,zxlx,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_shjz_t_wxwp_jdgmpz_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_shjz_t_wxwp_jdgmpz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_shjz_t_wxwp_jdgmpz_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_shjz_t_wxwp_jdgmpz_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df.py"}}

2019-09-05 14:24:48,811 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:24:48,992 - dodox_01907302051 - INFO - AW0AGM7CBZ1xJXgBM4Fl
2019-09-05 14:24:50,071 - dodox_01907302051 - INFO - c99b5f4dc4e6cebdebcdc4eb5e4ac451
2019-09-05 14:24:50,071 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:24:51,191 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:24:51,192 - dodox_01907302051 - INFO - workflowid:c99b5f4dc4e6cebdebcdc4eb5e4ac451
2019-09-05 14:24:52,322 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df'
2019-09-05 14:24:52,322 - db - INFO - update  public.task_info set wfid='c99b5f4dc4e6cebdebcdc4eb5e4ac451',status='up',scriptid='AW0AGM7CBZ1xJXgBM4Fl' where workflowname='gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdgmpz_df'
2019-09-05 14:24:52,324 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3669.33ms
2019-09-05 14:27:03,807 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df'
2019-09-05 14:27:03,808 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.51ms
2019-09-05 14:27:12,341 - db - INFO - select * from public.task_info where wfid = '95f8c97c2f09018886eeb76e8d7ab9fc'
2019-09-05 14:27:12,342 - db - INFO - update  public.task_info set status='down' where wfid='95f8c97c2f09018886eeb76e8d7ab9fc'
2019-09-05 14:27:13,535 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1194.33ms
2019-09-05 14:27:18,168 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df'
2019-09-05 14:27:18,253 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:27:18,286 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.log', 'gonganju_txt_ods.base_jjlhy_acd_duty_df', 'dsjzx.base_jjlhy_acd_duty_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_acd_duty_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_acd_duty_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_acd_duty_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_acd_duty_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_acd_duty_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_acd_duty_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_duty_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_duty_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_duty_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_duty_df.txt' into table gonganju_txt_ods.base_jjlhy_acd_duty_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jjlhy_acd_duty_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jjlhy_acd_duty_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_acd_duty_df (sgbh,wsbh,jbss,dsfqk,rdnr,baryj,zjyj,cbr1,cbr2,xbrq,tqsprq,sprq,spr,jbr,wszt,jyw,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select sgbh,wsbh,jbss,dsfqk,rdnr,baryj,zjyj,cbr1,cbr2,xbrq,tqsprq,sprq,spr,jbr,wszt,jyw,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_acd_duty_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_acd_duty_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jjlhy_acd_duty_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_acd_duty_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df.py"}}

2019-09-05 14:27:18,286 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:27:18,447 - dodox_01907302051 - INFO - AW0AGxahBZ1xJXgBM4Fu
2019-09-05 14:27:19,533 - dodox_01907302051 - INFO - 305980a597741f750079a193d0816a8d
2019-09-05 14:27:19,533 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:27:20,645 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:27:20,645 - dodox_01907302051 - INFO - workflowid:305980a597741f750079a193d0816a8d
2019-09-05 14:27:21,762 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df'
2019-09-05 14:27:21,762 - db - INFO - update  public.task_info set wfid='305980a597741f750079a193d0816a8d',status='up',scriptid='AW0AGxahBZ1xJXgBM4Fu' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df'
2019-09-05 14:27:21,764 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3650.42ms
2019-09-05 14:28:37,731 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_duty_df'
2019-09-05 14:28:37,733 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.04ms
2019-09-05 14:29:56,849 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df'
2019-09-05 14:29:56,851 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 59.31ms
2019-09-05 14:30:06,489 - db - INFO - select * from public.task_info where wfid = '15531f3446b132efa0340f7eae49e715'
2019-09-05 14:30:06,490 - db - INFO - update  public.task_info set status='down' where wfid='15531f3446b132efa0340f7eae49e715'
2019-09-05 14:30:07,673 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1184.47ms
2019-09-05 14:30:11,914 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df'
2019-09-05 14:30:11,983 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:30:12,023 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.log', 'gonganju_txt_ods.base_jjlhy_acd_filehuman_df', 'dsjzx.base_jjlhy_acd_filehuman_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_acd_filehuman_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_acd_filehuman_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_acd_filehuman_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_acd_filehuman_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_acd_filehuman_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_acd_filehuman_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_filehuman_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_filehuman_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_acd_filehuman_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_acd_filehuman_df.txt' into table gonganju_txt_ods.base_jjlhy_acd_filehuman_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jjlhy_acd_filehuman_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jjlhy_acd_filehuman_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_acd_filehuman_df (sgbh,xzqh,rybh,sfdsr,dwgr,xm,xb,sfzmhm,nl,csny,mz,gj,whcd,jg,hjz,zz,dh,rylx,wgrlx,dw,sfty,swsj,shcd,shcd24,shcd3,shcd7,shcd30,ssbw,zsyy,hkxz,wfxw1,wfxw2,wfxw3,zyysdw,yzbm,jtfs,glxzqh,dabh,jl,jszzl,jsrlx,zjcx,cclzrq,fzjg,jxmc,sgzr,bx,bxgs,bxpzh,xyjjhl,xszt,aqdtkqk,xrzt,xrsd,pzjs,clbsqdw,clzxdzt,clzmdzt,claqqnzt,hphm,hpzl,clfzjg,clpp,clxh,syq,jdcsyr,clsyxz,clsbdh,fdjh,jdcxh,csys,sfcz,hzl,szl,cllx,jdczt,hpzl1,hphm1,cllx1,clpp1,clxh1,hzl1,szl1,clhfzt,claqzk,glkylc,glkyjyfs,yzwxp,wxpzl,ysxk,wxpcyzg,yzwxphg,czclbh,ylzd1,ylzd2,ylzd3,ylzd4,ylzd5,tdyl1,tdyl2,tdyl3,tdyl4,tdyl5,tdyl6,tdyl7,tdyl8,tdyl9,tdyl10,cjcxbj,jyw,fsjg,ffjg,clsyxzy,ytsx,sfxcfw,xcjszg,xdzt,dwd_loadtime,dwd_updatetime,dwd_yxbz,xzqhmc,xbmc,mzmc,gjmc,whcdmc,jgmc,shcdmc,ssbwmc,zsyymc,wfxw1mc,wfxw2mc,wfxw3mc,jtfsmc,jszzlmc,jsrlxmc,zjcxmc,fzjgmc,sgzrmc,bxgsmc,xsztmc,hpzlmc,clsyxzmc,csysmc,cllxmc,clhfztmc,csny_dt,csny_int,swsj_dt,swsj_int,cclzrq_dt,cclzrq_int,dt,jhpt_update_time,jhpt_delete) select sgbh,xzqh,rybh,sfdsr,dwgr,xm,xb,sfzmhm,nl,csny,mz,gj,whcd,jg,hjz,zz,dh,rylx,wgrlx,dw,sfty,swsj,shcd,shcd24,shcd3,shcd7,shcd30,ssbw,zsyy,hkxz,wfxw1,wfxw2,wfxw3,zyysdw,yzbm,jtfs,glxzqh,dabh,jl,jszzl,jsrlx,zjcx,cclzrq,fzjg,jxmc,sgzr,bx,bxgs,bxpzh,xyjjhl,xszt,aqdtkqk,xrzt,xrsd,pzjs,clbsqdw,clzxdzt,clzmdzt,claqqnzt,hphm,hpzl,clfzjg,clpp,clxh,syq,jdcsyr,clsyxz,clsbdh,fdjh,jdcxh,csys,sfcz,hzl,szl,cllx,jdczt,hpzl1,hphm1,cllx1,clpp1,clxh1,hzl1,szl1,clhfzt,claqzk,glkylc,glkyjyfs,yzwxp,wxpzl,ysxk,wxpcyzg,yzwxphg,czclbh,ylzd1,ylzd2,ylzd3,ylzd4,ylzd5,tdyl1,tdyl2,tdyl3,tdyl4,tdyl5,tdyl6,tdyl7,tdyl8,tdyl9,tdyl10,cjcxbj,jyw,fsjg,ffjg,clsyxzy,ytsx,sfxcfw,xcjszg,xdzt,dwd_loadtime,dwd_updatetime,dwd_yxbz,xzqhmc,xbmc,mzmc,gjmc,whcdmc,jgmc,shcdmc,ssbwmc,zsyymc,wfxw1mc,wfxw2mc,wfxw3mc,jtfsmc,jszzlmc,jsrlxmc,zjcxmc,fzjgmc,sgzrmc,bxgsmc,xsztmc,hpzlmc,clsyxzmc,csysmc,cllxmc,clhfztmc,csny_dt,csny_int,swsj_dt,swsj_int,cclzrq_dt,cclzrq_int,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_acd_filehuman_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_acd_filehuman_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jjlhy_acd_filehuman_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_acd_filehuman_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df.py"}}

2019-09-05 14:30:12,024 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:30:12,197 - dodox_01907302051 - INFO - AW0AHb1KBZ1xJXgBM4GF
2019-09-05 14:30:13,263 - dodox_01907302051 - INFO - fe8ed28dfa1f5018f5c1a09410895f73
2019-09-05 14:30:13,263 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:30:14,368 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:30:14,368 - dodox_01907302051 - INFO - workflowid:fe8ed28dfa1f5018f5c1a09410895f73
2019-09-05 14:30:15,479 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df'
2019-09-05 14:30:15,479 - db - INFO - update  public.task_info set wfid='fe8ed28dfa1f5018f5c1a09410895f73',status='up',scriptid='AW0AHb1KBZ1xJXgBM4GF' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_acd_filehuman_df'
2019-09-05 14:30:15,481 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3621.71ms
2019-09-05 14:32:07,949 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df'
2019-09-05 14:32:07,950 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.63ms
2019-09-05 14:32:15,695 - db - INFO - select * from public.task_info where wfid = '8cf741919d99e14df1dd7c2532ffb2b9'
2019-09-05 14:32:15,695 - db - INFO - update  public.task_info set status='down' where wfid='8cf741919d99e14df1dd7c2532ffb2b9'
2019-09-05 14:32:16,892 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1197.75ms
2019-09-05 14:32:25,217 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df'
2019-09-05 14:32:25,283 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:32:25,357 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.log', 'gonganju_txt_ods.base_shjz_t_wxwp_jdzgz_df', 'dsjzx.base_shjz_t_wxwp_jdzgz_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_shjz_t_wxwp_jdzgz_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_shjz_t_wxwp_jdzgz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_shjz_t_wxwp_jdzgz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_shjz_t_wxwp_jdzgz_df.txt' into table gonganju_txt_ods.base_shjz_t_wxwp_jdzgz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_shjz_t_wxwp_jdzgz_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_shjz_t_wxwp_jdzgz_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_shjz_t_wxwp_jdzgz_df (dwmc,xsdw,pzbh,gmjbrxm,jbrgmsfhm1,xsjbrxm,jbrgmsfhm2,xsfzrxm,yxrq,bz,tbr,tbrq,pcsbm,rksj,cjrjh,cjrxm,cjsj,zxrq,zxyy,zxcjsj,zxcjrxm,zxcjrjh,id,zxflag,hid,fzjg,zghxpmc,isdr,zxlx,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select dwmc,xsdw,pzbh,gmjbrxm,jbrgmsfhm1,xsjbrxm,jbrgmsfhm2,xsfzrxm,yxrq,bz,tbr,tbrq,pcsbm,rksj,cjrjh,cjrxm,cjsj,zxrq,zxyy,zxcjsj,zxcjrxm,zxcjrjh,id,zxflag,hid,fzjg,zghxpmc,isdr,zxlx,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_shjz_t_wxwp_jdzgz_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_shjz_t_wxwp_jdzgz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_shjz_t_wxwp_jdzgz_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_shjz_t_wxwp_jdzgz_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df.py"}}

2019-09-05 14:32:25,357 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:32:25,491 - dodox_01907302051 - INFO - AW0AH8YhBZ1xJXgBM4GV
2019-09-05 14:32:26,577 - dodox_01907302051 - INFO - d9c558d7a8c0260af677329c25893621
2019-09-05 14:32:26,577 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:32:27,684 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:32:27,684 - dodox_01907302051 - INFO - workflowid:d9c558d7a8c0260af677329c25893621
2019-09-05 14:32:28,806 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df'
2019-09-05 14:32:28,807 - db - INFO - update  public.task_info set wfid='d9c558d7a8c0260af677329c25893621',status='up',scriptid='AW0AH8YhBZ1xJXgBM4GV' where workflowname='gonganju_8_103_dsjzx_base_shjz_t_wxwp_jdzgz_df'
2019-09-05 14:32:28,809 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3646.77ms
2019-09-05 14:37:25,478 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx'
2019-09-05 14:37:25,479 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.68ms
2019-09-05 14:37:35,220 - db - INFO - select * from public.task_info where wfid = 'd7b397db021dd697e9832eacf150be4c'
2019-09-05 14:37:35,221 - db - INFO - update  public.task_info set status='down' where wfid='d7b397db021dd697e9832eacf150be4c'
2019-09-05 14:37:36,388 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1168.53ms
2019-09-05 14:37:40,754 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx'
2019-09-05 14:37:40,818 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:37:40,873 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.log', 'gonganju_txt_ods.base_kksj_sjkk_sbxx', 'dsjzx.base_kksj_sjkk_sbxx','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_kksj_sjkk_sbxx data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_kksj_sjkk_sbxx\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_kksj_sjkk_sbxx_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_kksj_sjkk_sbxx_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_kksj_sjkk_sbxx_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_kksj_sjkk_sbxx_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_kksj_sjkk_sbxx_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_kksj_sjkk_sbxx_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_kksj_sjkk_sbxx_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_kksj_sjkk_sbxx.txt' into table gonganju_txt_ods.base_kksj_sjkk_sbxx\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_kksj_sjkk_sbxx\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_kksj_sjkk_sbxx succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_kksj_sjkk_sbxx (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_kksj_sjkk_sbxx\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_kksj_sjkk_sbxx\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_kksj_sjkk_sbxx succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_kksj_sjkk_sbxx extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx.py"}}

2019-09-05 14:37:40,873 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:37:41,022 - dodox_01907302051 - INFO - AW0AJJabBZ1xJXgBM4Gq
2019-09-05 14:37:42,098 - dodox_01907302051 - INFO - 805ead1a10fee7874616aa5848f2042f
2019-09-05 14:37:42,099 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:37:43,204 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:37:43,204 - dodox_01907302051 - INFO - workflowid:805ead1a10fee7874616aa5848f2042f
2019-09-05 14:37:44,323 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx'
2019-09-05 14:37:44,324 - db - INFO - update  public.task_info set wfid='805ead1a10fee7874616aa5848f2042f',status='up',scriptid='AW0AJJabBZ1xJXgBM4Gq' where workflowname='gonganju_8_103_dsjzx_base_kksj_sjkk_sbxx'
2019-09-05 14:37:44,325 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3628.02ms
2019-09-05 14:45:10,725 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df'
2019-09-05 14:45:10,726 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.50ms
2019-09-05 14:45:17,733 - db - INFO - select * from public.task_info where wfid = '9d135238dfcc8eb9a8526216f7e8f37a'
2019-09-05 14:45:17,733 - db - INFO - update  public.task_info set status='down' where wfid='9d135238dfcc8eb9a8526216f7e8f37a'
2019-09-05 14:45:18,899 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1167.28ms
2019-09-05 14:45:22,727 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df'
2019-09-05 14:45:22,799 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:45:22,852 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.log', 'gonganju_txt_ods.base_crjdata_cjsqxx_df', 'dsjzx.base_crjdata_cjsqxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_cjsqxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_cjsqxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_cjsqxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_cjsqxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_cjsqxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_cjsqxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_cjsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_cjsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_cjsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_cjsqxx_df.txt' into table gonganju_txt_ods.base_crjdata_cjsqxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_crjdata_cjsqxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_crjdata_cjsqxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_cjsqxx_df (sq_id,ry_id,rybh,ywbh,sqlb,bzlb,bm,mz,hyzk,zzmm,whcd,gzdw,zy,zwzc,lxdh,hkszd,sspcs,jtzz,sfxtkzd,sjr,yzbm,emsdz,sfxsjfsspzk,sjhm,swbadwbh,swbadwmc,dbdw,brjl,qwd,cjsy,djsy,xczjzl,xczjhm,xczjqfrq,xczjyxqz,sbzjhm,sbqzhm,sldw,slrq,slr,spdw,sprq,spr,spjg,bpzyy,zzrq,fzrq,gdrq,jjbs,tbbs,hdbh,sfqrbz,sflb,sfje,sfbz,syhbs,sfsyhsj,sfyhfksj,tfsyhsj,tfyhfksj,qrsfsj,qrsfr,qrtfsj,qrtfr,xxrs,xxid,dah,xxly,xxjb,glywbh,yyqzrq,sfxxz,sfxqz,sfxjz,sfcjzp,sfyjrga,jrgarq,lpzx,lpzm,bz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,xb,csrq,sfzh,gjdq,rydylb,csd,slrqchar,sprqchar,zzzrqchar,zqzrqchar,zzrqchar,fzrqchar,zwtxcjjg,zwmbcjjg,zzznm1,zzznm2,stglxx,stbzxx,sjbh,zwbh,rwbh,sfdzzj,zwmbxrgaq,sqh,tjbh,lxth,sflyhz,yyslsj,lyfph,qzzl,jzzl,qzhm,jffs,qrbz,hkqrqk,yddrxbdbz,ydyrxbdbz,ydbzrylb,jjqk_lxr,jjqk_lxrdh,emsdh,jjzl,jjyy,old_sqid,dah2,zdspbz,zzslbz,zzslszbz,zzslszdw,zzslszrq,szqm,xptm,ydlb,qzdw,qzdz,yyqzrq_char,tdxzqh,sfmclbh,lxtxxb_id,bjczjmbz,yjjzd,qzfsdd,cjka,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select sq_id,ry_id,rybh,ywbh,sqlb,bzlb,bm,mz,hyzk,zzmm,whcd,gzdw,zy,zwzc,lxdh,hkszd,sspcs,jtzz,sfxtkzd,sjr,yzbm,emsdz,sfxsjfsspzk,sjhm,swbadwbh,swbadwmc,dbdw,brjl,qwd,cjsy,djsy,xczjzl,xczjhm,xczjqfrq,xczjyxqz,sbzjhm,sbqzhm,sldw,slrq,slr,spdw,sprq,spr,spjg,bpzyy,zzrq,fzrq,gdrq,jjbs,tbbs,hdbh,sfqrbz,sflb,sfje,sfbz,syhbs,sfsyhsj,sfyhfksj,tfsyhsj,tfyhfksj,qrsfsj,qrsfr,qrtfsj,qrtfr,xxrs,xxid,dah,xxly,xxjb,glywbh,yyqzrq,sfxxz,sfxqz,sfxjz,sfcjzp,sfyjrga,jrgarq,lpzx,lpzm,bz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,xb,csrq,sfzh,gjdq,rydylb,csd,slrqchar,sprqchar,zzzrqchar,zqzrqchar,zzrqchar,fzrqchar,zwtxcjjg,zwmbcjjg,zzznm1,zzznm2,stglxx,stbzxx,sjbh,zwbh,rwbh,sfdzzj,zwmbxrgaq,sqh,tjbh,lxth,sflyhz,yyslsj,lyfph,qzzl,jzzl,qzhm,jffs,qrbz,hkqrqk,yddrxbdbz,ydyrxbdbz,ydbzrylb,jjqk_lxr,jjqk_lxrdh,emsdh,jjzl,jjyy,old_sqid,dah2,zdspbz,zzslbz,zzslszbz,zzslszdw,zzslszrq,szqm,xptm,ydlb,qzdw,qzdz,yyqzrq_char,tdxzqh,sfmclbh,lxtxxb_id,bjczjmbz,yjjzd,qzfsdd,cjka,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_cjsqxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_cjsqxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_crjdata_cjsqxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_cjsqxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df.py"}}

2019-09-05 14:45:22,852 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:45:22,998 - dodox_01907302051 - INFO - AW0AK6M4BZ1xJXgBM4G6
2019-09-05 14:45:24,079 - dodox_01907302051 - INFO - 043a546cd2d19bd61138bab19fec81cd
2019-09-05 14:45:24,079 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:45:25,178 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:45:25,179 - dodox_01907302051 - INFO - workflowid:043a546cd2d19bd61138bab19fec81cd
2019-09-05 14:45:26,301 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df'
2019-09-05 14:45:26,301 - db - INFO - update  public.task_info set wfid='043a546cd2d19bd61138bab19fec81cd',status='up',scriptid='AW0AK6M4BZ1xJXgBM4G6' where workflowname='gonganju_8_103_dsjzx_base_crjdata_cjsqxx_df'
2019-09-05 14:45:26,303 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3635.39ms
2019-09-05 14:46:23,060 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df'
2019-09-05 14:46:23,061 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.42ms
2019-09-05 14:46:29,707 - db - INFO - select * from public.task_info where wfid = 'a43b74cff909655108a07a846d9c8228'
2019-09-05 14:46:29,708 - db - INFO - update  public.task_info set status='down' where wfid='a43b74cff909655108a07a846d9c8228'
2019-09-05 14:46:30,932 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1225.48ms
2019-09-05 14:46:33,274 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df'
2019-09-05 14:46:33,337 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 14:46:33,381 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.log', 'gonganju_txt_ods.base_crjdata_ry_czjwryjbxx_df', 'dsjzx.base_crjdata_ry_czjwryjbxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_ry_czjwryjbxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_ry_czjwryjbxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ry_czjwryjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_ry_czjwryjbxx_df.txt' into table gonganju_txt_ods.base_crjdata_ry_czjwryjbxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_crjdata_ry_czjwryjbxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_crjdata_ry_czjwryjbxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_ry_czjwryjbxx_df (yw_id,czjwrylb,ry_id,rybh,xp_id,pcsyw_id,sf,qfrq,zjyxqz,zjnrs,qzzl,jlsy,qzhm,qzqfrq,qzyxqz,qfjg,lxdh,bz,ryzl,jddwlb,jddw,zdrwbs,hczt,sfyx,lrsj,lrr,zhxgr,tbdwbh,ssbz,jsbz,scbz,lcztbz,czbz,ydbz,zjzl,zjhm,gjdq,xb,csrq,rydylb,ywx,ywm,ywxm,zwxm,crjxxhcbz,rjsy,rjrq,sfzh,pcsmc,jzdhsbz,gzdhsbz,pcsbh,zxsj,jzzt,zxr,zxyy,old_ywid,jwjzd,qzyxcs,rjka,yjjlbz,ssgabbh,zhxgsj,jh_xzqh,sjxzqh,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select yw_id,czjwrylb,ry_id,rybh,xp_id,pcsyw_id,sf,qfrq,zjyxqz,zjnrs,qzzl,jlsy,qzhm,qzqfrq,qzyxqz,qfjg,lxdh,bz,ryzl,jddwlb,jddw,zdrwbs,hczt,sfyx,lrsj,lrr,zhxgr,tbdwbh,ssbz,jsbz,scbz,lcztbz,czbz,ydbz,zjzl,zjhm,gjdq,xb,csrq,rydylb,ywx,ywm,ywxm,zwxm,crjxxhcbz,rjsy,rjrq,sfzh,pcsmc,jzdhsbz,gzdhsbz,pcsbh,zxsj,jzzt,zxr,zxyy,old_ywid,jwjzd,qzyxcs,rjka,yjjlbz,ssgabbh,zhxgsj,jh_xzqh,sjxzqh,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_ry_czjwryjbxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_ry_czjwryjbxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_crjdata_ry_czjwryjbxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_ry_czjwryjbxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df.py"}}

2019-09-05 14:46:33,381 - dodox_01907302051 - INFO - Upload Success
2019-09-05 14:46:33,526 - dodox_01907302051 - INFO - AW0ALLbABZ1xJXgBM4HD
2019-09-05 14:46:34,602 - dodox_01907302051 - INFO - 8d4d0b150ea1929ad6a64e53bb1f0be9
2019-09-05 14:46:34,602 - dodox_01907302051 - INFO - workflow success
2019-09-05 14:46:35,711 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 14:46:35,711 - dodox_01907302051 - INFO - workflowid:8d4d0b150ea1929ad6a64e53bb1f0be9
2019-09-05 14:46:36,836 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df'
2019-09-05 14:46:36,836 - db - INFO - update  public.task_info set wfid='8d4d0b150ea1929ad6a64e53bb1f0be9',status='up',scriptid='AW0ALLbABZ1xJXgBM4HD' where workflowname='gonganju_8_103_dsjzx_base_crjdata_ry_czjwryjbxx_df'
2019-09-05 14:46:36,838 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3618.84ms
2019-09-05 15:00:56,485 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-09-05 15:00:56,487 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 57.52ms
2019-09-05 15:01:04,255 - db - INFO - select * from public.task_info where wfid = '13e01b720018a1c997cbabee5baf57f8'
2019-09-05 15:01:04,256 - db - INFO - update  public.task_info set status='down' where wfid='13e01b720018a1c997cbabee5baf57f8'
2019-09-05 15:01:05,429 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1174.60ms
2019-09-05 15:01:08,846 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-09-05 15:01:08,911 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:01:08,944 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.log', 'gonganju_txt_ods.base_crjdata_ryxx_df', 'dsjzx.base_crjdata_ryxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_ryxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_ryxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_ryxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_ryxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_ryxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_ryxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ryxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ryxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ryxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt' into table gonganju_txt_ods.base_crjdata_ryxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_crjdata_ryxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_crjdata_ryxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_ryxx_df (ry_id,rybh,ryxh,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,yym,xb,csrq,csd,sfzh,gjdq,zjzl,zjhm,jmzjhm,zjhmc,zjhmd,rydylb,jdywlx,jdywbh,jdsj,ywglsfyx,ywglbs,xxrbs,czrybh,cdh,bz,yxbz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,old_sqid,old_ryid,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select ry_id,rybh,ryxh,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,yym,xb,csrq,csd,sfzh,gjdq,zjzl,zjhm,jmzjhm,zjhmc,zjhmd,rydylb,jdywlx,jdywbh,jdsj,ywglsfyx,ywglbs,xxrbs,czrybh,cdh,bz,yxbz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,old_sqid,old_ryid,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_ryxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_ryxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_crjdata_ryxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_ryxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.py"}}

2019-09-05 15:01:08,945 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:01:09,104 - dodox_01907302051 - INFO - AW0AOhLkBZ1xJXgBM4HX
2019-09-05 15:01:10,186 - dodox_01907302051 - INFO - 07ac5dabf594c0fe1660a0ede02c123d
2019-09-05 15:01:10,186 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:01:11,312 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:01:11,313 - dodox_01907302051 - INFO - workflowid:07ac5dabf594c0fe1660a0ede02c123d
2019-09-05 15:01:12,424 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-09-05 15:01:12,424 - db - INFO - update  public.task_info set wfid='07ac5dabf594c0fe1660a0ede02c123d',status='up',scriptid='AW0AOhLkBZ1xJXgBM4HX' where workflowname='gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-09-05 15:01:12,426 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3635.08ms
2019-09-05 15:02:19,207 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df'
2019-09-05 15:02:19,208 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.58ms
2019-09-05 15:02:28,041 - db - INFO - select * from public.task_info where wfid = 'd669272eb39cd2722c6c7dfdac89b46f'
2019-09-05 15:02:28,042 - db - INFO - update  public.task_info set status='down' where wfid='d669272eb39cd2722c6c7dfdac89b46f'
2019-09-05 15:02:29,211 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1170.71ms
2019-09-05 15:02:34,345 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df'
2019-09-05 15:02:34,428 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:02:34,464 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.log', 'gonganju_txt_ods.base_crjdata_twtbsqxx_df', 'dsjzx.base_crjdata_twtbsqxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_twtbsqxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_twtbsqxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_twtbsqxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_twtbsqxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_twtbsqxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_twtbsqxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_twtbsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_twtbsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_twtbsqxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_twtbsqxx_df.txt' into table gonganju_txt_ods.base_crjdata_twtbsqxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_crjdata_twtbsqxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_crjdata_twtbsqxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_twtbsqxx_df (sq_id,ry_id,rybh,ywbh,sqlb,bzlb,sqsy,djsy,mz,jwrylb,ldlsf,jwzy,jnlxdh,twhzhm,twsfzh,ldlsy,rjka,rjrq,qwd,twjzd,twxxzz,ndjzdpcs,ndjzdxxdz,ndjzdxzqh,dwbh,dwmc,dwszdpcs,dwszdxxdz,dwszdxzqh,dbdw,dbr,dbrlxdh,tqywbh,xczjzl,xczjhm,xczjbbh,xczjqfjg,xczjqfrq,xczjyxqz,xcqzzl,xcqzrjcs,xcqzhm,xcqzqfrq,xcqzyxqz,xcqzqfjg,sbzjhm,sbqzhm,sldw,slrq,slr,spdw,sprq,spr,spjg,bpzyy,zzrq,fzrq,gdrq,sfqrbz,sflb,sfje,sfbz,syhbs,sfsyhsj,sfyhfksj,tfsyhsj,tfyhfksj,qrsfsj,qrsfr,qrtfsj,qrtfr,jjbs,tbbs,dah,xxjb,yyqzrq,sfxxz,sfxqz,sfxjz,sfcjzp,bz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,xxly,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,xb,csrq,sfzh,gjdq,rydylb,csd,slrqchar,sprqchar,zzzrqchar,zqzrqchar,zzrqchar,fzrqchar,sfxtkzd,sjr,yzbm,emsdz,zjclhm,jffs,yddrxbdbz,ydyrxbdbz,xm_gbk,ftxm_gbk,wwbm,twzyrwbz,sjrdh,jjqk_lxr,jjqk_lxrdh,old_sqid,sfdzzj,sjxfbz,hyzk,jg,ndjlb,whcd,yhjszd,szqm,dah2,djpzdh,tbyj,qzdw,qzdz,yyqzrq_char,emsdh,tdxzqh,sfmclbh,qzfsdd,jjzl,jjyy,cym,ycxzjhm,ndjd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select sq_id,ry_id,rybh,ywbh,sqlb,bzlb,sqsy,djsy,mz,jwrylb,ldlsf,jwzy,jnlxdh,twhzhm,twsfzh,ldlsy,rjka,rjrq,qwd,twjzd,twxxzz,ndjzdpcs,ndjzdxxdz,ndjzdxzqh,dwbh,dwmc,dwszdpcs,dwszdxxdz,dwszdxzqh,dbdw,dbr,dbrlxdh,tqywbh,xczjzl,xczjhm,xczjbbh,xczjqfjg,xczjqfrq,xczjyxqz,xcqzzl,xcqzrjcs,xcqzhm,xcqzqfrq,xcqzyxqz,xcqzqfjg,sbzjhm,sbqzhm,sldw,slrq,slr,spdw,sprq,spr,spjg,bpzyy,zzrq,fzrq,gdrq,sfqrbz,sflb,sfje,sfbz,syhbs,sfsyhsj,sfyhfksj,tfsyhsj,tfyhfksj,qrsfsj,qrsfr,qrtfsj,qrtfr,jjbs,tbbs,dah,xxjb,yyqzrq,sfxxz,sfxqz,sfxjz,sfcjzp,bz,scbz,ssbz,jsbz,tbdwbh,zhxgr,zhxgsj,xxly,ywx,ywm,ywxm,zwx,zwm,zwxm,zwxmgb2312,zwxmft,xb,csrq,sfzh,gjdq,rydylb,csd,slrqchar,sprqchar,zzzrqchar,zqzrqchar,zzrqchar,fzrqchar,sfxtkzd,sjr,yzbm,emsdz,zjclhm,jffs,yddrxbdbz,ydyrxbdbz,xm_gbk,ftxm_gbk,wwbm,twzyrwbz,sjrdh,jjqk_lxr,jjqk_lxrdh,old_sqid,sfdzzj,sjxfbz,hyzk,jg,ndjlb,whcd,yhjszd,szqm,dah2,djpzdh,tbyj,qzdw,qzdz,yyqzrq_char,emsdh,tdxzqh,sfmclbh,qzfsdd,jjzl,jjyy,cym,ycxzjhm,ndjd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_twtbsqxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_twtbsqxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_crjdata_twtbsqxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_twtbsqxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df.py"}}

2019-09-05 15:02:34,465 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:02:34,606 - dodox_01907302051 - INFO - AW0AO2D5BZ1xJXgBM4Hg
2019-09-05 15:02:35,671 - dodox_01907302051 - INFO - 8a34bd2fd8c276789dec9d4829b7f6ba
2019-09-05 15:02:35,671 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:02:36,794 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:02:36,794 - dodox_01907302051 - INFO - workflowid:8a34bd2fd8c276789dec9d4829b7f6ba
2019-09-05 15:02:37,918 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df'
2019-09-05 15:02:37,918 - db - INFO - update  public.task_info set wfid='8a34bd2fd8c276789dec9d4829b7f6ba',status='up',scriptid='AW0AO2D5BZ1xJXgBM4Hg' where workflowname='gonganju_8_103_dsjzx_base_crjdata_twtbsqxx_df'
2019-09-05 15:02:37,920 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3629.79ms
2019-09-05 15:03:26,961 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_zjblxx_df'
2019-09-05 15:03:26,962 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.26ms
2019-09-05 15:03:36,297 - db - INFO - select * from public.task_info where wfid = 'c8571804746085f6fa2494dd715eec02'
2019-09-05 15:03:36,298 - db - INFO - update  public.task_info set status='down' where wfid='c8571804746085f6fa2494dd715eec02'
2019-09-05 15:03:37,478 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1181.90ms
2019-09-05 15:03:40,682 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_zjblxx_df'
2019-09-05 15:03:40,752 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:03:40,784 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.log', 'gonganju_txt_ods.base_crjdata_zjblxx_df', 'dsjzx.base_crjdata_zjblxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_zjblxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_zjblxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_zjblxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_zjblxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_zjblxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_zjblxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_zjblxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_zjblxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_zjblxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_zjblxx_df.txt' into table gonganju_txt_ods.base_crjdata_zjblxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_crjdata_zjblxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_crjdata_zjblxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_zjblxx_df (zjbl_id,sq_id,ywbh,sqlb,spdw,sprq,spjg,bpzyy,zjzl,zjhm,zjyxcs,zjbbh,zjqfrq,zjqfdw,zjyxq,zjyxqdw,zjyxqz,sfmclbh,bz,scbz,ssbz,jsbz,wfcs,cjka,dbdw,dbr,dbrlxdh,yqdwbh,yqdwmc,slrq,tbdwbh,zhxgr,zhxgsj,tbzzjhm,old_sqid,dah,zjyxqjdw,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select zjbl_id,sq_id,ywbh,sqlb,spdw,sprq,spjg,bpzyy,zjzl,zjhm,zjyxcs,zjbbh,zjqfrq,zjqfdw,zjyxq,zjyxqdw,zjyxqz,sfmclbh,bz,scbz,ssbz,jsbz,wfcs,cjka,dbdw,dbr,dbrlxdh,yqdwbh,yqdwmc,slrq,tbdwbh,zhxgr,zhxgsj,tbzzjhm,old_sqid,dah,zjyxqjdw,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_crjdata_zjblxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_zjblxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_crjdata_zjblxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_crjdata_zjblxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_zjblxx_df.py"}}

2019-09-05 15:03:40,784 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:03:40,934 - dodox_01907302051 - INFO - AW0APGQGBZ1xJXgBM4Ho
2019-09-05 15:03:41,997 - dodox_01907302051 - INFO - d5875f5e5de887ffeda0c2b94d70da21
2019-09-05 15:03:41,997 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:03:43,108 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:03:43,108 - dodox_01907302051 - INFO - workflowid:d5875f5e5de887ffeda0c2b94d70da21
2019-09-05 15:03:44,226 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_zjblxx_df'
2019-09-05 15:03:44,227 - db - INFO - update  public.task_info set wfid='d5875f5e5de887ffeda0c2b94d70da21',status='up',scriptid='AW0APGQGBZ1xJXgBM4Ho' where workflowname='gonganju_8_103_dsjzx_base_crjdata_zjblxx_df'
2019-09-05 15:03:44,229 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3602.01ms
2019-09-05 15:04:54,685 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df'
2019-09-05 15:04:54,686 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 57.36ms
2019-09-05 15:05:01,152 - db - INFO - select * from public.task_info where wfid = '5b674acd8c09783f2766fb2a862bc385'
2019-09-05 15:05:01,152 - db - INFO - update  public.task_info set status='down' where wfid='5b674acd8c09783f2766fb2a862bc385'
2019-09-05 15:05:02,323 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1172.18ms
2019-09-05 15:05:06,014 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df'
2019-09-05 15:05:06,079 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:05:06,111 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.log', 'gonganju_txt_ods.base_czrk_t3_rk_hjbxx_df', 'dsjzx.base_czrk_t3_rk_hjbxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_czrk_t3_rk_hjbxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_czrk_t3_rk_hjbxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_czrk_t3_rk_hjbxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_czrk_t3_rk_hjbxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_hjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_hjbxx_df.txt' into table gonganju_txt_ods.base_czrk_t3_rk_hjbxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_czrk_t3_rk_hjbxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_czrk_t3_rk_hjbxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_czrk_t3_rk_hjbxx_df (hid,mnpid,pcsbm,hh,hb,hbhz,jlh,zzlmhz,zzxz,mlph,mlph2,jlsj,jlsj_dt,zxsj,zxsj_dt,ch,xhhkbbh,hsxkzw,jwh,hzid,hzsfzhm,hzxm,hzxb,xxztbz,sjsbxxtqbs,sjsbxxtq,sjhzbs,sjhzsj,slywbm,hzcsrq,hzcsrq_dt,hjywlx,zxbdyy,zxbdyyhz,qybs,ph,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,pcsmc,jlhmc,hzxbmc,hjywlxmc,zxbdyymc,dt,jhpt_update_time,jhpt_delete) select hid,mnpid,pcsbm,hh,hb,hbhz,jlh,zzlmhz,zzxz,mlph,mlph2,jlsj,jlsj_dt,zxsj,zxsj_dt,ch,xhhkbbh,hsxkzw,jwh,hzid,hzsfzhm,hzxm,hzxb,xxztbz,sjsbxxtqbs,sjsbxxtq,sjhzbs,sjhzsj,slywbm,hzcsrq,hzcsrq_dt,hjywlx,zxbdyy,zxbdyyhz,qybs,ph,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,pcsmc,jlhmc,hzxbmc,hjywlxmc,zxbdyymc,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_czrk_t3_rk_hjbxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_czrk_t3_rk_hjbxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_czrk_t3_rk_hjbxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_czrk_t3_rk_hjbxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df.py"}}

2019-09-05 15:05:06,112 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:05:06,263 - dodox_01907302051 - INFO - AW0APbFVBZ1xJXgBM4Hx
2019-09-05 15:05:07,338 - dodox_01907302051 - INFO - fa56258781950232a1667279fc9610a4
2019-09-05 15:05:07,338 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:05:08,443 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:05:08,443 - dodox_01907302051 - INFO - workflowid:fa56258781950232a1667279fc9610a4
2019-09-05 15:05:09,550 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df'
2019-09-05 15:05:09,551 - db - INFO - update  public.task_info set wfid='fa56258781950232a1667279fc9610a4',status='up',scriptid='AW0APbFVBZ1xJXgBM4Hx' where workflowname='gonganju_8_103_dsjzx_base_czrk_t3_rk_hjbxx_df'
2019-09-05 15:05:09,553 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3593.96ms
2019-09-05 15:06:54,706 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df'
2019-09-05 15:06:54,708 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 57.31ms
2019-09-05 15:07:03,342 - db - INFO - select * from public.task_info where wfid = 'ca49bd6d7d67bc6781b397cc14257ae7'
2019-09-05 15:07:03,343 - db - INFO - update  public.task_info set status='down' where wfid='ca49bd6d7d67bc6781b397cc14257ae7'
2019-09-05 15:07:04,539 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1197.62ms
2019-09-05 15:07:07,682 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df'
2019-09-05 15:07:07,746 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:07:07,782 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.log', 'gonganju_txt_ods.base_czrk_t3_rk_jmswbzz_df', 'dsjzx.base_czrk_t3_rk_jmswbzz_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_czrk_t3_rk_jmswbzz_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_czrk_t3_rk_jmswbzz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_jmswbzz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_jmswbzz_df.txt' into table gonganju_txt_ods.base_czrk_t3_rk_jmswbzz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_czrk_t3_rk_jmswbzz_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_czrk_t3_rk_jmswbzz_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_czrk_t3_rk_jmswbzz_df (pcsbh,szxm,sfzbh,swyxzmsbh,swyydm,swyyhz,swrq,jsxm,jsdz,yxqc,yxqz,qfr,qfrq,qyph,rid,ytclddmc,ytcldd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select pcsbh,szxm,sfzbh,swyxzmsbh,swyydm,swyyhz,swrq,jsxm,jsdz,yxqc,yxqz,qfr,qfrq,qyph,rid,ytclddmc,ytcldd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_czrk_t3_rk_jmswbzz_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_czrk_t3_rk_jmswbzz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_czrk_t3_rk_jmswbzz_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_czrk_t3_rk_jmswbzz_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df.py"}}

2019-09-05 15:07:07,783 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:07:07,920 - dodox_01907302051 - INFO - AW0AP4yZBZ1xJXgBM4H9
2019-09-05 15:07:08,984 - dodox_01907302051 - INFO - 9320b805c6d6937d18d61236d7959a30
2019-09-05 15:07:08,984 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:07:10,090 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:07:10,090 - dodox_01907302051 - INFO - workflowid:9320b805c6d6937d18d61236d7959a30
2019-09-05 15:07:11,211 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df'
2019-09-05 15:07:11,211 - db - INFO - update  public.task_info set wfid='9320b805c6d6937d18d61236d7959a30',status='up',scriptid='AW0AP4yZBZ1xJXgBM4H9' where workflowname='gonganju_8_103_dsjzx_base_czrk_t3_rk_jmswbzz_df'
2019-09-05 15:07:11,213 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3584.07ms
2019-09-05 15:08:19,549 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df'
2019-09-05 15:08:19,551 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.64ms
2019-09-05 15:08:27,080 - db - INFO - select * from public.task_info where wfid = '3ef4f221e120b522adc15e8f158b4d8c'
2019-09-05 15:08:27,081 - db - INFO - update  public.task_info set status='down' where wfid='3ef4f221e120b522adc15e8f158b4d8c'
2019-09-05 15:08:28,245 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1164.99ms
2019-09-05 15:08:31,358 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df'
2019-09-05 15:08:31,424 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:08:31,466 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.log', 'gonganju_txt_ods.base_czrk_t3_rk_swzxxx_df', 'dsjzx.base_czrk_t3_rk_swzxxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_czrk_t3_rk_swzxxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_czrk_t3_rk_swzxxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_czrk_t3_rk_swzxxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_czrk_t3_rk_swzxxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t3_rk_swzxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_czrk_t3_rk_swzxxx_df.txt' into table gonganju_txt_ods.base_czrk_t3_rk_swzxxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_czrk_t3_rk_swzxxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_czrk_t3_rk_swzxxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_czrk_t3_rk_swzxxx_df (rid,hid,mnpid,hkszdpcs,pcsmc,sfzhm,xm,hkszdhh,hbdm,hbdmmc,yhb,yhzgx,yhzgxmc,xbdm,xb,csrq,whcddm,whcdmc,pzdw,pzdwmc,bdfx,bdfxmc,swzxlb,swzxlbmc,bdrq,bdsqbh,bdpcsbhdm,bdpcsbh,sfhbd,sfhbdmc,slrxm,slywbm,ph,bz,gmsfzsjyy,gmsfzsjyymc,hkszddz,hkszdmlph,hkszdmlph2,hkszdxzqhdm,hkszdxzqhdmmc,hkszdxzqh,jsdz,jsxm,mz,swdd,swrq,swzmbh,ytcldd,yxrqc,yxrqz,zzxz,ytclddmc,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,hid,mnpid,hkszdpcs,pcsmc,sfzhm,xm,hkszdhh,hbdm,hbdmmc,yhb,yhzgx,yhzgxmc,xbdm,xb,csrq,whcddm,whcdmc,pzdw,pzdwmc,bdfx,bdfxmc,swzxlb,swzxlbmc,bdrq,bdsqbh,bdpcsbhdm,bdpcsbh,sfhbd,sfhbdmc,slrxm,slywbm,ph,bz,gmsfzsjyy,gmsfzsjyymc,hkszddz,hkszdmlph,hkszdmlph2,hkszdxzqhdm,hkszdxzqhdmmc,hkszdxzqh,jsdz,jsxm,mz,swdd,swrq,swzmbh,ytcldd,yxrqc,yxrqz,zzxz,ytclddmc,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_czrk_t3_rk_swzxxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_czrk_t3_rk_swzxxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_czrk_t3_rk_swzxxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_czrk_t3_rk_swzxxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df.py"}}

2019-09-05 15:08:31,466 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:08:31,603 - dodox_01907302051 - INFO - AW0AQNN9BZ1xJXgBM4IL
2019-09-05 15:08:32,691 - dodox_01907302051 - INFO - 12018f78a8063f8ec7df109041816956
2019-09-05 15:08:32,691 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:08:33,878 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:08:33,878 - dodox_01907302051 - INFO - workflowid:12018f78a8063f8ec7df109041816956
2019-09-05 15:08:34,997 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df'
2019-09-05 15:08:34,998 - db - INFO - update  public.task_info set wfid='12018f78a8063f8ec7df109041816956',status='up',scriptid='AW0AQNN9BZ1xJXgBM4IL' where workflowname='gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df'
2019-09-05 15:08:35,000 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3698.31ms
2019-09-05 15:09:36,550 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t3_rk_swzxxx_df'
2019-09-05 15:09:36,552 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.24ms
2019-09-05 15:10:26,925 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df'
2019-09-05 15:10:26,926 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 54.95ms
2019-09-05 15:10:33,782 - db - INFO - select * from public.task_info where wfid = '923dddba0e34e2e69da46df26ace8d27'
2019-09-05 15:10:33,782 - db - INFO - update  public.task_info set status='down' where wfid='923dddba0e34e2e69da46df26ace8d27'
2019-09-05 15:10:34,965 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1183.44ms
2019-09-05 15:10:38,540 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df'
2019-09-05 15:10:38,613 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:10:38,647 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.log', 'gonganju_txt_ods.base_czrk_t_t3_rk_edz_df', 'dsjzx.base_czrk_t_t3_rk_edz_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_czrk_t_t3_rk_edz_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_czrk_t_t3_rk_edz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_czrk_t_t3_rk_edz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_czrk_t_t3_rk_edz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_czrk_t_t3_rk_edz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_czrk_t_t3_rk_edz_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t_t3_rk_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t_t3_rk_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_czrk_t_t3_rk_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_czrk_t_t3_rk_edz_df.txt' into table gonganju_txt_ods.base_czrk_t_t3_rk_edz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_czrk_t_t3_rk_edz_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_czrk_t_t3_rk_edz_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_czrk_t_t3_rk_edz_df (rid,zjsfzhm,zjxm,zjxb,xbhz,zjmz,mzhz,zjcsrq,zjcsrq_dt,zjqfjg,zjyxqxqsrq,zjyxqxqsrq_dt,zjyxqxjzrq,zjyxqxjzrq_dt,zjaddr,zjktglh,zjaddr1,zjaddr2,zjaddr3,zjaddr4,czjq1,czktglh1,czrq1,czjq2,czktglh2,czrq2,czjq3,czktglh3,czrq3,czjq4,czktglh4,czrq4,zxsj,zxsj_dt,zxr,zxrjh,zxyy,zxpcsbh,ph,keyid,xxgxsj,xxgxsj_dt,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,zjsfzhm,zjxm,zjxb,xbhz,zjmz,mzhz,zjcsrq,zjcsrq_dt,zjqfjg,zjyxqxqsrq,zjyxqxqsrq_dt,zjyxqxjzrq,zjyxqxjzrq_dt,zjaddr,zjktglh,zjaddr1,zjaddr2,zjaddr3,zjaddr4,czjq1,czktglh1,czrq1,czjq2,czktglh2,czrq2,czjq3,czktglh3,czrq3,czjq4,czktglh4,czrq4,zxsj,zxsj_dt,zxr,zxrjh,zxyy,zxpcsbh,ph,keyid,xxgxsj,xxgxsj_dt,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_czrk_t_t3_rk_edz_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_czrk_t_t3_rk_edz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_czrk_t_t3_rk_edz_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_czrk_t_t3_rk_edz_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df.py"}}

2019-09-05 15:10:38,647 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:10:38,784 - dodox_01907302051 - INFO - AW0AQsRJBZ1xJXgBM4Ie
2019-09-05 15:10:39,849 - dodox_01907302051 - INFO - 5f90d82e90ce99116bc56ab3b7bdc5c2
2019-09-05 15:10:39,849 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:10:40,956 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:10:40,956 - dodox_01907302051 - INFO - workflowid:5f90d82e90ce99116bc56ab3b7bdc5c2
2019-09-05 15:10:42,074 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df'
2019-09-05 15:10:42,074 - db - INFO - update  public.task_info set wfid='5f90d82e90ce99116bc56ab3b7bdc5c2',status='up',scriptid='AW0AQsRJBZ1xJXgBM4Ie' where workflowname='gonganju_8_103_dsjzx_base_czrk_t_t3_rk_edz_df'
2019-09-05 15:10:42,076 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3590.68ms
2019-09-05 15:11:43,135 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df'
2019-09-05 15:11:43,136 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.59ms
2019-09-05 15:11:53,705 - db - INFO - select * from public.task_info where wfid = '9d2d333cca6b9f8714f11a33bec6cf11'
2019-09-05 15:11:53,705 - db - INFO - update  public.task_info set status='down' where wfid='9d2d333cca6b9f8714f11a33bec6cf11'
2019-09-05 15:11:54,865 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1161.27ms
2019-09-05 15:11:58,488 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df'
2019-09-05 15:11:58,561 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:11:58,598 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.log', 'gonganju_txt_ods.base_fwdj_t_rhfl_bdb_df', 'dsjzx.base_fwdj_t_rhfl_bdb_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_fwdj_t_rhfl_bdb_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_fwdj_t_rhfl_bdb_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_fwdj_t_rhfl_bdb_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_fwdj_t_rhfl_bdb_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_fwdj_t_rhfl_bdb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_fwdj_t_rhfl_bdb_df.txt' into table gonganju_txt_ods.base_fwdj_t_rhfl_bdb_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_fwdj_t_rhfl_bdb_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_fwdj_t_rhfl_bdb_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_fwdj_t_rhfl_bdb_df (hjdxzqhdm,hjdxzqhhz,hjdlmdm,hjdlmhz,hjdxz,jzdxzqhdm,jzdxzqhhz,jzdlmdm,jzdlmhz,jzdxz,hh,mlphxx,sh,zzjgdm,zzjghz,djrxm,djrq,djjgdm,djjgmc,djsj,bdrxm,bdrq,bdsj,bdjgdm,bdjgmc,fwbm,id,jzdpcsdm,jzdpcshz,xm,xbdm,xbhz,mzdm,mzhz,csrq,jgdm,jghz,zjhm,qdm,qmc,jddm,jdmc,jcwdm,jcwmc,jlxdm,jlxmc,mlph,xjgajgdm,xjgajgmc,pcsdm,pcsmc,yfzgxdm,yfzgxhz,flyydm,flyyhz,flsj,flag,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select hjdxzqhdm,hjdxzqhhz,hjdlmdm,hjdlmhz,hjdxz,jzdxzqhdm,jzdxzqhhz,jzdlmdm,jzdlmhz,jzdxz,hh,mlphxx,sh,zzjgdm,zzjghz,djrxm,djrq,djjgdm,djjgmc,djsj,bdrxm,bdrq,bdsj,bdjgdm,bdjgmc,fwbm,id,jzdpcsdm,jzdpcshz,xm,xbdm,xbhz,mzdm,mzhz,csrq,jgdm,jghz,zjhm,qdm,qmc,jddm,jdmc,jcwdm,jcwmc,jlxdm,jlxmc,mlph,xjgajgdm,xjgajgmc,pcsdm,pcsmc,yfzgxdm,yfzgxhz,flyydm,flyyhz,flsj,flag,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_fwdj_t_rhfl_bdb_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_fwdj_t_rhfl_bdb_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_fwdj_t_rhfl_bdb_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_fwdj_t_rhfl_bdb_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df.py"}}

2019-09-05 15:11:58,599 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:11:58,739 - dodox_01907302051 - INFO - AW0AQ_ycBZ1xJXgBM4In
2019-09-05 15:11:59,807 - dodox_01907302051 - INFO - a7128cf099261e70c38e565e88e3ea27
2019-09-05 15:11:59,807 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:12:00,925 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:12:00,926 - dodox_01907302051 - INFO - workflowid:a7128cf099261e70c38e565e88e3ea27
2019-09-05 15:12:02,045 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df'
2019-09-05 15:12:02,046 - db - INFO - update  public.task_info set wfid='a7128cf099261e70c38e565e88e3ea27',status='up',scriptid='AW0AQ_ycBZ1xJXgBM4In' where workflowname='gonganju_8_103_dsjzx_base_fwdj_t_rhfl_bdb_df'
2019-09-05 15:12:02,048 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3616.84ms
2019-09-05 15:17:38,807 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-09-05 15:17:38,809 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.82ms
2019-09-05 15:17:46,187 - db - INFO - select * from public.task_info where wfid = 'b359efdeb1059ea5218aee9256b18e69'
2019-09-05 15:17:46,187 - db - INFO - update  public.task_info set status='down' where wfid='b359efdeb1059ea5218aee9256b18e69'
2019-09-05 15:17:47,344 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1157.88ms
2019-09-05 15:17:51,747 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-09-05 15:17:51,828 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:17:51,869 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.log', 'gonganju_txt_ods.base_jjlhy_drivinglicense_df', 'dsjzx.base_jjlhy_drivinglicense_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_drivinglicense_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_drivinglicense_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_drivinglicense_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drivinglicense_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_drivinglicense_df.txt' into table gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jjlhy_drivinglicense_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jjlhy_drivinglicense_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_drivinglicense_df (dabh,sfzmhm,zjcx,yzjcx,qfrq,qfrq_dt,syrq,syrq_dt,cclzrq,cclzrq_dt,ccfzjg,jzqx,yxqs,yxqz,ljjf,cfrq,cfrq_dt,xxtzrq,xxtzrq_dt,bzcs,zt,ly,jxmc,jly,xzqh,xzqj,fzrq,jbr,glbm,fzjg,gxsj,gxsj_dt,lsh,xgzl,bz,jyw,ydabh,sqdm,zxbh,xh,sfzmmc,hmcd,xm,xb,csrq,csrq_dt,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,zzfzrq_dt,sfbd,dwbh,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,xzqhmc,xbmc,dt,jhpt_update_time,jhpt_delete) select dabh,sfzmhm,zjcx,yzjcx,qfrq,qfrq_dt,syrq,syrq_dt,cclzrq,cclzrq_dt,ccfzjg,jzqx,yxqs,yxqz,ljjf,cfrq,cfrq_dt,xxtzrq,xxtzrq_dt,bzcs,zt,ly,jxmc,jly,xzqh,xzqj,fzrq,jbr,glbm,fzjg,gxsj,gxsj_dt,lsh,xgzl,bz,jyw,ydabh,sqdm,zxbh,xh,sfzmmc,hmcd,xm,xb,csrq,csrq_dt,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,zzfzrq_dt,sfbd,dwbh,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,xzqhmc,xbmc,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_drivinglicense_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jjlhy_drivinglicense_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_drivinglicense_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df.py"}}

2019-09-05 15:17:51,869 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:17:52,066 - dodox_01907302051 - INFO - AW0ASWCpBZ1xJXgBM4JA
2019-09-05 15:17:53,138 - dodox_01907302051 - INFO - 02dfca6ab2b0c48f47a7c8358dd019c5
2019-09-05 15:17:53,138 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:17:54,288 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:17:54,288 - dodox_01907302051 - INFO - workflowid:02dfca6ab2b0c48f47a7c8358dd019c5
2019-09-05 15:17:55,397 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-09-05 15:17:55,397 - db - INFO - update  public.task_info set wfid='02dfca6ab2b0c48f47a7c8358dd019c5',status='up',scriptid='AW0ASWCpBZ1xJXgBM4JA' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_drivinglicense_df'
2019-09-05 15:17:55,400 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3711.81ms
2019-09-05 15:22:38,922 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-09-05 15:22:38,923 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 60.89ms
2019-09-05 15:22:47,003 - db - INFO - select * from public.task_info where wfid = '07d561c440c56cecb87c3452a36c815e'
2019-09-05 15:22:47,003 - db - INFO - update  public.task_info set status='down' where wfid='07d561c440c56cecb87c3452a36c815e'
2019-09-05 15:22:48,195 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1192.68ms
2019-09-05 15:22:51,584 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-09-05 15:22:51,663 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:22:51,708 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.log', 'gonganju_txt_ods.base_jjlhy_drv_logout_di', 'dsjzx.base_jjlhy_drv_logout_di','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_drv_logout_di data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_drv_logout_di\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_drv_logout_di_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_drv_logout_di_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_drv_logout_di_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_drv_logout_di_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_logout_di_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_logout_di_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_logout_di_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt' into table gonganju_txt_ods.base_jjlhy_drv_logout_di\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jjlhy_drv_logout_di\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jjlhy_drv_logout_di succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_drv_logout_di (xzqh,xzqj,fzrq,jbr,glbm,fzjg,zxjbr,lsh,xgzl,zrd,ydabh,jyw,bz,bh,csbj,xh,sfzmmc,hmcd,xm,xb,csrq,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,sfbd,dlr,dlrxm,dwd_loadtime,dwd_updatetime,dwd_yxbz,zxyymc,zjcxmc,yzjcxmc,ccfzjgmc,ztmc,lymc,xzqhmc,glbmmc,fzjgmc,xgzlmc,sfzmmcmc,xbmc,gjmc,djzsxzqhmc,lxzsxzqhmc,dt,jhpt_update_time,jhpt_delete) select xzqh,xzqj,fzrq,jbr,glbm,fzjg,zxjbr,lsh,xgzl,zrd,ydabh,jyw,bz,bh,csbj,xh,sfzmmc,hmcd,xm,xb,csrq,gj,djzsxzqh,djzsxxdz,lxzsxzqh,lxzsxxdz,lxzsyzbm,lxdh,sjhm,dzyx,zzzm,zzfzjg,zzfzrq,sfbd,dlr,dlrxm,dwd_loadtime,dwd_updatetime,dwd_yxbz,zxyymc,zjcxmc,yzjcxmc,ccfzjgmc,ztmc,lymc,xzqhmc,glbmmc,fzjgmc,xgzlmc,sfzmmcmc,xbmc,gjmc,djzsxzqhmc,lxzsxzqhmc,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_drv_logout_di\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_drv_logout_di\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jjlhy_drv_logout_di succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_drv_logout_di extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.py"}}

2019-09-05 15:22:51,708 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:22:51,878 - dodox_01907302051 - INFO - AW0ATfPTBZ1xJXgBM4JL
2019-09-05 15:22:52,961 - dodox_01907302051 - INFO - d02dcd62a069de8c49a9d07062686622
2019-09-05 15:22:52,961 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:22:54,069 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:22:54,069 - dodox_01907302051 - INFO - workflowid:d02dcd62a069de8c49a9d07062686622
2019-09-05 15:22:55,202 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-09-05 15:22:55,203 - db - INFO - update  public.task_info set wfid='d02dcd62a069de8c49a9d07062686622',status='up',scriptid='AW0ATfPTBZ1xJXgBM4JL' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-09-05 15:22:55,206 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3677.53ms
2019-09-05 15:25:51,893 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-09-05 15:25:51,894 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.95ms
2019-09-05 15:25:59,070 - db - INFO - select * from public.task_info where wfid = 'd02dcd62a069de8c49a9d07062686622'
2019-09-05 15:25:59,071 - db - INFO - update  public.task_info set status='down' where wfid='d02dcd62a069de8c49a9d07062686622'
2019-09-05 15:26:00,258 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1188.18ms
2019-09-05 15:26:03,516 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-09-05 15:26:03,589 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:26:03,642 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.log', 'gonganju_txt_ods.base_jjlhy_drv_logout_di', 'dsjzx.base_jjlhy_drv_logout_di','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_drv_logout_di data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_drv_logout_di\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_drv_logout_di_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_drv_logout_di_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_drv_logout_di_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_drv_logout_di_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_logout_di_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_logout_di_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_logout_di_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_logout_di.txt' into table gonganju_txt_ods.base_jjlhy_drv_logout_di\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jjlhy_drv_logout_di\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jjlhy_drv_logout_di succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_drv_logout_di (dabh,bdrq,sfzmhm,bdzjcx,bdyy,zjbj,yzjcx,jxmc,jly,lsh,jbr,fzjg,jyw,xh,sxzjcx,sxyxqs,sxyxqz,sxqljjf1,sxqljjf2,sxbj,jfjzrq,sfzxyw,zxzk,zyjy,jyw2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select dabh,bdrq,sfzmhm,bdzjcx,bdyy,zjbj,yzjcx,jxmc,jly,lsh,jbr,fzjg,jyw,xh,sxzjcx,sxyxqs,sxyxqz,sxqljjf1,sxqljjf2,sxbj,jfjzrq,sfzxyw,zxzk,zyjy,jyw2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_drv_logout_di\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_drv_logout_di\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jjlhy_drv_logout_di succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_drv_logout_di extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di.py"}}

2019-09-05 15:26:03,643 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:26:03,791 - dodox_01907302051 - INFO - AW0AUOGPBZ1xJXgBM4Jb
2019-09-05 15:26:04,866 - dodox_01907302051 - INFO - cc4cc63f996a237f44c80a49bc30b065
2019-09-05 15:26:04,866 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:26:05,989 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:26:05,989 - dodox_01907302051 - INFO - workflowid:cc4cc63f996a237f44c80a49bc30b065
2019-09-05 15:26:07,107 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-09-05 15:26:07,107 - db - INFO - update  public.task_info set wfid='cc4cc63f996a237f44c80a49bc30b065',status='up',scriptid='AW0AUOGPBZ1xJXgBM4Jb' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_drv_logout_di'
2019-09-05 15:26:07,109 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3646.18ms
2019-09-05 15:28:16,971 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df'
2019-09-05 15:28:16,973 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.84ms
2019-09-05 15:28:31,473 - db - INFO - select * from public.task_info where wfid = '86b1ff893c16e67d27fdfa4e78c123b0'
2019-09-05 15:28:31,474 - db - INFO - update  public.task_info set status='down' where wfid='86b1ff893c16e67d27fdfa4e78c123b0'
2019-09-05 15:28:32,640 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1167.05ms
2019-09-05 15:28:37,002 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df'
2019-09-05 15:28:37,076 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:28:37,112 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.log', 'gonganju_txt_ods.base_jjlhy_drv_vehicletype_df', 'dsjzx.base_jjlhy_drv_vehicletype_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_drv_vehicletype_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_drv_vehicletype_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_drv_vehicletype_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_drv_vehicletype_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_drv_vehicletype_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_drv_vehicletype_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_vehicletype_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_vehicletype_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_drv_vehicletype_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_drv_vehicletype_df.txt' into table gonganju_txt_ods.base_jjlhy_drv_vehicletype_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jjlhy_drv_vehicletype_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jjlhy_drv_vehicletype_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_drv_vehicletype_df (dabh,bdrq,sfzmhm,bdzjcx,bdyy,zjbj,yzjcx,jxmc,jly,lsh,jbr,fzjg,jyw,xh,sxzjcx,sxyxqs,sxyxqz,sxqljjf1,sxqljjf2,sxbj,jfjzrq,sfzxyw,zxzk,zyjy,jyw2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select dabh,bdrq,sfzmhm,bdzjcx,bdyy,zjbj,yzjcx,jxmc,jly,lsh,jbr,fzjg,jyw,xh,sxzjcx,sxyxqs,sxyxqz,sxqljjf1,sxqljjf2,sxbj,jfjzrq,sfzxyw,zxzk,zyjy,jyw2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_drv_vehicletype_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_drv_vehicletype_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jjlhy_drv_vehicletype_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_drv_vehicletype_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df.py"}}

2019-09-05 15:28:37,113 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:28:37,295 - dodox_01907302051 - INFO - AW0AUzklBZ1xJXgBM4Jo
2019-09-05 15:28:38,367 - dodox_01907302051 - INFO - 6b646194b7baa34008026b0ccb09a3f8
2019-09-05 15:28:38,367 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:28:39,489 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:28:39,489 - dodox_01907302051 - INFO - workflowid:6b646194b7baa34008026b0ccb09a3f8
2019-09-05 15:28:40,625 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df'
2019-09-05 15:28:40,625 - db - INFO - update  public.task_info set wfid='6b646194b7baa34008026b0ccb09a3f8',status='up',scriptid='AW0AUzklBZ1xJXgBM4Jo' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_drv_vehicletype_df'
2019-09-05 15:28:40,627 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3687.01ms
2019-09-05 15:31:08,307 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df'
2019-09-05 15:31:08,308 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.28ms
2019-09-05 15:31:15,320 - db - INFO - select * from public.task_info where wfid = 'cf43bc8a69a8962a25ba98619f6931fc'
2019-09-05 15:31:15,320 - db - INFO - update  public.task_info set status='down' where wfid='cf43bc8a69a8962a25ba98619f6931fc'
2019-09-05 15:31:16,490 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1170.62ms
2019-09-05 15:31:18,671 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df'
2019-09-05 15:31:18,802 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:31:18,841 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.log', 'gonganju_txt_ods.base_jjlhy_t_acd_dutysimple_df', 'dsjzx.base_jjlhy_t_acd_dutysimple_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_t_acd_dutysimple_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_t_acd_dutysimple_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_t_acd_dutysimple_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_t_acd_dutysimple_df.txt' into table gonganju_txt_ods.base_jjlhy_t_acd_dutysimple_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jjlhy_t_acd_dutysimple_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jjlhy_t_acd_dutysimple_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_t_acd_dutysimple_df (djbh,sgbh,xzqh,xq,xqmc,sgfssj,lh,lm,gls,ms,jdwz,sgdd,ssrs,zjccss,lwsglx,rdyyfl,rdyyflmc,sgrdyy,sgrdyymc,tq,tqmc,xc,swsg,sgxt,sgxtmc,cljsg,dcsg,pzfs,lbqk,tjr1,cclrsj,jllx,scsjd,sszd,sszdmc,dah,sb,tjsgbh,glbm,dzzb,badw,wsbh,sgss,zrtjjg,jar1,jar2,jbr,gxsj,jyw,jafs,dllx,dllxmc,glxzdj,tjfs,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select djbh,sgbh,xzqh,xq,xqmc,sgfssj,lh,lm,gls,ms,jdwz,sgdd,ssrs,zjccss,lwsglx,rdyyfl,rdyyflmc,sgrdyy,sgrdyymc,tq,tqmc,xc,swsg,sgxt,sgxtmc,cljsg,dcsg,pzfs,lbqk,tjr1,cclrsj,jllx,scsjd,sszd,sszdmc,dah,sb,tjsgbh,glbm,dzzb,badw,wsbh,sgss,zrtjjg,jar1,jar2,jbr,gxsj,jyw,jafs,dllx,dllxmc,glxzdj,tjfs,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_t_acd_dutysimple_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_t_acd_dutysimple_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jjlhy_t_acd_dutysimple_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_t_acd_dutysimple_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df.py"}}

2019-09-05 15:31:18,841 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:31:19,006 - dodox_01907302051 - INFO - AW0AVbDdBZ1xJXgBM4J3
2019-09-05 15:31:20,094 - dodox_01907302051 - INFO - 8e8658220a24b9e5c05fc420cef4103d
2019-09-05 15:31:20,094 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:31:21,308 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:31:21,308 - dodox_01907302051 - INFO - workflowid:8e8658220a24b9e5c05fc420cef4103d
2019-09-05 15:31:22,461 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df'
2019-09-05 15:31:22,462 - db - INFO - update  public.task_info set wfid='8e8658220a24b9e5c05fc420cef4103d',status='up',scriptid='AW0AVbDdBZ1xJXgBM4J3' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_t_acd_dutysimple_df'
2019-09-05 15:31:22,464 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3847.78ms
2019-09-05 15:36:00,419 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df'
2019-09-05 15:36:00,420 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.59ms
2019-09-05 15:36:07,540 - db - INFO - select * from public.task_info where wfid = 'be153c18ead4a5d652480549ce350bbd'
2019-09-05 15:36:07,541 - db - INFO - update  public.task_info set status='down' where wfid='be153c18ead4a5d652480549ce350bbd'
2019-09-05 15:36:08,712 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1172.55ms
2019-09-05 15:36:13,884 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df'
2019-09-05 15:36:13,950 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:36:13,987 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.log', 'gonganju_txt_ods.base_jjlhy_veh_ownermodify_df', 'dsjzx.base_jjlhy_veh_ownermodify_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_veh_ownermodify_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_veh_ownermodify_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_veh_ownermodify_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_veh_ownermodify_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_veh_ownermodify_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_veh_ownermodify_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_veh_ownermodify_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_veh_ownermodify_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_veh_ownermodify_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_veh_ownermodify_df.txt' into table gonganju_txt_ods.base_jjlhy_veh_ownermodify_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jjlhy_veh_ownermodify_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jjlhy_veh_ownermodify_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_veh_ownermodify_df (xh,hpzldm,hpzl,hphm,ysyr,sfzmmc,sfzmhm,yxzqhdm,yxzqh,yxxdz,yyzbm,ylxdh,yhdfs,ysyxz,yxsdw,yxsjg,yhpzldm,yhpzl,yhphm,yglxq,jcjgzms,xgzl,bgrq,jbr,fzjg,lsh,yllpz1,ypzbh1,yllpz2,ypzbh2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,hpzldm,hpzl,hphm,ysyr,sfzmmc,sfzmhm,yxzqhdm,yxzqh,yxxdz,yyzbm,ylxdh,yhdfs,ysyxz,yxsdw,yxsjg,yhpzldm,yhpzl,yhphm,yglxq,jcjgzms,xgzl,bgrq,jbr,fzjg,lsh,yllpz1,ypzbh1,yllpz2,ypzbh2,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_veh_ownermodify_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_veh_ownermodify_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jjlhy_veh_ownermodify_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_veh_ownermodify_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df.py"}}

2019-09-05 15:36:13,988 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:36:14,146 - dodox_01907302051 - INFO - AW0AWjG6BZ1xJXgBM4KI
2019-09-05 15:36:15,236 - dodox_01907302051 - INFO - c518d3aa187b6156628112f0e68422fb
2019-09-05 15:36:15,236 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:36:16,351 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:36:16,351 - dodox_01907302051 - INFO - workflowid:c518d3aa187b6156628112f0e68422fb
2019-09-05 15:36:17,471 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df'
2019-09-05 15:36:17,471 - db - INFO - update  public.task_info set wfid='c518d3aa187b6156628112f0e68422fb',status='up',scriptid='AW0AWjG6BZ1xJXgBM4KI' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df'
2019-09-05 15:36:17,473 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3644.57ms
2019-09-05 15:36:45,653 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_veh_ownermodify_df'
2019-09-05 15:36:45,655 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.08ms
2019-09-05 15:40:51,821 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_vehicle_df'
2019-09-05 15:40:51,822 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 57.23ms
2019-09-05 15:40:59,278 - db - INFO - select * from public.task_info where wfid = '3aac27be7a3c7d138823e4965c051002'
2019-09-05 15:40:59,279 - db - INFO - update  public.task_info set status='down' where wfid='3aac27be7a3c7d138823e4965c051002'
2019-09-05 15:41:00,449 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1171.09ms
2019-09-05 15:41:04,349 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_vehicle_df'
2019-09-05 15:41:04,417 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:41:04,449 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.log', 'gonganju_txt_ods.base_jjlhy_vehicle_df', 'dsjzx.base_jjlhy_vehicle_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_vehicle_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jjlhy_vehicle_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jjlhy_vehicle_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jjlhy_vehicle_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jjlhy_vehicle_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jjlhy_vehicle_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_vehicle_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_vehicle_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jjlhy_vehicle_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jjlhy_vehicle_df.txt' into table gonganju_txt_ods.base_jjlhy_vehicle_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jjlhy_vehicle_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jjlhy_vehicle_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jjlhy_vehicle_df (hpzl,hphm,clpp1,clxh,clpp2,gcjk,zzg,zzcmc,clsbdh,fdjh,cllx,csys,syxz,sfzmhm,sfzmmc,syr,syq,ccdjrq,ccdjrq_dt,djrq,djrq_dt,yxqz,yxqz_dt,qzbfqz,qzbfqz_dt,fzjg,glbm,fprq,fprq_dt,fzrq,fzrq_dt,fdjrq,fdjrq_dt,fhgzrq,fhgzrq_dt,bxzzrq,bxzzrq_dt,bpcs,bzcs,bdjcs,djzsbh,zdjzshs,dabh,xzqh,zt,dybj,jbr,clly,lsh,fdjxh,rlzl,pl,gl,zxxs,cwkc,cwkk,cwkg,hxnbcd,hxnbkd,hxnbgd,gbthps,zs,zj,qlj,hlj,ltgg,lts,zzl,zbzl,hdzzl,hdzk,zqyzl,qpzk,hpzk,hbdbqk,ccrq,ccrq_dt,hdfs,llpz1,pzbh1,llpz2,pzbh2,xsdw,xsjg,xsrq,xsrq_dt,jkpz,jkpzhm,hgzbh,nszm,nszmbh,gxrq,gxrq_dt,xgzl,qmbh,hmbh,bz,jyw,zsxzqh,zsxxdz,yzbm1,lxdh,zzz,zzxzqh,zzxxdz,yzbm2,zdyzt,yxh,cyry,dphgzbh,sqdm,clyt,ytsx,dzyx,xszbh,sjhm,jyhgbzbh,dwbh,syqsrq,syqsrq_dt,yqjyqzbfqz,yqjyqz2,fdjgs,sfyzhgn,zzjglx,wxmbc,ncdqsy,hpqysj,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dzbsxlh,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select hpzl,hphm,clpp1,clxh,clpp2,gcjk,zzg,zzcmc,clsbdh,fdjh,cllx,csys,syxz,sfzmhm,sfzmmc,syr,syq,ccdjrq,ccdjrq_dt,djrq,djrq_dt,yxqz,yxqz_dt,qzbfqz,qzbfqz_dt,fzjg,glbm,fprq,fprq_dt,fzrq,fzrq_dt,fdjrq,fdjrq_dt,fhgzrq,fhgzrq_dt,bxzzrq,bxzzrq_dt,bpcs,bzcs,bdjcs,djzsbh,zdjzshs,dabh,xzqh,zt,dybj,jbr,clly,lsh,fdjxh,rlzl,pl,gl,zxxs,cwkc,cwkk,cwkg,hxnbcd,hxnbkd,hxnbgd,gbthps,zs,zj,qlj,hlj,ltgg,lts,zzl,zbzl,hdzzl,hdzk,zqyzl,qpzk,hpzk,hbdbqk,ccrq,ccrq_dt,hdfs,llpz1,pzbh1,llpz2,pzbh2,xsdw,xsjg,xsrq,xsrq_dt,jkpz,jkpzhm,hgzbh,nszm,nszmbh,gxrq,gxrq_dt,xgzl,qmbh,hmbh,bz,jyw,zsxzqh,zsxxdz,yzbm1,lxdh,zzz,zzxzqh,zzxxdz,yzbm2,zdyzt,yxh,cyry,dphgzbh,sqdm,clyt,ytsx,dzyx,xszbh,sjhm,jyhgbzbh,dwbh,syqsrq,syqsrq_dt,yqjyqzbfqz,yqjyqz2,fdjgs,sfyzhgn,zzjglx,wxmbc,ncdqsy,hpqysj,deip_update_time,deip_update_time_dt,deip_time,deip_time_dt,dzbsxlh,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jjlhy_vehicle_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jjlhy_vehicle_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jjlhy_vehicle_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jjlhy_vehicle_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jjlhy_vehicle_df.py"}}

2019-09-05 15:41:04,450 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:41:04,594 - dodox_01907302051 - INFO - AW0AXqBaBZ1xJXgBM4KX
2019-09-05 15:41:05,654 - dodox_01907302051 - INFO - 0125bc819310683008122b2237dc7f42
2019-09-05 15:41:05,655 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:41:06,762 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:41:06,763 - dodox_01907302051 - INFO - workflowid:0125bc819310683008122b2237dc7f42
2019-09-05 15:41:07,875 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jjlhy_vehicle_df'
2019-09-05 15:41:07,876 - db - INFO - update  public.task_info set wfid='0125bc819310683008122b2237dc7f42',status='up',scriptid='AW0AXqBaBZ1xJXgBM4KX' where workflowname='gonganju_8_103_dsjzx_base_jjlhy_vehicle_df'
2019-09-05 15:41:07,877 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3584.39ms
2019-09-05 15:48:34,861 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df'
2019-09-05 15:48:34,862 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.99ms
2019-09-05 15:48:43,150 - db - INFO - select * from public.task_info where wfid = '81e217a169d7aff7cb97f2bcb8ac3ba8'
2019-09-05 15:48:43,150 - db - INFO - update  public.task_info set status='down' where wfid='81e217a169d7aff7cb97f2bcb8ac3ba8'
2019-09-05 15:48:44,315 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1166.29ms
2019-09-05 15:48:48,403 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df'
2019-09-05 15:48:48,472 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:48:48,515 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.log', 'gonganju_txt_ods.base_jzz_jzz_cardinfo_df', 'dsjzx.base_jzz_jzz_cardinfo_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jzz_jzz_cardinfo_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jzz_jzz_cardinfo_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jzz_jzz_cardinfo_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jzz_jzz_cardinfo_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jzz_jzz_cardinfo_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jzz_jzz_cardinfo_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_cardinfo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_cardinfo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_cardinfo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_cardinfo_df.txt' into table gonganju_txt_ods.base_jzz_jzz_cardinfo_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jzz_jzz_cardinfo_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jzz_jzz_cardinfo_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jzz_jzz_cardinfo_df (apptype,apptype_hz,regcode,chidcard,chname,sortcode,certinum,enrolid,cardid,atr,version,facedate,facedate_dt,validdate,validdate_dt,recokdate,reusenum,cardstatus,cardstatus_hz,cardstadate,statusunitcode,statusunitcode_hz,oprlattice,oprlattice_hz,confirmstatus,confirmdate,confirmdate_dt,latgetcard,latgetcard_hz,latgetdate,pergetdate,errorreason,timestamp,createtime,createtime_dt,reserved,updtuser,updttime,updttime_dt,policeid,policeid_hz,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select apptype,apptype_hz,regcode,chidcard,chname,sortcode,certinum,enrolid,cardid,atr,version,facedate,facedate_dt,validdate,validdate_dt,recokdate,reusenum,cardstatus,cardstatus_hz,cardstadate,statusunitcode,statusunitcode_hz,oprlattice,oprlattice_hz,confirmstatus,confirmdate,confirmdate_dt,latgetcard,latgetcard_hz,latgetdate,pergetdate,errorreason,timestamp,createtime,createtime_dt,reserved,updtuser,updttime,updttime_dt,policeid,policeid_hz,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jzz_jzz_cardinfo_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jzz_jzz_cardinfo_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jzz_jzz_cardinfo_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jzz_jzz_cardinfo_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df.py"}}

2019-09-05 15:48:48,515 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:48:48,657 - dodox_01907302051 - INFO - AW0AZbUYBZ1xJXgBM4Kt
2019-09-05 15:48:49,726 - dodox_01907302051 - INFO - 8a8296f86ac418e5c332e8e63f393bc9
2019-09-05 15:48:49,726 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:48:50,837 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:48:50,837 - dodox_01907302051 - INFO - workflowid:8a8296f86ac418e5c332e8e63f393bc9
2019-09-05 15:48:51,955 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df'
2019-09-05 15:48:51,956 - db - INFO - update  public.task_info set wfid='8a8296f86ac418e5c332e8e63f393bc9',status='up',scriptid='AW0AZbUYBZ1xJXgBM4Kt' where workflowname='gonganju_8_103_dsjzx_base_jzz_jzz_cardinfo_df'
2019-09-05 15:48:51,958 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3608.63ms
2019-09-05 15:53:06,741 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_person_df'
2019-09-05 15:53:06,742 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.35ms
2019-09-05 15:53:14,029 - db - INFO - select * from public.task_info where wfid = '3d48374c91d1d3159085cc12fbeabd1b'
2019-09-05 15:53:14,029 - db - INFO - update  public.task_info set status='down' where wfid='3d48374c91d1d3159085cc12fbeabd1b'
2019-09-05 15:53:15,227 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1198.84ms
2019-09-05 15:53:19,385 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_person_df'
2019-09-05 15:53:19,458 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:53:19,493 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.log', 'gonganju_txt_ods.base_jzz_jzz_person_df', 'dsjzx.base_jzz_jzz_person_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jzz_jzz_person_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jzz_jzz_person_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jzz_jzz_person_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jzz_jzz_person_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jzz_jzz_person_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jzz_jzz_person_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_person_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_person_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_jzz_person_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jzz_jzz_person_df.txt' into table gonganju_txt_ods.base_jzz_jzz_person_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jzz_jzz_person_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jzz_jzz_person_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jzz_jzz_person_df (apptype,regcode,regcertcode,chidcard,chname,choldname,chsex,xbhz,mzdm,mzdmhz,dtbirthday,dtbirthday_dt,jgcode,height,xxdm,xxhz,chpolity,whcd,whcdhz,oprtype,hjcode,hjaddr,hjtype,birthplace,chreason,dtcome,dtcome_dt,chshlivearea,chshlivestreet,chshliveroad,chshliveaddr,chshhandphone,mobile,chlivetype,houseusage,chlivekind,chliveno,dtendday,chhouseorgname,chhouseownername,rentrooms,houseownertel,chhouseownerid,chrelation,tenantname,tenantrel,isemployee,orgname,orgroad,orgaddr,orgtel,jobtype,orgindustry,isinsurance,hyzk,hyzkhz,chponame,chpoidcard,mcertiflag,chhealth,chvaccinate,minorkeeper,minorkeeperrel,iskeeperlocal,keeperpid,vehicletype,vehicleno,memo,houseid,policeid,applattice,fillernmae,dtfilldate,dtfilldate_dt,dtsavedate,dtsavedate_dt,choperator,chinputor,chphotoname,chchecker,reserved1,reserved2,createtime,createtime_dt,reserved,updtuser,updttime,updttime_dt,personchgseq,houseseq,housechgseq,subhouseseq,subhousechgseq,personstatus,validdate,validdate_dt,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,edunow,email,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjhm,bzyfzgxdm,bzyfzgxhz,dt,jhpt_update_time,jhpt_delete) select apptype,regcode,regcertcode,chidcard,chname,choldname,chsex,xbhz,mzdm,mzdmhz,dtbirthday,dtbirthday_dt,jgcode,height,xxdm,xxhz,chpolity,whcd,whcdhz,oprtype,hjcode,hjaddr,hjtype,birthplace,chreason,dtcome,dtcome_dt,chshlivearea,chshlivestreet,chshliveroad,chshliveaddr,chshhandphone,mobile,chlivetype,houseusage,chlivekind,chliveno,dtendday,chhouseorgname,chhouseownername,rentrooms,houseownertel,chhouseownerid,chrelation,tenantname,tenantrel,isemployee,orgname,orgroad,orgaddr,orgtel,jobtype,orgindustry,isinsurance,hyzk,hyzkhz,chponame,chpoidcard,mcertiflag,chhealth,chvaccinate,minorkeeper,minorkeeperrel,iskeeperlocal,keeperpid,vehicletype,vehicleno,memo,houseid,policeid,applattice,fillernmae,dtfilldate,dtfilldate_dt,dtsavedate,dtsavedate_dt,choperator,chinputor,chphotoname,chchecker,reserved1,reserved2,createtime,createtime_dt,reserved,updtuser,updttime,updttime_dt,personchgseq,houseseq,housechgseq,subhouseseq,subhousechgseq,personstatus,validdate,validdate_dt,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,edunow,email,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjhm,bzyfzgxdm,bzyfzgxhz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jzz_jzz_person_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jzz_jzz_person_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jzz_jzz_person_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jzz_jzz_person_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jzz_jzz_person_df.py"}}

2019-09-05 15:53:19,494 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:53:19,634 - dodox_01907302051 - INFO - AW0AadeaBZ1xJXgBM4K1
2019-09-05 15:53:20,695 - dodox_01907302051 - INFO - abf7fd36a2286ba71a414d3c5201fe5f
2019-09-05 15:53:20,696 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:53:21,808 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:53:21,808 - dodox_01907302051 - INFO - workflowid:abf7fd36a2286ba71a414d3c5201fe5f
2019-09-05 15:53:22,939 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_jzz_person_df'
2019-09-05 15:53:22,940 - db - INFO - update  public.task_info set wfid='abf7fd36a2286ba71a414d3c5201fe5f',status='up',scriptid='AW0AadeaBZ1xJXgBM4K1' where workflowname='gonganju_8_103_dsjzx_base_jzz_jzz_person_df'
2019-09-05 15:53:22,941 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3612.93ms
2019-09-05 15:55:59,373 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df'
2019-09-05 15:55:59,375 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 55.64ms
2019-09-05 15:56:06,441 - db - INFO - select * from public.task_info where wfid = '0c0235e03b10f046bd73f7a582940b30'
2019-09-05 15:56:06,441 - db - INFO - update  public.task_info set status='down' where wfid='0c0235e03b10f046bd73f7a582940b30'
2019-09-05 15:56:07,630 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1189.49ms
2019-09-05 15:56:10,400 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df'
2019-09-05 15:56:10,467 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:56:10,500 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.log', 'gonganju_txt_ods.base_jzz_zp_jzz_photo_df', 'dsjzx.base_jzz_zp_jzz_photo_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_jzz_zp_jzz_photo_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_jzz_zp_jzz_photo_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_jzz_zp_jzz_photo_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_jzz_zp_jzz_photo_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_jzz_zp_jzz_photo_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_jzz_zp_jzz_photo_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_zp_jzz_photo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_zp_jzz_photo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_jzz_zp_jzz_photo_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_jzz_zp_jzz_photo_df.txt' into table gonganju_txt_ods.base_jzz_zp_jzz_photo_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_jzz_zp_jzz_photo_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_jzz_zp_jzz_photo_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_jzz_zp_jzz_photo_df (regcertcode,regcode,imagephoto,timestamp,createtime,reserved,updtuser,updttime,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,imagephoto_oss,dt,jhpt_update_time,jhpt_delete) select regcertcode,regcode,imagephoto,timestamp,createtime,reserved,updtuser,updttime,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,imagephoto_oss,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_jzz_zp_jzz_photo_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_jzz_zp_jzz_photo_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_jzz_zp_jzz_photo_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_jzz_zp_jzz_photo_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df.py"}}

2019-09-05 15:56:10,501 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:56:10,633 - dodox_01907302051 - INFO - AW0AbHOXBZ1xJXgBM4LG
2019-09-05 15:56:11,699 - dodox_01907302051 - INFO - 4afdaaca1ab0ed3fdcb0ebad330d126b
2019-09-05 15:56:11,700 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:56:12,809 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:56:12,809 - dodox_01907302051 - INFO - workflowid:4afdaaca1ab0ed3fdcb0ebad330d126b
2019-09-05 15:56:13,921 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df'
2019-09-05 15:56:13,922 - db - INFO - update  public.task_info set wfid='4afdaaca1ab0ed3fdcb0ebad330d126b',status='up',scriptid='AW0AbHOXBZ1xJXgBM4LG' where workflowname='gonganju_8_103_dsjzx_base_jzz_zp_jzz_photo_df'
2019-09-05 15:56:13,923 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3577.88ms
2019-09-05 15:58:39,525 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-09-05 15:58:39,526 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 54.79ms
2019-09-05 15:58:46,629 - db - INFO - select * from public.task_info where wfid = '43037b0941bf390da55141c5407ab91b'
2019-09-05 15:58:46,630 - db - INFO - update  public.task_info set status='down' where wfid='43037b0941bf390da55141c5407ab91b'
2019-09-05 15:58:47,797 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1168.64ms
2019-09-05 15:58:51,627 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-09-05 15:58:51,700 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 15:58:51,734 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.log', 'gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df', 'dsjzx.base_rkb_czrk_t_t3_rk_qczxxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_rkb_czrk_t_t3_rk_qczxxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt' into table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_rkb_czrk_t_t3_rk_qczxxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_rkb_czrk_t_t3_rk_qczxxx_df (rid,hid,mnpid,qcpcsbm,pcsmc,sfzhm,xm,hh,hbdm,hbdmmc,yhb,yhbdmmc,yhzgj,yhzgjmc,xbdm,xbmc,csrq,whcddm,whcdmc,pzdw,pzdwmc,qcfx,qcfxmc,qclb,qclbmc,qcrq,bdsqbh,bdsqbhmc,qwdpcs,sfhbd,sfhbdmc,slrxm,slywbm,hjywlx,hjywlxmc,ph,bz,cbsxz,cbsxzqhdm,gmsfzsjyy,gmsfzsjyymc,mzdm,mz,mzmc,qcdxz,qcdz,qcxz,qcxzqh,qwdgjdq,qwdgjdqmc,qwdjlh,qwdjlhmc,qwdxz,qwdxzqh,qyzbh,zqzbh,zzzk,zzzkmc,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,hid,mnpid,qcpcsbm,pcsmc,sfzhm,xm,hh,hbdm,hbdmmc,yhb,yhbdmmc,yhzgj,yhzgjmc,xbdm,xbmc,csrq,whcddm,whcdmc,pzdw,pzdwmc,qcfx,qcfxmc,qclb,qclbmc,qcrq,bdsqbh,bdsqbhmc,qwdpcs,sfhbd,sfhbdmc,slrxm,slywbm,hjywlx,hjywlxmc,ph,bz,cbsxz,cbsxzqhdm,gmsfzsjyy,gmsfzsjyymc,mzdm,mz,mzmc,qcdxz,qcdz,qcxz,qcxzqh,qwdgjdq,qwdgjdqmc,qwdjlh,qwdjlhmc,qwdxz,qwdxzqh,qyzbh,zqzbh,zzzk,zzzkmc,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_rkb_czrk_t_t3_rk_qczxxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.py"}}

2019-09-05 15:58:51,734 - dodox_01907302051 - INFO - Upload Success
2019-09-05 15:58:51,872 - dodox_01907302051 - INFO - AW0AbulsBZ1xJXgBM4LV
2019-09-05 15:58:52,936 - dodox_01907302051 - INFO - 788f030c0ce1ea00c3c750fb9d34ea86
2019-09-05 15:58:52,936 - dodox_01907302051 - INFO - workflow success
2019-09-05 15:58:54,092 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 15:58:54,092 - dodox_01907302051 - INFO - workflowid:788f030c0ce1ea00c3c750fb9d34ea86
2019-09-05 15:58:55,208 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-09-05 15:58:55,209 - db - INFO - update  public.task_info set wfid='788f030c0ce1ea00c3c750fb9d34ea86',status='up',scriptid='AW0AbulsBZ1xJXgBM4LV' where workflowname='gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-09-05 15:58:55,210 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3637.39ms
2019-09-05 16:01:51,955 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df'
2019-09-05 16:01:51,957 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.75ms
2019-09-05 16:02:00,965 - db - INFO - select * from public.task_info where wfid = '6dc8703ce72db52afa60a2203bd288ce'
2019-09-05 16:02:00,966 - db - INFO - update  public.task_info set status='down' where wfid='6dc8703ce72db52afa60a2203bd288ce'
2019-09-05 16:02:02,148 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1183.40ms
2019-09-05 16:02:05,869 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df'
2019-09-05 16:02:05,933 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 16:02:05,968 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.log', 'gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df', 'dsjzx.base_rkb_czrk_t_t3_rk_qrdjxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_rkb_czrk_t_t3_rk_qrdjxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.txt' into table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df (rid,hid,mnpid,qrpcsbm,pcsmc,sfzhm,xm,hkszdhh,hbdm,hbdmmc,yhbdm,yhbdmmc,yhzgj,yhzgjmc,xb,xbmc,csrq,whcd,whcdmc,pzdw,pzdwmc,qrfx,qrfxmc,qrlb,qrlbmc,qrrq,bdsqbh,bdsqbhmc,qcdpcsbh,sfhbd,sfhbdmc,slrxm,slywbm,hjywlx,hjywlxmc,ph,jg,jgmc,jggj,gjmc,jgxz,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select rid,hid,mnpid,qrpcsbm,pcsmc,sfzhm,xm,hkszdhh,hbdm,hbdmmc,yhbdm,yhbdmmc,yhzgj,yhzgjmc,xb,xbmc,csrq,whcd,whcdmc,pzdw,pzdwmc,qrfx,qrfxmc,qrlb,qrlbmc,qrrq,bdsqbh,bdsqbhmc,qcdpcsbh,sfhbd,sfhbdmc,slrxm,slywbm,hjywlx,hjywlxmc,ph,jg,jgmc,jggj,gjmc,jgxz,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qrdjxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_rkb_czrk_t_t3_rk_qrdjxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df.py"}}

2019-09-05 16:02:05,968 - dodox_01907302051 - INFO - Upload Success
2019-09-05 16:02:06,102 - dodox_01907302051 - INFO - AW0AceAjBZ1xJXgBM4Lj
2019-09-05 16:02:07,168 - dodox_01907302051 - INFO - d898642cf34efa59f187b86ee2dfa482
2019-09-05 16:02:07,169 - dodox_01907302051 - INFO - workflow success
2019-09-05 16:02:08,281 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 16:02:08,281 - dodox_01907302051 - INFO - workflowid:d898642cf34efa59f187b86ee2dfa482
2019-09-05 16:02:09,391 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df'
2019-09-05 16:02:09,392 - db - INFO - update  public.task_info set wfid='d898642cf34efa59f187b86ee2dfa482',status='up',scriptid='AW0AceAjBZ1xJXgBM4Lj' where workflowname='gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qrdjxx_df'
2019-09-05 16:02:09,393 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3580.27ms
2019-09-05 16:03:37,229 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df'
2019-09-05 16:03:37,230 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 56.43ms
2019-09-05 16:03:43,871 - db - INFO - select * from public.task_info where wfid = 'e02462062efd4925acedd3e24e2932d8'
2019-09-05 16:03:43,872 - db - INFO - update  public.task_info set status='down' where wfid='e02462062efd4925acedd3e24e2932d8'
2019-09-05 16:03:45,060 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1189.29ms
2019-09-05 16:03:48,467 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df'
2019-09-05 16:03:48,537 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 16:03:48,575 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.log', 'gonganju_txt_ods.base_rkb_czrk_t_t3_rk_xmbgb_df', 'dsjzx.base_rkb_czrk_t_t3_rk_xmbgb_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_rkb_czrk_t_t3_rk_xmbgb_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.txt' into table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_xmbgb_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_rkb_czrk_t_t3_rk_xmbgb_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_rkb_czrk_t_t3_rk_xmbgb_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_rkb_czrk_t_t3_rk_xmbgb_df (id,bgrh,hid,sfzhm,xm,hkszdhh,hkszdxzqh,hkszdpcs,hkszdjwh,bgxm,bgqnr,bghnr,bgrq,sjsbxxtqbs,sjsbxxtq,sjhzbs,sjhzsj,slywbm,ph,slrxm,bgyy,xbdm,xb,mzdm,mz,csrq,rkxxbggzlbdm,zaglxxlbdm,xxlbmc,bggzsjxbsf,bggzsjxmc,sbr_gmsfhm,sbr_xm,sbr_ycsrgx_jtgxdm,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select id,bgrh,hid,sfzhm,xm,hkszdhh,hkszdxzqh,hkszdpcs,hkszdjwh,bgxm,bgqnr,bghnr,bgrq,sjsbxxtqbs,sjsbxxtq,sjhzbs,sjhzsj,slywbm,ph,slrxm,bgyy,xbdm,xb,mzdm,mz,csrq,rkxxbggzlbdm,zaglxxlbdm,xxlbmc,bggzsjxbsf,bggzsjxmc,sbr_gmsfhm,sbr_xm,sbr_ycsrgx_jtgxdm,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_rkb_czrk_t_t3_rk_xmbgb_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_xmbgb_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_xmbgb_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_rkb_czrk_t_t3_rk_xmbgb_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df.py"}}

2019-09-05 16:03:48,575 - dodox_01907302051 - INFO - Upload Success
2019-09-05 16:03:48,729 - dodox_01907302051 - INFO - AW0Ac3D0BZ1xJXgBM4Ls
2019-09-05 16:03:49,802 - dodox_01907302051 - INFO - 5dfe59b6f9ae7840f701a5e265fa9ea4
2019-09-05 16:03:49,803 - dodox_01907302051 - INFO - workflow success
2019-09-05 16:03:50,909 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 16:03:50,909 - dodox_01907302051 - INFO - workflowid:5dfe59b6f9ae7840f701a5e265fa9ea4
2019-09-05 16:03:52,018 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df'
2019-09-05 16:03:52,019 - db - INFO - update  public.task_info set wfid='5dfe59b6f9ae7840f701a5e265fa9ea4',status='up',scriptid='AW0Ac3D0BZ1xJXgBM4Ls' where workflowname='gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_xmbgb_df'
2019-09-05 16:03:52,021 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3607.81ms
2019-09-05 16:05:09,897 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_sb_a_kxx_df'
2019-09-05 16:05:09,899 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.12ms
2019-09-05 16:05:21,115 - db - INFO - select * from public.task_info where wfid = 'b9d1d7da60e7f9f73f53b2487449c333'
2019-09-05 16:05:21,116 - db - INFO - update  public.task_info set status='down' where wfid='b9d1d7da60e7f9f73f53b2487449c333'
2019-09-05 16:05:22,301 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1186.79ms
2019-09-05 16:05:25,696 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_sb_a_kxx_df'
2019-09-05 16:05:25,766 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 16:05:25,803 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_sb_a_kxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_sb_a_kxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_sb_a_kxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_sb_a_kxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_sb_a_kxx_df.log', 'gonganju_txt_ods.base_sb_a_kxx_df', 'dsjzx.base_sb_a_kxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_sb_a_kxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_sb_a_kxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_sb_a_kxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_sb_a_kxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_sb_a_kxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_sb_a_kxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_sb_a_kxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_sb_a_kxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_sb_a_kxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_sb_a_kxx_df.txt' into table gonganju_txt_ods.base_sb_a_kxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_sb_a_kxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_sb_a_kxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_sb_a_kxx_df (klsh,zkrwh,zkzyh,nbgrwym,zjlx,zjhm,shbzhm,xm,xb,mz,csrq,gj,sjhm,lxdh,xzqh,tcq,dwbm,dwmc,yztdhm,zlwd,zdtddzyb,zdtddz,zksqwd2,slwdmc,dqkfbh,sbkh,ksbm,sbxpwlkh,fkrq,kyxq,zklx,klb,xh,hh,jzlb,gfbb,scbz,yhbm,yhkh,yhhm,khhhh,khhmc,yhjmctxx,khdcsjlsh,yhkzt,khsbyy,zkksrq,zkwcrq,kpzxyy,kplzzt,klx,slsj,lsgssj,zdjgsj,bz,sjlsh,bjryid,tdzt,tdzt_gxsj,zlwd_jssj,wdfksj,bhkbj,zdtddz_yznm,zlwd_yznm,txdz,txdz_yb,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select klsh,zkrwh,zkzyh,nbgrwym,zjlx,zjhm,shbzhm,xm,xb,mz,csrq,gj,sjhm,lxdh,xzqh,tcq,dwbm,dwmc,yztdhm,zlwd,zdtddzyb,zdtddz,zksqwd2,slwdmc,dqkfbh,sbkh,ksbm,sbxpwlkh,fkrq,kyxq,zklx,klb,xh,hh,jzlb,gfbb,scbz,yhbm,yhkh,yhhm,khhhh,khhmc,yhjmctxx,khdcsjlsh,yhkzt,khsbyy,zkksrq,zkwcrq,kpzxyy,kplzzt,klx,slsj,lsgssj,zdjgsj,bz,sjlsh,bjryid,tdzt,tdzt_gxsj,zlwd_jssj,wdfksj,bhkbj,zdtddz_yznm,zlwd_yznm,txdz,txdz_yb,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_sb_a_kxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_sb_a_kxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_sb_a_kxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_sb_a_kxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_sb_a_kxx_df.py"}}

2019-09-05 16:05:25,803 - dodox_01907302051 - INFO - Upload Success
2019-09-05 16:05:25,939 - dodox_01907302051 - INFO - AW0AdOy-BZ1xJXgBM4L3
2019-09-05 16:05:27,003 - dodox_01907302051 - INFO - 8cf4f3e99b62b6224f2d7795093b7dac
2019-09-05 16:05:27,004 - dodox_01907302051 - INFO - workflow success
2019-09-05 16:05:28,116 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 16:05:28,117 - dodox_01907302051 - INFO - workflowid:8cf4f3e99b62b6224f2d7795093b7dac
2019-09-05 16:05:29,231 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_sb_a_kxx_df'
2019-09-05 16:05:29,231 - db - INFO - update  public.task_info set wfid='8cf4f3e99b62b6224f2d7795093b7dac',status='up',scriptid='AW0AdOy-BZ1xJXgBM4L3' where workflowname='gonganju_8_103_dsjzx_base_sb_a_kxx_df'
2019-09-05 16:05:29,233 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3593.07ms
2019-09-05 16:06:55,311 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df'
2019-09-05 16:06:55,313 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 57.96ms
2019-09-05 16:07:01,971 - db - INFO - select * from public.task_info where wfid = '2f537872ecf9ff0b193b25bd2b2837cc'
2019-09-05 16:07:01,971 - db - INFO - update  public.task_info set status='down' where wfid='2f537872ecf9ff0b193b25bd2b2837cc'
2019-09-05 16:07:03,141 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1170.79ms
2019-09-05 16:07:07,078 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df'
2019-09-05 16:07:07,150 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 16:07:07,184 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.log', 'gonganju_txt_ods.base_syrk_t_rjbxx_df', 'dsjzx.base_syrk_t_rjbxx_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_syrk_t_rjbxx_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_syrk_t_rjbxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_syrk_t_rjbxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_syrk_t_rjbxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_syrk_t_rjbxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_syrk_t_rjbxx_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_rjbxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_syrk_t_rjbxx_df.txt' into table gonganju_txt_ods.base_syrk_t_rjbxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_syrk_t_rjbxx_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_syrk_t_rjbxx_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_syrk_t_rjbxx_df (rid,syrklbdm,syrklbhz,zjzldm,zjzlhz,zjhm,xm,xmqp,xmsp,cym,xbdm,xbhz,mzdm,mzhz,csrq,csrq_dt,csdxzqhdm,csdxzqhhz,csdxz,jgdm,jghz,hh,fhlsh,hlsh,hjdxzqhdm,hjdxzqhhz,hjdlmdm,hjdlmhz,hjdxz,hjdz,hjdyjmp,hjdyjmpdsh,hjdejmp,hjdejmpdsh,jzdxzqhdm,jzdxzqhhz,jzdlmdm,jzdlmhz,jzdxz,jzdz,jzdyjmp,jzdyjmpdsh,jzdejmp,jzdejmpdsh,whcddm,whcdhz,hyzkdm,hyzkhz,poxm,pozjhm,zy,zylbdm,zylbhz,fwcs,zjxydm,zjxyhz,byzkdm,byzkhz,sg,xxdm,xxhz,zzsydm,zzsyhz,gjdm,gjhz,ywx,ywm,jwrysfdm,jwrysfhz,tlsydm,tlsyhz,rjsj,rjsj_dt,xxjb,zzjgdm,zzjghz,zwbh,dnabh,zxgxsj,zxgxsj_dt,wzjzd,wzjz,sjlydm,sjlyhz,bz,mapid,did,hjdid,del_flag,is_jsbr,is_zzrs,is_xdry,is_szry,jzzh,mapidd,yhzgxdm,yhzgxhz,yzjzrgxdm,yzjzrgxhz,tzbj,hjfwid,jzfwid,syrkzlbdm,syrkzlbhz,ywbh,is_kgh,qzdqrq,qzdqrq_dt,jzdzzjgdm,jzdzzjghz,sckrksj,sckrksj_dt,sckgxsj,sckgxsj_dt,jzdjzwdm,jzdjzwmc,hjdjzwdm,hjdjzwmc,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,dt,jhpt_update_time,jhpt_delete) select rid,syrklbdm,syrklbhz,zjzldm,zjzlhz,zjhm,xm,xmqp,xmsp,cym,xbdm,xbhz,mzdm,mzhz,csrq,csrq_dt,csdxzqhdm,csdxzqhhz,csdxz,jgdm,jghz,hh,fhlsh,hlsh,hjdxzqhdm,hjdxzqhhz,hjdlmdm,hjdlmhz,hjdxz,hjdz,hjdyjmp,hjdyjmpdsh,hjdejmp,hjdejmpdsh,jzdxzqhdm,jzdxzqhhz,jzdlmdm,jzdlmhz,jzdxz,jzdz,jzdyjmp,jzdyjmpdsh,jzdejmp,jzdejmpdsh,whcddm,whcdhz,hyzkdm,hyzkhz,poxm,pozjhm,zy,zylbdm,zylbhz,fwcs,zjxydm,zjxyhz,byzkdm,byzkhz,sg,xxdm,xxhz,zzsydm,zzsyhz,gjdm,gjhz,ywx,ywm,jwrysfdm,jwrysfhz,tlsydm,tlsyhz,rjsj,rjsj_dt,xxjb,zzjgdm,zzjghz,zwbh,dnabh,zxgxsj,zxgxsj_dt,wzjzd,wzjz,sjlydm,sjlyhz,bz,mapid,did,hjdid,del_flag,is_jsbr,is_zzrs,is_xdry,is_szry,jzzh,mapidd,yhzgxdm,yhzgxhz,yzjzrgxdm,yzjzrgxhz,tzbj,hjfwid,jzfwid,syrkzlbdm,syrkzlbhz,ywbh,is_kgh,qzdqrq,qzdqrq_dt,jzdzzjgdm,jzdzzjghz,sckrksj,sckrksj_dt,sckgxsj,sckgxsj_dt,jzdjzwdm,jzdjzwmc,hjdjzwdm,hjdjzwmc,deip_time,deip_time_dt,deip_update_time,deip_update_time_dt,dwd_loadtime,dwd_updatetime,dwd_yxbz,bzzjzldm,bzzjzlhz,bzzjhm,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_syrk_t_rjbxx_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_syrk_t_rjbxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_syrk_t_rjbxx_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_syrk_t_rjbxx_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df.py"}}

2019-09-05 16:07:07,185 - dodox_01907302051 - INFO - Upload Success
2019-09-05 16:07:07,323 - dodox_01907302051 - INFO - AW0AdnjHBZ1xJXgBM4ME
2019-09-05 16:07:08,382 - dodox_01907302051 - INFO - b126a59fdb64d67f92f4702df8722b10
2019-09-05 16:07:08,382 - dodox_01907302051 - INFO - workflow success
2019-09-05 16:07:09,491 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 16:07:09,491 - dodox_01907302051 - INFO - workflowid:b126a59fdb64d67f92f4702df8722b10
2019-09-05 16:07:10,616 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df'
2019-09-05 16:07:10,617 - db - INFO - update  public.task_info set wfid='b126a59fdb64d67f92f4702df8722b10',status='up',scriptid='AW0AdnjHBZ1xJXgBM4ME' where workflowname='gonganju_8_103_dsjzx_base_syrk_t_rjbxx_df'
2019-09-05 16:07:10,618 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3595.15ms
2019-09-05 16:08:05,724 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-09-05 16:08:05,725 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 58.19ms
2019-09-05 16:08:12,500 - db - INFO - select * from public.task_info where wfid = '3fea68f77d863275279ff5aff44031fb'
2019-09-05 16:08:12,500 - db - INFO - update  public.task_info set status='down' where wfid='3fea68f77d863275279ff5aff44031fb'
2019-09-05 16:08:13,665 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.92) 1166.26ms
2019-09-05 16:08:17,440 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-09-05 16:08:17,513 - dodox_01907302051 - INFO - Successful folder creation
2019-09-05 16:08:17,550 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.log', 'gonganju_txt_ods.base_syrk_t_zp_edz_df', 'dsjzx.base_syrk_t_zp_edz_df','public.job_run_info')\r\n\t\tpri.ok(\"table dsjzx.base_syrk_t_zp_edz_df data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_syrk_t_zp_edz_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_syrk_t_zp_edz_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_syrk_t_zp_edz_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_syrk_t_zp_edz_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_syrk_t_zp_edz_df_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_zp_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_zp_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_syrk_t_zp_edz_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_syrk_t_zp_edz_df.txt' into table gonganju_txt_ods.base_syrk_t_zp_edz_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '1'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table gonganju_orc_ods.base_syrk_t_zp_edz_df\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table gonganju_orc_ods.base_syrk_t_zp_edz_df succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_syrk_t_zp_edz_df (id,zjhm,zp,zprq,sjgxsj,photo_no,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select id,zjhm,zp,zprq,sjgxsj,photo_no,deip_time,deip_update_time,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from gonganju_txt_ods.base_syrk_t_zp_edz_df\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_syrk_t_zp_edz_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table gonganju_txt_ods.base_syrk_t_zp_edz_df succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table dsjzx.base_syrk_t_zp_edz_df extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df.py"}}

2019-09-05 16:08:17,550 - dodox_01907302051 - INFO - Upload Success
2019-09-05 16:08:17,691 - dodox_01907302051 - INFO - AW0Ad4umBZ1xJXgBM4MQ
2019-09-05 16:08:18,758 - dodox_01907302051 - INFO - 45eeaa776ef3fb1c7b8b72f5fe4fdcdf
2019-09-05 16:08:18,759 - dodox_01907302051 - INFO - workflow success
2019-09-05 16:08:19,867 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-05 16:08:19,867 - dodox_01907302051 - INFO - workflowid:45eeaa776ef3fb1c7b8b72f5fe4fdcdf
2019-09-05 16:08:20,982 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-09-05 16:08:20,983 - db - INFO - update  public.task_info set wfid='45eeaa776ef3fb1c7b8b72f5fe4fdcdf',status='up',scriptid='AW0Ad4umBZ1xJXgBM4MQ' where workflowname='gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-09-05 16:08:20,985 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3599.19ms
2019-09-06 14:49:50,126 - db - INFO - select * from public.task_info where wfid = '5fbc243936e6be328161e62ce353ffe8'
2019-09-06 14:49:50,134 - db - INFO - update  public.task_info set status='down' where wfid='5fbc243936e6be328161e62ce353ffe8'
2019-09-06 14:49:51,513 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1387.04ms
2019-09-06 15:00:34,246 - db - INFO - The database has been successfully connected
2019-09-06 15:00:34,246 - db - INFO - select token from public.token_info
2019-09-06 15:00:34,277 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjgzNTgwMzQsImlhdCI6MTU2Nzc1MzIzNCwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.fitPALuKrR-ghtKMS0o3q-21Aii3HoUhuIJIFKxqz_NHdpCsR585gJtchcV9iUNrlzGg4DS0nwoenugmDA-xBs5rXISsBOuJj31Fq9M-qOofHVuGBZyIiatke1zl-IBVA-YibG1a0auJFBsqYr2XMdW5AyKKT8BmlScRj8KQ3OGHtcY26EVhmYseTA1wwGJXHbv4QC7Nn9ejjzdrrqY3B8GgfRUjAGk1nirKMvGtOl58WveT8PA5NIrcMCSJsfukzWVbnyO7DlpdtUfxTr3BZg4YOhKvCpwiLS2YXrdH9SjSfksVZeBcHgRvlio6arEggoCjPoKVSJ3gjdAv_RSxM7e6gBNWqK2cgzQz88X3yiAtXke4HTXd9ImZdcEvGCveUxNJqqDINZTY895M-b3bK9IO7i4rRRzLvhBGlSYX68m89VcQrI-oUrMX-P7XTEB1S-d3FfO2YsEXDckybvRvID9Pj8V_EOqCReuB1I-f7gAchowG_KNJjxZhDvYbx8GhywKlPVWb7h8utAuTPrHQiQB6LG2_fDOV7J0LV2OtyzexS572rQPm_t056TyUooC8wbQ5M9xPO8tLDQhxhSlPnlwa7LrCGy03pdvzsx9yi7J0L6-20qlPHejqRhJ2WXaOZJTLVYGUttSqNC3udHqpyAAUt4-c4NoOUEWJTqYrh3Q' where 1='1'
Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjgzNTgwMzQsImlhdCI6MTU2Nzc1MzIzNCwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.fitPALuKrR-ghtKMS0o3q-21Aii3HoUhuIJIFKxqz_NHdpCsR585gJtchcV9iUNrlzGg4DS0nwoenugmDA-xBs5rXISsBOuJj31Fq9M-qOofHVuGBZyIiatke1zl-IBVA-YibG1a0auJFBsqYr2XMdW5AyKKT8BmlScRj8KQ3OGHtcY26EVhmYseTA1wwGJXHbv4QC7Nn9ejjzdrrqY3B8GgfRUjAGk1nirKMvGtOl58WveT8PA5NIrcMCSJsfukzWVbnyO7DlpdtUfxTr3BZg4YOhKvCpwiLS2YXrdH9SjSfksVZeBcHgRvlio6arEggoCjPoKVSJ3gjdAv_RSxM7e6gBNWqK2cgzQz88X3yiAtXke4HTXd9ImZdcEvGCveUxNJqqDINZTY895M-b3bK9IO7i4rRRzLvhBGlSYX68m89VcQrI-oUrMX-P7XTEB1S-d3FfO2YsEXDckybvRvID9Pj8V_EOqCReuB1I-f7gAchowG_KNJjxZhDvYbx8GhywKlPVWb7h8utAuTPrHQiQB6LG2_fDOV7J0LV2OtyzexS572rQPm_t056TyUooC8wbQ5M9xPO8tLDQhxhSlPnlwa7LrCGy03pdvzsx9yi7J0L6-20qlPHejqRhJ2WXaOZJTLVYGUttSqNC3udHqpyAAUt4-c4NoOUEWJTqYrh3Q
Traceback (most recent call last):
  File "api_201907302051.py", line 168, in <module>
    application.listen(12306)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2042, in listen
    server.listen(port, address)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/tcpserver.py", line 143, in listen
    sockets = bind_sockets(port, address=address)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/netutil.py", line 168, in bind_sockets
    sock.bind(sockaddr)
  File "/usr/local/python2.7/lib/python2.7/socket.py", line 228, in meth
    return getattr(self._sock,name)(*args)
socket.error: [Errno 98] Address already in use
2019-09-06 15:00:34,329 - db - INFO - The database has been closed
2019-09-06 15:01:53,893 - db - INFO - The database has been successfully connected
2019-09-06 15:01:53,893 - db - INFO - select token from public.token_info
2019-09-06 15:01:53,924 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjgzNTgxMTMsImlhdCI6MTU2Nzc1MzMxMywiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.VtSzjXB5JHrm00IVFV-iLmh1qIaJXoyuuL8JYT7jx7bDAqhUA8IFcICfMvhpaKfs5pqCvAVaJx57NS7nhzVt10UR_U0wUbdQhw4ugefae4Fyh_DzUfHb3DLIDG8gzxe5CNXLNlCvZ-f5ElRysy3pN49UmF8mRWYPBkx-zUni2FWvYgHTCS8_U1fZKVH3mO07QUrWf_-mpcoxeTCJviyNhYTapF4KEaMZNNMLl_qMJ8PuccYr8Z_Zo8nwUmuPBUzlMwqQECvw-DjRtG47FBh1qKvJxaH_-W1oWc07bCuH8Ayahy1q2UXq7cT9wHzPPbsgSNf-V28_Oc8wfyyemXXA0amYoPK6RQnZ9w1dQDJTybnTrh7Me1Z-UKxtKJPgcGhMa4fpqNo7gfzHYL17kqnaljm3dMUPgIrdWaG8wCvUjVUmHCfSZi4tpHpRS735SbGgoTXPwSJO_oOZc1RiTs-G-FE6sd-Gx3veAekob_rDW63OnPbTWMuawpBBo2VDEffwn5fbAjNquBvI4VO3mReWcm3fftmht8VN0kWaHt0eM0ErTdQ4Y4oVNC-LiIzyVwdDKurpDEcS4k6q5UCKZHkC8umWfMnL_ScwAutj1kPzdzr-ckFjQO8n--3v2JPTk_F-Wbz2IK2n1-DIFVLNqK-J5xrJukHMGSpvgz-bqXNfLw8' where 1='1'
Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjgzNTgxMTMsImlhdCI6MTU2Nzc1MzMxMywiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.VtSzjXB5JHrm00IVFV-iLmh1qIaJXoyuuL8JYT7jx7bDAqhUA8IFcICfMvhpaKfs5pqCvAVaJx57NS7nhzVt10UR_U0wUbdQhw4ugefae4Fyh_DzUfHb3DLIDG8gzxe5CNXLNlCvZ-f5ElRysy3pN49UmF8mRWYPBkx-zUni2FWvYgHTCS8_U1fZKVH3mO07QUrWf_-mpcoxeTCJviyNhYTapF4KEaMZNNMLl_qMJ8PuccYr8Z_Zo8nwUmuPBUzlMwqQECvw-DjRtG47FBh1qKvJxaH_-W1oWc07bCuH8Ayahy1q2UXq7cT9wHzPPbsgSNf-V28_Oc8wfyyemXXA0amYoPK6RQnZ9w1dQDJTybnTrh7Me1Z-UKxtKJPgcGhMa4fpqNo7gfzHYL17kqnaljm3dMUPgIrdWaG8wCvUjVUmHCfSZi4tpHpRS735SbGgoTXPwSJO_oOZc1RiTs-G-FE6sd-Gx3veAekob_rDW63OnPbTWMuawpBBo2VDEffwn5fbAjNquBvI4VO3mReWcm3fftmht8VN0kWaHt0eM0ErTdQ4Y4oVNC-LiIzyVwdDKurpDEcS4k6q5UCKZHkC8umWfMnL_ScwAutj1kPzdzr-ckFjQO8n--3v2JPTk_F-Wbz2IK2n1-DIFVLNqK-J5xrJukHMGSpvgz-bqXNfLw8
Traceback (most recent call last):
  File "api_201907302051.py", line 168, in <module>
    application.listen(12306)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 2042, in listen
    server.listen(port, address)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/tcpserver.py", line 143, in listen
    sockets = bind_sockets(port, address=address)
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/netutil.py", line 168, in bind_sockets
    sock.bind(sockaddr)
  File "/usr/local/python2.7/lib/python2.7/socket.py", line 228, in meth
    return getattr(self._sock,name)(*args)
socket.error: [Errno 98] Address already in use
2019-09-06 15:01:53,942 - db - INFO - The database has been closed
2019-09-06 15:02:24,816 - db - INFO - The database has been successfully connected
2019-09-06 15:02:24,816 - db - INFO - select token from public.token_info
2019-09-06 15:02:24,847 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjgzNTgxNDQsImlhdCI6MTU2Nzc1MzM0NCwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.WYemH1Ev2xiOp7BEybs8hjScy7dQlP7W1Jmz4h3htKWWf1HFq6P8x6g1e1uNLAqpoYIrSQ77hVSdBdKhUOturN0AbcJ-2KK3-d8X2RN1kKfY13Fstmp0i49mj2BpHgWN947SyIbhY1q9AWuAGWZEbVjudmQGtkkN4pj1zH66n0XmV4qh2xwzzs9NhJQkqJXJ6KzcpCkfPtPem6eVROmj128WP0Pcaf8gOgRy7pzwV3zMgLEDXmPXzE9LnYYyltjAa3z_7psYox2lsGcGAnpa5Vh6bx0Dy2jLgv9wd9IKr-RT9k5MXc-vpWiX_ASXggW0kzvqg7bdJuKSkupj2GZHtNYx1ue-4Mi3xZmJAAl_j4NuhdwHMIaTk6KjI0_cwpQTVjYxSTxDzOXiEHFuIWRiD_tErZmqQnHz1niE0qdGTQVvcGbnPjXrrnjy_iBzgWnxlFivWA64LOMf5tb4cmtCzjaYKdGks8IgOecHeQU4PBwXA81we_fpyE5V1dvKLyXprkNV38DMRB0XTyh6TZMH2tA1Ag2RA7uqm2D-FnNTKoPqP7T_vRUF3LiJmUpVfZSH96GF6vDNpEMUUkkyvU0PSxfNwWGjqz5Ck_Zf5fy-LIleo5Jo8vc6oSjOdlqiPO4HNFAM6GXc-JyfJGM0ecRZJrJrHwlvmXbJPK5byaJ1YlU' where 1='1'
2019-09-06 15:03:11,717 - db - INFO - select * from public.task_info where wfid = 'fdd622e6aa8a4bcd1287dd5d89b48463'
2019-09-06 15:03:11,719 - db - INFO - update  public.task_info set status='down' where wfid='fdd622e6aa8a4bcd1287dd5d89b48463'
2019-09-06 15:03:13,153 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1436.31ms
2019-09-06 15:03:31,140 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-06 15:03:31,222 - dodox_01907302051 - INFO - Successful folder creation
2019-09-06 15:03:31,289 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'tdt.xh_ga1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table tdt.xh_ga1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table tdt.xh_ga2\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table tdt.xh_ga2 succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into tdt.xh_ga2 (xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete) select xh,xzqh,sbbh,sbmc,sblx,sbcs,azrq,ipdz,sswzdm,sswzmc,wzlx,jd,wd,dwd_loadtime,dwd_updatetime,dwd_yxbz,dt,jhpt_update_time,jhpt_delete  from tdt.xh_ga1\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table tdt.xh_ga1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table tdt.xh_ga1 succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table test.xh_ga extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-06 15:03:31,289 - dodox_01907302051 - INFO - Upload Success
2019-09-06 15:03:31,531 - dodox_01907302051 - INFO - AW0FYprvBZ1xJXgBM4P4
2019-09-06 15:03:32,657 - dodox_01907302051 - INFO - 8331cceb1ec47735060588d49882c9b3
2019-09-06 15:03:32,657 - dodox_01907302051 - INFO - workflow success
2019-09-06 15:03:33,810 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-06 15:03:33,811 - dodox_01907302051 - INFO - workflowid:8331cceb1ec47735060588d49882c9b3
2019-09-06 15:03:34,996 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-06 15:03:34,997 - db - INFO - update  public.task_info set wfid='8331cceb1ec47735060588d49882c9b3',status='up',scriptid='AW0FYprvBZ1xJXgBM4P4' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-06 15:03:34,998 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3913.45ms
2019-09-06 15:36:22,725 - db - INFO - select * from public.task_info where wfid = 'd376a316acc560150323b066afa84f1a'
2019-09-06 15:36:23,823 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1098.32ms
2019-09-06 15:36:23,931 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-06 15:36:23,932 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 57.05ms
2019-09-06 15:36:35,003 - db - INFO - select * from public.task_info where wfid = '8331cceb1ec47735060588d49882c9b3'
2019-09-06 15:36:35,003 - db - INFO - update  public.task_info set status='down' where wfid='8331cceb1ec47735060588d49882c9b3'
2019-09-06 15:36:36,311 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1308.95ms
2019-09-06 15:36:36,418 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-06 15:36:36,529 - dodox_01907302051 - INFO - Successful folder creation
2019-09-06 15:36:36,593 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/huanbaoju_16_87_test_xh_ga.json \u003e /opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/huanbaoju_16_87_test_xh_ga.log', 'shenjiju_txt.packet_in_exchange1', 'test.xh_ga','public.job_run_info')\r\n\t\tpri.ok(\"table test.xh_ga data extraction txt succeed，uploading to inceptor!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.26.41.32:30366/tdt;guardianToken=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\tpath=\"%s/huanbaoju/test_xh_ga\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/test_xh_ga_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/test_xh_ga_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/test_xh_ga_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/test_xh_ga_split\"%path):\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tpri.info(\"data uploading...............\")\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"file %s upload failed,re-uploading!\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/test_xh_ga_split/%s \\\"http://172.26.41.32:32055/webhdfs/v1/tmp/detuo/huanbaoju_test_xh_ga.txt?op=CREATE\u0026data=true\u0026guardian_access_token=6mKYTUMtterzxlYyMpv4-CEIJAZ5.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/huanbaoju_test_xh_ga.txt' into table shenjiju_txt.packet_in_exchange1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tpri.ok(\"data upload to hdfs succeed\")\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tExecrate = '2'\r\n\t\tExecrate = str(Execrate)\r\n\t\tif Execrate == '2':\r\n\t\t\tpri.info(\"Full data extraction per day!\")\r\n\t\t\tcurs4 = conn.cursor()\r\n\t\t\tsql_truncate_orc = \"truncate table shenjiju_orc.packet_in_exchange1\"\r\n\t\t\tcurs4.execute(sql_truncate_orc)\r\n\t\t\tpri.ok(\"truncate orc table shenjiju_orc.packet_in_exchange1 succeed\")\r\n\t\t\tcurs4.close()\r\n\t\telse:\r\n\t\t\tpri.info(\"incremental data extraction per day!\")\r\n\t\tsql_orc = \"insert into shenjiju_orc.packet_in_exchange1 (BATH,CREATETIME,PROVINCE_CODE,PARAM1,PARAM2,PARAM3,PARAM4,PARAM5,RECOURD_NUM,TABLE_NAME,ID,MX) select BATH,CREATETIME,PROVINCE_CODE,PARAM1,PARAM2,PARAM3,PARAM4,PARAM5,RECOURD_NUM,TABLE_NAME,ID,MX  from shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs2.execute(sql_orc)\r\n\t\tpri.ok(\"insert orc table from txt table succeed!\")\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tpri.ok(\"truncate txt table shenjiju_txt.packet_in_exchange1 succeed!\")\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"table test.xh_ga extracte succeed!\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/huanbaoju/huanbaoju_16_87_test_xh_ga.py"}}

2019-09-06 15:36:36,594 - dodox_01907302051 - INFO - Upload Success
2019-09-06 15:36:36,767 - dodox_01907302051 - INFO - AW0FgOYHBZ1xJXgBM4QJ
2019-09-06 15:36:37,849 - dodox_01907302051 - INFO - bf2f7bcac321afce408634eb2a87911d
2019-09-06 15:36:37,850 - dodox_01907302051 - INFO - workflow success
2019-09-06 15:36:38,966 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-09-06 15:36:38,967 - dodox_01907302051 - INFO - workflowid:bf2f7bcac321afce408634eb2a87911d
2019-09-06 15:36:40,109 - db - INFO - select * from public.task_info where workflowname = 'huanbaoju_16_87_test_xh_ga'
2019-09-06 15:36:40,109 - db - INFO - update  public.task_info set wfid='bf2f7bcac321afce408634eb2a87911d',status='up',scriptid='AW0FgOYHBZ1xJXgBM4QJ' where workflowname='huanbaoju_16_87_test_xh_ga'
2019-09-06 15:36:40,112 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3745.93ms
