nohup: ignoring input
2019-08-19 10:42:40,520 - db - INFO - The database has been successfully connected
2019-08-19 10:42:40,520 - db - INFO - select token from public.token_info
2019-08-19 10:42:40,551 - db - INFO - update  public.token_info set token='Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1NjY3ODczNjAsImlhdCI6MTU2NjE4MjU2MCwiaXNzIjoiZGFuYXN0dWRpb19hdXRoX3NlcnZlciIsIm1vZHVsZXMiOlsiYWNjZXNzIiwibWluZGluZyIsIndvcmtmbG93IiwidmF1bHQiLCJtbGliIl0sInJvbGVfaWQiOiJkZXZlbG9wZXIiLCJyb2xlX25hbWUiOiLlvIDlj5HogIUiLCJ0a3ZlcnNpb24iOjEsInVzZXJfaWQiOiJBV3FhWm1DaGNrVXdEUkk5blBWayIsInVzZXJfbmFtZSI6ImRhdGF0b20ifQ.tz4VShyyTMGMXfb20UZrxkLXMy79kz27vG1ph_lZd1mERDRAItl50wzysKB5h4fOXtozhbZs1L7oeWH-37hjxTgHJWrb5sxusJrxLJ2YbxdxNrwVpS8xdrpcxZUgWzHXWJKxBZsM_ir0s0ZPZk_pCzyBgmI8RXiO9-SaZqTWnNe5fmszk68Qxb4G5uskmgtTIyfentEP60xbyJpP6Y17MR--kmarANxGpoM7S9akJxJMeOJrbzWm_xv-jVlXTLET_hQZPsXv580p0qJX8jAL_lJVM757xRtt-c8hJ6GNbyzZN5FQLb7tzBqwQYpS7W38XZdbqWOYhRZ-JlYI7oRnJEGUzVKusTD0Tnjd0yS6QEcl3OKbog8HLxvFj4ZjNECDOGPsGI58CE8UhkoobsZAYqN-SeGHrfI5gXqcY4t9MOR5KXPKBBsovagDlfxt02CdZYRmfb0vNQzz1N6GqIA96uTWT4T_SgXWa7t_UBPiluTLdER-a5-NlFSwVnap4ZXXnaYar0G-EhRbEyPrgBJ6dPmNc5LuBEzlF-mlBygrlb0FCXGzR5mNCmvqh6UM4cntd76CLZlgy2OA7yC0jFoRaW5C2t4PQpZv4W59kvQUHwsVvyOeQrHupux3lNfdHBEIEGAkPgBB8rclzpP9HKD5_JeL2JGZaVmyfgvVVCqYRrc' where 1='1'
2019-08-19 10:56:25,924 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.7)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.7')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "/opt/dodox_api/api_201907302051.py", line 52, in post
    ColumnType = res['ColumnType']
KeyError: 'ColumnType'
2019-08-19 10:56:25,925 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.7) 2.05ms
2019-08-19 10:59:45,351 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-19 10:59:45,435 - dodox_01907302051 - INFO - Successful folder creation
2019-08-19 10:59:45,497 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_testone_packet_in_exchange3.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_testone_packet_in_exchange3.log', 'shenjiju_txt.packet_in_exchange1', 'testone.packet_in_exchange3','public.job_run_info')\r\n\t\tpri.ok(\"表testone.packet_in_exchange3数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:31326/shenjiju_orc;guardianToken=8OaTwGAflRSKjKEex8gw-M8IUIMT.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/testone_packet_in_exchange3\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/testone_packet_in_exchange3_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/testone_packet_in_exchange3_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/testone_packet_in_exchange3_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/testone_packet_in_exchange3_split/%s \\\"http://172.17.148.189:31734/webhdfs/v1/tmp/detuo/gonganju_testone_packet_in_exchange3.txt?op=CREATE\u0026data=true\u0026guardian_access_token=IdnsKV9cgCVkfF00VEka-M8IUIMT.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_testone_packet_in_exchange3.txt' into table shenjiju_txt.packet_in_exchange1\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into shenjiju_orc.packet_in_exchange1 select * from shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table shenjiju_txt.packet_in_exchange1\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表testone.packet_in_exchange3抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_testone_packet_in_exchange3.py"}}

2019-08-19 10:59:45,498 - dodox_01907302051 - INFO - Upload Success
2019-08-19 10:59:45,667 - dodox_01907302051 - INFO - AWyn0PbjBZ1xJXgBM2my
2019-08-19 10:59:46,763 - dodox_01907302051 - INFO - 37528f483e6828d103477859e071ecd1
2019-08-19 10:59:46,763 - dodox_01907302051 - INFO - workflow success
2019-08-19 10:59:47,896 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-19 10:59:47,896 - dodox_01907302051 - INFO - workflowid:37528f483e6828d103477859e071ecd1
2019-08-19 10:59:49,038 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_testone_packet_in_exchange3'
2019-08-19 10:59:49,039 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('37528f483e6828d103477859e071ecd1','up','AWyn0PbjBZ1xJXgBM2my','gonganju_8_103_testone_packet_in_exchange3')
2019-08-19 10:59:49,041 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.7) 3746.70ms
2019-08-19 11:00:45,179 - db - INFO - select * from public.task_info where wfid = '37528f483e6828d103477859e071ecd1'
2019-08-19 11:00:45,179 - db - INFO - update  public.task_info set status='down' where wfid='37528f483e6828d103477859e071ecd1'
2019-08-19 11:00:46,343 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.7) 1165.16ms
2019-08-19 14:36:35,970 - tornado.access - INFO - 200 GET /dana/workflow/add (172.26.16.92) 1.02ms
2019-08-19 14:36:44,782 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-08-19 14:36:44,784 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 97.35ms
2019-08-19 15:16:13,843 - tornado.access - WARNING - 404 POST /dana/workflow/add/ (172.26.16.92) 0.79ms
2019-08-19 15:18:20,730 - tornado.access - WARNING - 404 POST /dana/workflow/add/ (172.26.16.92) 0.69ms
2019-08-19 15:23:22,935 - tornado.access - WARNING - 404 POST /dana/workflow/add/ (172.26.16.92) 0.66ms
2019-08-19 15:26:28,497 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-08-19 15:26:28,629 - dodox_01907302051 - INFO - Successful folder creation
2019-08-19 15:26:28,752 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.log', 'gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df', 'dsjzx.base_rkb_czrk_t_t3_rk_qczxxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_rkb_czrk_t_t3_rk_qczxxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.txt' into table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_rkb_czrk_t_t3_rk_qczxxx_df select * from gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_rkb_czrk_t_t3_rk_qczxxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_rkb_czrk_t_t3_rk_qczxxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df.py"}}

2019-08-19 15:26:28,753 - dodox_01907302051 - INFO - Upload Success
2019-08-19 15:26:28,972 - dodox_01907302051 - INFO - AWyoxSenBZ1xJXgBM2nh
2019-08-19 15:26:30,073 - dodox_01907302051 - INFO - 56103221fab6f8eadd04249cf860bbb1
2019-08-19 15:26:30,073 - dodox_01907302051 - INFO - workflow success
2019-08-19 15:26:31,212 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-19 15:26:31,212 - dodox_01907302051 - INFO - workflowid:56103221fab6f8eadd04249cf860bbb1
2019-08-19 15:26:32,400 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df'
2019-08-19 15:26:32,400 - db - INFO - insert into public.task_info(wfid,status,scriptid,workflowname) values('56103221fab6f8eadd04249cf860bbb1','up','AWyoxSenBZ1xJXgBM2nh','gonganju_8_103_dsjzx_base_rkb_czrk_t_t3_rk_qczxxx_df')
2019-08-19 15:26:32,402 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.92) 3972.48ms
2019-08-19 16:40:06,207 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-08-19 16:40:06,214 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 74.14ms
2019-08-19 16:40:17,687 - db - INFO - select * from public.task_info where wfid = 'fe5319afcfa7fad415dc67587a4ce9e0'
2019-08-19 16:40:17,688 - db - INFO - update  public.task_info set status='down' where wfid='fe5319afcfa7fad415dc67587a4ce9e0'
2019-08-19 16:40:18,922 - tornado.access - INFO - 200 POST /dana/workflow/delete (172.26.16.93) 1235.19ms
2019-08-19 16:40:22,242 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-08-19 16:40:22,343 - dodox_01907302051 - INFO - Successful folder creation
2019-08-19 16:40:22,396 - dodox_01907302051 - INFO - {"code":200,"result":{"context":"#!/usr/bin/env python\r\n# -*- encoding: utf-8 -*-\r\n\r\nimport os\r\nimport sys\r\nimport ConfigParser\r\nimport subprocess\r\nimport jaydebeapi\r\nimport logging\r\nimport xml.etree.ElementTree as ET\r\nimport commands\r\nimport psycopg2\r\nimport datetime\r\nimport re\r\nimport time\r\nsys.path.append('/opt/datatom/dana_api/script')\r\nfrom check_datax_log import operate_tables\r\n\r\n#文件路径\r\nfile_dir='/opt/datatom/dana_api/data'\r\njarFile='/opt/datatom/dana_api/libs/inceptor-driver-5.2.0.jar'\r\nlog_path='/opt/datatom/dana_api/log/'\r\nsource_log='source.log'\r\n\r\n\r\n#定义打印信息类\r\nclass Print:\r\n    def info(self, info):\r\n        print('\\033[1;36;10m[INFO]%s\\033[0m' % info)\r\n    def error(self, error):\r\n        print('\\033[1;31;10m[ERROR]%s\\033[0m' % error)\r\n        sys.exit(2)\r\n    def ok(self, ok):\r\n        print('\\033[1;32;10m[INFO]%s\\033[0m' % ok)\r\npri = Print();\r\n\r\n#log日志\r\nlog_name = log_path + source_log\r\nEL = logging.FileHandler(log_name, mode='a')\r\nformatter = logging.Formatter(\"%(asctime)s - [line:%(lineno)d] - %(levelname)s: %(message)s\")\r\nEL.setFormatter(formatter)\r\nelogger = logging.Logger(name='Sourcelog',level=logging.DEBUG)\r\nelogger.addHandler(EL)\r\n\r\n\r\n\r\naddtime = time.strftime('%Y%m%d%H%M%S',time.localtime(time.time()))[0:8]\r\n\r\n\r\n#执行datax并把日志写入库\r\ndef action_datax():\r\n\ttry:\r\n\t\t#os.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.json \u003e /opt/datatom/dana_api/log/${exec_datax_log}/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.log\"%addtime)\r\n\t\tos.system(\"python /opt/datatom/datax/bin/datax.py -p \\\"-Dtimecolumn=%s\\\" /opt/datatom/dana_api/execute_cfg/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.json \u003e /opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.log\"%addtime)\r\n\t\toperate_tables('/opt/datatom/dana_api/log/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.log', 'gonganju_txt_ods.base_crjdata_ryxx_df', 'dsjzx.base_crjdata_ryxx_df','public.job_run_info')\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_ryxx_df数据抽取txt完成，正在上传至inceptor\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\r\n\r\ndef upload():\r\n\ttry:\r\n\t\tdirver = 'org.apache.hive.jdbc.HiveDriver'\r\n\t\tconn = jaydebeapi.connect(dirver, 'jdbc:hive2://172.17.148.189:30925/gonganju_txt_ods;guardianToken=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH', ['', ''], jarFile)\r\n\t\tcurs = conn.cursor()\r\n\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/?op=MKDIRS\u0026permission=777\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\tpath=\"%s/gonganju/dsjzx_base_crjdata_ryxx_df\"%file_dir\r\n\t\tfor root, dirs, files in os.walk(path):\t\r\n\t\t\tif not os.path.isdir(\"%s/dsjzx_base_crjdata_ryxx_df_split\"%path):\r\n\t\t\t\tos.system(\"mkdir -p %s/dsjzx_base_crjdata_ryxx_df_split\"%path)\r\n\t\t\tfor i in range(len(files)):\r\n\t\t\t\tos.system(\"split -l 5000000 %s/%s -d -a 10 %s/dsjzx_base_crjdata_ryxx_df_split/%s\"%(path,files[i],path,files[i]))\r\n\t\t\tbreak\r\n\t\t#上传文件并加载到星环\r\n\t\tfor file1,file2,file3 in os.walk(\"%s/dsjzx_base_crjdata_ryxx_df_split\"%path):\r\n\t\t\tprint(file3)\r\n\t\t\ti=0\r\n\t\t\tfor i in range(len(file3)):\r\n\t\t\t\tos.system(\"curl -i -X PUT \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\"\")\r\n\t\t\t\t#-C表示支持断点续传\r\n\t\t\t\t#os.system(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ryxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ryxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\ttime.sleep(5)\r\n\t\t\t\tprint(\"status=\",status)\r\n\t\t\t\tcount = 1\r\n\t\t\t\twhile (status != 0 and count \u003c= 5):\r\n\t\t\t\t\tprint(\"文件%s上传失败,正在重新上传\"%file3[i])\r\n\t\t\t\t\tstatus,out=commands.getstatusoutput(\"curl -i -C - -X PUT -T %s/dsjzx_base_crjdata_ryxx_df_split/%s \\\"http://172.17.148.189:32228/webhdfs/v1/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt?op=CREATE\u0026data=true\u0026guardian_access_token=YRzeh1lLQQETtBMYg5Sd-851RZ52.TDH\\\" -H \\\"Content-Type:application/octet-stream\\\"\"%(path,file3[i]))\r\n\t\t\t\t\tcount = count + 1\r\n\t\t\t\tsqlStr = \"load data inpath '/tmp/detuo/gonganju_dsjzx_base_crjdata_ryxx_df.txt' into table gonganju_txt_ods.base_crjdata_ryxx_df\"\r\n\t\t\t\tcurs.execute(sqlStr)\r\n\t\t\tbreak\r\n\t\tcurs2 = conn.cursor()\t\r\n\t\t#加载数据到事务表\r\n\t\tsql_orc = \"insert into gonganju_orc_ods.base_crjdata_ryxx_df select * from gonganju_txt_ods.base_crjdata_ryxx_df\"\r\n\t\tcurs2.execute(sql_orc)\t\r\n\t\tcurs3 = conn.cursor()\r\n\t\tsql_truncate = \"truncate table gonganju_txt_ods.base_crjdata_ryxx_df\"\r\n\t\tcurs3.execute(sql_truncate)\r\n\t\tcurs.close()\r\n\t\tcurs2.close()\r\n\t\tcurs3.close()\r\n\t\tconn.close()\r\n\t\tpri.ok(\"表dsjzx.base_crjdata_ryxx_df抽取成功\")\r\n\texcept Exception as e:\r\n\t\ts = sys.exc_info()\r\n\t\t\r\n\r\n        \r\nif __name__ == '__main__':\r\n\taction_datax()\r\n\tupload()\r\n","msg":"/var/dana/dodox/filemanager/file/admin/gonganju/gonganju_8_103_dsjzx_base_crjdata_ryxx_df.py"}}

2019-08-19 16:40:22,397 - dodox_01907302051 - INFO - Upload Success
2019-08-19 16:40:22,580 - dodox_01907302051 - INFO - AWypCM6TBZ1xJXgBM2pF
2019-08-19 16:40:23,668 - dodox_01907302051 - INFO - b99857a5dc5e7c41f76207cf74a2fb3f
2019-08-19 16:40:23,669 - dodox_01907302051 - INFO - workflow success
2019-08-19 16:40:24,791 - dodox_01907302051 - INFO - {"code":200,"result":"保存成功"}

2019-08-19 16:40:24,791 - dodox_01907302051 - INFO - workflowid:b99857a5dc5e7c41f76207cf74a2fb3f
2019-08-19 16:40:25,921 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-08-19 16:40:25,921 - db - INFO - update  public.task_info set wfid='b99857a5dc5e7c41f76207cf74a2fb3f',status='up',scriptid='AWypCM6TBZ1xJXgBM2pF' where workflowname='gonganju_8_103_dsjzx_base_crjdata_ryxx_df'
2019-08-19 16:40:25,923 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 3740.95ms
2019-08-20 11:13:46,257 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-08-20 11:13:46,259 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 71.73ms
2019-08-20 14:02:56,475 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-08-20 14:02:56,477 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 55.29ms
2019-08-20 14:23:19,663 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.92)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.92')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "/opt/dodox_api/api_201907302051.py", line 27, in post
    res = json.loads(res)
  File "/usr/local/python2.7/lib/python2.7/json/__init__.py", line 339, in loads
    return _default_decoder.decode(s)
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 364, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 380, in raw_decode
    obj, end = self.scan_once(s, idx)
ValueError: Expecting ',' delimiter: line 1 column 494 (char 493)
2019-08-20 14:23:19,678 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.92) 15.32ms
2019-08-20 14:25:48,283 - db - INFO - select * from public.task_info where workflowname = 'gonganju_8_103_dsjzx_base_syrk_t_zp_edz_df'
2019-08-20 14:25:48,285 - tornado.access - INFO - 200 POST /dana/workflow/add (172.26.16.93) 54.85ms
2019-08-20 14:28:46,937 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.92)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.92')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "/opt/dodox_api/api_201907302051.py", line 27, in post
    res = json.loads(res)
  File "/usr/local/python2.7/lib/python2.7/json/__init__.py", line 339, in loads
    return _default_decoder.decode(s)
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 364, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 380, in raw_decode
    obj, end = self.scan_once(s, idx)
ValueError: Expecting ',' delimiter: line 1 column 494 (char 493)
2019-08-20 14:28:46,938 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.92) 1.24ms
2019-08-20 14:33:03,608 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.92)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.92')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "/opt/dodox_api/api_201907302051.py", line 27, in post
    res = json.loads(res)
  File "/usr/local/python2.7/lib/python2.7/json/__init__.py", line 339, in loads
    return _default_decoder.decode(s)
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 364, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 380, in raw_decode
    obj, end = self.scan_once(s, idx)
ValueError: Expecting ',' delimiter: line 1 column 494 (char 493)
2019-08-20 14:33:03,608 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.92) 1.08ms
2019-08-20 14:35:12,889 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.92)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.92')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "/opt/dodox_api/api_201907302051.py", line 27, in post
    res = json.loads(res)
  File "/usr/local/python2.7/lib/python2.7/json/__init__.py", line 339, in loads
    return _default_decoder.decode(s)
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 364, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 380, in raw_decode
    obj, end = self.scan_once(s, idx)
ValueError: Expecting ',' delimiter: line 1 column 494 (char 493)
2019-08-20 14:35:12,890 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.92) 1.09ms
2019-08-20 14:39:45,585 - tornado.application - ERROR - Uncaught exception POST /dana/workflow/add (172.26.16.93)
HTTPServerRequest(protocol='http', host='172.26.16.90:12306', method='POST', uri='/dana/workflow/add', version='HTTP/1.1', remote_ip='172.26.16.93')
Traceback (most recent call last):
  File "/usr/local/python2.7/lib/python2.7/site-packages/tornado-5.1.1-py2.7-linux-x86_64.egg/tornado/web.py", line 1590, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File "/opt/dodox_api/api_201907302051.py", line 27, in post
    res = json.loads(res)
  File "/usr/local/python2.7/lib/python2.7/json/__init__.py", line 339, in loads
    return _default_decoder.decode(s)
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 364, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/usr/local/python2.7/lib/python2.7/json/decoder.py", line 380, in raw_decode
    obj, end = self.scan_once(s, idx)
ValueError: Expecting ',' delimiter: line 1 column 495 (char 494)
2019-08-20 14:39:45,586 - tornado.access - ERROR - 500 POST /dana/workflow/add (172.26.16.93) 1.02ms
